<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Define a fonte Inter para toda a página */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Cor de fundo suave */
        }

        /* Estilos para a mensagem de feedback */
        #feedback-message {
            display: none;
            padding: 12px;
            margin-top: 16px;
            border-radius: 8px;
            font-weight: 500;
            position: fixed; /* Para melhor visibilidade */
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000; /* Para ficar sobre outros elementos */
            min-width: 300px;
            text-align: center;
        }

        .feedback-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .feedback-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .feedback-info {
            background-color: #e0f2fe;
            color: #075985;
        }

        /* Estilos para ocultar/mostrar elementos */
        .hidden {
            display: none !important;
        }

        /* Estilos para a seção colapsável */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .collapsible-header:hover {
            background-color: #f8fafc;
        }

        .collapsible-header h2 {
            margin-bottom: 0;
        }

        .arrow-icon {
            transition: transform 0.3s ease;
        }

        .arrow-icon.rotated {
            transform: rotate(90deg);
        }

        /* Estilo para transações pagas */
        .paid-transaction {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }

        /* Estilos para o modal */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-body label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }

        .modal-body input[type="text"],
        .modal-body input[type="number"],
        .modal-body select { /* Estilo adicionado para selects no modal */
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-10">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-8">Controle Financeiro Pessoal Completo</h1>

        <div id="feedback-message" class="hidden"></div> <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-blue-800">Poder de Compra Total</h2>
                <p id="total-receitas" class="text-2xl font-bold text-blue-700">R$ 0,00</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-red-800">Despesas do Mês</h2>
                <p id="total-despesas" class="text-2xl font-bold text-red-700">R$ 0,00</p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-green-800">Saldo Consolidado</h2>
                <p id="saldo-atual" class="text-2xl font-bold text-green-700">R$ 0,00</p>
            </div>
        </div>
        <div class="bg-purple-100 p-4 rounded-lg shadow-md mb-8">
            <h2 class="text-lg font-semibold text-purple-800">Total de Faturas de Cartão (Mês Atual)</h2>
            <p id="total-card-bills" class="text-2xl font-bold text-purple-700">R$ 0,00</p>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <div id="detailed-card-bills-header" class="collapsible-header">
                <h2 class="text-2xl font-semibold text-gray-700">Faturas Detalhadas de Cartão</h2>
                <svg id="detailed-card-bills-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </div>
            <div id="detailed-card-bills-content" class="hidden">
                <ul id="detailed-card-bills-list" class="bg-white rounded-md shadow-sm divide-y divide-gray-200">
                </ul>
                <p id="no-card-bills-message" class="text-center text-gray-500 mt-4 hidden">Nenhuma fatura de cartão para exibir.</p>
            </div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gerenciar Contas</h2>
            <div class="p-4 bg-gray-50 rounded-lg shadow-sm mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Conta</h3>
                <form id="add-account-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
                    <div>
                        <label for="account-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Conta</label>
                        <input type="text" id="account-name" placeholder="Nome da Conta (ex: Banco X, Dinheiro)" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="account-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                        <select id="account-type"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="overdraft">Cheque Especial</option>
                            <option value="cash" selected>Dinheiro</option>
                        </select>
                    </div>
                    <div>
                        <label for="initial-balance" class="block text-sm font-medium text-gray-700 mb-1" id="initial-value-label">Saldo Inicial (R$)</label>
                        <input type="number" id="initial-balance" step="0.01" placeholder="Saldo Inicial (R$)" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="sm:col-span-3 flex justify-end">
                        <button type="submit"
                                class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition duration-150 ease-in-out">
                            Adicionar
                        </button>
                    </div>
                </form>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Minhas Contas</h3>
                <ul id="accounts-list" class="bg-white rounded-md shadow-sm divide-y divide-gray-200">
                </ul>
            </div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gerenciar Cartões de Crédito</h2>
            <div class="p-4 bg-gray-50 rounded-lg shadow-sm mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Cartão de Crédito</h3>
                <form id="add-credit-card-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
                    <div>
                        <label for="card-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cartão</label>
                        <input type="text" id="card-name" placeholder="Nome do Cartão (ex: Visa, Master)" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="card-limit" class="block text-sm font-medium text-gray-700 mb-1">Limite (R$)</label>
                        <input type="number" id="card-limit" step="0.01" placeholder="Limite (R$)" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="card-due-day" class="block text-sm font-medium text-gray-700 mb-1">Dia Venc. Fatura</label>
                        <input type="number" id="card-due-day" min="1" max="31" placeholder="Dia Venc. Fatura" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-sm shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                    </div>
                    <div class="sm:col-span-3 flex justify-end">
                        <button type="submit"
                                class="px-5 py-2 bg-purple-500 text-white font-semibold rounded-md shadow-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-400 transition duration-150 ease-in-out">
                            Adicionar
                        </button>
                    </div>
                </form>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Meus Cartões</h3>
                <ul id="credit-cards-list" class="bg-white rounded-md shadow-sm divide-y divide-gray-200">
                </ul>
            </div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Adicionar Nova Transação Manualmente</h2>
            <form id="transaction-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                    <input type="date" id="date" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <input type="text" id="description" placeholder="Ex: Salário, Aluguel, Supermercado" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="value" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                    <input type="number" id="value" step="0.01" placeholder="0.00" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                    <select id="type" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="receita">Receita</option>
                        <option value="despesa" selected>Despesa</option>
                    </select>
                </div>
                <div>
                    <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                    <select id="category-select" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </select>
                    <input type="text" id="new-category-input" placeholder="Nova Categoria"
                           class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm hidden">
                </div>
                <div>
                    <label for="account-select" class="block text-sm font-medium text-gray-700 mb-1">Conta / Cartão</label>
                    <select id="account-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </select>
                </div>
                <div class="col-span-1 sm:col-span-2 lg:col-span-1">
                    <label for="installments" class="block text-sm font-medium text-gray-700 mb-1">Parcelas (total)</label>
                    <input type="number" id="installments" min="1" value="1"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="col-span-1 sm:col-span-2 lg:col-span-1"> <label for="installments-paid" class="block text-sm font-medium text-gray-700 mb-1">Parcelas já pagas</label>
                    <input type="number" id="installments-paid" min="0" value="0"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="sm:col-span-2 lg:col-span-full flex items-end justify-end">
                    <button type="submit"
                            class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Adicionar Transação
                    </button>
                </div>
            </form>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <div id="import-header" class="collapsible-header">
                <h2 class="text-2xl font-semibold text-gray-700">Importar Extratos</h2>
                <svg id="import-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </div>
            <div id="import-section-content" class="hidden">
                <p class="text-sm text-gray-600 mb-4">
                    Seu arquivo deve ser OFX, CSV ou Excel e conter informações de transação com Data, Descrição, Valor e Tipo.
                    <span class="font-bold text-red-600">Atenção: Integração direta com bancos (Open Finance) não é possível em uma aplicação web no navegador por motivos de segurança e privacidade.</span>
                    <span class="font-bold text-red-600">Importação por imagem não é suportada (requer OCR e processamento de servidor).</span>
                </p>
                <div class="p-4 bg-gray-50 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Carregar Arquivo de Extrato</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="file-input" class="block text-sm font-medium text-gray-700 mb-1">Selecione o Arquivo</label>
                            <input type="file" id="file-input" accept=".ofx, .csv, .xls, .xlsx"
                                   class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer">
                        </div>
                        <div class="flex justify-end col-span-full sm:col-span-1">
                            <button id="import-file-btn"
                                    class="w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                Carregar para Revisão
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="import-review-section" class="mb-8 border-b pb-6 border-gray-200 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Revisar Transações Importadas</h2>
            <p class="text-sm text-gray-600 mb-4">
                Vincule cada transação importada a uma de suas contas ou cartões.
            </p>
            <div class="overflow-x-auto rounded-lg shadow-md mb-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-yellow-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Descrição</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Valor</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tipo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Categoria</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Vincular a</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="imported-transactions-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancel-review-btn"
                        class="px-6 py-2 bg-gray-400 text-white font-semibold rounded-md shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 transition duration-150 ease-in-out">
                    Cancelar Importação
                </button>
                <button id="confirm-import-btn"
                        class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    Confirmar Importação
                </button>
            </div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Baixar Planilha</h2>
            <button id="download-xlsx-btn"
                    class="w-full sm:w-auto px-6 py-2 bg-gray-600 text-white font-semibold rounded-md shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                Baixar Transações do Mês como Excel (.xlsx)
            </button>
        </div>

        <div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Minhas Transações</h2>
            <div class="flex items-center space-x-4 mb-4">
                <button id="prev-month-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Anterior</button>
                <span id="current-month-display" class="text-lg font-semibold text-gray-800"></span>
                <button id="next-month-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Próximo</button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conta / Cartão</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parcela</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <p id="no-transactions-message" class="text-center text-gray-500 mt-4 hidden">Nenhuma transação registrada ainda.</p>
        </div>
    </div>

    <div id="edit-transaction-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Transação</h3>
                <button class="modal-close-btn" id="close-edit-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-transaction-id">
                <label for="edit-description">Descrição:</label>
                <input type="text" id="edit-description" readonly class="bg-gray-100 cursor-not-allowed">
                <label for="edit-value">Valor:</label>
                <input type="text" id="edit-value" readonly class="bg-gray-100 cursor-not-allowed">
                <label for="edit-installments-total">Parcelas (Total):</label>
                <input type="text" id="edit-installments-total" readonly class="bg-gray-100 cursor-not-allowed">
                <label for="edit-installments-paid">Parcelas já pagas:</label>
                <input type="number" id="edit-installments-paid" min="0" required>
            </div>
            <div class="modal-footer">
                <button id="save-edit-transaction-btn"
                        class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition duration-150 ease-in-out">
                    Salvar Alterações
                </button>
                <button id="cancel-edit-transaction-btn"
                        class="px-4 py-2 bg-gray-400 text-white font-semibold rounded-md shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 transition duration-150 ease-in-out">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="link-expense-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Vincular Despesa a Conta/Cartão</h3>
                <button class="modal-close-btn" id="close-link-expense-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="link-expense-transaction-id">
                <p class="mb-2">Vincular a despesa "<span id="link-expense-description-display" class="font-semibold"></span>" no valor de <span id="link-expense-value-display" class="font-semibold"></span> para:</p>
                <div>
                    <label for="link-expense-account-select" class="block text-sm font-medium text-gray-700 mb-1">Conta / Cartão</label>
                    <select id="link-expense-account-select"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Selecione uma conta ou cartão</option>
                        </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-link-expense-btn"
                        class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition duration-150 ease-in-out">
                    Confirmar Vínculo
                </button>
                <button id="cancel-link-expense-btn"
                        class="px-4 py-2 bg-gray-400 text-white font-semibold rounded-md shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 transition duration-150 ease-in-out">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Arrays globais para armazenar dados
        let accounts = [];
        let creditCards = [];
        let transactions = [];
        let categories = [
            "Alimentação", "Transporte", "Moradia", "Lazer", "Saúde", "Educação",
            "Salário", "Investimentos", "Contas Fixas", "Compras", "Outros"
        ];
        let importedTransactionsToReview = [];
        let currentMonth = new Date().getMonth(); // 0-indexed (Jan = 0)
        let currentYear = new Date().getFullYear();
        let expensesChart = null;

        // Referências aos elementos do DOM
        const totalReceitasEl = document.getElementById('total-receitas');
        const totalDespesasEl = document.getElementById('total-despesas');
        const saldoAtualEl = document.getElementById('saldo-atual');
        const totalCardBillsEl = document.getElementById('total-card-bills');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const addAccountForm = document.getElementById('add-account-form');
        const accountsList = document.getElementById('accounts-list');
        const addCreditCardForm = document.getElementById('add-credit-card-form');
        const creditCardsList = document.getElementById('credit-cards-list');
        const accountSelect = document.getElementById('account-select');
        const accountTypeSelect = document.getElementById('account-type');
        const initialBalanceInput = document.getElementById('initial-balance');
        const initialValueLabel = document.getElementById('initial-value-label');
        const cardDueDayInput = document.getElementById('card-due-day');
        const transactionForm = document.getElementById('transaction-form');
        const transactionList = document.getElementById('transaction-list');
        const installmentsInput = document.getElementById('installments');
        const installmentsPaidInput = document.getElementById('installments-paid');
        const transactionTypeSelect = document.getElementById('type');
        const categorySelect = document.getElementById('category-select');
        const newCategoryInput = document.getElementById('new-category-input');
        const importHeader = document.getElementById('import-header');
        const importSectionContent = document.getElementById('import-section-content');
        const importArrow = document.getElementById('import-arrow');
        const importReviewSection = document.getElementById('import-review-section');
        const importedTransactionsTableBody = document.getElementById('imported-transactions-table-body');
        const confirmImportBtn = document.getElementById('confirm-import-btn');
        const cancelReviewBtn = document.getElementById('cancel-review-btn');
        const fileInput = document.getElementById('file-input');
        const importFileBtn = document.getElementById('import-file-btn');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthDisplay = document.getElementById('current-month-display');
        const downloadXlsxBtn = document.getElementById('download-xlsx-btn');
        const detailedCardBillsHeader = document.getElementById('detailed-card-bills-header');
        const detailedCardBillsContent = document.getElementById('detailed-card-bills-content');
        const detailedCardBillsArrow = document.getElementById('detailed-card-bills-arrow');
        const detailedCardBillsList = document.getElementById('detailed-card-bills-list');
        const noCardBillsMessage = document.getElementById('no-card-bills-message');
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal');
        const saveEditTransactionBtn = document.getElementById('save-edit-transaction-btn');
        const cancelEditTransactionBtn = document.getElementById('cancel-edit-transaction-btn');
        const editTransactionIdInput = document.getElementById('edit-transaction-id');
        const editDescriptionInput = document.getElementById('edit-description');
        const editValueInput = document.getElementById('edit-value');
        const editInstallmentsTotalInput = document.getElementById('edit-installments-total');
        const editInstallmentsPaidInput = document.getElementById('edit-installments-paid');

        // --- NOVO: Referências do Modal de Vinculação de Despesa ---
        const linkExpenseModal = document.getElementById('link-expense-modal');
        const closeLinkExpenseModalBtn = document.getElementById('close-link-expense-modal');
        const confirmLinkExpenseBtn = document.getElementById('confirm-link-expense-btn');
        const cancelLinkExpenseBtn = document.getElementById('cancel-link-expense-btn');
        const linkExpenseTransactionIdInput = document.getElementById('link-expense-transaction-id');
        const linkExpenseAccountSelect = document.getElementById('link-expense-account-select');
        const linkExpenseDescriptionDisplay = document.getElementById('link-expense-description-display');
        const linkExpenseValueDisplay = document.getElementById('link-expense-value-display');

        // --- Funções Utilitárias ---
        const showFeedback = (message, type) => {
            feedbackMessageEl.textContent = message;
            feedbackMessageEl.className = ''; // Limpa classes antigas
            feedbackMessageEl.classList.add(`feedback-${type}`);
            feedbackMessageEl.style.display = 'block';
            // Remove a mensagem de feedback após 5 segundos
            setTimeout(() => {
                feedbackMessageEl.style.display = 'none';
            }, 5000);
        };

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);

        // --- MODIFICADO: Renomeado e unificado para listeners de ações da linha de transação ---
        const addTransactionRowActionListeners = () => {
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    const type = e.currentTarget.dataset.type; // 'account', 'creditCard', or 'transaction'
                    performDelete(id, type);
                };
            });
            document.querySelectorAll('.pay-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    markTransactionAsPaid(id);
                };
            });
            document.querySelectorAll('.edit-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    openEditModal(id);
                };
            });
            // NOVO: Listener para o botão de vincular despesa
            document.querySelectorAll('.link-expense-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    openLinkExpenseModal(id);
                };
            });
        };

        // --- Persistência de Dados (localStorage) ---
        const loadData = () => {
            const storedAccounts = localStorage.getItem('financialAccounts');
            if (storedAccounts) accounts = JSON.parse(storedAccounts);
            const storedCreditCards = localStorage.getItem('financialCreditCards');
            if (storedCreditCards) creditCards = JSON.parse(storedCreditCards);
            const storedTransactions = localStorage.getItem('financialFinancialTransactions');
            if (storedTransactions) transactions = JSON.parse(storedTransactions);
            const storedCategories = localStorage.getItem('financialCategories');
            if (storedCategories) categories = JSON.parse(storedCategories);

            // Renderiza e atualiza a UI com os dados carregados
            renderAccounts();
            renderCreditCards();
            populateAccountSelects(); // Chama para o select principal
            populateCategorySelect();
            renderTransactions();
            updateSummary();
            renderMonthlySummary();
            renderDetailedCardBills();
            checkCreditCardDueDates();
        };

        const saveAccounts = () => localStorage.setItem('financialAccounts', JSON.stringify(accounts));
        const saveCreditCards = () => localStorage.setItem('financialCreditCards', JSON.stringify(creditCards));
        const saveTransactions = () => localStorage.setItem('financialFinancialTransactions', JSON.stringify(transactions));
        const saveCategories = () => localStorage.setItem('financialCategories', JSON.stringify(categories));

        // --- Gerenciamento de Contas e Cartões de Crédito ---
        accountTypeSelect.addEventListener('change', () => {
            if (accountTypeSelect.value === 'overdraft') {
                initialValueLabel.textContent = 'Limite (R$)';
                initialBalanceInput.placeholder = 'Limite (R$)';
            } else { // 'cash'
                initialValueLabel.textContent = 'Saldo Inicial (R$)';
                initialBalanceInput.placeholder = 'Saldo Inicial (R$)';
            }
        });

        addAccountForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('account-name').value.trim();
            const type = document.getElementById('account-type').value;
            const initialValue = parseFloat(initialBalanceInput.value) || 0;
            let newAccount;
            if (type === 'overdraft') {
                newAccount = { id: generateUniqueId(), name, type, balance: 0, limit: initialValue };
            } else { // type === 'cash'
                newAccount = { id: generateUniqueId(), name, type, balance: initialValue, limit: 0 };
            }
            if (name) {
                accounts.push(newAccount);
                saveAccounts();
                renderAccounts();
                populateAccountSelects(); // Atualiza todos os selects de conta
                updateSummary();
                addAccountForm.reset();
                // Reset label and placeholder after form submission
                initialValueLabel.textContent = 'Saldo Inicial (R$)';
                initialBalanceInput.placeholder = 'Saldo Inicial (R$)';
                document.getElementById('account-type').value = 'cash'; // Reset select
                showFeedback('Conta adicionada com sucesso!', 'success');
            } else {
                showFeedback('Por favor, insira um nome para a conta.', 'error');
            }
        });

        addCreditCardForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('card-name').value.trim();
            const limit = parseFloat(document.getElementById('card-limit').value) || 0;
            const dueDay = parseInt(cardDueDayInput.value);
            if (name && limit > 0 && dueDay >= 1 && dueDay <= 31) {
                const newCard = { id: generateUniqueId(), name, limit, availableLimit: limit, currentBillAmount: 0, dueDay };
                creditCards.push(newCard);
                saveCreditCards();
                renderCreditCards();
                populateAccountSelects(); // Atualiza todos os selects de conta
                addCreditCardForm.reset();
                showFeedback('Cartão de crédito adicionado com sucesso!', 'success');
            } else {
                showFeedback('Por favor, preencha todos os campos do cartão de crédito corretamente.', 'error');
            }
        });

        const renderAccounts = () => {
            accountsList.innerHTML = '';
            if (accounts.length === 0) {
                accountsList.innerHTML = '<li class="p-4 text-gray-500 text-center">Nenhuma conta adicionada ainda.</li>';
                return;
            }
            accounts.forEach(account => {
                const li = document.createElement('li');
                li.className = 'p-4 flex justify-between items-center bg-white hover:bg-gray-50';
                let accountDetailsHtml = '';
                if (account.type === 'overdraft') {
                    accountDetailsHtml = `
                        <span class="font-semibold text-gray-800">${account.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(Cheque Especial)</span>
                        <p class="text-gray-600 text-sm">Limite: <span class="font-bold">${formatCurrency(account.limit)}</span></p>
                        <p class="text-gray-600 text-sm">Utilizado: <span class="font-bold">${formatCurrency(Math.abs(account.balance))}</span></p>
                        <p class="text-gray-600 text-sm">Disponível: <span class="font-bold">${formatCurrency(account.limit + account.balance)}</span></p>`;
                } else { // type === 'cash'
                    accountDetailsHtml = `
                        <span class="font-semibold text-gray-800">${account.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(Dinheiro)</span>
                        <p class="text-gray-600 text-sm">Saldo: <span class="font-bold">${formatCurrency(account.balance)}</span></p>`;
                }
                li.innerHTML = `
                    <div>${accountDetailsHtml}</div>
                    <button data-id="${account.id}" data-type="account" class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition duration-150 ease-in-out" title="Excluir Conta">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>`;
                accountsList.appendChild(li);
            });
            addTransactionRowActionListeners(); // Para os botões de delete das contas
        };

        const renderCreditCards = () => {
            creditCardsList.innerHTML = '';
            if (creditCards.length === 0) {
                creditCardsList.innerHTML = '<li class="p-4 text-gray-500 text-center">Nenhum cartão de crédito adicionado ainda.</li>';
                return;
            }
            creditCards.forEach(card => {
                let currentMonthBill = transactions.reduce((sum, t) => {
                    const transactionDate = new Date(t.date);
                    if (t.accountId === card.id && t.type === 'despesa' && !t.isPaid &&
                        transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear) {
                        return sum + t.value;
                    }
                    return sum;
                }, 0);
                const li = document.createElement('li');
                li.className = 'p-4 flex justify-between items-center bg-white hover:bg-gray-50';
                li.innerHTML = `
                    <div>
                        <span class="font-semibold text-gray-800">${card.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(Crédito)</span>
                        <p class="text-gray-600 text-sm">Limite: <span class="font-bold">${formatCurrency(card.limit)}</span></p>
                        <p class="text-gray-600 text-sm">Limite Disponível: <span class="font-bold">${formatCurrency(card.availableLimit)}</span></p>
                        <p class="text-gray-600 text-sm">Fatura Atual: <span class="font-bold">${formatCurrency(currentMonthBill)}</span></p>
                        <p class="text-gray-600 text-sm">Vencimento: Dia ${card.dueDay}</p>
                    </div>
                    <button data-id="${card.id}" data-type="creditCard" class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition duration-150 ease-in-out" title="Excluir Cartão">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>`;
                creditCardsList.appendChild(li);
            });
            addTransactionRowActionListeners(); // Para os botões de delete dos cartões
        };

        // MODIFICADO: Para popular qualquer select de conta/cartão e adicionar opção de não vincular se necessário
        const populateAccountSelects = (targetSelectElement = accountSelect, addUnlinkedOptionAsDefault = true) => {
            const currentSelection = targetSelectElement.value; // Salva a seleção atual, se houver
            targetSelectElement.innerHTML = ''; // Limpa opções existentes

            if (addUnlinkedOptionAsDefault && targetSelectElement.id === 'account-select') {
                const defaultOption = document.createElement('option');
                defaultOption.value = ""; // Valor vazio para "Não vincular"
                defaultOption.textContent = 'Não vincular (registrar avulso)';
                targetSelectElement.appendChild(defaultOption);
            } else if (targetSelectElement.id === 'link-expense-account-select' || targetSelectElement.id.startsWith('imported-account-select-')) { // Modal de vincular ou importação
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = 'Selecione uma conta ou cartão';
                targetSelectElement.appendChild(defaultOption);
            }


            accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                const accountTypeText = account.type === 'overdraft' ? 'Cheque Especial' : 'Dinheiro';
                option.textContent = `${account.name} (${accountTypeText})`;
                targetSelectElement.appendChild(option);
            });
            creditCards.forEach(card => {
                const option = document.createElement('option');
                option.value = card.id;
                option.textContent = `${card.name} (Cartão de Crédito)`;
                targetSelectElement.appendChild(option);
            });
            // Restaura a seleção anterior se ainda for válida
            if (Array.from(targetSelectElement.options).some(opt => opt.value === currentSelection)) {
                 targetSelectElement.value = currentSelection;
            } else if (addUnlinkedOptionAsDefault && targetSelectElement.id === 'account-select') {
                 targetSelectElement.value = ""; // Garante que "Não vincular" seja o default se a anterior não for válida
            }
        };

        const populateCategorySelect = () => {
            const currentCategory = categorySelect.value;
            categorySelect.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
            const newOption = document.createElement('option');
            newOption.value = 'nova-categoria';
            newOption.textContent = 'Adicionar Nova Categoria...';
            categorySelect.appendChild(newOption);
            if (currentCategory && categories.includes(currentCategory)) {
                categorySelect.value = currentCategory;
            } else if (currentCategory === 'nova-categoria') {
                categorySelect.value = 'nova-categoria';
            }
        };

        categorySelect.addEventListener('change', () => {
            if (categorySelect.value === 'nova-categoria') {
                newCategoryInput.classList.remove('hidden');
                newCategoryInput.focus();
                newCategoryInput.value = '';
            } else {
                newCategoryInput.classList.add('hidden');
                newCategoryInput.value = '';
            }
        });

        // --- Gerenciamento de Transações ---
        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const date = document.getElementById('date').value;
            const description = document.getElementById('description').value.trim();
            const value = parseFloat(document.getElementById('value').value);
            const type = document.getElementById('type').value;
            const accountId = document.getElementById('account-select').value; // Pode ser string vazia
            const installments = parseInt(installmentsInput.value) || 1;
            const installmentsPaid = parseInt(installmentsPaidInput.value) || 0;

            let category;
            if (categorySelect.value === 'nova-categoria') {
                category = newCategoryInput.value.trim();
                if (category && !categories.includes(category)) {
                    categories.push(category);
                    saveCategories();
                    populateCategorySelect(); // Repopula
                    categorySelect.value = category; // Seleciona a nova
                } else if (!category) {
                    showFeedback('Por favor, insira um nome para a nova categoria.', 'error');
                    return;
                }
            } else {
                category = categorySelect.value;
            }

            if (!date || !description || isNaN(value) || !type || !category) {
                showFeedback('Por favor, preencha todos os campos obrigatórios da transação (Data, Descrição, Valor, Tipo, Categoria).', 'error');
                return;
            }
            if (value <= 0) {
                showFeedback('O valor da transação deve ser maior que zero.', 'error');
                return;
            }
            if (installmentsPaid > installments) {
                showFeedback('O número de parcelas pagas não pode ser maior que o total de parcelas.', 'error');
                return;
            }

            const isCreditCardTransaction = accountId ? !!creditCards.find(card => card.id === accountId) : false;

            let transactionsToAdd = [];
            if (installments > 1) {
                const installmentValue = parseFloat((value / installments).toFixed(2));
                let totalCalculated = 0;
                for (let i = 0; i < installments; i++) {
                    let currentInstallmentValue = installmentValue;
                    if (i === installments - 1) { // Última parcela ajusta a diferença
                        currentInstallmentValue = parseFloat((value - totalCalculated).toFixed(2));
                    }
                    totalCalculated += currentInstallmentValue;

                    const transactionDate = new Date(date);
                    transactionDate.setMonth(transactionDate.getMonth() + i);
                    transactionsToAdd.push({
                        id: generateUniqueId(),
                        date: transactionDate.toISOString().split('T')[0],
                        description: `${description} (${i + 1}/${installments})`,
                        value: currentInstallmentValue, type, category,
                        accountId: accountId || null,
                        isCreditCard: isCreditCardTransaction,
                        installments: `${i + 1}/${installments}`,
                        isPaid: (i + 1) <= installmentsPaid,
                        originalTransactionId: (i === 0) ? null : transactionsToAdd[0]?.id // Link to first installment
                    });
                }
            } else {
                transactionsToAdd.push({
                    id: generateUniqueId(), date, description, value, type, category,
                    accountId: accountId || null,
                    isCreditCard: isCreditCardTransaction,
                    installments: '1/1',
                    isPaid: installmentsPaid >= 1
                });
            }

            let transactionAddedSuccessfully = true;
            for (const newTransaction of transactionsToAdd) {
                if (newTransaction.accountId) { // Só afeta saldo se vinculada
                    const linkedAccount = accounts.find(acc => acc.id === newTransaction.accountId);
                    const linkedCard = creditCards.find(card => card.id === newTransaction.accountId);

                    if (newTransaction.isCreditCard && linkedCard) {
                        if (newTransaction.type === 'despesa') {
                             if (linkedCard.availableLimit < newTransaction.value) {
                                showFeedback(`Despesa de ${formatCurrency(newTransaction.value)} excede limite disponível do cartão ${linkedCard.name}.`, 'error');
                                transactionAddedSuccessfully = false; break;
                            }
                            linkedCard.availableLimit -= newTransaction.value;
                        } else { // receita no cartão (estorno)
                            linkedCard.availableLimit += newTransaction.value;
                        }
                    } else if (linkedAccount) {
                        if (newTransaction.type === 'despesa') {
                            if (linkedAccount.type === 'overdraft' && (linkedAccount.balance - newTransaction.value < -linkedAccount.limit)) {
                                showFeedback(`Despesa de ${formatCurrency(newTransaction.value)} excede limite do cheque especial ${linkedAccount.name}.`, 'error');
                                transactionAddedSuccessfully = false; break;
                            }
                            // Para contas 'cash', não há verificação de saldo negativo explícita aqui, mas poderia ser adicionada
                            linkedAccount.balance -= newTransaction.value;
                        } else { // receita
                            linkedAccount.balance += newTransaction.value;
                        }
                    }
                }
                // Adiciona à lista global DEPOIS de verificar saldos
                if (transactionAddedSuccessfully) {
                     transactions.push(newTransaction);
                } else {
                    // Se uma parcela falhou, não adiciona nenhuma subsequente desta transação parcelada
                    const firstInstallmentId = transactionsToAdd[0].id;
                    transactions = transactions.filter(t => t.originalTransactionId !== firstInstallmentId && t.id !== firstInstallmentId);
                    // Reverter alterações de saldo (complexo para parcelas, ideal seria transacional)
                    // Por ora, a mensagem de erro impede a adição das parcelas problemáticas.
                    break;
                }
            }


            if (transactionAddedSuccessfully) {
                saveTransactions();
                if (accountId) { // Salva contas/cartões apenas se uma foi afetada
                    if (isCreditCardTransaction) saveCreditCards();
                    else saveAccounts();
                }
                renderTransactions();
                updateSummary();
                renderDetailedCardBills();
                checkCreditCardDueDates();
                transactionForm.reset();
                document.getElementById('account-select').value = ""; // Garante que "Não vincular" seja selecionado após reset
                installmentsInput.value = 1;
                installmentsPaidInput.value = 0;
                newCategoryInput.classList.add('hidden');
                populateCategorySelect(); // Mantém a categoria selecionada ou reseta
                showFeedback('Transação(ões) adicionada(s) com sucesso!', 'success');
            }
            // Se não foi successful, o feedback de erro já foi dado e as transações problemáticas não foram adicionadas.
        });


        const renderTransactions = () => {
            transactionList.innerHTML = '';
            const filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date + "T00:00:00"); // Adiciona T00:00:00 para evitar problemas de fuso ao pegar mês/ano
                return transactionDate.getUTCMonth() === currentMonth && transactionDate.getUTCFullYear() === currentYear;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (filteredTransactions.length === 0) {
                noTransactionsMessage.classList.remove('hidden');
                transactionList.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">Nenhuma transação para este mês.</td></tr>`;
                return;
            } else {
                noTransactionsMessage.classList.add('hidden');
            }

            filteredTransactions.forEach(transaction => {
                const tr = document.createElement('tr');
                tr.className = `bg-white hover:bg-gray-50 ${transaction.isPaid ? 'paid-transaction' : ''}`;

                const accountOrCardName = transaction.accountId
                    ? (transaction.isCreditCard
                        ? creditCards.find(card => card.id === transaction.accountId)?.name || 'Cartão Inválido'
                        : accounts.find(acc => acc.id === transaction.accountId)?.name || 'Conta Inválida')
                    : '<span class="text-gray-400 italic">Não Vinculada</span>';

                let linkButtonHtml = '';
                if (!transaction.accountId && transaction.type === 'despesa') {
                    linkButtonHtml = `
                        <button data-id="${transaction.id}" class="link-expense-btn text-green-500 hover:text-green-700 p-1 rounded-full hover:bg-green-100 transition duration-150 ease-in-out" title="Vincular Despesa">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                            </svg>
                        </button>`;
                }
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(transaction.date  + "T00:00:00").toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${transaction.type === 'receita' ? 'text-green-600' : 'text-red-600'}">
                        ${formatCurrency(transaction.value)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.type === 'receita' ? 'Receita' : 'Despesa'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${accountOrCardName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.installments}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.isPaid ? 'Pago' : 'Não Pago'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center justify-end space-x-1">
                        ${linkButtonHtml}
                        ${!transaction.isPaid ? `<button data-id="${transaction.id}" class="pay-transaction-btn text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition duration-150 ease-in-out" title="Marcar como Pago">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </button>` : ''}
                        <button data-id="${transaction.id}" class="edit-transaction-btn text-yellow-500 hover:text-yellow-700 p-1 rounded-full hover:bg-yellow-100 transition duration-150 ease-in-out" title="Editar Transação">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <button data-id="${transaction.id}" data-type="transaction" class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150 ease-in-out" title="Excluir Transação">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>`;
                transactionList.appendChild(tr);
            });
            addTransactionRowActionListeners();
        };

        const performDelete = (id, type) => {
            if (type === 'account') {
                if (transactions.some(t => t.accountId === id)) {
                    showFeedback('Não é possível excluir uma conta que possui transações associadas. Exclua ou desvincule as transações primeiro.', 'error'); return;
                }
                accounts = accounts.filter(acc => acc.id !== id);
                saveAccounts(); renderAccounts(); populateAccountSelects(); updateSummary();
                showFeedback('Conta excluída com sucesso!', 'success');
            } else if (type === 'creditCard') {
                if (transactions.some(t => t.accountId === id)) {
                    showFeedback('Não é possível excluir um cartão de crédito que possui transações associadas. Exclua ou desvincule as transações primeiro.', 'error'); return;
                }
                creditCards = creditCards.filter(card => card.id !== id);
                saveCreditCards(); renderCreditCards(); populateAccountSelects(); updateSummary(); renderDetailedCardBills();
                showFeedback('Cartão de crédito excluído com sucesso!', 'success');
            } else if (type === 'transaction') {
                const deletedTransactionIndex = transactions.findIndex(t => t.id === id);
                if (deletedTransactionIndex > -1) {
                    const deletedTransaction = transactions[deletedTransactionIndex];
                    // Reverte o impacto da transação no saldo da conta/cartão SOMENTE se estava vinculada
                    if (deletedTransaction.accountId) {
                        const account = accounts.find(acc => acc.id === deletedTransaction.accountId);
                        const card = creditCards.find(c => c.id === deletedTransaction.accountId);
                        if (deletedTransaction.isCreditCard && card) {
                            if (deletedTransaction.type === 'despesa') card.availableLimit += deletedTransaction.value;
                            else card.availableLimit -= deletedTransaction.value; // Estorno de receita
                            saveCreditCards();
                        } else if (account) {
                            if (deletedTransaction.type === 'despesa') account.balance += deletedTransaction.value;
                            else account.balance -= deletedTransaction.value;
                            saveAccounts();
                        }
                    }
                    transactions.splice(deletedTransactionIndex, 1); // Remove a transação
                    saveTransactions();
                    renderTransactions(); updateSummary(); renderMonthlySummary(); renderDetailedCardBills(); checkCreditCardDueDates();
                    showFeedback('Transação excluída com sucesso!', 'success');
                }
            }
        };

        const markTransactionAsPaid = (transactionId) => {
            const transaction = transactions.find(t => t.id === transactionId);
            if (transaction && !transaction.isPaid) {
                transaction.isPaid = true;
                // Se a transação não estava vinculada, marcar como paga não afeta saldos de contas.
                // Se estava vinculada, o saldo já foi afetado na criação ou vinculação.
                // Esta função apenas muda o status visual e lógico 'isPaid'.
                saveTransactions();
                renderTransactions(); updateSummary(); renderMonthlySummary(); renderDetailedCardBills(); checkCreditCardDueDates();
                showFeedback('Transação marcada como paga!', 'success');
            } else if (transaction && transaction.isPaid) {
                showFeedback('Esta transação já está marcada como paga.', 'info');
            }
        };

        // --- Funções do Modal de Edição ---
        const openEditModal = (transactionId) => {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) { showFeedback('Transação não encontrada para edição.', 'error'); return; }
            editTransactionIdInput.value = transaction.id;
            editDescriptionInput.value = transaction.description;
            editValueInput.value = formatCurrency(transaction.value); // Apenas para exibição
            const [currentPaid, totalInstallments] = transaction.installments.split('/').map(Number);
            editInstallmentsTotalInput.value = totalInstallments;
            editInstallmentsPaidInput.value = currentPaid; // Preenche com o número atual de parcelas pagas
            editTransactionModal.classList.remove('hidden');
        };
        const closeEditModal = () => {
            editTransactionModal.classList.add('hidden');
            // Limpar campos seria bom aqui
        };
        closeEditModalBtn.addEventListener('click', closeEditModal);
        cancelEditTransactionBtn.addEventListener('click', closeEditModal);

        saveEditTransactionBtn.addEventListener('click', () => {
            const transactionId = editTransactionIdInput.value;
            const newInstallmentsPaid = parseInt(editInstallmentsPaidInput.value);
            const transaction = transactions.find(t => t.id === transactionId);

            if (transaction) {
                const totalInstallments = parseInt(transaction.installments.split('/')[1]); // Pega o total do objeto transação
                if (isNaN(newInstallmentsPaid) || newInstallmentsPaid < 0 || newInstallmentsPaid > totalInstallments) {
                    showFeedback('Por favor, insira um número válido para parcelas já pagas, não maior que o total.', 'error');
                    return;
                }
                transaction.installments = `${newInstallmentsPaid}/${totalInstallments}`;
                transaction.isPaid = newInstallmentsPaid >= totalInstallments;
                saveTransactions();
                renderTransactions(); updateSummary(); renderMonthlySummary(); renderDetailedCardBills(); checkCreditCardDueDates();
                showFeedback('Transação atualizada com sucesso!', 'success');
                closeEditModal();
            } else {
                showFeedback('Erro: Transação não encontrada.', 'error');
            }
        });

        // --- NOVO: Funções e listeners para o modal de vinculação de despesa ---
        const openLinkExpenseModal = (transactionId) => {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                showFeedback('Transação não encontrada para vincular.', 'error');
                return;
            }
            linkExpenseTransactionIdInput.value = transaction.id; // Armazena o ID da transação
            linkExpenseDescriptionDisplay.textContent = transaction.description;
            linkExpenseValueDisplay.textContent = formatCurrency(transaction.value);
            populateAccountSelects(linkExpenseAccountSelect, false); // Popula o select do modal
            linkExpenseAccountSelect.value = ""; // Garante que nada esteja pré-selecionado
            linkExpenseModal.classList.remove('hidden');
        };

        const closeLinkExpenseModal = () => {
            linkExpenseModal.classList.add('hidden');
        };

        closeLinkExpenseModalBtn.addEventListener('click', closeLinkExpenseModal);
        cancelLinkExpenseBtn.addEventListener('click', closeLinkExpenseModal);

        confirmLinkExpenseBtn.addEventListener('click', () => {
            const transactionId = linkExpenseTransactionIdInput.value;
            const newAccountId = linkExpenseAccountSelect.value;

            if (!newAccountId) {
                showFeedback('Por favor, selecione uma conta ou cartão para vincular.', 'error');
                return;
            }

            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                showFeedback('Erro: Transação não encontrada.', 'error');
                closeLinkExpenseModal();
                return;
            }
            if (transaction.accountId) { // Já estava vinculada, não deveria chegar aqui por este fluxo
                showFeedback('Esta transação já está vinculada.', 'info');
                closeLinkExpenseModal();
                return;
            }

            const targetAccount = accounts.find(acc => acc.id === newAccountId);
            const targetCard = creditCards.find(card => card.id === newAccountId);

            // Atualiza a transação
            transaction.accountId = newAccountId;
            transaction.isCreditCard = !!targetCard;

            // Aplica o impacto financeiro na conta/cartão selecionado
            // A transação é do tipo 'despesa' por definição do botão de vincular
            if (targetCard) {
                 if (targetCard.availableLimit < transaction.value) {
                    showFeedback(`Vincular esta despesa de ${formatCurrency(transaction.value)} excede o limite disponível do cartão ${targetCard.name}.`, 'error');
                    transaction.accountId = null; // Reverte
                    transaction.isCreditCard = false; // Reverte
                    return;
                }
                targetCard.availableLimit -= transaction.value;
                saveCreditCards();
            } else if (targetAccount) {
                if (targetAccount.type === 'overdraft') {
                    if (targetAccount.balance - transaction.value < -targetAccount.limit) {
                        showFeedback(`Vincular esta despesa de ${formatCurrency(transaction.value)} excede o limite do cheque especial ${targetAccount.name}.`, 'error');
                        transaction.accountId = null; // Reverte
                        transaction.isCreditCard = false; // Reverte
                        return;
                    }
                }
                // Para contas 'cash', não há verificação de saldo negativo, mas o saldo será atualizado
                targetAccount.balance -= transaction.value;
                saveAccounts();
            }

            saveTransactions(); // Salva a transação atualizada
            // Atualiza toda a UI
            renderTransactions();
            updateSummary();
            renderMonthlySummary();
            renderDetailedCardBills();
            checkCreditCardDueDates();
            showFeedback('Despesa vinculada com sucesso!', 'success');
            closeLinkExpenseModal();
        });

        // --- Resumo e Cálculos ---
        const updateSummary = () => {
            let totalPoderDeCompra = 0;
            accounts.forEach(account => {
                if (account.type === 'cash') totalPoderDeCompra += account.balance;
                else if (account.type === 'overdraft') totalPoderDeCompra += (account.limit + account.balance); // Disponível no cheque especial
            });
            creditCards.forEach(card => {
                totalPoderDeCompra += card.availableLimit; // Limite disponível dos cartões
            });
            totalReceitasEl.textContent = formatCurrency(totalPoderDeCompra);

            const totalDespesasMesAtual = parseFloat(totalDespesasEl.textContent.replace(/[R$. ]/g, '').replace(',', '.')) || 0;
            const saldoConsolidado = totalPoderDeCompra - totalDespesasMesAtual; // Poder de compra - despesas do mês
            saldoAtualEl.textContent = formatCurrency(saldoConsolidado);
            saldoAtualEl.className = `text-2xl font-bold ${saldoConsolidado >= 0 ? 'text-green-700' : 'text-red-700'}`;
            
            let totalFaturasCartaoMesAtual = 0;
            creditCards.forEach(card => {
                const currentMonthBill = transactions.reduce((sum, t) => {
                    const transactionDate = new Date(t.date + "T00:00:00");
                    if (t.accountId === card.id && t.type === 'despesa' &&
                        transactionDate.getUTCMonth() === currentMonth && transactionDate.getUTCFullYear() === currentYear) {
                        // Considera 'isPaid' para fatura? Normalmente fatura mostra tudo e o pagamento abate.
                        // Para simplificar, vamos somar todas as despesas do cartão no mês.
                        return sum + t.value;
                    }
                    return sum;
                }, 0);
                totalFaturasCartaoMesAtual += currentMonthBill;
            });
            totalCardBillsEl.textContent = formatCurrency(totalFaturasCartaoMesAtual);
        };

        // --- Navegação e Resumo por Mês ---
        const updateMonthlyDisplay = () => {
            const date = new Date(currentYear, currentMonth);
            currentMonthDisplay.textContent = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric', timeZone: 'UTC' });
        };

        const renderMonthlySummary = () => {
            let monthlyExpenses = 0;
            transactions.forEach(t => {
                const transactionDate = new Date(t.date + "T00:00:00"); // Adiciona T00:00:00 para evitar problemas de fuso
                if (transactionDate.getUTCMonth() === currentMonth && transactionDate.getUTCFullYear() === currentYear) {
                    if (t.type === 'despesa') {
                        monthlyExpenses += t.value;
                    }
                }
            });
            totalDespesasEl.textContent = formatCurrency(monthlyExpenses);
             updateSummary(); // Atualiza o saldo consolidado após recalcular despesas do mês
        };

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            updateMonthlyDisplay(); renderTransactions(); renderMonthlySummary(); /* updateSummary já é chamado por renderMonthlySummary */
        });
        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            updateMonthlyDisplay(); renderTransactions(); renderMonthlySummary(); /* updateSummary já é chamado por renderMonthlySummary */
        });

        // --- Funções de Importação ---
        importHeader.addEventListener('click', () => {
            importSectionContent.classList.toggle('hidden');
            importArrow.classList.toggle('rotated');
        });

        importFileBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) { showFeedback('Por favor, selecione um arquivo para importar.', 'error'); return; }
            importedTransactionsToReview = [];
            importedTransactionsTableBody.innerHTML = '';
            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();

            reader.onload = async (e) => {
                const data = e.target.result;
                try {
                    if (fileExtension === 'ofx') importedTransactionsToReview = parseOFX(data);
                    else if (['csv', 'xls', 'xlsx'].includes(fileExtension)) importedTransactionsToReview = parseExcelCsv(data, fileExtension);
                    else { showFeedback('Formato de arquivo não suportado.', 'error'); return; }

                    if (importedTransactionsToReview.length > 0) {
                        renderImportedTransactionsForReview();
                        importReviewSection.classList.remove('hidden');
                        showFeedback('Arquivo carregado! Revise as transações.', 'success');
                    } else {
                        showFeedback('Nenhuma transação válida encontrada no arquivo.', 'info');
                        importReviewSection.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Erro ao processar o arquivo:', error);
                    showFeedback('Erro ao processar o arquivo. Verifique o formato.', 'error');
                    importReviewSection.classList.add('hidden');
                }
            };
            if (fileExtension === 'ofx' || fileExtension === 'csv') reader.readAsText(file); // CSV também como texto
            else reader.readAsBinaryString(file); // Excel
        });
        
        const parseOFX = (ofxContent) => {
            const parsedTransactions = [];
            const transactionRegex = /<STMTTRN>([\s\S]*?)<\/STMTTRN>/g;
            let match;
            while ((match = transactionRegex.exec(ofxContent)) !== null) {
                const transactionBlock = match[1];
                const dateMatch = /<DTPOSTED>(\d{4})(\d{2})(\d{2})/.exec(transactionBlock); // Captura YYYYMMDD
                const descriptionMatch = /<MEMO>([\s\S]*?)<\/(MEMO|NAME)>/.exec(transactionBlock);
                const valueMatch = /<TRNAMT>([-\d.]+)/.exec(transactionBlock); // Permitir negativo
                // OFX não tem tipo explícito de "receita" ou "despesa" universalmente, é pelo valor
                // TRNTYPE pode ser usado, mas o sinal do valor é mais confiável.

                if (dateMatch && descriptionMatch && valueMatch) {
                    const year = dateMatch[1];
                    const month = dateMatch[2];
                    const day = dateMatch[3];
                    const formattedDate = `${year}-${month}-${day}`;
                    const description = descriptionMatch[1].trim().replace(/&amp;/g, '&');
                    const value = parseFloat(valueMatch[1]);
                    const type = value >= 0 ? 'receita' : 'despesa';

                    parsedTransactions.push({
                        id: generateUniqueId(), date: formattedDate, description,
                        value: Math.abs(value), type, category: 'Importado',
                        accountId: null, isCreditCard: false, installments: '1/1', isPaid: true // OFX geralmente são transações já efetivadas
                    });
                }
            }
            return parsedTransactions;
        };

        const parseExcelCsv = (data, fileExtension) => {
            const parsedTransactions = [];
            try {
                const workbook = fileExtension === 'csv' ? XLSX.read(data, {type: 'string'}) : XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, dateNF: 'yyyy-mm-dd'}); // raw: false para datas formatadas

                if (json.length === 0) return parsedTransactions;

                let headerRowIndex = -1;
                let dateCol = -1, descCol = -1, valueCol = -1, typeCol = -1, catCol = -1;

                for (let i = 0; i < Math.min(json.length, 10); i++) { // Procura cabeçalho nas primeiras 10 linhas
                    const row = json[i];
                    if (Array.isArray(row)) {
                        const lowerCaseRow = row.map(cell => String(cell || '').toLowerCase().trim());
                        if (dateCol === -1) dateCol = lowerCaseRow.findIndex(h => h.includes('data') || h.includes('date'));
                        if (descCol === -1) descCol = lowerCaseRow.findIndex(h => h.includes('descri') || h.includes('memo')); // descri(ção)
                        if (valueCol === -1) valueCol = lowerCaseRow.findIndex(h => h.includes('valor') || h.includes('value') || h.includes('montante') || h.includes('amount'));
                        if (typeCol === -1) typeCol = lowerCaseRow.findIndex(h => h.includes('tipo') || h.includes('type'));
                        if (catCol === -1) catCol = lowerCaseRow.findIndex(h => h.includes('categoria') || h.includes('category'));

                        if (dateCol !== -1 && descCol !== -1 && valueCol !== -1) { // Tipo é opcional, deduzido do valor se ausente
                            headerRowIndex = i;
                            break;
                        }
                    }
                }

                if (headerRowIndex === -1) {
                    showFeedback('Não foi possível identificar as colunas "Data", "Descrição" e "Valor" no seu arquivo. Usando colunas padrão 0, 1, 2.', 'info');
                    dateCol = 0; descCol = 1; valueCol = 2; typeCol = 3; catCol = 4; // Assume colunas padrão se não encontrar cabeçalho
                    headerRowIndex = -1; // Processa desde a primeira linha se não houver cabeçalho
                }
                
                for (let i = headerRowIndex + 1; i < json.length; i++) {
                    const row = json[i];
                    if (!Array.isArray(row) || row.every(cell => cell === null || cell === '')) continue;

                    const dateRaw = row[dateCol];
                    const description = String(row[descCol] || 'Importado').trim();
                    const valueRaw = String(row[valueCol] || '0').replace(/[R$.]/g, '').replace(',', '.');
                    let value = parseFloat(valueRaw);
                    
                    let typeRaw = typeCol !== -1 ? String(row[typeCol] || '').toLowerCase() : '';
                    let type = value >= 0 ? 'receita' : 'despesa'; // Deduz pelo sinal se tipo não especificado/reconhecido
                    if (typeRaw.includes('despesa') || typeRaw.includes('débito') || typeRaw.includes('debit')) type = 'despesa';
                    else if (typeRaw.includes('receita') || typeRaw.includes('crédito') || typeRaw.includes('credit')) type = 'receita';
                    
                    value = Math.abs(value); // Usa sempre valor absoluto, tipo define o fluxo

                    let category = (catCol !== -1 && row[catCol]) ? String(row[catCol]).trim() : 'Importado';

                    let formattedDate;
                    if (dateRaw) {
                        // Tentar converter data do Excel (número) ou string
                        if (typeof dateRaw === 'number') { // Data Excel
                             const excelEpoch = new Date(1899, 11, 30); // Excel epoch starts Dec 30, 1899 for compatibility
                             const jsDate = new Date(excelEpoch.getTime() + dateRaw * 24 * 60 * 60 * 1000);
                             formattedDate = !isNaN(jsDate) ? jsDate.toISOString().split('T')[0] : null;
                        } else { // String de data
                            const parsedDate = new Date(dateRaw);
                            // Se a data for string e já estiver no formato YYYY-MM-DD ou similar que o new Date() entenda bem
                            if (!isNaN(parsedDate)) {
                                formattedDate = parsedDate.toISOString().split('T')[0];
                            } else { // Tentar formatos DD/MM/YYYY ou MM/DD/YYYY
                                const parts = String(dateRaw).split(/[\/\-.]/);
                                if (parts.length === 3) {
                                    let d, m, y;
                                    // Tenta DD/MM/YYYY
                                    [d,m,y] = parts.map(p => parseInt(p));
                                    if (String(y).length === 2) y += 2000;
                                    let testDate = new Date(y, m - 1, d);
                                    if (!isNaN(testDate) && testDate.getDate() === d && testDate.getMonth() === m -1 && testDate.getFullYear() === y) {
                                         formattedDate = testDate.toISOString().split('T')[0];
                                    } else { // Tenta MM/DD/YYYY
                                        [m,d,y] = parts.map(p => parseInt(p));
                                        if (String(y).length === 2) y += 2000;
                                        testDate = new Date(y, m - 1, d);
                                        if (!isNaN(testDate) && testDate.getDate() === d && testDate.getMonth() === m -1 && testDate.getFullYear() === y) {
                                            formattedDate = testDate.toISOString().split('T')[0];
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (!formattedDate) { console.warn("Data inválida ou não reconhecida:", dateRaw); continue; } // Pula se a data for inválida

                    if (!isNaN(value) && value > 0 && description) {
                        parsedTransactions.push({
                            id: generateUniqueId(), date: formattedDate, description,
                            value, type, category, accountId: null, isCreditCard: false,
                            installments: '1/1', isPaid: true // Assumir pago para importados
                        });
                    }
                }
            } catch (e) {
                console.error('Erro no parseExcelCsv:', e);
                showFeedback('Erro ao ler o arquivo Excel/CSV. Verifique se o formato está correto e se as colunas esperadas existem.', 'error');
            }
            return parsedTransactions;
        };

        const renderImportedTransactionsForReview = () => {
            importedTransactionsTableBody.innerHTML = '';
            importedTransactionsToReview.forEach((transaction, index) => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white hover:bg-gray-50';
                
                // Cria o select de contas/cartões para esta linha
                const accountSelectReviewId = `imported-account-select-${index}`;
                let accountOptionsHtml = `<option value="">Não Vincular</option>`;
                accounts.forEach(acc => {
                    const typeText = acc.type === 'overdraft' ? 'Cheque Especial' : 'Dinheiro';
                    accountOptionsHtml += `<option value="${acc.id}">${acc.name} (${typeText})</option>`;
                });
                creditCards.forEach(card => {
                    accountOptionsHtml += `<option value="${card.id}">${card.name} (Cartão de Crédito)</option>`;
                });

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(transaction.date + "T00:00:00").toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${transaction.type === 'receita' ? 'text-green-600' : 'text-red-600'}">
                        ${formatCurrency(transaction.value)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.type === 'receita' ? 'Receita' : 'Despesa'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <input type="text" class="category-input w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm" value="${transaction.category}" data-index="${index}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <select id="${accountSelectReviewId}" class="account-select-review w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm" data-index="${index}">
                            ${accountOptionsHtml}
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.isPaid ? 'Pago' : 'Não Pago'}</td>`;
                importedTransactionsTableBody.appendChild(tr);
            });

            document.querySelectorAll('.category-input').forEach(input => {
                input.onchange = (e) => { // Usar onchange para quando o valor for confirmado
                    const index = parseInt(e.target.dataset.index);
                    importedTransactionsToReview[index].category = e.target.value.trim();
                };
            });
            document.querySelectorAll('.account-select-review').forEach(select => {
                select.onchange = (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const selectedAccountId = e.target.value;
                    if (selectedAccountId) {
                        importedTransactionsToReview[index].accountId = selectedAccountId;
                        importedTransactionsToReview[index].isCreditCard = creditCards.some(card => card.id === selectedAccountId);
                    } else {
                        importedTransactionsToReview[index].accountId = null;
                        importedTransactionsToReview[index].isCreditCard = false;
                    }
                };
            });
        };
        
        confirmImportBtn.addEventListener('click', () => {
            let importedCount = 0;
            let skippedDueToError = 0;
            let financialErrors = [];

            const tempAccounts = JSON.parse(JSON.stringify(accounts));
            const tempCreditCards = JSON.parse(JSON.stringify(creditCards));
            const successfullyProcessedTransactions = [];

            for (const reviewedTx of importedTransactionsToReview) {
                let canAddTransaction = true;
                if (reviewedTx.accountId) { // Se vinculada, verificar saldos/limites
                    const targetAccount = tempAccounts.find(acc => acc.id === reviewedTx.accountId);
                    const targetCard = tempCreditCards.find(card => card.id === reviewedTx.accountId);

                    if (reviewedTx.isCreditCard && targetCard) {
                        if (reviewedTx.type === 'despesa' && targetCard.availableLimit < reviewedTx.value) {
                            financialErrors.push(`Transação "${reviewedTx.description}" excede limite do cartão ${targetCard.name}.`);
                            canAddTransaction = false;
                        } else if (reviewedTx.type === 'despesa') {
                            targetCard.availableLimit -= reviewedTx.value;
                        } else { // receita no cartão
                            targetCard.availableLimit += reviewedTx.value;
                        }
                    } else if (targetAccount) {
                        if (reviewedTx.type === 'despesa') {
                            if (targetAccount.type === 'overdraft' && (targetAccount.balance - reviewedTx.value < -targetAccount.limit)) {
                                financialErrors.push(`Transação "${reviewedTx.description}" excede limite do cheque especial ${targetAccount.name}.`);
                                canAddTransaction = false;
                            } else {
                                targetAccount.balance -= reviewedTx.value;
                            }
                        } else { // receita
                            targetAccount.balance += reviewedTx.value;
                        }
                    }
                }
                // Se passou nas verificações ou não está vinculada
                if (canAddTransaction) {
                    // Adiciona a categoria se for nova
                    if (reviewedTx.category && !categories.includes(reviewedTx.category)) {
                        categories.push(reviewedTx.category);
                        // saveCategories() será chamada depois se tudo der certo
                    }
                    successfullyProcessedTransactions.push(reviewedTx);
                    importedCount++;
                } else {
                    skippedDueToError++;
                }
            }

            if (financialErrors.length > 0) {
                showFeedback(`Erro(s) na importação: ${financialErrors.join(' ')}. Nenhuma transação foi importada devido a erros.`, 'error');
                return; // Não importa nada se houve erro financeiro
            }
            
            // Se chegou aqui, todas as transações vinculadas passaram nas verificações
            transactions.push(...successfullyProcessedTransactions);
            accounts = tempAccounts;
            creditCards = tempCreditCards;

            saveTransactions();
            saveAccounts();
            saveCreditCards();
            saveCategories(); // Salva categorias, pois podem ter sido adicionadas

            renderTransactions();
            updateSummary();
            renderMonthlySummary();
            renderDetailedCardBills();
            populateCategorySelect(); // Atualiza select de categorias
            checkCreditCardDueDates();
            
            importedTransactionsToReview = [];
            importedTransactionsTableBody.innerHTML = '';
            importReviewSection.classList.add('hidden');
            fileInput.value = '';
            showFeedback(`Importação concluída. ${importedCount} transação(ões) adicionada(s). ${skippedDueToError > 0 ? `${skippedDueToError} ignorada(s) devido a erros de limite.` : ''}`, 'success');
        });

        cancelReviewBtn.addEventListener('click', () => {
            importedTransactionsToReview = [];
            importedTransactionsTableBody.innerHTML = '';
            importReviewSection.classList.add('hidden');
            fileInput.value = '';
            showFeedback('Importação cancelada.', 'info');
        });

        // --- Download ---
        downloadXlsxBtn.addEventListener('click', () => {
            const dataToExport = transactions.filter(t => {
                const transactionDate = new Date(t.date + "T00:00:00");
                return transactionDate.getUTCMonth() === currentMonth && transactionDate.getUTCFullYear() === currentYear;
            }).map(t => ({
                Data: new Date(t.date + "T00:00:00").toLocaleDateString('pt-BR', {timeZone: 'UTC'}),
                Descrição: t.description, Valor: t.value,
                Tipo: t.type === 'receita' ? 'Receita' : 'Despesa',
                Categoria: t.category,
                'Conta / Cartão': t.accountId ? (t.isCreditCard ? creditCards.find(c=>c.id===t.accountId)?.name : accounts.find(a=>a.id===t.accountId)?.name) || 'N/A' : 'Não Vinculada',
                Parcela: t.installments, Pago: t.isPaid ? 'Sim' : 'Não'
            }));
            if (dataToExport.length === 0) { showFeedback('Não há transações para baixar neste mês.', 'info'); return; }
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Transacoes");
            const monthName = new Date(currentYear, currentMonth).toLocaleDateString('pt-BR', { month: 'long', timeZone: 'UTC' });
            XLSX.writeFile(workbook, `transacoes_${monthName}_${currentYear}.xlsx`);
            showFeedback('Planilha baixada com sucesso!', 'success');
        });

        // --- Faturas Detalhadas ---
        detailedCardBillsHeader.addEventListener('click', () => {
            detailedCardBillsContent.classList.toggle('hidden');
            detailedCardBillsArrow.classList.toggle('rotated');
        });

        const renderDetailedCardBills = () => {
            detailedCardBillsList.innerHTML = '';
            if (creditCards.length === 0) {
                noCardBillsMessage.classList.remove('hidden');
                return;
            } else {
                noCardBillsMessage.classList.add('hidden');
            }
            creditCards.forEach(card => {
                const currentMonthBill = transactions.reduce((sum, t) => {
                    const transactionDate = new Date(t.date + "T00:00:00");
                    if (t.accountId === card.id && t.type === 'despesa' &&
                        transactionDate.getUTCMonth() === currentMonth && transactionDate.getUTCFullYear() === currentYear) {
                        return sum + t.value;
                    }
                    return sum;
                }, 0);
                const li = document.createElement('li');
                li.className = 'p-4 flex justify-between items-center bg-white hover:bg-gray-50';
                li.innerHTML = `
                    <div class="font-semibold text-gray-800">${card.name}: <span class="text-purple-700">${formatCurrency(currentMonthBill)}</span></div>
                    <div class="text-sm text-gray-600">Vencimento: Dia ${card.dueDay}</div>`;
                detailedCardBillsList.appendChild(li);
            });
        };
        
        // --- Verificação de Datas de Vencimento ---
        const checkCreditCardDueDates = () => {
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0); 

            creditCards.forEach(card => {
                const dueDay = card.dueDay;
                let billDueDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), dueDay));

                if (today.getUTCDate() > dueDay) { // Se já passou o dia de vencimento neste mês
                    billDueDate.setUTCMonth(today.getUTCMonth() + 1);
                }

                // Calcula a data de fechamento (ex: 10 dias antes)
                let billClosingDate = new Date(billDueDate.getTime());
                billClosingDate.setUTCDate(billDueDate.getUTCDate() - 10); // Ajustar conforme regra do cartão

                const cardBillForCurrentCycle = transactions.reduce((sum, t) => {
                     const transactionDate = new Date(t.date + "T00:00:00");
                     // Lógica para determinar quais transações entram na fatura que vence em billDueDate
                     // Isso é complexo e depende da data de fechamento. Simplificando:
                     if(t.accountId === card.id && t.type === 'despesa' && transactionDate <= billClosingDate && transactionDate > new Date(billClosingDate.getTime() - 30*24*60*60*1000) ) {
                        return sum + t.value;
                     }
                     return sum;
                },0);


                if (today.getTime() === billClosingDate.getTime()) {
                    showFeedback(`A fatura do cartão ${card.name} fechou hoje! Valor: ${formatCurrency(cardBillForCurrentCycle)}. Vencimento: ${billDueDate.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}`, 'info');
                }

                const diffTimeDue = billDueDate.getTime() - today.getTime();
                const diffDaysDue = Math.ceil(diffTimeDue / (1000 * 60 * 60 * 24));

                if (diffDaysDue <= 7 && diffDaysDue >= 0 && cardBillForCurrentCycle > 0) {
                    if (diffDaysDue === 0) {
                        showFeedback(`A fatura do cartão ${card.name} vence HOJE! Valor: ${formatCurrency(cardBillForCurrentCycle)}`, 'error');
                    } else {
                        showFeedback(`Atenção: Fatura do cartão ${card.name} (${formatCurrency(cardBillForCurrentCycle)}) vence em ${diffDaysDue} dia(s).`, 'info');
                    }
                }
            });
        };

        // Carregamento inicial
        window.onload = () => {
            loadData();
            updateMonthlyDisplay();
            // Garante que "Não vincular" seja default no formulário principal
            if (document.getElementById('account-select')) {
                document.getElementById('account-select').value = "";
            }
            // Define o tipo de conta padrão para Dinheiro e o tipo de transação para Despesa
            if(document.getElementById('account-type')) document.getElementById('account-type').value = 'cash';
            if(document.getElementById('type')) document.getElementById('type').value = 'despesa';

            // Dispara a atualização inicial do label do saldo/limite da conta
            const event = new Event('change');
            accountTypeSelect.dispatchEvent(event);
        };
    </script>
</body>
</html>
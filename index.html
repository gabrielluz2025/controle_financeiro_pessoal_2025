<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js' defer></script>
    <style>
        /* Define a fonte Inter para toda a página */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Cor de fundo suave */
        }

        /* Estilos para a mensagem de feedback */
        #feedback-message {
            display: none;
            padding: 12px;
            margin-top: 16px;
            border-radius: 8px;
            font-weight: 500;
            position: fixed; /* Para sobrepor outros elementos */
            bottom: 20px; /* Distância do fundo */
            left: 50%; /* Centraliza horizontalmente */
            transform: translateX(-50%); /* Ajuste fino para centralização */
            z-index: 2000; /* Garante que fique acima de outros modais/elementos */
            min-width: 300px; /* Largura mínima */
            text-align: center; /* Centraliza o texto */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* Sombra suave */
        }

        .feedback-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .feedback-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .feedback-info {
            background-color: #e0f2fe;
            color: #075985;
        }

        /* Estilos para ocultar/mostrar elementos */
        .hidden {
            display: none !important;
        }

        /* Estilos para a seção colapsável */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .collapsible-header:hover {
            background-color: #f8fafc;
        }

        .collapsible-header h2 {
            margin-bottom: 0;
        }

        .arrow-icon {
            transition: transform 0.3s ease;
        }

        .arrow-icon.rotated {
            transform: rotate(90deg);
        }

        /* Estilo para transações pagas */
        .paid-transaction td { /* Aplicar a toda a linha */
            text-decoration: line-through;
            color: #9ca3af; /* gray-400, um pouco mais claro para melhor leitura */
        }
         /* Estilo para transações pendentes de meses anteriores */
        .pending-previous-month td {
            font-style: italic;
        }
        .pending-previous-month:not(.paid-transaction) td {
             font-weight: 600; /* Negrito para pendentes */
        }


        /* Estilos para o modal */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-y: auto; 
        }

        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px; 
            margin-top: 2rem; 
            margin-bottom: 2rem; 
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-body label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        .modal-body p { 
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .modal-body strong { 
            font-weight: 600;
            color: #1e40af; 
        }
        .modal-body ul { 
            list-style-position: inside;
            padding-left: 0.5rem;
        }
        .modal-body ul li {
            margin-bottom: 0.5rem;
        }


        .modal-body input[type="text"],
        .modal-body input[type="number"],
        .modal-body input[type="date"],
        .modal-body select {  
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            background-color: #fff; 
        }


        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        #imported-transactions-table-body input, 
        #imported-transactions-table-body select,
        #imported-transactions-table-body textarea {
            font-size: 0.875rem; 
            padding: 0.25rem 0.5rem; 
        }
        #imported-transactions-table-body textarea {
            min-height: 40px; 
        }
        .ai-btn-spinner { 
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
            margin-left: 0.5em;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Estilos para a lista de metas */
        #financial-goals-list li {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f9fafb; /* Fundo levemente diferente */
        }
        #financial-goals-list .goal-details p {
            margin-bottom: 0.25rem;
        }
        #financial-goals-list .goal-actions button {
            margin-right: 0.5rem;
        }
        #financial-goals-list .ai-plan-content {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background-color: #fff;
            border: 1px dashed #cbd5e1;
            border-radius: 0.375rem;
            font-size: 0.9rem;
        }
         #financial-goals-list .ai-plan-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e3a8a; 
            margin-bottom: 0.5rem;
        }
        #financial-goals-list .ai-plan-content ul {
            list-style-position: inside;
            padding-left: 0.5rem;
        }
         #financial-goals-list .ai-plan-content li {
            border: none;
            padding: 0;
            margin-bottom: 0.25rem;
            background-color: transparent;
        }

    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-10">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-8">Controle Financeiro Pessoal Completo</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-blue-800">Poder de Compra Total</h2>
                <p id="total-receitas" class="text-2xl font-bold text-blue-700">R$ 0,00</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-red-800">Despesas do Mês</h2>
                <p id="total-despesas" class="text-2xl font-bold text-red-700">R$ 0,00</p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-green-800">Saldo Consolidado</h2>
                <p id="saldo-atual" class="text-2xl font-bold text-green-700">R$ 0,00</p>
            </div>
        </div>
        <div class="bg-purple-100 p-4 rounded-lg shadow-md mb-8">
            <h2 class="text-lg font-semibold text-purple-800">Total de Faturas de Cartão (Mês Atual)</h2>
            <p id="total-card-bills" class="text-2xl font-bold text-purple-700">R$ 0,00</p>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <div id="detailed-card-bills-header" class="collapsible-header">
                <h2 class="text-2xl font-semibold text-gray-700">Faturas Detalhadas de Cartão</h2>
                <svg id="detailed-card-bills-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </div>
            <div id="detailed-card-bills-content" class="hidden">
                <ul id="detailed-card-bills-list" class="bg-white rounded-md shadow-sm divide-y divide-gray-200">
                </ul>
                <p id="no-card-bills-message" class="text-center text-gray-500 mt-4 hidden">Nenhuma fatura de cartão para exibir.</p>
            </div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gerenciar Contas</h2>
            <div class="p-4 bg-gray-50 rounded-lg shadow-sm mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Conta</h3>
                <form id="add-account-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
                    <div>
                        <label for="account-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Conta</label>
                        <input type="text" id="account-name" placeholder="Nome da Conta (ex: Banco X, Dinheiro)" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="account-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                        <select id="account-type"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="overdraft">Cheque Especial</option>
                            <option value="cash">Dinheiro</option>
                        </select>
                    </div>
                    <div>
                        <label for="initial-balance" class="block text-sm font-medium text-gray-700 mb-1" id="initial-value-label">Saldo Inicial (R$)</label>
                        <input type="number" id="initial-balance" step="0.01" placeholder="Saldo Inicial (R$)" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="sm:col-span-3 flex justify-end">
                        <button type="submit"
                                class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition duration-150 ease-in-out">
                            Adicionar
                        </button>
                    </div>
                </form>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Minhas Contas</h3>
                <ul id="accounts-list" class="bg-white rounded-md shadow-sm divide-y divide-gray-200">
                </ul>
            </div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gerenciar Cartões de Crédito</h2>
            <div class="p-4 bg-gray-50 rounded-lg shadow-sm mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Cartão de Crédito</h3>
                <form id="add-credit-card-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
                    <div>
                        <label for="card-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cartão</label>
                        <input type="text" id="card-name" placeholder="Nome do Cartão (ex: Visa, Master)" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="card-limit" class="block text-sm font-medium text-gray-700 mb-1">Limite (R$)</label>
                        <input type="number" id="card-limit" step="0.01" placeholder="Limite (R$)" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="card-due-day" class="block text-sm font-medium text-gray-700 mb-1">Dia Venc. Fatura</label>
                        <input type="number" id="card-due-day" min="1" max="31" placeholder="Dia Venc. Fatura" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-sm shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                    </div>
                    <div class="sm:col-span-3 flex justify-end">
                        <button type="submit"
                                class="px-5 py-2 bg-purple-500 text-white font-semibold rounded-md shadow-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-400 transition duration-150 ease-in-out">
                            Adicionar
                        </button>
                    </div>
                </form>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Meus Cartões</h3>
                <ul id="credit-cards-list" class="bg-white rounded-md shadow-sm divide-y divide-gray-200">
                </ul>
            </div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <div id="financial-goals-header" class="collapsible-header">
                 <h2 class="text-2xl font-semibold text-gray-700">Minhas Metas Financeiras</h2>
                <svg id="financial-goals-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </div>
            <div id="financial-goals-content" class="hidden">
                <div class="p-4 bg-gray-50 rounded-lg shadow-sm mb-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Nova Meta</h3>
                    <form id="add-financial-goal-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="goal-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Meta</label>
                            <input type="text" id="goal-name" placeholder="Ex: Viagem para a Europa" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="goal-target-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor Total (R$)</label>
                            <input type="number" id="goal-target-amount" step="0.01" placeholder="15000.00" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="goal-deadline" class="block text-sm font-medium text-gray-700 mb-1">Prazo (Data Alvo)</label>
                            <input type="date" id="goal-deadline" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        </div>
                        <div class="sm:col-span-full flex justify-end">
                            <button type="submit" id="add-goal-ai-plan-btn" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out flex items-center justify-center">
                                Adicionar Meta
                            </button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Metas Ativas</h3>
                    <ul id="financial-goals-list">
                        </ul>
                    <p id="no-financial-goals-message" class="text-center text-gray-500 mt-4 hidden">Nenhuma meta financeira adicionada ainda.</p>
                </div>
            </div>
        </div>


        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Adicionar Nova Transação Manualmente</h2>
            <form id="transaction-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                    <input type="date" id="date" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <input type="text" id="description" placeholder="Ex: Salário, Aluguel, Supermercado" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="value" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                    <input type="number" id="value" step="0.01" placeholder="0.00" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                    <select id="type" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                        <option value="saque">Saque (da conta)</option>
                        <option value="pix_enviado">PIX Enviado (Pagamento)</option>
                        <option value="pix_recebido">PIX Recebido</option>
                    </select>
                </div>
                <div>
                    <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                    <div class="flex items-center space-x-2">
                        <select id="category-select" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </select>
                    </div>
                    <input type="text" id="new-category-input" placeholder="Nova Categoria"
                           class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm hidden">
                </div>
                <div>
                    <label for="account-select" class="block text-sm font-medium text-gray-700 mb-1">Conta / Cartão (Opcional)</label>
                    <select id="account-select"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </select>
                </div>
                <div class="col-span-1 sm:col-span-2 lg:col-span-1">
                    <label for="installments" class="block text-sm font-medium text-gray-700 mb-1">Parcelas (total)</label>
                    <input type="number" id="installments" min="1" value="1"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="col-span-1 sm:col-span-2 lg:col-span-1"> <label for="installments-paid" class="block text-sm font-medium text-gray-700 mb-1">Parcelas já pagas</label>
                    <input type="number" id="installments-paid" min="0" value="0"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="sm:col-span-2 lg:col-span-full flex items-end justify-end">
                    <button type="submit"
                            class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Adicionar Transação
                    </button>
                </div>
            </form>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <div id="import-header" class="collapsible-header">
                <h2 class="text-2xl font-semibold text-gray-700">Importar Extratos</h2>
                <svg id="import-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </div>
            
            <div id="import-section-content" class="hidden">
                <p class="text-sm text-gray-600 mb-4">
                    Seu arquivo deve ser OFX, CSV, Excel, Word (.docx) ou Imagem (.png, .jpg) e conter informações de transação com Data, Descrição, Valor e Tipo.
                    <span class="font-bold text-red-600">Atenção: Integração direta com bancos (Open Finance) não é possível em uma aplicação web no navegador por motivos de segurança e privacidade.</span>
                    <span class="font-bold text-orange-600">Importação de Word e Imagem: o texto será extraído e as transações listadas para revisão. Tente usar imagens com boa qualidade e texto claro. A precisão da extração de data, valor e parcelas é limitada e exigirá revisão cuidadosa.</span>
                </p>

                <div class="p-4 bg-gray-50 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Carregar Arquivo de Extrato</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="file-input" class="block text-sm font-medium text-gray-700 mb-1">Selecione o Arquivo</label>
                            <input type="file" id="file-input" accept=".ofx, .csv, .xls, .xlsx, .doc, .docx, .png, .jpg, .jpeg, .gif, .bmp, .tiff, .webp"
                                   class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer">
                        </div>
                        <div class="flex justify-end col-span-full sm:col-span-1">
                            <button id="import-file-btn"
                                    class="w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                Carregar para Revisão
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        <div id="feedback-message"></div> <div id="import-review-section" class="mb-8 border-b pb-6 border-gray-200 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Revisar Transações Importadas</h2>
            <p class="text-sm text-gray-600 mb-4">
                Vincule cada transação importada a uma de suas contas ou cartões e ajuste os dados conforme necessário.
                 <span class="font-bold text-orange-600">Para Word/Imagem, revise a descrição e complete os demais campos, especialmente data, valor e parcelas.</span>
            </p>
            <div class="overflow-x-auto rounded-lg shadow-md mb-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-yellow-50">
                        <tr>
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data</th>
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Descrição</th>
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Valor</th>
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tipo</th>
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Categoria</th>
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Parcelas (Tot/Pagas)</th> <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Vincular a</th>
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="imported-transactions-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancel-review-btn"
                        class="px-6 py-2 bg-gray-400 text-white font-semibold rounded-md shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 transition duration-150 ease-in-out">
                    Cancelar Importação
                </button>
                <button id="confirm-import-btn"
                        class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    Confirmar Importação
                </button>
            </div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Baixar Planilha</h2>
            <button id="download-xlsx-btn"
                    class="w-full sm:w-auto px-6 py-2 bg-gray-600 text-white font-semibold rounded-md shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                Baixar Transações (com pendências) como Excel (.xlsx)
            </button>
        </div>

        <div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Minhas Transações</h2>
            </div>
            <div class="flex items-center space-x-4 mb-4">
                <button id="prev-month-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Anterior</button>
                <span id="current-month-display" class="text-lg font-semibold text-gray-800"></span>
                <button id="next-month-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Próximo</button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conta / Cartão</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parcela</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <p id="no-transactions-message" class="text-center text-gray-500 mt-4 hidden">Nenhuma transação registrada ainda.</p>
        </div>

    </div>

    <div id="edit-transaction-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Transação</h3>
                <button class="modal-close-btn" id="close-edit-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-transaction-id">
                
                <label for="edit-date">Data:</label>
                <input type="date" id="edit-date">

                <label for="edit-description">Descrição:</label>
                <input type="text" id="edit-description">

                <label for="edit-value">Valor:</label>
                <input type="number" id="edit-value" step="0.01">
                
                <label for="edit-category">Categoria:</label>
                <select id="edit-category" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-4"></select>
                <input type="text" id="edit-new-category" placeholder="Nova Categoria (se 'Adicionar Nova...' selecionada)" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-4">

                <label for="edit-installments-total">Parcelas (Total):</label>
                <input type="text" id="edit-installments-total" readonly class="bg-gray-100 cursor-not-allowed">

                <label for="edit-installments-paid">Parcelas já pagas:</label>
                <input type="number" id="edit-installments-paid" min="0" required>
            </div>
            <div class="modal-footer">
                <button id="save-edit-transaction-btn"
                        class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition duration-150 ease-in-out">
                    Salvar Alterações
                </button>
                <button id="cancel-edit-transaction-btn"
                        class="px-4 py-2 bg-gray-400 text-white font-semibold rounded-md shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 transition duration-150 ease-in-out">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Arrays globais para armazenar dados
        let accounts = [];
        let creditCards = [];
        let transactions = [];
        let categories = [
            "Alimentação", "Transporte", "Moradia", "Lazer", "Saúde", "Educação",
            "Salário", "Investimentos", "Contas Fixas", "Compras", "Outros", "Revisar Importação"
        ];
        let financialGoals = []; 

        let importedTransactionsToReview = [];
        let currentMonth = new Date().getMonth(); 
        let currentYear = new Date().getFullYear();

        const totalReceitasEl = document.getElementById('total-receitas');
        const totalDespesasEl = document.getElementById('total-despesas');
        const saldoAtualEl = document.getElementById('saldo-atual');
        const totalCardBillsEl = document.getElementById('total-card-bills');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const addAccountForm = document.getElementById('add-account-form');
        const accountsList = document.getElementById('accounts-list');
        const addCreditCardForm = document.getElementById('add-credit-card-form');
        const creditCardsList = document.getElementById('credit-cards-list');
        const accountSelect = document.getElementById('account-select'); 
        const accountTypeSelect = document.getElementById('account-type'); 
        const initialBalanceInput = document.getElementById('initial-balance');
        const initialValueLabel = document.getElementById('initial-value-label'); 
        const cardDueDayInput = document.getElementById('card-due-day');
        const transactionForm = document.getElementById('transaction-form');
        const transactionList = document.getElementById('transaction-list');
        const installmentsInput = document.getElementById('installments');
        const installmentsPaidInput = document.getElementById('installments-paid'); 
        const transactionTypeSelect = document.getElementById('type');
        const categorySelect = document.getElementById('category-select');
        const newCategoryInput = document.getElementById('new-category-input');
        const importHeader = document.getElementById('import-header');
        const importSectionContent = document.getElementById('import-section-content');
        const importArrow = document.getElementById('import-arrow');
        const importReviewSection = document.getElementById('import-review-section');
        const importedTransactionsTableBody = document.getElementById('imported-transactions-table-body');
        const confirmImportBtn = document.getElementById('confirm-import-btn');
        const cancelReviewBtn = document.getElementById('cancel-review-btn');
        const fileInput = document.getElementById('file-input');
        const importFileBtn = document.getElementById('import-file-btn');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthDisplay = document.getElementById('current-month-display');
        const downloadXlsxBtn = document.getElementById('download-xlsx-btn');
        const detailedCardBillsHeader = document.getElementById('detailed-card-bills-header');
        const detailedCardBillsContent = document.getElementById('detailed-card-bills-content');
        const detailedCardBillsArrow = document.getElementById('detailed-card-bills-arrow');
        const detailedCardBillsList = document.getElementById('detailed-card-bills-list');
        const noCardBillsMessage = document.getElementById('no-card-bills-message');
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal');
        const saveEditTransactionBtn = document.getElementById('save-edit-transaction-btn');
        const cancelEditTransactionBtn = document.getElementById('cancel-edit-transaction-btn');
        const editTransactionIdInput = document.getElementById('edit-transaction-id');
        const editDateInput = document.getElementById('edit-date'); 
        const editDescriptionInput = document.getElementById('edit-description');
        const editValueInput = document.getElementById('edit-value');
        const editCategorySelect = document.getElementById('edit-category'); 
        const editNewCategoryInput = document.getElementById('edit-new-category'); 
        const editInstallmentsTotalInput = document.getElementById('edit-installments-total');
        const editInstallmentsPaidInput = document.getElementById('edit-installments-paid');
        const financialGoalsHeader = document.getElementById('financial-goals-header');
        const financialGoalsContent = document.getElementById('financial-goals-content');
        const financialGoalsArrow = document.getElementById('financial-goals-arrow');
        const addFinancialGoalForm = document.getElementById('add-financial-goal-form');
        const financialGoalsList = document.getElementById('financial-goals-list');
        const noFinancialGoalsMessage = document.getElementById('no-financial-goals-message');

        // --- Funções Utilitárias ---
        const showFeedback = (message, type) => {
            feedbackMessageEl.textContent = message;
            feedbackMessageEl.classList.remove('hidden', 'feedback-success', 'feedback-error', 'feedback-info');
            feedbackMessageEl.classList.add(`feedback-${type}`);
            feedbackMessageEl.style.display = 'block'; 
            setTimeout(() => {
                if (feedbackMessageEl.textContent === message) { 
                    feedbackMessageEl.style.display = 'none'; 
                }
            }, 7000); 
        };

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        };

        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);

        function formatDateFromVariousFormats(dateString, yearToAssume = new Date().getFullYear()) {
            if (!dateString || typeof dateString !== 'string') return null;
            let day, month, year;
            dateString = dateString.trim();

            let match = dateString.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{4})$/); 
            if (match) {
                day = parseInt(match[1], 10); month = parseInt(match[2], 10); year = parseInt(match[3], 10);
            } else {
                match = dateString.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{2})$/); 
                if (match) {
                    day = parseInt(match[1], 10); month = parseInt(match[2], 10); year = parseInt(match[3], 10);
                    year += (year < 70 ? 2000 : 1900);
                } else {
                    match = dateString.match(/^(\d{4})[-\/\.](\d{1,2})[-\/\.](\d{1,2})$/); 
                    if (match) {
                        year = parseInt(match[1], 10); month = parseInt(match[2], 10); day = parseInt(match[3], 10);
                    } else {
                        match = dateString.match(/^(\d{1,2})[\/\.](\d{1,2})$/); 
                        if (match) {
                            day = parseInt(match[1], 10); month = parseInt(match[2], 10); year = yearToAssume;
                        } else {
                            match = dateString.match(/^(\d{2})(\d{2})(\d{4})$/);
                            if (match) {
                                day = parseInt(match[1], 10); month = parseInt(match[2], 10); year = parseInt(match[3], 10);
                            } else {
                                match = dateString.match(/^(\d{2})(\d{2})(\d{2})$/);
                                if (match) {
                                    day = parseInt(match[1], 10); month = parseInt(match[2], 10); year = parseInt(match[3], 10);
                                    year += (year < 70 ? 2000 : 1900);
                                } else {
                                    return null; 
                                }
                            }
                        }
                    }
                }
            }
            if (month < 1 || month > 12 || day < 1 || day > 31) return null;
            const dateObj = new Date(year, month - 1, day);
            if (dateObj.getFullYear() === year && dateObj.getMonth() === month - 1 && dateObj.getDate() === day) {
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }
            return null;
        }

        function parseCurrencyValue(valueString) {
            if (!valueString || typeof valueString !== 'string') return { value: 0, isCredit: null, extractedString: "", lineRemainder: valueString };
            
            let originalMatchedString = "";
            let lineRemainder = valueString;
            const currencyPatterns = [
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d{1,3}(?:\.\d{3})*(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i, 
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d+(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,                 
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d{1,3}(?:,\d{3})*(?:\.\d{2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i, 
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d+(?:\.\d{2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,                  
                /(?:^|\s)([\-\+]?\s*\d{1,3}(?:\.\d{3})*(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i, 
                /(?:^|\s)([\-\+]?\s*\d+(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,                         
            ];
            let numericPart = "";
            let indicator = "";
            for (const pattern of currencyPatterns) {
                const match = lineRemainder.match(pattern); 
                if (match) {
                    originalMatchedString = match[0].trim();
                    numericPart = match[2] ? match[2].trim() : (match[1] && !match[1].toUpperCase().includes("R$") ? match[1].trim() : "");
                    indicator = match[3] ? match[3].trim().toUpperCase() : "";
                    const startIndex = lineRemainder.indexOf(originalMatchedString);
                    if (startIndex !== -1) {
                        lineRemainder = lineRemainder.substring(0, startIndex) + lineRemainder.substring(startIndex + originalMatchedString.length);
                        lineRemainder = lineRemainder.trim();
                    }
                    break;
                }
            }
            if (!numericPart) return { value: 0, isCredit: null, extractedString: "", lineRemainder: valueString };
            let cleanedNumericPart = numericPart.replace("R$", "").replace("+", "").trim();
            const hasMinus = cleanedNumericPart.startsWith('-');
            if (hasMinus) cleanedNumericPart = cleanedNumericPart.substring(1);
            let numberValue;
            if (cleanedNumericPart.includes(',')) { 
                if (cleanedNumericPart.match(/\.\d{3},\d{1,2}$/)) { 
                    numberValue = parseFloat(cleanedNumericPart.replace(/\./g, '').replace(',', '.'));
                } else if (cleanedNumericPart.match(/,\d{1,2}$/)) { 
                    numberValue = parseFloat(cleanedNumericPart.replace(',', '.'));
                } else if (cleanedNumericPart.match(/,\d{3}(?:\.\d{2})?$/)) { 
                     numberValue = parseFloat(cleanedNumericPart.replace(/,/g, ''));
                } else { 
                    numberValue = parseFloat(cleanedNumericPart.replace(',', '.'));
                }
            } else {
                numberValue = parseFloat(cleanedNumericPart); 
            }
            if (isNaN(numberValue)) return { value: 0, isCredit: null, extractedString: "", lineRemainder: valueString };
            let finalIsCredit = null;
            if (indicator.startsWith("C")) finalIsCredit = true;
            else if (indicator.startsWith("D")) finalIsCredit = false;
            else if (hasMinus) finalIsCredit = false;
            return { value: Math.abs(numberValue), isCredit: finalIsCredit, extractedString: originalMatchedString, lineRemainder: lineRemainder };
        }

        function extractInstallmentInfo(text) {
            if (!text || typeof text !== 'string') return { paid: 1, total: 1, matchedText: "", lineRemainder: text };
            let paid = 1;
            let total = 1;
            let matchedText = "";
            let lineRemainder = text;
            const patterns = [
                /(\d{1,2})\s*\/\s*(\d{1,2})/, 
                /parc(?:ela)?\.?\s*(\d{1,2})\s*(?:de|\/)\s*(\d{1,2})/i, 
                /inst\s*(\d{1,2})\s*\/\s*(\d{1,2})/i 
            ];
            for (const pattern of patterns) {
                const match = lineRemainder.match(pattern);
                if (match) {
                    paid = parseInt(match[1], 10);
                    total = parseInt(match[2], 10);
                    matchedText = match[0];
                    const startIndex = lineRemainder.indexOf(matchedText);
                    if (startIndex !== -1) {
                        lineRemainder = lineRemainder.substring(0, startIndex) + lineRemainder.substring(startIndex + matchedText.length);
                        lineRemainder = lineRemainder.trim();
                    }
                    break; 
                }
            }
            if (total < paid || total <= 0 || paid <= 0) { // Basic validation
                return { paid: 1, total: 1, matchedText: "", lineRemainder: text };
            }
            return { paid, total, matchedText, lineRemainder };
        }

        // --- Event Listeners ---
        const addDeleteListeners = () => { document.querySelectorAll('.delete-btn').forEach(b => { b.onclick = (e) => { performDelete(e.currentTarget.dataset.id, e.currentTarget.dataset.type); }; }); };
        const addPayTransactionListeners = () => { document.querySelectorAll('.pay-transaction-btn').forEach(b => { b.onclick = (e) => { markTransactionAsPaid(e.currentTarget.dataset.id); }; }); };
        const addEditTransactionListeners = () => { document.querySelectorAll('.edit-transaction-btn').forEach(b => { b.onclick = (e) => { openEditModal(e.currentTarget.dataset.id); }; }); };

        // --- Persistência de Dados ---
        const loadData = () => {
            const storedAccounts = localStorage.getItem('financialAccounts'); if (storedAccounts) accounts = JSON.parse(storedAccounts);
            const storedCreditCards = localStorage.getItem('financialCreditCards'); if (storedCreditCards) creditCards = JSON.parse(storedCreditCards);
            const storedTransactions = localStorage.getItem('financialFinancialTransactions'); if (storedTransactions) transactions = JSON.parse(storedTransactions);
            const storedCategories = localStorage.getItem('financialCategories'); if (storedCategories) { categories = JSON.parse(storedCategories); if (!categories.includes("Revisar Importação")) categories.push("Revisar Importação"); } else { if (!categories.includes("Revisar Importação")) categories.push("Revisar Importação");}
            const storedFinancialGoals = localStorage.getItem('financialGoals'); if (storedFinancialGoals) financialGoals = JSON.parse(storedFinancialGoals);
            renderAccounts(); renderCreditCards(); populateAccountSelects(); populateCategorySelect(); populateCategorySelect(editCategorySelect); 
            renderTransactions(); renderFinancialGoals(); updateSummary(); renderMonthlySummary(); renderDetailedCardBills(); checkCreditCardDueDates(); 
        };
        const saveAccounts = () => localStorage.setItem('financialAccounts', JSON.stringify(accounts));
        const saveCreditCards = () => localStorage.setItem('financialCreditCards', JSON.stringify(creditCards));
        const saveTransactions = () => localStorage.setItem('financialFinancialTransactions', JSON.stringify(transactions));
        const saveCategories = () => localStorage.setItem('financialCategories', JSON.stringify(categories));
        const saveFinancialGoals = () => localStorage.setItem('financialGoals', JSON.stringify(financialGoals)); 

        // --- Gerenciamento de Contas e Cartões ---
        accountTypeSelect.addEventListener('change', () => { initialValueLabel.textContent = accountTypeSelect.value === 'overdraft' ? 'Limite (R$)' : 'Saldo Inicial (R$)'; initialBalanceInput.placeholder = accountTypeSelect.value === 'overdraft' ? 'Limite (R$)' : 'Saldo Inicial (R$)'; });
        addAccountForm.addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('account-name').value.trim(); const type = document.getElementById('account-type').value; const initialValue = parseFloat(initialBalanceInput.value) || 0; let newAccount = type === 'overdraft' ? { id:generateUniqueId(), name, type, balance:0, limit:initialValue } : { id:generateUniqueId(), name, type, balance:initialValue, limit:0 }; if (name) { accounts.push(newAccount); saveAccounts(); renderAccounts(); populateAccountSelects(); updateSummary(); addAccountForm.reset(); initialValueLabel.textContent = 'Saldo Inicial (R$)'; initialBalanceInput.placeholder = 'Saldo Inicial (R$)'; showFeedback('Conta adicionada!', 'success'); } else showFeedback('Insira um nome para a conta.', 'error'); });
        addCreditCardForm.addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('card-name').value.trim(); const limit = parseFloat(document.getElementById('card-limit').value) || 0; const dueDay = parseInt(cardDueDayInput.value); if (name && limit > 0 && dueDay >= 1 && dueDay <= 31) { const newCard = { id:generateUniqueId(), name, limit, availableLimit:limit, currentBillAmount:0, dueDay }; creditCards.push(newCard); saveCreditCards(); renderCreditCards(); populateAccountSelects(); addCreditCardForm.reset(); showFeedback('Cartão adicionado!', 'success'); } else showFeedback('Preencha os campos do cartão.', 'error'); });
        const renderAccounts = () => { accountsList.innerHTML = ''; if (accounts.length === 0) { accountsList.innerHTML = '<li class="p-4 text-gray-500 text-center">Nenhuma conta.</li>'; return; } accounts.forEach(acc => { const li = document.createElement('li'); li.className = 'p-4 flex justify-between items-center'; let html = `<span class="font-semibold">${acc.name}</span><span class="text-sm text-gray-500 ml-2">(${acc.type==='overdraft'?'C. Especial':'Dinheiro'})</span>`; if (acc.type === 'overdraft') html += `<p class="text-xs">Limite: ${formatCurrency(acc.limit)} | Disp: ${formatCurrency(acc.limit+acc.balance)}</p>`; else html += `<p class="text-xs">Saldo: ${formatCurrency(acc.balance)}</p>`; li.innerHTML = `<div>${html}</div><button data-id="${acc.id}" data-type="account" class="delete-btn text-red-500 hover:text-red-700 p-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>`; accountsList.appendChild(li); }); addDeleteListeners(); };
        const renderCreditCards = () => { creditCardsList.innerHTML = ''; if (creditCards.length === 0) { creditCardsList.innerHTML = '<li class="p-4 text-gray-500 text-center">Nenhum cartão.</li>'; return; } creditCards.forEach(card => { let bill = transactions.reduce((s,t)=>(t.accountId===card.id&&t.type==='despesa'&&!t.isPaid&&new Date(t.date).getMonth()===currentMonth&&new Date(t.date).getFullYear()===currentYear)?s+t.value:s,0); const li=document.createElement('li');li.className='p-4 flex justify-between items-center'; li.innerHTML = `<div><span class="font-semibold">${card.name}</span><p class="text-xs">Limite: ${formatCurrency(card.limit)} | Disp: ${formatCurrency(card.availableLimit)} | Fatura: ${formatCurrency(bill)} (Venc. dia ${card.dueDay})</p></div><button data-id="${card.id}" data-type="creditCard" class="delete-btn text-red-500 hover:text-red-700 p-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>`; creditCardsList.appendChild(li); }); addDeleteListeners(); };
        const populateAccountSelects = (targetSelect = accountSelect) => { targetSelect.innerHTML = ''; const noLinkOpt = document.createElement('option'); noLinkOpt.value = ""; noLinkOpt.textContent = targetSelect === accountSelect ? "Não Vincular / Geral" : "Selecione"; targetSelect.appendChild(noLinkOpt); accounts.forEach(acc => { const opt = document.createElement('option'); opt.value = acc.id; opt.textContent = `${acc.name} (${acc.type === 'overdraft' ? 'C. Especial' : 'Dinheiro'})`; targetSelect.appendChild(opt); }); creditCards.forEach(card => { const opt = document.createElement('option'); opt.value = card.id; opt.textContent = `${card.name} (Cartão)`; targetSelect.appendChild(opt); }); if (!targetSelect.value && targetSelect === accountSelect) targetSelect.value = ""; };
        populateAccountSelects(); 
        const populateCategorySelect = (selectElement = categorySelect) => { const currVal = selectElement.value; selectElement.innerHTML = ''; if (selectElement === categorySelect) { const phOpt = document.createElement('option'); phOpt.value = ""; phOpt.textContent = "Selecione categoria"; phOpt.disabled = true; phOpt.selected = !currVal; selectElement.appendChild(phOpt); } categories.sort((a,b) => a.localeCompare(b)).forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; selectElement.appendChild(opt); }); const newOpt = document.createElement('option'); newOpt.value = 'nova-categoria'; newOpt.textContent = 'Adicionar Nova...'; selectElement.appendChild(newOpt); if (categories.includes(currVal)) selectElement.value = currVal; else if (currVal === 'nova-categoria' && selectElement === categorySelect) selectElement.value = 'nova-categoria'; else if (!currVal && selectElement !== categorySelect && categories.length > 0 && selectElement.options.length > (selectElement === categorySelect ? 1:0) ) selectElement.value = categories[0]; };
        populateCategorySelect(); 
        categorySelect.addEventListener('change', () => { if (categorySelect.value === 'nova-categoria') { newCategoryInput.classList.remove('hidden'); newCategoryInput.focus(); newCategoryInput.value = ''; } else { newCategoryInput.classList.add('hidden'); newCategoryInput.value = ''; }});

        // --- Gerenciamento de Transações ---
        transactionForm.addEventListener('submit', (e) => { e.preventDefault(); const date=document.getElementById('date').value; const description=document.getElementById('description').value.trim(); const value=parseFloat(document.getElementById('value').value); let type=document.getElementById('type').value; const accountId=document.getElementById('account-select').value; const installments=parseInt(installmentsInput.value)||1; const installmentsPaid=parseInt(installmentsPaidInput.value)||0; let category; if(categorySelect.value==='nova-categoria'){category=newCategoryInput.value.trim(); if(category&&!categories.includes(category)){categories.push(category);saveCategories();populateCategorySelect();populateCategorySelect(editCategorySelect);categorySelect.value=category;}else if(categories.includes(category)){categorySelect.value=category;newCategoryInput.classList.add('hidden');newCategoryInput.value='';}else if(!category){showFeedback('Insira nome para nova categoria.','error');return;}}else{category=categorySelect.value;} if(!date||!description||isNaN(value)||value<=0||!type||!category){showFeedback('Preencha todos os campos obrigatórios.','error');return;} if(installmentsPaid>installments||installmentsPaid<0){showFeedback('Parcelas pagas inválido.','error');return;} const account=accountId?accounts.find(acc=>acc.id===accountId):null; const creditCard=accountId?creditCards.find(card=>card.id===accountId):null; const isCreditCardTransaction=!!creditCard; let transactionsToAdd=[]; const originalGroupId=generateUniqueId(); let fundamentalType=(type==='receita'||type==='pix_recebido')?'receita':'despesa'; if(installments>1&&(type==='despesa'||type==='pix_enviado'||type==='saque')){const instVal=parseFloat((value/installments).toFixed(2));let sumInst=0;for(let i=0;i<installments;i++){let currInstVal=(i===installments-1)?parseFloat((value-sumInst).toFixed(2)):instVal;sumInst+=currInstVal;const txDate=new Date(date);txDate.setMonth(txDate.getMonth()+i);transactionsToAdd.push({id:generateUniqueId(),date:txDate.toISOString().split('T')[0],description:`${description} (${i+1}/${installments})`,value:currInstVal,type,fundamentalType,category,accountId:accountId||null,isCreditCard:isCreditCardTransaction,installments:`${i+1}/${installments}`,isPaid:(i+1)<=installmentsPaid,originalGroupId});}}else{transactionsToAdd.push({id:generateUniqueId(),date,description,value,type,fundamentalType,category,accountId:accountId||null,isCreditCard:isCreditCardTransaction,installments:'1/1',isPaid:installmentsPaid>=1,originalGroupId});} let txAddedOk=true;const tempAccs=JSON.parse(JSON.stringify(accounts));const tempCards=JSON.parse(JSON.stringify(creditCards));for(const newTx of transactionsToAdd){if(newTx.accountId){let target=newTx.isCreditCard?tempCards.find(c=>c.id===newTx.accountId):tempAccs.find(a=>a.id===newTx.accountId);if(target){if(newTx.isCreditCard){if(newTx.fundamentalType==='despesa')target.availableLimit-=newTx.value;else target.availableLimit+=newTx.value;}else if(newTx.isPaid){if(newTx.fundamentalType==='despesa'){if(target.type==='overdraft'&&(target.balance-newTx.value<-target.limit)){showFeedback(`Transação ${formatCurrency(newTx.value)} para ${target.name} excede limite.`,'error');txAddedOk=false;break;}target.balance-=newTx.value;}else target.balance+=newTx.value;}}else{showFeedback('Conta/Cartão não encontrado.','info');newTx.accountId=null;newTx.isCreditCard=false;}}}if(!txAddedOk)return;if(accountId){accounts=tempAccs;creditCards=tempCards;}transactions.push(...transactionsToAdd);saveTransactions();saveAccounts();saveCreditCards();renderTransactions();updateSummary();renderDetailedCardBills();checkCreditCardDueDates();transactionForm.reset();installmentsInput.value=1;installmentsPaidInput.value=0;accountSelect.value="";newCategoryInput.classList.add('hidden');populateCategorySelect();showFeedback('Transação(ões) adicionada(s)!','success');});

        // --- Renderização e Lógica de Exclusão/Pagamento/Edição de Transações ---
        const renderTransactions = () => { transactionList.innerHTML = ''; const bom = new Date(currentYear, currentMonth, 1); bom.setHours(0,0,0,0); const filtered = transactions.filter(t => { const td = new Date(t.date); td.setHours(0,0,0,0); return (td.getMonth() === currentMonth && td.getFullYear() === currentYear) || (td < bom && !t.isPaid); }).sort((a, b) => new Date(a.date) - new Date(b.date)); if (filtered.length === 0) { noTransactionsMessage.classList.remove('hidden'); return; } else noTransactionsMessage.classList.add('hidden'); filtered.forEach(tx => { const tr = document.createElement('tr'); let rClass = 'bg-white hover:bg-gray-50'; const tDate = new Date(tx.date); tDate.setHours(0,0,0,0); if (tx.isPaid) rClass += ' paid-transaction'; else if (tDate < bom) rClass += ' pending-previous-month'; tr.className = rClass; const accCardName = tx.accountId ? (tx.isCreditCard ? (creditCards.find(c=>c.id===tx.accountId)?.name||'Cartão Desc.') : (accounts.find(a=>a.id===tx.accountId)?.name||'Conta Desc.')) : 'Não Vinculada'; const txtStyle = tx.isPaid ? 'text-gray-500' : (tDate < bom ? 'text-gray-900 font-semibold' : 'text-gray-900 font-semibold'); let typeDisp = tx.type, valColor = 'text-gray-800'; if(tx.fundamentalType==='receita'){valColor='text-green-600';if(tx.type==='pix_recebido')typeDisp='PIX Recebido';else if(tx.type==='receita')typeDisp='Receita';}else if(tx.fundamentalType==='despesa'){valColor=tx.isPaid?'text-red-500':'text-red-700 font-bold';if(tx.type==='saque')typeDisp='Saque';else if(tx.type==='pix_enviado')typeDisp='PIX Enviado';else if(tx.type==='despesa')typeDisp='Despesa';} const statStyle = tx.isPaid ? 'text-green-600' : 'text-red-700 font-bold'; tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm ${txtStyle}">${new Date(tx.date).toLocaleDateString('pt-BR')}</td><td class="px-6 py-4 whitespace-nowrap text-sm ${txtStyle}">${tx.description}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${valColor}">${formatCurrency(tx.value)}</td><td class="px-6 py-4 whitespace-nowrap text-sm ${txtStyle}">${typeDisp}</td><td class="px-6 py-4 whitespace-nowrap text-sm ${txtStyle}">${tx.category}</td><td class="px-6 py-4 whitespace-nowrap text-sm ${txtStyle}">${accCardName}</td><td class="px-6 py-4 whitespace-nowrap text-sm ${txtStyle}">${tx.installments}</td><td class="px-6 py-4 whitespace-nowrap text-sm ${statStyle}">${tx.isPaid?'Pago':'Não Pago'}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${!tx.isPaid?`<button data-id="${tx.id}" class="pay-transaction-btn text-blue-600 hover:text-blue-900 mr-2 p-2 rounded-full hover:bg-blue-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>`:''} <button data-id="${tx.id}" class="edit-transaction-btn text-yellow-600 hover:text-yellow-900 mr-2 p-2 rounded-full hover:bg-yellow-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button data-id="${tx.id}" data-type="transaction" class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td>`; transactionList.appendChild(tr); }); addDeleteListeners();addPayTransactionListeners();addEditTransactionListeners();};
        const performDelete = (id, type) => { if(type==='account'){if(transactions.some(t=>t.accountId===id)){showFeedback('Exclua transações da conta primeiro.','error');return;}accounts=accounts.filter(acc=>acc.id!==id);saveAccounts();renderAccounts();populateAccountSelects();updateSummary();showFeedback('Conta excluída.','success');}else if(type==='creditCard'){if(transactions.some(t=>t.accountId===id)){showFeedback('Exclua transações do cartão primeiro.','error');return;}creditCards=creditCards.filter(card=>card.id!==id);saveCreditCards();renderCreditCards();populateAccountSelects();updateSummary();showFeedback('Cartão excluído.','success');}else if(type==='transaction'){const idx=transactions.findIndex(t=>t.id===id);if(idx>-1){const delTx=transactions[idx];if(delTx.accountId){if(delTx.isCreditCard){const card=creditCards.find(c=>c.id===delTx.accountId);if(card){if(delTx.fundamentalType==='despesa')card.availableLimit+=delTx.value;else card.availableLimit-=delTx.value;}}else{const acc=accounts.find(a=>a.id===delTx.accountId);if(acc&&delTx.isPaid){if(delTx.fundamentalType==='despesa')acc.balance+=delTx.value;else acc.balance-=delTx.value;}}}transactions.splice(idx,1);saveTransactions();saveAccounts();saveCreditCards();renderTransactions();updateSummary();renderMonthlySummary();renderDetailedCardBills();checkCreditCardDueDates();showFeedback('Transação excluída.','success');}}};
        const markTransactionAsPaid = (id) => { const tx = transactions.find(t=>t.id===id); if(tx&&!tx.isPaid){const prevPaid=tx.isPaid;tx.isPaid=true;if(!prevPaid&&tx.accountId&&!tx.isCreditCard){const acc=accounts.find(a=>a.id===tx.accountId);if(acc){if(tx.fundamentalType==='despesa'){if(acc.type==='overdraft'&&(acc.balance-tx.value<-acc.limit)){showFeedback(`Pagamento ${formatCurrency(tx.value)} p/ ${acc.name} excede limite.`,'error');}else acc.balance-=tx.value;}else acc.balance+=tx.value;saveAccounts();}}saveTransactions();renderTransactions();updateSummary();renderMonthlySummary();renderDetailedCardBills();checkCreditCardDueDates();showFeedback('Transação paga!','success');}else if(tx&&tx.isPaid)showFeedback('Transação já está paga.','info');};
        const openEditModal = (id) => { const tx=transactions.find(t=>t.id===id);if(!tx){showFeedback('Transação não encontrada.','error');return;}editTransactionIdInput.value=tx.id;editDateInput.value=tx.date;editDescriptionInput.value=tx.description;editValueInput.value=tx.value.toFixed(2);populateCategorySelect(editCategorySelect);editCategorySelect.value=tx.category;editNewCategoryInput.classList.add('hidden');editNewCategoryInput.value='';const[paid,total]=tx.installments.split('/').map(Number);editInstallmentsTotalInput.value=total;editInstallmentsTotalInput.readOnly=true;editInstallmentsTotalInput.classList.add('bg-gray-100','cursor-not-allowed');editInstallmentsPaidInput.value=paid;editInstallmentsPaidInput.max=total;editDateInput.readOnly=false;editDescriptionInput.readOnly=false;editDescriptionInput.classList.remove('bg-gray-100','cursor-not-allowed');editValueInput.readOnly=false;editValueInput.classList.remove('bg-gray-100','cursor-not-allowed');editTransactionModal.classList.remove('hidden');};
        editCategorySelect.addEventListener('change', () => { if(editCategorySelect.value==='nova-categoria'){editNewCategoryInput.classList.remove('hidden');editNewCategoryInput.focus();}else{editNewCategoryInput.classList.add('hidden');editNewCategoryInput.value='';}});
        const closeEditModal = () => {editTransactionModal.classList.add('hidden');editDescriptionInput.readOnly=true;editDescriptionInput.classList.add('bg-gray-100','cursor-not-allowed');editValueInput.readOnly=true;editValueInput.classList.add('bg-gray-100','cursor-not-allowed');editInstallmentsTotalInput.readOnly=true;editInstallmentsTotalInput.classList.add('bg-gray-100','cursor-not-allowed');editDateInput.readOnly=true;editNewCategoryInput.classList.add('hidden');};
        closeEditModalBtn.addEventListener('click',closeEditModal);cancelEditTransactionBtn.addEventListener('click',closeEditModal);
        saveEditTransactionBtn.addEventListener('click',()=>{const id=editTransactionIdInput.value;const newDate=editDateInput.value;const newDesc=editDescriptionInput.value.trim();const newVal=parseFloat(editValueInput.value);const newPaidInst=parseInt(editInstallmentsPaidInput.value);let newCat=editCategorySelect.value;if(newCat==='nova-categoria'){const typedNewCat=editNewCategoryInput.value.trim();if(typedNewCat){if(!categories.includes(typedNewCat)){categories.push(typedNewCat);saveCategories();populateCategorySelect();populateCategorySelect(editCategorySelect);}newCat=typedNewCat;}else{showFeedback('Nova categoria vazia.','error');return;}}const tx=transactions.find(t=>t.id===id);if(!tx){showFeedback('Transação não encontrada.','error');closeEditModal();return;}const totalInst=parseInt(tx.installments.split('/')[1]);if(!newDate||!newDesc||isNaN(newVal)||newVal<=0||isNaN(newPaidInst)||newPaidInst<0||newPaidInst>totalInst){showFeedback('Dados inválidos.','error');return;}const oldVal=tx.value;const oldPaid=tx.isPaid;const fundType=tx.fundamentalType;if(tx.accountId){if(!tx.isCreditCard&&oldPaid){const acc=accounts.find(a=>a.id===tx.accountId);if(acc){if(fundType==='despesa')acc.balance+=oldVal;else acc.balance-=oldVal;}}if(tx.isCreditCard){const card=creditCards.find(c=>c.id===tx.accountId);if(card){if(fundType==='despesa')card.availableLimit+=oldVal;else card.availableLimit-=oldVal;}}}tx.date=newDate;tx.description=newDesc;tx.value=newVal;tx.category=newCat;tx.installments=`${newPaidInst}/${totalInst}`;tx.isPaid=newPaidInst>=totalInst;if(tx.accountId){if(!tx.isCreditCard&&tx.isPaid){const acc=accounts.find(a=>a.id===tx.accountId);if(acc){if(fundType==='despesa')acc.balance-=tx.value;else acc.balance+=tx.value;}}if(tx.isCreditCard){const card=creditCards.find(c=>c.id===tx.accountId);if(card){if(fundType==='despesa')card.availableLimit-=tx.value;else card.availableLimit+=tx.value;}}}saveTransactions();saveAccounts();saveCreditCards();renderTransactions();updateSummary();renderMonthlySummary();renderDetailedCardBills();checkCreditCardDueDates();showFeedback('Transação atualizada!','success');closeEditModal();});

        // --- Resumo e Cálculos ---
        const updateSummary = () => { let totalPoder=0;accounts.forEach(acc=>totalPoder+=(acc.type==='cash'?acc.balance:(acc.limit+acc.balance)));creditCards.forEach(card=>totalPoder+=card.availableLimit);totalReceitasEl.textContent=formatCurrency(totalPoder);const totalDespTxt=totalDespesasEl.textContent||"R$ 0,00";const totalDesp=parseFloat(totalDespTxt.replace('R$','').replace(/\./g,'').replace(',','.'))||0;const saldoCons=totalPoder-totalDesp;saldoAtualEl.textContent=formatCurrency(saldoCons);let totalFaturas=0;creditCards.forEach(card=>{totalFaturas+=transactions.reduce((s,t)=>(t.accountId===card.id&&t.isCreditCard&&t.fundamentalType==='despesa'&&!t.isPaid&&new Date(t.date).getMonth()===currentMonth&&new Date(t.date).getFullYear()===currentYear)?s+t.value:s,0);});totalCardBillsEl.textContent=formatCurrency(totalFaturas);saldoAtualEl.className=`text-2xl font-bold ${saldoCons>=0?'text-green-700':'text-red-700'}`;};
        const updateMonthlyDisplay = () => { currentMonthDisplay.textContent = new Date(currentYear,currentMonth).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});};
        const renderMonthlySummary = () => { let monthExp=0;const bom=new Date(currentYear,currentMonth,1);bom.setHours(0,0,0,0);transactions.forEach(t=>{const tD=new Date(t.date);tD.setHours(0,0,0,0);if(t.fundamentalType==='despesa'&&((tD.getMonth()===currentMonth&&tD.getFullYear()===currentYear)||(tD<bom&&!t.isPaid)))monthExp+=t.value;});totalDespesasEl.textContent=formatCurrency(monthExp);};
        prevMonthBtn.addEventListener('click',()=>{currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--;}updateMonthlyDisplay();renderTransactions();renderMonthlySummary();updateSummary();});
        nextMonthBtn.addEventListener('click',()=>{currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++;}updateMonthlyDisplay();renderTransactions();renderMonthlySummary();updateSummary();});

        // --- Funções de Importação Modificadas ---
        const finalizeImportProcessing = (parsedTxs) => { fileInput.value='';fileInput.disabled=false;importFileBtn.disabled=false;if(parsedTxs&&parsedTxs.length>0){importedTransactionsToReview=parsedTxs;renderImportedTransactionsForReview();importReviewSection.classList.remove('hidden');}else importReviewSection.classList.add('hidden');};
        const handleImportError = (err,fileType) => { console.error(`Erro ${fileType}:`,err);showFeedback(`Erro ao processar ${fileType}.`,'error');importReviewSection.classList.add('hidden');fileInput.value='';fileInput.disabled=false;importFileBtn.disabled=false;};
        const parseOFX = (content) => { const pTxs=[];const rgx=/<STMTTRN>([\s\S]*?)<\/STMTTRN>/g;let m;while((m=rgx.exec(content))!==null){const blk=m[1];const dM=/<DTPOSTED>(\d{8})/.exec(blk);const deM=/<MEMO>([\s\S]*?)<\/(MEMO|NAME)>/.exec(blk);const vM=/<TRNAMT>([+\-]?[\d,.]+)/.exec(blk);const tyM=/<TRNTYPE>(DEBIT|CREDIT)/i.exec(blk);if(dM&&deM&&vM){const dS=dM[1];const fD=`${dS.substring(0,4)}-${dS.substring(4,6)}-${dS.substring(6,8)}`;const de=deM[1].trim();const v=parseFloat(vM[1].replace(',','.'));let type=v<0?'despesa':'receita';if(tyM)type=tyM[1].toUpperCase()==='CREDIT'?'receita':'despesa';if(!isNaN(v))pTxs.push({id:generateUniqueId(),date:fD,description:de,value:Math.abs(v),type,fundamentalType:type,category:'Importado OFX',accountId:'',isCreditCard:false,installments:'1/1',isPaid:true,fundamentalTypeOriginalSignal:v>=0?1:-1});}}if(pTxs.length===0&&content.length>100)showFeedback("Nenhuma transação OFX.",'info');else if(pTxs.length>0)showFeedback(`${pTxs.length} transações OFX.`,'success');return pTxs;};
        const parseExcelCsv = (data,ext,isTxt) => { const pTxs=[];try{const wb=XLSX.read(data,{type:isTxt?'string':'binary',cellDates:true});const ws=wb.Sheets[wb.SheetNames[0]];const json=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:""});if(json.length===0){showFeedback(`Arquivo ${ext} vazio.`,'info');return pTxs;}let hR=-1,dC=-1,dsC=-1,vC=-1,tC=-1;const kw={date:['data','date','dt.'],desc:['descricao','descrição','description','histórico','historico','memo','lançamento','lancamento'],value:['valor','value','montante','amount','crédito','credito','débito','debito'],type:['tipo','type','natureza','t']};for(let i=0;i<Math.min(json.length,15);i++){const r=json[i];if(Array.isArray(r)&&r.some(c=>String(c||'').trim()!=='')){const lcR=r.map(c=>String(c||'').toLowerCase().trim());if(dC===-1)dC=lcR.findIndex(h=>kw.date.some(k=>h.includes(k)));if(dsC===-1)dsC=lcR.findIndex(h=>kw.desc.some(k=>h.includes(k)));if(vC===-1)vC=lcR.findIndex(h=>kw.value.some(k=>h.includes(k)));if(tC===-1)tC=lcR.findIndex(h=>kw.type.some(k=>h.includes(k)));if(dC!==-1&&dsC!==-1&&vC!==-1){hR=i;break;}}}if(dC===-1||dsC===-1||vC===-1){showFeedback(`Colunas (Data, Descrição, Valor) não encontradas no ${ext}.`,'error');return pTxs;}const sIdx=hR===-1?0:hR+1;for(let i=sIdx;i<json.length;i++){const r=json[i];if(!Array.isArray(r)||r.every(c=>String(c||'').trim()===''))continue;const dR=r[dC],de=String(r[dsC]||'').trim(),vR=String(r[vC]||'0').trim(),tyR=tC!==-1?String(r[tC]||'').toLowerCase().trim():'';if(!de&&!vR)continue;const fD=formatDateFromVariousFormats(dR,currentYear)||new Date().toISOString().split('T')[0];const vRes=parseCurrencyValue(vR);const val=vRes.value;let type='despesa',fundT='despesa',origSig=-1;if(vRes.isCredit===true){type='receita';fundT='receita';origSig=1;}else if(vRes.isCredit===false){type='despesa';fundT='despesa';origSig=-1;}else{const dL=de.toLowerCase();if(val>0&&(dL.includes('crédito')||dL.includes('recebimento')||dL.includes('salário'))){type='receita';fundT='receita';origSig=1;}else if(val>0&&(tyR.includes('receita')||tyR.includes('credit')||tyR.includes('crédito')||tyR.includes('c')||tyR.startsWith('r'))){type='receita';fundT='receita';origSig=1;}else if(val>0&&(tyR.includes('despesa')||tyR.includes('debit')||tyR.includes('débito')||tyR.includes('d')||tyR.startsWith('d'))){type='despesa';fundT='despesa';origSig=-1;}else if(val<0){type='despesa';fundT='despesa';origSig=-1;}if(val>0&&type!=='receita'){type='despesa';fundT='despesa';origSig=-1;}}if(val===0&&tyR){if(tyR.includes('receita')||tyR.includes('credit')||tyR.includes('crédito')||tyR.includes('c')||tyR.startsWith('r')){type='receita';fundT='receita';origSig=1;}}if(!isNaN(val)&&de)pTxs.push({id:generateUniqueId(),date:fD,description:de,value:Math.abs(val),type,fundamentalType:fundT,category:`Importado ${ext.toUpperCase()}`,accountId:'',isCreditCard:false,installments:'1/1',isPaid:true,fundamentalTypeOriginalSignal:origSig});}}catch(e){console.error(`Erro parseExcelCsv (${ext}):`,e);showFeedback(`Erro ao ler ${ext}.`,'error');return[];}if(pTxs.length===0&&data.length>10)showFeedback(`Nenhuma transação ${ext} encontrada.`,'info');else if(pTxs.length>0)showFeedback(`${pTxs.length} transações ${ext} carregadas.`,'success');return pTxs;};
        const processAndStructureTextLines = (text, fileName) => { const lines = text.split('\n').filter(line => line.trim().length > 3); return lines.map(originalLine => { let line = originalLine.trim(); let extractedDateStr = null; let valueResult = { value: 0, isCredit: null, extractedString: "", lineRemainder: line }; let installmentResult = { paid: 1, total: 1, matchedText: "", lineRemainder: line }; let dueDateText = ""; const datePatterns = [ /(\d{1,2}[\/\.]\d{1,2}[\/\.]\d{4})/g, /(\d{1,2}[\/\.]\d{1,2}[\/\.]\d{2})/g, /(\d{4}-\d{1,2}-\d{1,2})/g, /(\d{1,2}[\/\.]\d{1,2})/g ]; let bestDateMatch = null; for (const pattern of datePatterns) { const matches = Array.from(line.matchAll(pattern)); if (matches.length > 0) { for (const match of matches) { const potentialDate = formatDateFromVariousFormats(match[0], currentYear); if (potentialDate) { bestDateMatch = { date: potentialDate, text: match[0] }; break; } } if (bestDateMatch) break; } } if (bestDateMatch) { extractedDateStr = bestDateMatch.date; line = line.replace(bestDateMatch.text, '').trim(); } else { extractedDateStr = new Date().toISOString().split('T')[0]; } valueResult = parseCurrencyValue(line); line = valueResult.lineRemainder; installmentResult = extractInstallmentInfo(line); line = installmentResult.lineRemainder; let remainingLineForDueDateSearch = line; const dueDateMatches = []; for (const pattern of datePatterns) { const matches = Array.from(remainingLineForDueDateSearch.matchAll(pattern)); matches.forEach(match => { const potentialDueDate = formatDateFromVariousFormats(match[0], currentYear); if (potentialDueDate && potentialDueDate !== extractedDateStr) { dueDateMatches.push({ date: potentialDueDate, text: match[0] }); remainingLineForDueDateSearch = remainingLineForDueDateSearch.replace(match[0], '').trim(); } }); } if (dueDateMatches.length > 0) { dueDateText = ` (Venc. ${new Date(dueDateMatches[0].date).toLocaleDateString('pt-BR')})`; line = remainingLineForDueDateSearch; } let finalDescription = line.trim() || "Revisar descrição"; if (dueDateText) { finalDescription += dueDateText; } let extractedValue = valueResult.value; let extractedType = 'despesa'; let fundamentalType = 'despesa'; let originalSignal = -1; if (valueResult.isCredit === true) { extractedType = 'receita'; fundamentalType = 'receita'; originalSignal = 1; } else if (valueResult.isCredit === false) { extractedType = 'despesa'; fundamentalType = 'despesa'; originalSignal = -1; } else { const descLower = finalDescription.toLowerCase(); if (extractedValue > 0 && (descLower.includes('crédito') || descLower.includes('receb') || descLower.includes('salário'))) { extractedType = 'receita'; fundamentalType = 'receita'; originalSignal = 1;} else if (extractedValue > 0) {extractedType = 'receita'; fundamentalType = 'receita'; originalSignal = 1;} else {extractedType = 'despesa'; fundamentalType = 'despesa'; originalSignal = -1;} } return { id: generateUniqueId(), date: extractedDateStr, description: finalDescription.replace(/\s+/g, ' ').trim(), value: extractedValue, type: extractedType, fundamentalType: fundamentalType, category: 'Revisar Importação', accountId: '', isCreditCard: false, installments: `${installmentResult.paid}/${installmentResult.total}`, isPaid: false, fundamentalTypeOriginalSignal: originalSignal, installmentsTotal: installmentResult.total, installmentsPaid: installmentResult.paid }; }).filter(tx => tx.description.toLowerCase() !== "revisar descrição" || tx.value > 0); };
        const parseWord = async (file) => { if (typeof mammoth === 'undefined') { showFeedback('Biblioteca Word não carregada.', 'error'); finalizeImportProcessing([]); return []; } showFeedback("Extraindo texto do Word...", 'info'); try { const { value } = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() }); if (value && value.trim()) { const parsed = processAndStructureTextLines(value, file.name); showFeedback(`${parsed.length} linhas do Word para revisão.`, "info"); return parsed; } else { showFeedback("Nenhum texto no Word.", 'info'); return []; } } catch (err) { console.error("Erro Word:", err); showFeedback("Erro ao extrair do Word.", 'error'); return []; } };
        const parseImage = async (file) => { if (typeof Tesseract === 'undefined' || typeof Tesseract.createWorker !== 'function') { showFeedback('Biblioteca OCR não carregada.', 'error'); finalizeImportProcessing([]); return []; } showFeedback("Processando imagem OCR...", 'info'); try { const worker = await Tesseract.createWorker('por', 1, { logger: m => { if (m.status === 'recognizing text') showFeedback(`OCR: ${m.status} ${Math.round(m.progress * 100)}%`, 'info'); } }); const { data: { text } } = await worker.recognize(file); await worker.terminate(); if (text && text.trim()) { const parsed = processAndStructureTextLines(text, file.name); showFeedback(`${parsed.length} linhas da Imagem (OCR) para revisão.`, "info"); return parsed; } else { showFeedback("Nenhum texto OCR na imagem.", 'info'); return []; } } catch (err) { console.error("Erro OCR:", err); showFeedback("Erro OCR imagem.", 'error'); return []; } };
        importHeader.addEventListener('click', () => { importSectionContent.classList.toggle('hidden'); importArrow.classList.toggle('rotated'); });
        importFileBtn.addEventListener('click', async () => { const file = fileInput.files[0]; if (!file) { showFeedback('Selecione um arquivo.', 'error'); return; } importedTransactionsToReview = []; importedTransactionsTableBody.innerHTML = ''; importReviewSection.classList.add('hidden'); fileInput.disabled = true; importFileBtn.disabled = true; const reader = new FileReader(); const fileExt = file.name.split('.').pop().toLowerCase(); let parsedData = []; try { if (fileExt==='ofx'){reader.onload=(e)=>{try{parsedData=parseOFX(e.target.result);finalizeImportProcessing(parsedData);}catch(err){handleImportError(err,"OFX");}};reader.onerror=()=>handleImportError(new Error("Erro OFX."),"OFX");reader.readAsText(file);} else if(fileExt==='csv'){reader.onload=(e)=>{try{parsedData=parseExcelCsv(e.target.result,fileExt,true);finalizeImportProcessing(parsedData);}catch(err){handleImportError(err,"CSV");}};reader.onerror=()=>handleImportError(new Error("Erro CSV."),"CSV");reader.readAsText(file,'ISO-8859-1');} else if(['xls','xlsx'].includes(fileExt)){reader.onload=(e)=>{try{parsedData=parseExcelCsv(e.target.result,fileExt,false);finalizeImportProcessing(parsedData);}catch(err){handleImportError(err,"Excel");}};reader.onerror=()=>handleImportError(new Error("Erro Excel."),"Excel");reader.readAsBinaryString(file);} else if(['doc','docx'].includes(fileExt)){if(fileExt==='doc'&&(typeof mammoth==='undefined'||!mammoth.extractRawText)){showFeedback('.doc não suportado. Tente .docx.','info');finalizeImportProcessing([]);return;}parsedData=await parseWord(file);finalizeImportProcessing(parsedData);} else if(['png','jpg','jpeg','gif','bmp','tiff','webp'].includes(fileExt)){parsedData=await parseImage(file);finalizeImportProcessing(parsedData);} else{showFeedback(`Formato .${fileExt} não suportado.`,'error');finalizeImportProcessing([]);}} catch (error) { handleImportError(error, `arquivo ${fileExt}`); }});
        renderImportedTransactionsForReview = () => { importedTransactionsTableBody.innerHTML = ''; if (!importedTransactionsToReview || importedTransactionsToReview.length === 0) { importReviewSection.classList.add('hidden'); return; } importedTransactionsToReview.forEach((tx, idx) => { const tr = document.createElement('tr'); tr.className = 'bg-white hover:bg-gray-50'; let accOpts = accounts.map(a=>`<option value="${a.id}" ${tx.accountId===a.id?'selected':''}>${a.name} (${a.type==='overdraft'?'C.Especial':'Dinheiro'})</option>`).join(''); let cardOpts = creditCards.map(c=>`<option value="${c.id}" ${tx.accountId===c.id?'selected':''}>${c.name} (Cartão)</option>`).join(''); const valFmt = typeof tx.value==='number'?tx.value.toFixed(2):'0.00'; const instTotal=tx.installmentsTotal||(tx.installments?parseInt(tx.installments.split('/')[1]):1)||1; const instPaid=tx.installmentsPaid||(tx.installments?parseInt(tx.installments.split('/')[0]):(tx.isPaid?1:0))||0; tr.innerHTML = `<td class="px-2 py-2"><input type="date" class="date-input w-full border rdd px-1 py-0.5 text-xs" value="${tx.date||new Date().toISOString().split('T')[0]}" data-index="${idx}"></td> <td class="px-2 py-2"><textarea class="description-input w-full border rdd px-1 py-0.5 text-xs" data-index="${idx}" rows="2">${tx.description||''}</textarea></td> <td class="px-2 py-2"><input type="number" step="0.01" class="value-input w-24 border rdd px-1 py-0.5 text-xs" value="${valFmt}" data-index="${idx}"></td> <td class="px-2 py-2"><select class="type-input w-full border rdd px-1 py-0.5 text-xs" data-index="${idx}"><option value="receita" ${tx.type==='receita'?'selected':''}>Receita</option><option value="despesa" ${tx.type==='despesa'?'selected':''}>Despesa</option><option value="saque" ${tx.type==='saque'?'selected':''}>Saque</option><option value="pix_enviado" ${tx.type==='pix_enviado'?'selected':''}>PIX Enviado</option><option value="pix_recebido" ${tx.type==='pix_recebido'?'selected':''}>PIX Recebido</option></select></td> <td class="px-2 py-2"><select class="category-input w-full border rdd px-1 py-0.5 text-xs" data-index="${idx}">${categories.sort((a,b)=>a.localeCompare(b)).map(c=>`<option value="${c}" ${tx.category===c?'selected':''}>${c}</option>`).join('')}<option value="nova-categoria-review">Adicionar Nova...</option></select><input type="text" class="new-category-input-review hidden w-full border rdd px-1 py-0.5 text-xs mt-1" placeholder="Nova Cat." data-index="${idx}" value="${!categories.includes(tx.category)&&tx.category!=='Outros'&&!tx.category?.startsWith('Importado')?tx.category:''}"></td> <td class="px-2 py-2"><div class="flex space-x-1"><input type="number" min="1" value="${instTotal}" class="installments-total-review w-16 border rdd px-1 py-0.5 text-xs" data-index="${idx}" title="Total Parcelas"><input type="number" min="0" value="${instPaid}" class="installments-paid-review w-16 border rdd px-1 py-0.5 text-xs" data-index="${idx}" title="Parcelas Pagas"></div></td> <td class="px-2 py-2"><select class="account-select-review w-full border rdd px-1 py-0.5 text-xs" data-index="${idx}"><option value="">Não Vincular</option>${accOpts}${cardOpts}</select></td> <td class="px-2 py-2"><select class="paid-status-input w-full border rdd px-1 py-0.5 text-xs" data-index="${idx}"><option value="false" ${!tx.isPaid?'selected':''}>Não Pago</option><option value="true" ${tx.isPaid?'selected':''}>Pago</option></select></td>`; importedTransactionsTableBody.appendChild(tr); const accSelEl=tr.querySelector('.account-select-review');if(tx.accountId)accSelEl.value=tx.accountId;const catInEl=tr.querySelector('.category-input');const newCatInEl=tr.querySelector('.new-category-input-review');if(!categories.includes(tx.category)&&tx.category&&tx.category!=='Outros'&&!tx.category?.startsWith('Importado')){catInEl.value='nova-categoria-review';newCatInEl.classList.remove('hidden');}tr.querySelector('.date-input').addEventListener('change',(e)=>importedTransactionsToReview[idx].date=e.target.value);tr.querySelector('.description-input').addEventListener('input',(e)=>importedTransactionsToReview[idx].description=e.target.value);tr.querySelector('.value-input').addEventListener('change',(e)=>{const v=parseFloat(e.target.value)||0;const s=importedTransactionsToReview[idx].fundamentalTypeOriginalSignal||(v>=0?1:-1);importedTransactionsToReview[idx].value=Math.abs(v);if(v!==0)importedTransactionsToReview[idx].fundamentalType=v*s>=0?'receita':'despesa';else importedTransactionsToReview[idx].fundamentalType=s>0?'receita':'despesa';if(['receita','despesa'].includes(importedTransactionsToReview[idx].type)||!importedTransactionsToReview[idx].type){importedTransactionsToReview[idx].type=importedTransactionsToReview[idx].fundamentalType;tr.querySelector('.type-input').value=importedTransactionsToReview[idx].type;}});tr.querySelector('.type-input').addEventListener('change',(e)=>{const nT=e.target.value;importedTransactionsToReview[idx].type=nT;if(nT==='receita'||nT==='pix_recebido'){importedTransactionsToReview[idx].fundamentalType='receita';importedTransactionsToReview[idx].fundamentalTypeOriginalSignal=1;}else{importedTransactionsToReview[idx].fundamentalType='despesa';importedTransactionsToReview[idx].fundamentalTypeOriginalSignal=-1;}});catInEl.addEventListener('change',(e)=>{if(e.target.value==='nova-categoria-review'){newCatInEl.classList.remove('hidden');newCatInEl.focus();importedTransactionsToReview[idx].category='';}else{newCatInEl.classList.add('hidden');newCatInEl.value='';importedTransactionsToReview[idx].category=e.target.value;}});newCatInEl.addEventListener('blur',(e)=>{if(e.target.value.trim()&&catInEl.value==='nova-categoria-review')importedTransactionsToReview[idx].category=e.target.value.trim();});accSelEl.addEventListener('change',(e)=>{importedTransactionsToReview[idx].accountId=e.target.value;importedTransactionsToReview[idx].isCreditCard=e.target.value?creditCards.some(c=>c.id===e.target.value):false;});tr.querySelector('.paid-status-input').addEventListener('change',(e)=>importedTransactionsToReview[idx].isPaid=e.target.value==='true');const instTotEl=tr.querySelector('.installments-total-review');const instPaidEl=tr.querySelector('.installments-paid-review');instTotEl.addEventListener('change',(e)=>{let t=parseInt(e.target.value)||1;if(t<1)t=1;e.target.value=t;importedTransactionsToReview[idx].installmentsTotal=t;if(parseInt(instPaidEl.value)>t){instPaidEl.value=t;importedTransactionsToReview[idx].installmentsPaid=t;}});instPaidEl.addEventListener('change',(e)=>{const t=parseInt(instTotEl.value)||1;let p=parseInt(e.target.value)||0;if(p<0)p=0;if(p>t)p=t;e.target.value=p;importedTransactionsToReview[idx].installmentsPaid=p;});});};
        
        // --- Confirmação de Importação ---
        confirmImportBtn.addEventListener('click', () => { let impCount=0,skipCount=0,impErrs=[];const txsToCommit=[];const tmpAccs=JSON.parse(JSON.stringify(accounts));const tmpCards=JSON.parse(JSON.stringify(creditCards));let newCatsAdded=[];importedTransactionsToReview.forEach((revTx,idx)=>{const catInEl=document.querySelector(`.category-input[data-index="${idx}"]`);const newCatInEl=document.querySelector(`.new-category-input-review[data-index="${idx}"]`);const instTotEl=document.querySelector(`.installments-total-review[data-index="${idx}"]`);const instPaidEl=document.querySelector(`.installments-paid-review[data-index="${idx}"]`);revTx.installmentsTotal=parseInt(instTotEl.value)||1;revTx.installmentsPaid=parseInt(instPaidEl.value)||0;if(catInEl&&catInEl.value==='nova-categoria-review'&&newCatInEl&&newCatInEl.value.trim()){const ncName=newCatInEl.value.trim();if(ncName&&!categories.includes(ncName)&&!newCatsAdded.includes(ncName))newCatsAdded.push(ncName);revTx.category=ncName||'Outros';}else if(catInEl)revTx.category=catInEl.value||'Outros';if(!revTx.fundamentalType)revTx.fundamentalType=(revTx.type==='receita'||revTx.type==='pix_recebido')?'receita':'despesa';if(!revTx.description||isNaN(revTx.value)||revTx.value<0){skipCount++;return;}if(revTx.installmentsTotal>1&&(revTx.fundamentalType==='despesa')){const oVal=revTx.value;const iVal=parseFloat((oVal/revTx.installmentsTotal).toFixed(2));let sInst=0;for(let i=0;i<revTx.installmentsTotal;i++){let cInstVal=(i===revTx.installmentsTotal-1)?parseFloat((oVal-sInst).toFixed(2)):iVal;sInst+=cInstVal;const txDate=new Date(revTx.date);txDate.setMonth(txDate.getMonth()+i);const instTx={...revTx,id:generateUniqueId(),date:txDate.toISOString().split('T')[0],description:`${revTx.description} (${i+1}/${revTx.installmentsTotal})`,value:cInstVal,installments:`${i+1}/${revTx.installmentsTotal}`,isPaid:(i+1)<=revTx.installmentsPaid,originalGroupId:revTx.id};let instValid=true;if(instTx.accountId){const acc=tmpAccs.find(a=>a.id===instTx.accountId);const card=tmpCards.find(c=>c.id===instTx.accountId);if(instTx.isCreditCard&&card){if(instTx.fundamentalType==='despesa')card.availableLimit-=instTx.value;else card.availableLimit+=instTx.value;}else if(acc){if(instTx.isPaid){if(instTx.fundamentalType==='despesa'){if(acc.type==='overdraft'&&(acc.balance-instTx.value<-acc.limit)){impErrs.push(`Parcela ${formatCurrency(instTx.value)} p/ ${acc.name} excede limite.`);instValid=false;}else if(instValid)acc.balance-=instTx.value;}else if(instValid)acc.balance+=instTx.value;}}else{impErrs.push(`Conta/Cartão ID ${instTx.accountId} não encontrado.`);instValid=false;}}if(instValid)txsToCommit.push(instTx);else skipCount++;}impCount++;}else{let txValid=true;if(revTx.accountId){const acc=tmpAccs.find(a=>a.id===revTx.accountId);const card=tmpCards.find(c=>c.id===revTx.accountId);if(revTx.isCreditCard&&card){if(revTx.fundamentalType==='despesa')card.availableLimit-=revTx.value;else card.availableLimit+=revTx.value;}else if(acc){if(revTx.isPaid){if(revTx.fundamentalType==='despesa'){if(acc.type==='overdraft'&&(acc.balance-revTx.value<-acc.limit)){impErrs.push(`Importada de ${formatCurrency(revTx.value)} p/ ${acc.name} excede limite.`);txValid=false;}else if(txValid)acc.balance-=revTx.value;}else if(txValid)acc.balance+=revTx.value;}}else{impErrs.push(`Conta/Cartão ID ${revTx.accountId} não encontrado.`);txValid=false;}}if(txValid){txsToCommit.push({...revTx,id:generateUniqueId(),installments:'1/1'});impCount++;}else skipCount++;}});if(newCatsAdded.length>0){categories.push(...newCatsAdded);saveCategories();populateCategorySelect();populateCategorySelect(editCategorySelect);if(!importReviewSection.classList.contains('hidden'))renderImportedTransactionsForReview();}if(impErrs.length>0){showFeedback(`Erro(s) importação: ${impErrs.join(' ')} ${skipCount>0?(impCount>0?'Outras ':'')+skipCount+' ignoradas.':''}`,'error');if(impCount===0)return;}transactions.push(...txsToCommit);accounts=tmpAccs;creditCards=tmpCards;saveTransactions();saveAccounts();saveCreditCards();renderTransactions();updateSummary();renderMonthlySummary();renderDetailedCardBills();checkCreditCardDueDates();importedTransactionsToReview=[];importedTransactionsTableBody.innerHTML='';importReviewSection.classList.add('hidden');let fbMsg=`Importação: ${impCount} transação(ões) processada(s).`;if(skipCount>0&&impErrs.length===0)fbMsg+=` ${skipCount} ignorada(s).`;else if(skipCount>0&&impErrs.length>0&&impCount>0)fbMsg+=` ${skipCount} adicional(is) ignorada(s).`;showFeedback(fbMsg,impCount>0?'success':(impErrs.length>0?'error':'info'));});
        cancelReviewBtn.addEventListener('click', () => { importedTransactionsToReview = []; importedTransactionsTableBody.innerHTML = ''; importReviewSection.classList.add('hidden'); fileInput.value = ''; showFeedback('Importação cancelada.', 'info'); fileInput.disabled = false; importFileBtn.disabled = false; });
        
        // --- Funções de Download, Faturas, Notificações, Metas (sem alterações significativas na lógica central) ---
        downloadXlsxBtn.addEventListener('click', () => { const bom=new Date(currentYear,currentMonth,1);bom.setHours(0,0,0,0);const dataExp=transactions.filter(t=>{const td=new Date(t.date);td.setHours(0,0,0,0);return(td.getMonth()===currentMonth&&td.getFullYear()===currentYear)||(td<bom&&!t.isPaid);}).sort((a,b)=>new Date(a.date)-new Date(b.date)).map(t=>{let typeD=t.type;if(t.type==='pix_enviado')typeD='PIX Enviado';else if(t.type==='pix_recebido')typeD='PIX Recebido';else if(t.type==='saque')typeD='Saque';else if(t.type==='receita')typeD='Receita';else if(t.type==='despesa')typeD='Despesa';return{Data:new Date(t.date).toLocaleDateString('pt-BR'),Descrição:t.description,Valor:t.value,Tipo:typeD,Categoria:t.category,'Conta / Cartão':t.accountId?(t.isCreditCard?(creditCards.find(c=>c.id===t.accountId)?.name||'N/A'):(accounts.find(a=>a.id===t.accountId)?.name||'N/A')):"Não Vinculada",Parcela:t.installments,Pago:t.isPaid?'Sim':'Não'}});if(dataExp.length===0){showFeedback('Não há transações para baixar.','info');return;}const ws=XLSX.utils.json_to_sheet(dataExp);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Transacoes");const mName=new Date(currentYear,currentMonth).toLocaleDateString('pt-BR',{month:'long'});XLSX.writeFile(wb,`transacoes_${mName}_${currentYear}.xlsx`);showFeedback('Planilha baixada!','success');});
        detailedCardBillsHeader.addEventListener('click',()=>{detailedCardBillsContent.classList.toggle('hidden');detailedCardBillsArrow.classList.toggle('rotated');});
        const renderDetailedCardBills=()=>{detailedCardBillsList.innerHTML='';if(creditCards.length===0){noCardBillsMessage.classList.remove('hidden');return;}else noCardBillsMessage.classList.add('hidden');creditCards.forEach(card=>{const bill=transactions.reduce((s,t)=>(t.accountId===card.id&&t.isCreditCard&&t.fundamentalType==='despesa'&&!t.isPaid&&new Date(t.date).getMonth()===currentMonth&&new Date(t.date).getFullYear()===currentYear)?s+t.value:s,0);const li=document.createElement('li');li.className='p-4 flex justify-between items-center';li.innerHTML=`<div class="font-semibold">${card.name}: <span class="text-purple-700">${formatCurrency(bill)}</span></div><div class="text-sm text-gray-600">Venc. dia ${card.dueDay}</div>`;detailedCardBillsList.appendChild(li);});};
        const checkCreditCardDueDates = () => { const today=new Date();today.setHours(0,0,0,0);creditCards.forEach(card=>{const dueDay=card.dueDay;let billDueDate=new Date(today.getFullYear(),today.getMonth(),dueDay);billDueDate.setHours(0,0,0,0);if(today.getDate()>dueDay)billDueDate.setMonth(today.getMonth()+1);let billClosingDate=new Date(billDueDate.getTime());billClosingDate.setDate(billDueDate.getDate()-10);billClosingDate.setHours(0,0,0,0);if(today.getTime()===billClosingDate.getTime()){const closingBill=transactions.reduce((s,t)=>{const tD=new Date(t.date);let cSA=new Date(billClosingDate);cSA.setDate(cSA.getDate()-(card.dueDay>10?30:28));if(t.accountId===card.id&&t.isCreditCard&&t.fundamentalType==='despesa'&&tD>=cSA&&tD<billClosingDate)return s+t.value;return s;},0);if(closingBill>0)showFeedback(`FATURA FECHADA: ${card.name} fechou! Valor: ${formatCurrency(closingBill)}. Venc.: ${billDueDate.toLocaleDateString('pt-BR')}`,'info');}const diffT=billDueDate.getTime()-today.getTime();const diffD=Math.ceil(diffT/(1000*60*60*24));const billNotify=transactions.reduce((s,t)=>{const tD=new Date(t.date);if(t.accountId===card.id&&t.isCreditCard&&t.fundamentalType==='despesa'&&!t.isPaid&&tD>=billClosingDate&&tD<billDueDate)return s+t.value;return s;},0);if(diffD<=7&&diffD>=0&&billNotify>0)showFeedback(`VENC. PRÓXIMO: ${card.name} vence ${diffD===0?'HOJE':'em '+diffD+' dia(s)'}! Valor: ${formatCurrency(billNotify)}`,'info');});};
        financialGoalsHeader.addEventListener('click',()=>{financialGoalsContent.classList.toggle('hidden');financialGoalsArrow.classList.toggle('rotated');});
        addFinancialGoalForm.addEventListener('submit',(e)=>{e.preventDefault();const name=document.getElementById('goal-name').value.trim();const targetAmount=parseFloat(document.getElementById('goal-target-amount').value);const deadline=document.getElementById('goal-deadline').value;if(!name||isNaN(targetAmount)||targetAmount<=0||!deadline){showFeedback("Preencha campos da meta.","error");return;}if(new Date(deadline)<=new Date()){showFeedback("Prazo da meta deve ser futuro.","error");return;}const newGoal={id:generateUniqueId(),name,targetAmount,deadline,currentAmountSaved:0,aiPlan:"",status:'active'};financialGoals.push(newGoal);saveFinancialGoals();renderFinancialGoals();addFinancialGoalForm.reset();showFeedback(`Meta "${name}" adicionada!`,"success");});
        const renderFinancialGoals = () => { financialGoalsList.innerHTML='';const activeGoals=financialGoals.filter(g=>g.status==='active');if(activeGoals.length===0){noFinancialGoalsMessage.classList.remove('hidden');return;}noFinancialGoalsMessage.classList.add('hidden');activeGoals.forEach(goal=>{const li=document.createElement('li');const deadlineDate=new Date(goal.deadline);const today=new Date();const timeDiff=deadlineDate.getTime()-today.getTime();const daysRem=Math.max(0,Math.ceil(timeDiff/(1000*60*60*24)));const monthsRem=Math.max(0,Math.ceil(daysRem/30.44));li.innerHTML=`<div class="goal-details"><h4 class="text-lg font-semibold text-green-700">${goal.name}</h4><p><strong>Meta:</strong> ${formatCurrency(goal.targetAmount)}</p><p><strong>Prazo:</strong> ${deadlineDate.toLocaleDateString('pt-BR')} (${daysRem} dias / ${monthsRem} meses restantes)</p><p><strong>Status:</strong> ${goal.status==='active'?'Ativa':'Concluída'}</p></div><div class="goal-actions mt-3"><button data-goal-id="${goal.id}" class="complete-goal-btn px-3 py-1.5 text-sm bg-green-500 text-white rounded-md hover:bg-green-600">Marcar Concluída</button><button data-goal-id="${goal.id}" class="delete-goal-btn px-3 py-1.5 text-sm bg-red-500 text-white rounded-md hover:bg-red-600">Excluir</button></div>`;financialGoalsList.appendChild(li);li.querySelector('.complete-goal-btn').addEventListener('click',(e)=>{const gId=e.currentTarget.dataset.goalId;const gIdx=financialGoals.findIndex(g=>g.id===gId);if(gIdx>-1){financialGoals[gIdx].status='completed';saveFinancialGoals();renderFinancialGoals();showFeedback(`Meta "${financialGoals[gIdx].name}" concluída!`,'success');}});li.querySelector('.delete-goal-btn').addEventListener('click',(e)=>{const gId=e.currentTarget.dataset.goalId;financialGoals=financialGoals.filter(g=>g.id!==gId);saveFinancialGoals();renderFinancialGoals();showFeedback("Meta excluída.","info");});});};
        financialGoalsHeader.addEventListener('click',()=>{financialGoalsContent.classList.toggle('hidden');financialGoalsArrow.classList.toggle('rotated');});

        // Carregamento inicial
        window.onload = () => {
            loadData();
            updateMonthlyDisplay(); 
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal Unificado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Azul acinzentado claro */
        }
        #feedback-message {
            display: none; padding: 12px; margin-top: 16px; border-radius: 8px; font-weight: 500;
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; min-width: 300px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .feedback-success { background-color: #d1fae5; color: #065f46; }
        .feedback-error { background-color: #fee2e2; color: #991b1b; }
        .feedback-info { background-color: #e0f2fe; color: #075985; }
        .hidden { display: none !important; }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #e2e8f0; margin-bottom: 1rem; }
        .collapsible-header:hover { background-color: #f8fafc; }
        .collapsible-header h2 { margin-bottom: 0; }
        .arrow-icon { transition: transform 0.3s ease; }
        .arrow-icon.rotated { transform: rotate(90deg); }
        .paid-transaction td { text-decoration: line-through; color: #9ca3af; }
        .pending-previous-month td { font-style: italic; }
        .pending-previous-month:not(.paid-transaction) td { font-weight: 600; color: #b91c1c; /* Vermelho mais escuro para pendentes antigos */ }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; overflow-y: auto; }
        .modal-content { background-color: #fff; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); width: 90%; max-width: 700px; margin-top: 2rem; margin-bottom: 2rem; max-height: 90vh; overflow-y: auto;}
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
        .modal-header h3 { font-size: 1.5rem; font-weight: 600; color: #1f2937; }
        .modal-close-btn { background: none; border: none; font-size: 1.75rem; cursor: pointer; color: #6b7280; transition: color 0.2s; }
        .modal-close-btn:hover { color: #1f2937; }
        .modal-body label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #4b5563; }
        .modal-body input[type="text"], .modal-body input[type="number"], .modal-body input[type="date"], .modal-body select, .modal-body textarea { 
            width: 100%; padding: 0.625rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 1rem; background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .modal-body input:focus, .modal-body select:focus, .modal-body textarea:focus {
            border-color: #4f46e5; /* Indigo-500 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
            outline: none;
        }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;}
        
        .transaction-type-tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; }
        .transaction-type-tab {
            padding: 0.75rem 1.25rem; cursor: pointer; font-weight: 500; color: #6b7280;
            border-bottom: 2px solid transparent; margin-bottom: -2px;
            transition: color 0.2s, border-color 0.2s;
        }
        .transaction-type-tab:hover { color: #374151; }
        .transaction-type-tab.active { color: #4f46e5; border-color: #4f46e5; }

        #reports-section-content .report-table th, #reports-section-content .report-table td { padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; text-align: left; }
        #reports-section-content .report-table th { background-color: #f8fafc; font-weight: 600; }
        #reports-section-content .report-table td:nth-child(n+2) { text-align: right; }
        .account-item-header { cursor: pointer; display: flex; align-items: center; }
        .account-item-header .arrow-icon { margin-left: 0.5rem; }
        .account-details-content { padding-left: 1.5rem; margin-top: 0.5rem; }
        #detailed-statement-modal .modal-content, #edit-account-modal .modal-content { max-height: 80vh; }
        #confirmation-modal .modal-content { max-width: 400px; }
        
        #suggested-goals-list .goal-card { 
            background-color: #eef2ff;
            padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; 
            border: 1px solid #c7d2fe;
        }
        #suggested-goals-list .goal-card strong { color: #4338ca; }
        #suggested-goals-list .goal-card p { font-size: 0.9rem; color: #374151; }

        #clear-all-data-link, #save-all-data-link, #load-saved-data-btn { font-size: 0.8rem; color: #6b7280; text-decoration: underline; cursor: pointer; }
        #clear-all-data-link:hover, #save-all-data-link:hover, #load-saved-data-btn:hover { color: #ef4444; }
        #save-all-data-link:hover { color: #16a34a; } 
        #load-saved-data-btn:hover { color: #4f46e5; }


        .add-transaction-main-btn {
            padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 500;
            background-color: #4f46e5; color: white;
            transition: background-color 0.2s;
        }
        .add-transaction-main-btn:hover { background-color: #4338ca; }

        .sub-section-form { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; background-color: #f9fafb;}
        .sub-section-form h4 { font-size: 1rem; font-weight: 600; color: #4b5563; margin-bottom: 0.75rem; }
        .input-xs { font-size: 0.875rem; padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; } 
        .btn-xs { padding: 0.25rem 0.75rem; font-size: 0.875rem; border-radius: 0.375rem; font-weight: 500; color: white; } 
        .th-xs { padding: 0.5rem 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; color: #4b5563;} 
        .table-action-btn { padding: 0.25rem; border-radius: 0.25rem; transition: background-color 0.2s; }
        .table-action-btn:hover { background-color: #e5e7eb; }
        .filters-collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .filters-collapsible-content.expanded { max-height: 500px; }


    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-10">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-xl p-6 sm:p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 flex-grow text-center">Controle Financeiro Pessoal Unificado</h1>
            <div class="flex items-center space-x-3 ml-4 whitespace-nowrap">
                <button id="clear-all-data-link">Limpar Dados</button>
            </div>
        </div>

        <!-- Painel de Resumo -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-10">
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-blue-800">Poder de Compra Total</h2>
                <p id="total-poder-compra" class="text-2xl font-bold text-blue-700">R$ 0,00</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-red-800">Despesas do Mês</h2>
                <p id="total-despesas" class="text-2xl font-bold text-red-700">R$ 0,00</p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-green-800">Saldo Contas (Líquido)</h2>
                <p id="saldo-liquido-contas" class="text-2xl font-bold text-green-700">R$ 0,00</p>
            </div>
            <div class="bg-orange-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-orange-800">Faturas Cartões (Mês)</h2>
                <p id="total-faturas-cartoes-mes" class="text-2xl font-bold text-orange-700">R$ 0,00</p>
            </div>
        </div>

        <!-- Gerenciar Contas -->
        <div class="mb-10 border-b pb-8 border-gray-200">
             <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gerenciar Contas</h2>
            <div class="p-6 bg-gray-50 rounded-lg shadow-sm mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Conta</h3>
                <form id="add-account-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="account-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Conta</label>
                            <input type="text" id="account-name" placeholder="Ex: Banco X, Carteira" required class="w-full input-sm">
                        </div>
                        <div>
                            <label for="account-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Conta</label>
                            <select id="account-type" class="w-full input-sm">
                                <option value="corrente">Conta Corrente</option>
                                <option value="poupanca">Conta Poupança</option>
                                <option value="cash">Dinheiro (Caixa)</option>
                                <option value="investimento">Investimento</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label for="initial-balance" class="block text-sm font-medium text-gray-700 mb-1">Saldo Inicial (R$)</label>
                            <input type="number" id="initial-balance" step="0.01" placeholder="0.00" required class="w-full input-sm">
                        </div>
                    </div>

                    <div id="overdraft-section" class="hidden sub-section-form">
                        <h4>Cheque Especial</h4>
                        <div>
                            <label for="overdraft-limit" class="block text-sm font-medium text-gray-700 mb-1">Limite do Cheque Especial (R$)</label>
                            <input type="number" id="overdraft-limit" step="0.01" placeholder="0.00" class="w-full input-sm">
                        </div>
                    </div>

                    <div id="credit-card-section" class="hidden sub-section-form">
                        <h4>Cartões de Crédito Vinculados a esta Conta</h4>
                        <div id="linked-cards-container" class="space-y-3"></div>
                        <button type="button" id="add-another-card-btn" class="mt-3 px-4 py-1.5 bg-purple-500 text-white text-xs font-semibold rounded-md hover:bg-purple-600">Adicionar Cartão a esta Conta</button>
                    </div>
                     <div class="flex justify-end pt-3">
                        <button type="submit" class="px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 transition duration-150">Adicionar Conta</button>
                    </div>
                </form>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Minhas Contas</h3>
                <ul id="accounts-list" class="bg-white rounded-lg shadow divide-y divide-gray-200"></ul>
            </div>
        </div>
        
        <div class="mb-10 border-b pb-8 border-gray-200">
            <div id="suggested-goals-header" class="collapsible-header">
                <h2 class="text-2xl font-semibold text-gray-700">Sugestões de Metas Financeiras</h2>
                <svg id="suggested-goals-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
            <div id="suggested-goals-content" class="hidden p-4 bg-gray-50 rounded-lg shadow-sm mt-4">
                <ul id="suggested-goals-list" class="space-y-3"></ul>
                <p id="no-suggested-goals-message" class="text-center text-gray-500 mt-2 hidden">Nenhuma sugestão de meta no momento.</p>
            </div>
        </div>

        <div class="mb-10 border-b pb-8 border-gray-200">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-semibold text-gray-700">Transações</h2>
                 <button id="open-add-transaction-modal-main-btn" class="add-transaction-main-btn flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Adicionar Transação
                </button>
            </div>
        </div>


        <div id="feedback-message"></div>

        <div class="mb-10 border-b pb-8 border-gray-200">
            <div id="reports-header" class="collapsible-header"><h2 class="text-2xl font-semibold text-gray-700">Relatórios de Gastos</h2><svg id="reports-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
            <div id="reports-section-content" class="hidden mt-4">
                <div class="p-6 bg-gray-50 rounded-lg shadow-sm mb-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Configurar Relatório</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-4 items-end mb-6">
                        <div>
                            <label for="report-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Relatório</label>
                            <select id="report-type" class="mt-1 block w-full input-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="monthly">Gastos Mensais por Categoria</option>
                                <option value="annual">Gastos Anuais por Categoria</option>
                                <option value="comparison_monthly">Comparativo Mensal (Categorias)</option>
                                <option value="comparison_annual">Comparativo Anual (Categorias)</option>
                            </select>
                        </div>
                        <div id="report-period1-month-div">
                            <label for="report-month" class="block text-sm font-medium text-gray-700 mb-1">Mês (Período 1)</label>
                            <select id="report-month" class="mt-1 block w-full input-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div id="report-period1-year-div">
                            <label for="report-year" class="block text-sm font-medium text-gray-700 mb-1">Ano (Período 1)</label>
                            <select id="report-year" class="mt-1 block w-full input-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div id="report-period2-month-div" class="hidden">
                            <label for="report-month-comp" class="block text-sm font-medium text-gray-700 mb-1">Mês (Período 2)</label>
                            <select id="report-month-comp" class="mt-1 block w-full input-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div id="report-period2-year-div" class="hidden">
                            <label for="report-year-comp" class="block text-sm font-medium text-gray-700 mb-1">Ano (Período 2)</label>
                            <select id="report-year-comp" class="mt-1 block w-full input-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div class="md:col-span-3 flex justify-end mt-2">
                             <button id="generate-report-btn" class="px-6 py-2.5 bg-teal-600 text-white font-semibold rounded-md shadow-md hover:bg-teal-700 transition duration-150">Gerar Relatório</button>
                        </div>
                    </div>
                </div>
                <div id="report-output-area" class="mt-6 p-4 bg-white rounded-lg shadow">
                     <p class="text-center text-gray-500 italic">Selecione os filtros e clique em "Gerar Relatório" para visualizar os dados.</p>
                </div>
            </div>
        </div>

        <div class="mb-10 border-b pb-8 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Opções de Dados</h2>
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <button id="download-xlsx-btn" class="w-full sm:w-auto px-6 py-2.5 bg-gray-600 text-white font-semibold rounded-md shadow-md hover:bg-gray-700 transition duration-150">Baixar Transações (Excel)</button>
                <a href="#" id="save-all-data-link" class="text-sm text-green-600 hover:text-green-800 underline">Salvar Todos os Dados (JSON)</a>
                <button id="load-saved-data-btn" class="w-full sm:w-auto px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 transition duration-150">Carregar Dados Salvos (JSON)</button>
                <input type="file" id="load-json-input" class="hidden" accept=".json">
            </div>
        </div>

        <!-- Minhas Transações (Reformulado) -->
        <div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-semibold text-gray-700">Histórico de Transações</h2>
                <div class="flex items-center w-full md:w-auto">
                     <input type="text" id="search-transactions-input" placeholder="Buscar por descrição, categoria..." class="input-sm w-full md:w-64 px-4 py-2 border border-gray-300 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="toggle-filters-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-r-md hover:bg-gray-300 transition ml-[-1px]">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 12h9.75m-9.75 6h9.75M3.75 6H7.5m3 12V6.75M3.75 12h3.75m-3.75 6h3.75M3.75 6.75A.75.75 0 013 6V4.5a.75.75 0 01.75-.75H7.5a.75.75 0 01.75.75V6a.75.75 0 01-.75.75H3.75z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Filtros Avançados (Colapsáveis) -->
            <div id="main-filters-collapsible-content" class="filters-collapsible-content mb-6">
                 <div class="p-4 bg-gray-100 rounded-lg">
                    <div id="main-filters-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                        <div>
                            <label for="filter-main-type" class="text-xs font-medium text-gray-700">Tipo:</label>
                            <select id="filter-main-type" class="filter-main-select mt-1 block w-full input-xs">
                                <option value="all">Todos os Tipos</option>
                                <option value="receita">Receita</option>
                                <option value="despesa">Despesa</option>
                                <option value="transferencia_entrada">Transferência (Entrada)</option>
                                <option value="transferencia_saida">Transferência (Saída)</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-main-category" class="text-xs font-medium text-gray-700">Categoria:</label>
                            <select id="filter-main-category" class="filter-main-select mt-1 block w-full input-xs"> </select>
                        </div>
                        <div>
                            <label for="filter-main-account" class="text-xs font-medium text-gray-700">Conta:</label>
                            <select id="filter-main-account" class="filter-main-select mt-1 block w-full input-xs"> </select>
                        </div>
                        <div>
                            <label for="filter-main-fund-source" class="text-xs font-medium text-gray-700">Fonte Pag.:</label>
                            <select id="filter-main-fund-source" class="filter-main-select mt-1 block w-full input-xs">
                                <option value="all">Todas as Fontes</option>
                                <option value="account_balance">Saldo da Conta</option>
                                <option value="overdraft">Cheque Especial</option>
                                <option value="credit_card_any">Cartão de Crédito (Qualquer)</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-main-status" class="text-xs font-medium text-gray-700">Status:</label>
                            <select id="filter-main-status" class="filter-main-select mt-1 block w-full input-xs">
                                <option value="all">Todos os Status</option>
                                <option value="paid">Realizado</option>
                                <option value="pending">Pendente</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ações em Lote (aparecem quando transações são selecionadas) -->
            <div id="bulk-actions-container" class="mb-4 hidden">
                <span class="text-sm font-medium text-gray-700 mr-3"><span id="selected-transactions-count">0</span> transações selecionadas:</span>
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <button id="pay-selected-transactions-btn" type="button" class="btn-xs bg-green-500 hover:bg-green-600 rounded-l-md">Pagar</button>
                    <button id="unpay-selected-transactions-btn" type="button" class="btn-xs bg-yellow-500 hover:bg-yellow-600">Desm. Pagar</button>
                    <select id="link-selected-account-select" class="input-xs border-l-0 border-r-0"></select>
                    <button id="link-selected-transactions-btn" type="button" class="btn-xs bg-blue-500 hover:bg-blue-600">Vinc. Conta</button>
                    <select id="link-selected-category-select" class="input-xs border-l-0 border-r-0"></select>
                    <button id="link-selected-category-btn" type="button" class="btn-xs bg-indigo-500 hover:bg-indigo-600">Vinc. Cat.</button>
                    <button id="delete-selected-transactions-btn" type="button" class="btn-xs bg-red-500 hover:bg-red-600 rounded-r-md">Excluir</button>
                </div>
            </div>


            <div class="flex items-center space-x-4 mb-4">
                <button id="prev-month-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 text-sm">Mês Anterior</button>
                <span id="current-month-display" class="text-lg font-semibold text-gray-800"></span>
                <button id="next-month-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 text-sm">Próximo Mês</button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-2 py-3 text-center th-xs"><input type="checkbox" id="select-all-transactions" class="form-checkbox h-4 w-4 text-indigo-600"></th>
                            <th class="px-6 py-3 text-left th-xs">Data</th>
                            <th class="px-6 py-3 text-left th-xs">Status</th>
                            <th class="px-6 py-3 text-left th-xs">Descrição</th>
                            <th class="px-6 py-3 text-left th-xs">Valor</th>
                            <th class="px-6 py-3 text-left th-xs">Tipo</th>
                            <th class="px-6 py-3 text-left th-xs">Categoria</th>
                            <th class="px-6 py-3 text-left th-xs">Conta</th>
                            <th class="px-6 py-3 text-left th-xs">Fonte Pagamento</th>
                            <th class="px-6 py-3 text-left th-xs">Parcela</th>
                            <th class="px-6 py-3 text-left th-xs">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <p id="no-transactions-message" class="text-center text-gray-500 mt-6 hidden">Nenhuma transação registrada para este período ou filtro.</p>
        </div>
    </div>

    <!-- Modais -->
    <!-- ... (Todo o código HTML dos modais é mantido igual) ... -->
    
    <!-- Modal: Adicionar/Editar Transação -->
    <div id="add-transaction-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="add-transaction-modal-title">Adicionar Nova Transação</h3>
                <button class="modal-close-btn" id="close-add-transaction-modal">&times;</button>
            </div>
            <div class="modal-body">
                 <!-- Abas para tipo de transação -->
                <div class="transaction-type-tabs mb-6">
                    <button data-type="receita" class="transaction-type-tab active">Receita</button>
                    <button data-type="despesa" class="transaction-type-tab">Despesa</button>
                    <button data-type="transferencia" class="transaction-type-tab">Transferência</button>
                </div>
                <form id="transaction-form-modal" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                    <input type="hidden" id="modal-transaction-id"> 
                    <input type="hidden" id="modal-transaction-type-hidden" value="receita"> <!-- Valor inicial, atualizado pelas abas -->
                    <div>
                        <label for="modal-date">Data</label>
                        <input type="date" id="modal-date" required>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="modal-description">Descrição</label>
                        <input type="text" id="modal-description" placeholder="Ex: Salário, Aluguel da Casa" required>
                    </div>
                    <div>
                        <label for="modal-value">Valor da Parcela (R$)</label>
                        <input type="number" id="modal-value" step="0.01" placeholder="0.00" required>
                    </div>
                    
                    <div id="modal-category-section" class="sm:col-span-2"> <!-- Visível para Receita/Despesa -->
                        <label for="modal-category-select">Categoria</label>
                        <div class="flex items-center space-x-2">
                            <select id="modal-category-select"></select> <!-- required será tratado por JS -->
                        </div>
                        <input type="text" id="modal-new-category-input" placeholder="Nome da Nova Categoria" class="mt-2 hidden">
                    </div>

                    <div id="modal-account-section"> <!-- Conta Principal -->
                        <label for="modal-account-select">Conta Principal</label>
                        <select id="modal-account-select"></select> 
                    </div>
                    
                    <div id="modal-fund-source-div" class="hidden"> <!-- Fonte de Pagamento (para despesas de conta corrente) -->
                        <label for="modal-fund-source-select">Fonte do Pagamento</label>
                        <select id="modal-fund-source-select"></select>
                    </div>

                    <div id="modal-destination-account-div" class="hidden"> <!-- Conta de Destino (para transferências) -->
                        <label for="modal-destination-account-select">Conta de Destino/Origem</label>
                        <select id="modal-destination-account-select"></select>
                    </div>
                    
                    <div>
                        <label for="modal-installments">Total de Parcelas</label>
                        <input type="number" id="modal-installments" min="1" value="1">
                    </div>
                    <div id="modal-installments-paid-section">
                        <label for="modal-installments-paid">Parcelas já pagas/recebidas</label>
                        <input type="number" id="modal-installments-paid" min="0" value="0">
                    </div>
                     <div class="sm:col-span-2">
                        <label for="modal-paid-status" class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="modal-paid-status" class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-700">Marcar como Realizada (Paga/Recebida)</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancel-add-transaction-modal-btn" class="px-5 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 transition duration-150">Cancelar</button>
                <button id="save-add-transaction-modal-btn" type="submit" form="transaction-form-modal" class="px-6 py-2.5 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 transition duration-150">Salvar Transação</button>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Conta -->
    <div id="edit-account-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Conta</h3>
                <button class="modal-close-btn" id="close-edit-account-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-account-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-account-name">Nome da Conta</label>
                        <input type="text" id="edit-account-name" required>
                    </div>
                    <div>
                        <label for="edit-account-type-display">Tipo de Conta</label>
                        <input type="text" id="edit-account-type-display" readonly class="bg-gray-100">
                    </div>
                </div>
                <div>
                    <label for="edit-account-balance">Saldo Atual (R$)</label>
                    <input type="number" id="edit-account-balance" step="0.01" required>
                </div>
                <div id="edit-overdraft-section" class="hidden sub-section-form mt-4">
                    <h4>Cheque Especial</h4>
                    <div>
                        <label for="edit-overdraft-limit">Limite do Cheque Especial (R$)</label>
                        <input type="number" id="edit-overdraft-limit" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div id="edit-credit-card-section" class="hidden sub-section-form mt-4">
                    <h4>Cartões de Crédito Vinculados</h4>
                    <div id="edit-linked-cards-container" class="space-y-3"></div>
                    <button type="button" id="edit-add-another-card-btn" class="mt-3 px-4 py-1.5 bg-purple-500 text-white text-xs font-semibold rounded-md hover:bg-purple-600">Adicionar Novo Cartão a esta Conta</button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-edit-account-btn" class="px-5 py-2 bg-gray-300 text-gray-700 font-semibold rounded-md hover:bg-gray-400">Cancelar</button>
                <button id="save-edit-account-btn" class="px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- Modal: Extrato Detalhado -->
    <div id="detailed-statement-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailed-statement-title">Extrato Detalhado</h3>
                <button class="modal-close-btn" id="close-detailed-statement-modal">&times;</button>
            </div>
            <div class="modal-body overflow-y-auto">
                <div class="mb-4">
                    <label for="statement-source-select" class="block text-sm font-medium text-gray-700 mb-1">Visualizar Extrato de:</label>
                    <select id="statement-source-select" class="w-full input-sm"></select>
                </div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left th-xs">Data</th>
                            <th class="px-4 py-2 text-left th-xs">Descrição</th>
                            <th class="px-4 py-2 text-left th-xs">Valor</th>
                            <th class="px-4 py-2 text-left th-xs">Saldo Após (Opcional)</th>
                            <th class="px-4 py-2 text-left th-xs">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-statement-list" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                <p id="no-detailed-statement-message" class="text-center text-gray-500 mt-4 hidden">Nenhuma transação para este extrato.</p>
            </div>
            <div class="modal-footer">
                <button id="close-detailed-statement-modal-footer" class="px-5 py-2 bg-gray-300 text-gray-700 font-semibold rounded-md hover:bg-gray-400">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmação -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content"><div class="modal-header"><h3 id="confirmation-modal-title">Confirmar</h3><button class="modal-close-btn" id="close-confirmation-modal">&times;</button></div><div class="modal-body"><p id="confirmation-modal-message">Tem certeza?</p></div><div class="modal-footer"><button id="confirm-delete-btn" class="px-5 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">Confirmar</button><button id="cancel-delete-btn" class="px-5 py-2 bg-gray-300 text-gray-700 font-semibold rounded-md hover:bg-gray-400">Cancelar</button></div></div>
    </div>

    <!-- Modal 1: Seleção de Arquivo para Importação -->
    <div id="file-import-selection-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Importar Extrato de Arquivo</h3>
                <button class="modal-close-btn" id="close-file-import-selection-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-gray-600 mb-4">Selecione o arquivo de extrato (OFX, PDF, XLS, XLSX).</p>
                <div>
                    <label for="import-file-input-modal" class="block text-sm font-medium text-gray-700 mb-1">Selecione o Arquivo</label>
                    <input type="file" id="import-file-input-modal" accept=".ofx,.pdf,.xls,.xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer mb-4">
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-file-import-selection-btn" class="px-5 py-2 bg-gray-300 text-gray-700 font-semibold rounded-md hover:bg-gray-400">Cancelar</button>
                <button id="load-file-for-review-btn" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">Carregar para Revisão</button>
            </div>
        </div>
    </div>

    <!-- Modal 2: Revisão de Transações Importadas -->
    <div id="review-imported-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Revisar Transações Importadas</h3>
                <button class="modal-close-btn" id="close-review-imported-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-gray-600 mb-2">Ajuste os dados abaixo. As transações selecionadas serão importadas.</p>
                <div class="overflow-x-auto max-h-[60vh]">
                    <table id="review-imported-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="sticky top-0 bg-gray-100 z-10">
                            <tr>
                                <th class="px-2 py-2 text-center"><input type="checkbox" id="select-all-review-checkbox" checked></th>
                                <th class="text-left">Data</th>
                                <th class="text-left">Descrição</th>
                                <th class="text-left">Valor (R$)</th>
                                <th class="text-left">Tipo</th>
                                <th class="text-left">Categoria</th>
                                <th class="text-left">Parcelas (Paga/Total)</th>
                                <th class="text-left">Conta</th>
                                <th class="text-left">Fonte Pag.</th>
                                <th class="text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody id="review-imported-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                 <p id="no-transactions-to-review-message" class="text-center text-gray-500 mt-4 hidden">Nenhuma transação para revisar.</p>
            </div>
            <div class="modal-footer">
                <button id="cancel-review-import-btn" class="px-5 py-2 bg-gray-300 text-gray-700 font-semibold rounded-md hover:bg-gray-400">Cancelar</button>
                <button id="confirm-reviewed-import-btn" class="px-5 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Confirmar Importação</button>
            </div>
        </div>
    </div>


    <script>
        // --- Variáveis Globais & Configuração Inicial ---
        let accounts = [];
        let transactions = [];
        let categories = ["Alimentação", "Transporte", "Moradia", "Lazer", "Saúde", "Educação", "Salário", "Investimentos", "Contas Fixas", "Compras", "Transferências", "Outros", "Revisar Importação"];
        let importedTransactionsToReview = []; 
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let itemToDelete = { id: null, type: null, showFeedback: true, isBulk: false, ids: [], accountIdForReversal: null, fundSourceForReversal: null };
        let cardFieldCounter = 0;

        // --- Elementos DOM ---
        const openFileImportModalHeader = document.getElementById('open-file-import-modal-header');
        const fileImportArrow = document.getElementById('file-import-arrow'); 
        const fileImportSelectionModal = document.getElementById('file-import-selection-modal');
        const closeFileImportSelectionModalBtn = document.getElementById('close-file-import-selection-modal');
        const cancelFileImportSelectionBtn = document.getElementById('cancel-file-import-selection-btn');
        const importFileInputModal = document.getElementById('import-file-input-modal');
        const loadFileForReviewBtn = document.getElementById('load-file-for-review-btn');

        const reviewImportedModal = document.getElementById('review-imported-modal');
        const closeReviewImportedModalBtn = document.getElementById('close-review-imported-modal');
        const reviewImportedTableBody = document.getElementById('review-imported-table-body');
        const selectAllReviewCheckbox = document.getElementById('select-all-review-checkbox');
        const cancelReviewImportBtn = document.getElementById('cancel-review-import-btn');
        const confirmReviewedImportBtn = document.getElementById('confirm-reviewed-import-btn');
        const noTransactionsToReviewMessage = document.getElementById('no-transactions-to-review-message');
        
        const totalPoderCompraEl = document.getElementById('total-poder-compra');
        const totalDespesasEl = document.getElementById('total-despesas');
        const saldoLiquidoContasEl = document.getElementById('saldo-liquido-contas');
        const totalFaturasCartoesMesEl = document.getElementById('total-faturas-cartoes-mes');
        const addAccountForm = document.getElementById('add-account-form');
        const accountNameInput = document.getElementById('account-name');
        const accountTypeSelect = document.getElementById('account-type');
        const initialBalanceInput = document.getElementById('initial-balance');
        const overdraftSection = document.getElementById('overdraft-section');
        const overdraftLimitInput = document.getElementById('overdraft-limit');
        const creditCardSection = document.getElementById('credit-card-section');
        const linkedCardsContainer = document.getElementById('linked-cards-container');
        const addAnotherCardBtn = document.getElementById('add-another-card-btn');
        const accountsList = document.getElementById('accounts-list');
        const transactionList = document.getElementById('transaction-list');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthDisplay = document.getElementById('current-month-display');
        const searchTransactionsInput = document.getElementById('search-transactions-input');
        
        const addTransactionModal = document.getElementById('add-transaction-modal');
        const closeAddTransactionModalBtn = document.getElementById('close-add-transaction-modal');
        const cancelAddTransactionModalBtn = document.getElementById('cancel-add-transaction-modal-btn');
        const saveAddTransactionModalBtn = document.getElementById('save-add-transaction-modal-btn');
        const transactionFormModal = document.getElementById('transaction-form-modal');
        const addTransactionModalTitle = document.getElementById('add-transaction-modal-title');
        const modalTransactionIdInput = document.getElementById('modal-transaction-id');
        const modalTransactionTypeHiddenInput = document.getElementById('modal-transaction-type-hidden'); 
        const modalDateInput = document.getElementById('modal-date');
        const modalDescriptionInput = document.getElementById('modal-description');
        const modalValueInput = document.getElementById('modal-value');
        const modalCategorySelect = document.getElementById('modal-category-select');
        const modalNewCategoryInput = document.getElementById('modal-new-category-input');
        const modalAccountSelect = document.getElementById('modal-account-select');
        const modalFundSourceDiv = document.getElementById('modal-fund-source-div');
        const modalFundSourceSelect = document.getElementById('modal-fund-source-select');
        const modalDestinationAccountDiv = document.getElementById('modal-destination-account-div');
        const modalDestinationAccountSelect = document.getElementById('modal-destination-account-select');
        const modalInstallmentsInput = document.getElementById('modal-installments');
        const modalInstallmentsPaidInput = document.getElementById('modal-installments-paid');
        const modalPaidStatusCheckbox = document.getElementById('modal-paid-status');
        const modalCategorySection = document.getElementById('modal-category-section');
        const modalInstallmentsPaidSection = document.getElementById('modal-installments-paid-section');


        const editAccountModal = document.getElementById('edit-account-modal');
        const closeEditAccountModalBtn = document.getElementById('close-edit-account-modal');
        const cancelEditAccountBtn = document.getElementById('cancel-edit-account-btn');
        const saveEditAccountBtn = document.getElementById('save-edit-account-btn');
        const editAccountIdInput = document.getElementById('edit-account-id');
        const editAccountNameInput = document.getElementById('edit-account-name');
        const editAccountTypeDisplay = document.getElementById('edit-account-type-display');
        const editAccountBalanceInput = document.getElementById('edit-account-balance');
        const editOverdraftSection = document.getElementById('edit-overdraft-section');
        const editOverdraftLimitInput = document.getElementById('edit-overdraft-limit');
        const editCreditCardSection = document.getElementById('edit-credit-card-section');
        const editLinkedCardsContainer = document.getElementById('edit-linked-cards-container');
        const editAddAnotherCardBtn = document.getElementById('edit-add-another-card-btn');
        const detailedStatementModal = document.getElementById('detailed-statement-modal');
        const closeDetailedStatementModalBtn = document.getElementById('close-detailed-statement-modal');
        const closeDetailedStatementModalFooterBtn = document.getElementById('close-detailed-statement-modal-footer');
        const detailedStatementTitle = document.getElementById('detailed-statement-title');
        const statementSourceSelect = document.getElementById('statement-source-select');
        const detailedStatementList = document.getElementById('detailed-statement-list');
        const noDetailedStatementMessage = document.getElementById('no-detailed-statement-message');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const closeConfirmationModalBtn = document.getElementById('close-confirmation-modal');
        const reportsHeader = document.getElementById('reports-header');
        const reportsSectionContent = document.getElementById('reports-section-content');
        const reportsArrow = document.getElementById('reports-arrow');
        const reportTypeSelect = document.getElementById('report-type');
        const reportMonthSelectorDiv1 = document.getElementById('report-period1-month-div');
        const reportYearSelectorDiv1 = document.getElementById('report-period1-year-div');
        const reportMonthSelectorDiv2 = document.getElementById('report-period2-month-div');
        const reportYearSelectorDiv2 = document.getElementById('report-period2-year-div');
        const reportMonthSelect1 = document.getElementById('report-month');
        const reportYearSelect1 = document.getElementById('report-year');
        const reportMonthSelect2 = document.getElementById('report-month-comp');
        const reportYearSelect2 = document.getElementById('report-year-comp');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportOutputArea = document.getElementById('report-output-area');
        const suggestedGoalsHeader = document.getElementById('suggested-goals-header');
        const suggestedGoalsContent = document.getElementById('suggested-goals-content');
        const suggestedGoalsArrow = document.getElementById('suggested-goals-arrow');
        const suggestedGoalsList = document.getElementById('suggested-goals-list');
        const noSuggestedGoalsMessage = document.getElementById('no-suggested-goals-message');
        const downloadXlsxBtn = document.getElementById('download-xlsx-btn');
        const clearAllDataLink = document.getElementById('clear-all-data-link');
        const loadSavedDataBtn = document.getElementById('load-saved-data-btn'); 
        const loadJsonInput = document.getElementById('load-json-input'); 


        const selectAllTransactionsCheckbox = document.getElementById('select-all-transactions');
        const paySelectedTransactionsBtn = document.getElementById('pay-selected-transactions-btn');
        const unpaySelectedTransactionsBtn = document.getElementById('unpay-selected-transactions-btn');
        const linkSelectedAccountSelect = document.getElementById('link-selected-account-select');
        const linkSelectedTransactionsBtn = document.getElementById('link-selected-transactions-btn');
        const linkSelectedCategorySelect = document.getElementById('link-selected-category-select');
        const linkSelectedCategoryBtn = document.getElementById('link-selected-category-btn');
        const deleteSelectedTransactionsBtn = document.getElementById('delete-selected-transactions-btn');
        const filterMainTypeSelect = document.getElementById('filter-main-type');
        const filterMainCategorySelect = document.getElementById('filter-main-category');
        const filterMainAccountSelect = document.getElementById('filter-main-account');
        const filterMainFundSourceSelect = document.getElementById('filter-main-fund-source');
        const filterMainStatusSelect = document.getElementById('filter-main-status');
        const saveAllDataLink = document.getElementById('save-all-data-link');
        const openAddTransactionMainBtn = document.getElementById('open-add-transaction-modal-main-btn');
        const mainFiltersCollapsibleContent = document.getElementById('main-filters-collapsible-content');
        const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
        const bulkActionsContainer = document.getElementById('bulk-actions-container');
        const selectedTransactionsCountEl = document.getElementById('selected-transactions-count');


        // --- Utility Functions ---
        const showFeedback = (message, type) => {
            feedbackMessageEl.textContent = message;
            feedbackMessageEl.className = '';
            feedbackMessageEl.classList.add(`feedback-${type}`, 'block');
            feedbackMessageEl.style.display = 'block';
            setTimeout(() => {
                if (feedbackMessageEl.textContent === message) {
                    feedbackMessageEl.style.display = 'none';
                }
            }, 7000);
        };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);

        const formatDateFromVariousFormats = (dateString, yearToAssume = new Date().getFullYear()) => {
            if (!dateString || typeof dateString !== 'string') return null;
            let day, month, year;
            dateString = dateString.trim();
            let match = dateString.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{4})$/);
            if (match) { [ , day, month, year] = match.map(Number); }
            else { 
                match = dateString.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{2})$/);
                if (match) { [ , day, month, year] = match.map(Number); year += (year < 70 ? 2000 : 1900); }
                else { 
                    match = dateString.match(/^(\d{4})[-\/\.](\d{1,2})[-\/\.](\d{1,2})$/);
                    if (match) { [ , year, month, day] = match.map(Number); }
                    else { 
                        match = dateString.match(/^(\d{1,2})[\/\.](\d{1,2})$/);
                        if (match) { [ , day, month] = match.map(Number); year = yearToAssume; }
                        else { match = dateString.match(/^(\d{2})(\d{2})(\d{4})$/);
                            if (match) { day = parseInt(match[1]); month = parseInt(match[2]); year = parseInt(match[3]); }
                            else { match = dateString.match(/^(\d{2})(\d{2})(\d{2})$/);
                                if (match) { day = parseInt(match[1]); month = parseInt(match[2]); year = parseInt(match[3]); year += (year < 70 ? 2000 : 1900); }
                                else return null; 
                            }
                        }
                    }
                }
            }
            if (month < 1 || month > 12 || day < 1 || day > 31) return null;
            const dateObj = new Date(year, month - 1, day);
            if (dateObj.getFullYear() === year && dateObj.getMonth() === month - 1 && dateObj.getDate() === day) {
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }
            return null;
        };

        const parseCurrencyValue = (valueString) => {
            if (!valueString || typeof valueString !== 'string') return { value: 0, isCredit: null, extractedString: "", lineRemainder: valueString };
            
            let lineRemainder = valueString;
            const currencyPatterns = [
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d{1,3}(?:\.\d{3})*(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i, 
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d+(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,       
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d{1,3}(?:,\d{3})*(?:\.\d{2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i, 
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d+(?:\.\d{2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,         
                /(?:^|\s)([\-\+]?\s*\d{1,3}(?:\.\d{3})*(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,  
                /(?:^|\s)([\-\+]?\s*\d+(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,                
            ];
            
            let numericPart = ""; 
            let indicator = "";
            let originalMatchedString = "";

            for (const pattern of currencyPatterns) {
                const match = lineRemainder.match(pattern);
                if (match) {
                    originalMatchedString = match[0].trim();
                    numericPart = match[2] ? match[2].trim() : (match[1] && !match[1].toUpperCase().includes("R$") ? match[1].trim() : ""); 
                    indicator = match[3] ? match[3].trim().toUpperCase() : ""; 
                    const startIndex = lineRemainder.indexOf(originalMatchedString);
                    if (startIndex !== -1) {
                        lineRemainder = lineRemainder.substring(0, startIndex) + lineRemainder.substring(startIndex + originalMatchedString.length);
                        lineRemainder = lineRemainder.trim();
                    }
                    break; 
                }
            }

            if (!numericPart) return { value: 0, isCredit: null, extractedString: "", lineRemainder: valueString };

            let cleanedNumericPart = numericPart.replace("R$", "").replace("+", "").trim();
            const hasMinus = cleanedNumericPart.startsWith('-');
            if (hasMinus) cleanedNumericPart = cleanedNumericPart.substring(1);
            
            let numberValue;
            if (cleanedNumericPart.includes(',')) { 
                if (cleanedNumericPart.match(/\.\d{3},\d{1,2}$/)) { 
                    numberValue = parseFloat(cleanedNumericPart.replace(/\./g, '').replace(',', '.'));
                } else { 
                    numberValue = parseFloat(cleanedNumericPart.replace(',', '.'));
                }
            } else if (cleanedNumericPart.includes('.')) { 
                 if (cleanedNumericPart.match(/\.\d{2}$/) && !cleanedNumericPart.match(/\.\d{3}/) ) { 
                    numberValue = parseFloat(cleanedNumericPart);
                 } else { 
                    numberValue = parseFloat(cleanedNumericPart.replace(/\./g, '')); 
                 }
            }
             else { 
                numberValue = parseFloat(cleanedNumericPart);
            }

            if (isNaN(numberValue)) return { value: 0, isCredit: null, extractedString: "", lineRemainder: valueString };

            let finalIsCredit = null;
            if (indicator.startsWith("C")) finalIsCredit = true;
            else if (indicator.startsWith("D")) finalIsCredit = false;
            else if (hasMinus) finalIsCredit = false;

            return { value: Math.abs(numberValue), isCredit: finalIsCredit, extractedString: originalMatchedString, lineRemainder: lineRemainder };
        };
        const extractInstallmentInfo = (text) => {
             if (!text || typeof text !== 'string') return { paid: 1, total: 1, matchedText: "", lineRemainder: text };
            let paid = 1; let total = 1; let matchedText = ""; let lineRemainder = text;
            const patterns = [ /(\d{1,2})\s*\/\s*(\d{1,2})/, /parc(?:ela)?\.?\s*(\d{1,2})\s*(?:de|\/)\s*(\d{1,2})/i, /inst\s*(\d{1,2})\s*\/\s*(\d{1,2})/i ];
            for (const pattern of patterns) {
                const match = lineRemainder.match(pattern);
                if (match) {
                    paid = parseInt(match[1], 10); total = parseInt(match[2], 10); matchedText = match[0];
                    const startIndex = lineRemainder.indexOf(matchedText);
                    if (startIndex !== -1) { lineRemainder = lineRemainder.substring(0, startIndex) + lineRemainder.substring(startIndex + matchedText.length); lineRemainder = lineRemainder.trim(); }
                    break;
                }
            }
            if (total < paid || total <= 0 || paid <= 0) { return { paid: 1, total: 1, matchedText: "", lineRemainder: text }; }
            return { paid, total, matchedText, lineRemainder };
        };


        // --- Data Persistence ---
         const saveData = () => {
            localStorage.setItem('financialUnifiedAccounts', JSON.stringify(accounts));
            localStorage.setItem('financialUnifiedTransactions', JSON.stringify(transactions));
            localStorage.setItem('financialUnifiedCategories', JSON.stringify(categories));
        };
        const loadData = () => {
            const storedAccounts = localStorage.getItem('financialUnifiedAccounts');
            if (storedAccounts) accounts = JSON.parse(storedAccounts);
            const storedTransactions = localStorage.getItem('financialUnifiedTransactions');
            if (storedTransactions) transactions = JSON.parse(storedTransactions);
            const storedCategories = localStorage.getItem('financialUnifiedCategories');
            if (storedCategories) { categories = JSON.parse(storedCategories); if (!categories.includes("Revisar Importação")) categories.push("Revisar Importação"); if (!categories.includes("Transferências")) categories.push("Transferências");}
            else { if (!categories.includes("Revisar Importação")) categories.push("Revisar Importação"); if (!categories.includes("Transferências")) categories.push("Transferências");}

            renderAll();
        };
        
        // --- Filter Population Functions --- 
        const populateMainFilters = () => {
            if(filterMainCategorySelect) populateCategorySelect(filterMainCategorySelect, "filter");
            if(filterMainAccountSelect) populateAccountSelects(filterMainAccountSelect, false, true, true); 
        };

        const renderAll = () => {
            renderAccounts();
            populateAccountSelects(modalAccountSelect, false, false, true); 
            populateAccountSelects(modalDestinationAccountSelect, true, false, false); 
            populateCategorySelect(modalCategorySelect);
            populateLinkSelectedAccountSelect();
            populateLinkSelectedCategorySelect();
            populateReportSelectors();
            populateMainFilters(); 
            renderTransactions(); 
            updateSummary();
            updateMonthlyDisplay();
            checkCreditCardDueDates();
            suggestFinancialGoals();
        };


        // --- Account Management ---
        const addCardInputFields = (container, cardData = null, isEditMode = false) => {
            cardFieldCounter++;
            const cardDiv = document.createElement('div');
            cardDiv.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 p-3 border border-purple-200 rounded-md relative';
            const cardId = cardData ? cardData.cardId : `newCard_${cardFieldCounter}`;
            cardDiv.dataset.cardId = cardId;

            const cardBrands = ["Visa", "Mastercard", "Elo", "American Express", "Hipercard", "Outra"];
            let brandOptions = cardBrands.map(brand => `<option value="${brand}" ${cardData && cardData.cardBrand === brand ? 'selected' : ''}>${brand}</option>`).join('');

            cardDiv.innerHTML = `
                <input type="hidden" class="card-id-field" value="${cardId}">
                <div>
                    <label for="card-brand-${cardId}" class="block text-xs font-medium text-gray-600 mb-0.5">Bandeira</label>
                    <select id="card-brand-${cardId}" class="w-full input-xs card-brand-select">
                        ${brandOptions}
                    </select>
                </div>
                <div>
                    <label for="card-name-${cardId}" class="block text-xs font-medium text-gray-600 mb-0.5">Nome Personalizado/Outra</label>
                    <input type="text" id="card-name-${cardId}" value="${cardData ? cardData.customCardName || '' : ''}" placeholder="Ex: Meu Cartão Azul" class="w-full input-xs card-name-input" ${cardData && cardData.cardBrand !== 'Outra' ? 'disabled' : ''}>
                </div>
                <div>
                    <label for="card-limit-${cardId}" class="block text-xs font-medium text-gray-600 mb-0.5">Limite (R$)</label>
                    <input type="number" id="card-limit-${cardId}" value="${cardData ? cardData.cardLimit : ''}" step="0.01" placeholder="2000.00" required class="w-full input-xs card-limit-input">
                </div>
                <div>
                    <label for="card-due-day-${cardId}" class="block text-xs font-medium text-gray-600 mb-0.5">Dia Venc. Fatura</label>
                    <input type="number" id="card-due-day-${cardId}" value="${cardData ? cardData.cardDueDay : ''}" min="1" max="31" placeholder="10" required class="w-full input-xs card-due-day-input">
                </div>
                ${isEditMode && cardData ? `<button type="button" class="absolute top-1 right-1 text-red-500 hover:text-red-700 remove-card-btn-edit p-0.5" data-card-id-to-remove="${cardId}">&times;</button>` : ''}
                 ${!isEditMode ? `<button type="button" class="absolute top-1 right-1 text-red-500 hover:text-red-700 remove-card-btn-new p-0.5">&times;</button>` : ''}
            `;
            container.appendChild(cardDiv);

            const brandSelect = cardDiv.querySelector('.card-brand-select');
            const nameInput = cardDiv.querySelector('.card-name-input');
            brandSelect.addEventListener('change', () => {
                nameInput.disabled = brandSelect.value !== 'Outra';
                if (brandSelect.value !== 'Outra') {
                    nameInput.value = ''; 
                }
            });


            if (!isEditMode) {
                 cardDiv.querySelector('.remove-card-btn-new').addEventListener('click', () => cardDiv.remove());
            } else if (cardData) {
                 const removeBtnEdit = cardDiv.querySelector('.remove-card-btn-edit');
                 if(removeBtnEdit) removeBtnEdit.addEventListener('click', (e) => {
                    const cardIdToRemove = e.currentTarget.dataset.cardIdToRemove;
                    const cardToRemoveEl = container.querySelector(`div[data-card-id="${cardIdToRemove}"]`);
                    if (cardToRemoveEl) {
                        cardToRemoveEl.classList.add('hidden', 'marked-for-deletion');
                        showFeedback(`Cartão ${cardData.cardBrand} ${cardData.customCardName || ''} será removido ao salvar.`, 'info');
                    }
                });
            }
        };

        if (accountTypeSelect) {
            accountTypeSelect.addEventListener('change', () => {
                const isChecking = accountTypeSelect.value === 'corrente';
                overdraftSection.classList.toggle('hidden', !isChecking);
                creditCardSection.classList.toggle('hidden', !isChecking);
                if (!isChecking) {
                    linkedCardsContainer.innerHTML = ''; 
                    overdraftLimitInput.value = '';
                } else if (linkedCardsContainer.children.length === 0) { 
                    addCardInputFields(linkedCardsContainer);
                }
            });
        }

        if (addAnotherCardBtn) {
            addAnotherCardBtn.addEventListener('click', () => addCardInputFields(linkedCardsContainer));
        }
         if (editAddAnotherCardBtn) {
            editAddAnotherCardBtn.addEventListener('click', () => addCardInputFields(editLinkedCardsContainer, null, true));
        }


        if (addAccountForm) {
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = accountNameInput.value.trim();
                const type = accountTypeSelect.value;
                const initialBal = parseFloat(initialBalanceInput.value) || 0;
                const overdraftLim = type === 'corrente' ? (parseFloat(overdraftLimitInput.value) || 0) : 0;

                if (!name) {
                    showFeedback('Nome da conta é obrigatório.', 'error');
                    return;
                }

                const newAccount = {
                    id: generateUniqueId(),
                    name,
                    type,
                    balance: initialBal,
                    limitOverdraft: overdraftLim,
                    creditCards: [] 
                };

                if (type === 'corrente') {
                    linkedCardsContainer.querySelectorAll('div[data-card-id]').forEach(cardDiv => {
                        const cardBrand = cardDiv.querySelector('.card-brand-select').value;
                        const customCardName = cardDiv.querySelector('.card-name-input').value.trim();
                        const cardLimit = parseFloat(cardDiv.querySelector('.card-limit-input').value) || 0;
                        const cardDueDay = parseInt(cardDiv.querySelector('.card-due-day-input').value) || 0;

                        if (cardBrand && cardLimit > 0 && cardDueDay >= 1 && cardDueDay <= 31) {
                            if (cardBrand === 'Outra' && !customCardName) {
                                showFeedback('Por favor, insira um nome para o cartão "Outra".', 'error');
                                return; 
                            }
                            newAccount.creditCards.push({
                                cardId: generateUniqueId(),
                                cardBrand,
                                customCardName: cardBrand === 'Outra' ? customCardName : '',
                                cardLimit,
                                cardAvailableLimit: cardLimit, 
                                cardDueDay,
                                cardClosingDay: calculateClosingDay(cardDueDay), 
                                currentBillAmount: 0
                            });
                        }
                    });
                }

                accounts.push(newAccount);
                saveData();
                renderAll(); 
                addAccountForm.reset();
                linkedCardsContainer.innerHTML = ''; 
                overdraftSection.classList.add('hidden');
                creditCardSection.classList.add('hidden');
                accountTypeSelect.value = 'corrente'; 
                showFeedback('Conta adicionada com sucesso!', 'success');
            });
        }
        const calculateClosingDay = (dueDay) => {
            if (!dueDay || dueDay < 1 || dueDay > 31) return null; 
            let closingDay = dueDay - 9;
            if (closingDay <= 0) {
                const tempDate = new Date(); 
                tempDate.setDate(dueDay); 
                tempDate.setMonth(tempDate.getMonth() -1); 
                const daysInPreviousMonth = new Date(tempDate.getFullYear(), tempDate.getMonth() + 1, 0).getDate();
                closingDay = daysInPreviousMonth + closingDay; 
            }
            return closingDay;
        };


        const renderAccounts = () => {
            accountsList.innerHTML = '';
            if (accounts.length === 0) {
                accountsList.innerHTML = '<li class="p-4 text-gray-500 text-center">Nenhuma conta adicionada.</li>';
                return;
            }
            accounts.forEach(account => {
                const li = document.createElement('li');
                li.className = 'p-3 border-b border-gray-200';

                let typeText = account.type.charAt(0).toUpperCase() + account.type.slice(1);
                if (account.type === 'corrente') typeText = "Conta Corrente";
                else if (account.type === 'poupanca') typeText = "Conta Poupança";
                else if (account.type === 'cash') typeText = "Dinheiro (Caixa)";

                let detailsHtml = `<p>Saldo: <span class="font-bold ${account.balance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(account.balance)}</span></p>`;
                if (account.type === 'corrente') {
                    detailsHtml += `<p>Cheque Especial: <span class="font-bold">${formatCurrency(account.limitOverdraft)}</span></p>`;
                    const totalAvailableChecking = account.balance + account.limitOverdraft;
                    detailsHtml += `<p>Disponível (C/C + Ch. Esp.): <span class="font-bold ${totalAvailableChecking >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(totalAvailableChecking)}</span></p>`;
                }

                if (account.creditCards && account.creditCards.length > 0) {
                    detailsHtml += `<h5 class="text-sm font-semibold mt-2 mb-1 text-purple-700">Cartões Vinculados:</h5><ul class="list-disc list-inside pl-2 text-xs">`;
                    account.creditCards.forEach(card => {
                        const cardDisplayName = card.cardBrand === 'Outra' ? card.customCardName : card.cardBrand;
                        const billForThisCardThisMonth = transactions.reduce((sum, t) => {
                            const tDate = new Date(t.date + "T00:00:00");
                             if (t.fundSource === `credit_card_${card.cardId}` && t.fundamentalType === 'despesa' && !t.isPaid && tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) {
                                return sum + t.value;
                            }
                            return sum;
                        },0);

                        detailsHtml += `<li>${cardDisplayName || 'Cartão'}: Limite ${formatCurrency(card.cardLimit)}, Disp. ${formatCurrency(card.cardAvailableLimit)}, Fatura Atual ${formatCurrency(billForThisCardThisMonth)}, Venc. dia ${card.cardDueDay} (Fech. dia ${card.cardClosingDay || 'N/A'})</li>`;
                    });
                    detailsHtml += `</ul>`;
                }
                
                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <div class="account-item-header flex justify-between items-center w-full">
                                <div>
                                    <span class="font-semibold text-gray-800">${account.name}</span>
                                    <span class="text-sm text-gray-500 ml-2">(${typeText})</span>
                                </div>
                                <svg class="arrow-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                            <div class="account-details-content hidden mt-2 pl-4 text-sm text-gray-600">
                                ${detailsHtml}
                                <button data-account-id="${account.id}" class="view-detailed-statement-btn text-xs text-blue-600 hover:text-blue-800 mt-1">Ver Extrato Detalhado</button>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button data-id="${account.id}" class="edit-account-btn text-yellow-500 hover:text-yellow-700 p-1 rounded-full hover:bg-yellow-100 mr-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg></button>
                            <button data-id="${account.id}" data-type="account" class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>
                        </div>
                    </div>`;
                
                const headerDiv = li.querySelector('.account-item-header');
                const detailsDiv = li.querySelector('.account-details-content');
                const arrowIcon = headerDiv.querySelector('.arrow-icon');
                headerDiv.addEventListener('click', () => {
                    detailsDiv.classList.toggle('hidden');
                    arrowIcon.classList.toggle('rotated');
                });
                li.querySelector('.view-detailed-statement-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDetailedStatementModal(account.id);
                });
                accountsList.appendChild(li);
            });
            addEditDeleteAccountListeners();
        };
        
        const addEditDeleteAccountListeners = () => {
            document.querySelectorAll('.edit-account-btn').forEach(b => {
                b.onclick = (e) => openEditAccountModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.delete-btn[data-type="account"]').forEach(b => {
                b.onclick = (e) => requestDeleteConfirmation(e.currentTarget.dataset.id, 'account');
            });
        };


        // --- Transaction Management ---
        const populateAccountSelects = (selectElement, includeCashOnly = false, includeMaintainOriginal = false, includeNoLink = true) => {
            if (!selectElement) return;
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';

            if (includeMaintainOriginal) {
                const maintainOpt = document.createElement('option');
                maintainOpt.value = ""; 
                maintainOpt.textContent = "Manter original / Não Vincular";
                selectElement.appendChild(maintainOpt);
            } else if (includeNoLink && !includeCashOnly) { 
                 const noLinkOpt = document.createElement('option');
                 noLinkOpt.value = "";
                 noLinkOpt.textContent = "Não Vincular / Geral";
                 selectElement.appendChild(noLinkOpt);
            } else if (includeNoLink && includeCashOnly) { 
                 const selectOpt = document.createElement('option');
                 selectOpt.value = "";
                 selectOpt.textContent = "Selecione uma Conta";
                 selectOpt.disabled = true; 
                 selectOpt.selected = true; 
                 selectElement.appendChild(selectOpt);
            }


            accounts.forEach(acc => {
                if (includeCashOnly && acc.type === 'corrente' && acc.creditCards && acc.creditCards.length > 0) return; 

                const opt = document.createElement('option');
                opt.value = acc.id;
                let typeText = acc.type.charAt(0).toUpperCase() + acc.type.slice(1);
                if (acc.type === 'corrente') typeText = "C/C";
                else if (acc.type === 'poupanca') typeText = "Poupança";
                opt.textContent = `${acc.name} (${typeText})`;
                selectElement.appendChild(opt);
            });
            if (currentVal && Array.from(selectElement.options).some(opt => opt.value === currentVal)) {
                 selectElement.value = currentVal;
            } else if (selectElement.options.length > 0 && (includeMaintainOriginal || (!includeCashOnly && includeNoLink && selectElement !== modalDestinationAccountSelect && selectElement !== modalAccountSelect && modalTransactionTypeHiddenInput.value !== 'transferencia' ) )) {
                selectElement.value = ""; 
            }
        };
        
        const populateFundSourceSelect = (accountId, targetSelectElement = modalFundSourceSelect) => {
            targetSelectElement.innerHTML = '';
            const account = accounts.find(acc => acc.id === accountId);
            
            if (targetSelectElement === modalFundSourceSelect && modalFundSourceDiv) {
                 modalFundSourceDiv.classList.add('hidden'); 
                 const currentTransactionType = modalTransactionTypeHiddenInput.value; 
                 if (!account || currentTransactionType === 'receita') { 
                    if (currentTransactionType === 'receita') {
                         targetSelectElement.innerHTML = `<option value="account_balance" selected>Saldo da Conta</option>`;
                    }
                    return; 
                 }
            } else if (!account && targetSelectElement !== modalFundSourceSelect) { 
                targetSelectElement.innerHTML = `<option value="account_balance" selected>Saldo Conta</option>`;
                return;
            }


            let hasOptions = false;
            const balanceOpt = document.createElement('option');
            balanceOpt.value = 'account_balance';
            balanceOpt.textContent = 'Saldo Conta';
            targetSelectElement.appendChild(balanceOpt);
            hasOptions = true;

            if (account && account.type === 'corrente') {
                if (account.limitOverdraft > 0) {
                    const overdraftOpt = document.createElement('option');
                    overdraftOpt.value = 'overdraft';
                    overdraftOpt.textContent = 'Cheque Esp.';
                    targetSelectElement.appendChild(overdraftOpt);
                    hasOptions = true;
                }
                if (account.creditCards && account.creditCards.length > 0) {
                    account.creditCards.forEach(card => {
                        const cardDisplayName = card.cardBrand === 'Outra' ? card.customCardName : card.cardBrand;
                        const cardOpt = document.createElement('option');
                        cardOpt.value = `credit_card_${card.cardId}`;
                        cardOpt.textContent = `Cartão: ${(cardDisplayName || 'Cartão').substring(0,15)}${(cardDisplayName || 'Cartão').length > 15 ? '...' : ''}`;
                        targetSelectElement.appendChild(cardOpt);
                        hasOptions = true;
                    });
                }
            }
             if (targetSelectElement === modalFundSourceSelect && modalFundSourceDiv && hasOptions && (modalTransactionTypeHiddenInput.value === 'despesa' || modalTransactionTypeHiddenInput.value === 'transferencia')) {
                modalFundSourceDiv.classList.remove('hidden');
            }
        };

        if (modalAccountSelect) {
            modalAccountSelect.addEventListener('change', (e) => {
                populateFundSourceSelect(e.target.value, modalFundSourceSelect);
                const currentTransactionType = modalTransactionTypeHiddenInput.value;
                 if (!e.target.value && modalFundSourceDiv) { 
                    modalFundSourceDiv.classList.add('hidden');
                } else if ((currentTransactionType === 'despesa' || currentTransactionType === 'transferencia') && e.target.value && modalFundSourceDiv) { 
                    modalFundSourceDiv.classList.remove('hidden');
                } else {
                    modalFundSourceDiv.classList.add('hidden');
                }
            });
        }
        
        document.querySelectorAll('.transaction-type-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const selectedType = e.currentTarget.dataset.type;
                modalTransactionTypeHiddenInput.value = selectedType; 

                document.querySelectorAll('.transaction-type-tab').forEach(t => t.classList.remove('active'));
                e.currentTarget.classList.add('active');

                const isTransfer = selectedType === 'transferencia';
                const isReceita = selectedType === 'receita';
                
                modalDestinationAccountDiv.classList.toggle('hidden', !isTransfer);
                modalCategorySection.classList.toggle('hidden', isTransfer); 
                if(modalInstallmentsPaidSection) modalInstallmentsPaidSection.classList.toggle('hidden', isTransfer); 

                const mainAccountLabel = modalAccountSelect.previousElementSibling;
                const destAccountLabel = modalDestinationAccountSelect.previousElementSibling;


                if (isReceita) {
                    modalFundSourceDiv.classList.add('hidden');
                    modalAccountSelect.required = false; 
                    populateAccountSelects(modalAccountSelect, false, false, true); 
                    if(mainAccountLabel) mainAccountLabel.textContent = "Conta Creditada (Opcional)";
                    if (modalFundSourceSelect) modalFundSourceSelect.innerHTML = `<option value="account_balance" selected>Saldo da Conta</option>`;
                } else if (selectedType === 'despesa') {
                    modalAccountSelect.required = false; 
                    populateAccountSelects(modalAccountSelect, false, false, true); 
                    if(mainAccountLabel) mainAccountLabel.textContent = "Conta Debitada (Opcional)";
                    if (modalAccountSelect.value) { 
                        populateFundSourceSelect(modalAccountSelect.value, modalFundSourceSelect);
                        modalFundSourceDiv.classList.remove('hidden');
                    } else {
                        modalFundSourceDiv.classList.add('hidden');
                    }
                } else if (isTransfer) { 
                    modalAccountSelect.required = true; 
                    populateAccountSelects(modalAccountSelect, false, false, false); 
                    if(mainAccountLabel) mainAccountLabel.textContent = "Conta de Origem";


                    if (modalAccountSelect.value) {
                        populateFundSourceSelect(modalAccountSelect.value, modalFundSourceSelect);
                        modalFundSourceDiv.classList.remove('hidden'); 
                    } else {
                        modalFundSourceDiv.classList.add('hidden');
                    }
                    modalDestinationAccountSelect.required = true;
                    populateAccountSelects(modalDestinationAccountSelect, false, false, false);
                    if(destAccountLabel) destAccountLabel.textContent = "Conta de Destino";
                }
            });
        });


        if(openAddTransactionMainBtn) {
            openAddTransactionMainBtn.addEventListener('click', () => {
                addTransactionModalTitle.textContent = 'Adicionar Nova Transação';
                transactionFormModal.reset();
                modalTransactionIdInput.value = ''; 
                
                document.querySelectorAll('.transaction-type-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.type === 'receita');
                });
                modalTransactionTypeHiddenInput.value = 'receita'; 
                
                const receitaTab = document.querySelector('.transaction-type-tab[data-type="receita"]');
                if(receitaTab) receitaTab.click();


                populateCategorySelect(modalCategorySelect);
                modalNewCategoryInput.classList.add('hidden');
                modalDateInput.value = new Date().toISOString().split('T')[0];
                modalInstallmentsInput.value = 1;
                modalInstallmentsPaidInput.value = 0;
                modalPaidStatusCheckbox.checked = true; 

                addTransactionModal.classList.remove('hidden');
            });
        }
        
        if(closeAddTransactionModalBtn) closeAddTransactionModalBtn.addEventListener('click', () => addTransactionModal.classList.add('hidden'));
        if(cancelAddTransactionModalBtn) cancelAddTransactionModalBtn.addEventListener('click', () => addTransactionModal.classList.add('hidden'));

        if (transactionFormModal) {
            transactionFormModal.addEventListener('submit', (e) => {
                e.preventDefault();
                const transactionIdToEdit = modalTransactionIdInput.value;
                const baseDateString = modalDateInput.value;
                const description = modalDescriptionInput.value.trim();
                const valuePerInstallment = parseFloat(modalValueInput.value);
                
                let typeFromTabs = modalTransactionTypeHiddenInput.value; 
                let finalType = typeFromTabs; 
                
                let accountId = modalAccountSelect.value || null; 
                let fundSource = (modalFundSourceDiv.classList.contains('hidden') || !modalFundSourceSelect.value || !accountId) ? null : modalFundSourceSelect.value; 
                let destinationAccountId = null;

                if (typeFromTabs === 'transferencia') {
                    destinationAccountId = modalDestinationAccountSelect.value;
                    if (!accountId || !destinationAccountId) {
                        showFeedback('Para transferência, as contas de origem e destino são obrigatórias.', 'error');
                        return;
                    }
                     if (accountId === destinationAccountId) { 
                        showFeedback('Conta de origem e destino não podem ser a mesma para transferência.', 'error'); return; 
                    }
                    finalType = 'transferencia_saida'; 
                } else {
                     finalType = typeFromTabs; 
                }


                let category;
                if(finalType.includes('transferencia')) {
                    category = 'Transferências';
                } else if (modalCategorySelect.value === 'nova-categoria') {
                    category = modalNewCategoryInput.value.trim();
                    if (category && !categories.includes(category)) { categories.push(category); populateCategorySelect(modalCategorySelect); populateLinkSelectedCategorySelect(); modalCategorySelect.value = category; } 
                    else if (categories.includes(category)) { modalCategorySelect.value = category; modalNewCategoryInput.classList.add('hidden'); }
                    else if (!category) { showFeedback('Insira nome para nova categoria.', 'error'); return; }
                } else { category = modalCategorySelect.value; }


                const totalInstallments = parseInt(modalInstallmentsInput.value) || 1;
                const installmentsPaidCount = parseInt(modalInstallmentsPaidInput.value) || 0;
                const isPaid = modalPaidStatusCheckbox.checked;

                if (!baseDateString || !description || isNaN(valuePerInstallment) || valuePerInstallment <= 0 || !finalType || !category) { showFeedback('Preencha campos obrigatórios.', 'error'); return; }
                if (installmentsPaidCount > totalInstallments || installmentsPaidCount < 0) { showFeedback('Parcelas pagas inválido.', 'error'); return; }
                
                const fundamentalType = (finalType === 'receita' || finalType === 'transferencia_entrada') ? 'receita' : 'despesa';
                const isCreditCardTx = accountId && fundSource && fundSource.startsWith('credit_card_'); 
                
                if (transactionIdToEdit) { 
                    const txIndex = transactions.findIndex(t => t.id === transactionIdToEdit);
                    if (txIndex === -1) { showFeedback('Erro: Transação para edição não encontrada.', 'error'); return; }
                    
                    const oldTx = JSON.parse(JSON.stringify(transactions[txIndex])); 
                    if (oldTx.accountId) { 
                        updateAccountBalance(oldTx.accountId, oldTx.fundSource, oldTx.value, oldTx.fundamentalType, true, oldTx.isPaid, oldTx.destinationAccountId, oldTx.type);
                    }
                     if (oldTx.type === 'transferencia_saida' && oldTx.destinationAccountId) {
                        const destAcc = accounts.find(a => a.id === oldTx.destinationAccountId);
                        if (destAcc) updateAccountBalance(destAcc.id, 'account_balance', oldTx.value, 'receita', true, oldTx.isPaid, oldTx.accountId, 'transferencia_entrada');
                    }


                    transactions[txIndex] = {
                        ...transactions[txIndex], 
                        date: baseDateString, description, value: valuePerInstallment, type: finalType, fundamentalType, category, accountId,
                        fundSource: accountId ? fundSource : null, 
                        isCreditCardTransaction: accountId ? isCreditCardTx : false,
                        installments: `${installmentsPaidCount + 1}/${totalInstallments}`, 
                        isPaid,
                        destinationAccountId
                    };
                    if (accountId) { 
                        updateAccountBalance(accountId, fundSource, valuePerInstallment, fundamentalType, false, isPaid, destinationAccountId, finalType);
                    }
                     if (finalType === 'transferencia_saida' && destinationAccountId) {
                        const destAcc = accounts.find(a => a.id === destinationAccountId);
                        if (destAcc) updateAccountBalance(destAcc.id, 'account_balance', valuePerInstallment, 'receita', false, isPaid, accountId, 'transferencia_entrada');
                    }
                    showFeedback('Transação atualizada!', 'success');

                } else { 
                    const originalGroupId = generateUniqueId();
                    for (let k = 1; k <= totalInstallments; k++) {
                        const transactionDateObject = new Date(baseDateString + "T00:00:00");
                        const monthOffset = k - (installmentsPaidCount + 1);
                        transactionDateObject.setMonth(transactionDateObject.getMonth() + monthOffset);
                        const originalDay = new Date(baseDateString + "T00:00:00").getDate();
                        if (transactionDateObject.getDate() !== originalDay) transactionDateObject.setDate(0);

                        const newTx = {
                            id: generateUniqueId(),
                            date: transactionDateObject.toISOString().split('T')[0],
                            description: `${description} (${k}/${totalInstallments})`,
                            value: valuePerInstallment, type: finalType, fundamentalType, category, accountId,
                            fundSource: accountId ? fundSource : null,
                            isCreditCardTransaction: accountId ? isCreditCardTx : false,
                            installments: `${k}/${totalInstallments}`,
                            isPaid: (k <= installmentsPaidCount) || isPaid, 
                            originalGroupId,
                            destinationAccountId
                        };
                        transactions.push(newTx);
                        if (newTx.accountId) { 
                            updateAccountBalance(newTx.accountId, newTx.fundSource, newTx.value, newTx.fundamentalType, false, newTx.isPaid, newTx.destinationAccountId, newTx.type);
                        }
                        if (newTx.type === 'transferencia_saida' && newTx.destinationAccountId) {
                            const destAcc = accounts.find(a => a.id === newTx.destinationAccountId);
                            if (destAcc) {
                                const entryTransaction = {
                                    ...newTx, 
                                    id: generateUniqueId(), 
                                    type: 'transferencia_entrada',
                                    fundamentalType: 'receita',
                                    accountId: newTx.destinationAccountId, 
                                    fundSource: 'account_balance', 
                                    isCreditCardTransaction: false,
                                    destinationAccountId: newTx.accountId 
                                };
                                transactions.push(entryTransaction);
                                updateAccountBalance(entryTransaction.accountId, entryTransaction.fundSource, entryTransaction.value, entryTransaction.fundamentalType, false, entryTransaction.isPaid, entryTransaction.destinationAccountId, entryTransaction.type);
                            }
                        }
                    }
                    showFeedback('Transação(ões) adicionada(s)!', 'success');
                }

                saveData();
                renderAll();
                addTransactionModal.classList.add('hidden');
            });
        }
        
        const updateAccountBalance = (accountId, fundSource, value, fundamentalType, isReversal = false, isTransactionPaid = true, destinationAccountId = null, transactionType = null) => {
            if (!accountId && !(transactionType === 'transferencia_entrada' && destinationAccountId)) { 
                 if (transactionType !== 'receita' && transactionType !== 'despesa') { 
                    return;
                 }
            }
             if (!isTransactionPaid && !(transactionType === 'transferencia_entrada' && fundamentalType === 'receita')) return; 


            const account = accounts.find(acc => acc.id === accountId);
            
            const targetAccountForEntry = transactionType === 'transferencia_entrada' ? accounts.find(acc => acc.id === accountId) : null;


            if (!account && !targetAccountForEntry) {
                if (transactionType !== 'receita' && transactionType !== 'despesa') {
                    console.warn(`Conta com ID ${accountId} não encontrada para atualização de saldo.`);
                }
                return;
            }
            
            const currentAccountToUpdate = targetAccountForEntry || account; 

            const amount = isReversal ? value : -value; 

            if (transactionType === 'transferencia_saida') {
                if (fundSource === 'overdraft') currentAccountToUpdate.balance += amount; 
                else if (fundSource && fundSource.startsWith('credit_card_')) { /* No direct balance impact */ }
                else currentAccountToUpdate.balance += amount; 

                const destAccount = accounts.find(acc => acc.id === destinationAccountId);
                if (destAccount) { 
                     destAccount.balance -= amount; 
                }

            } else if (transactionType === 'transferencia_entrada') {
                 currentAccountToUpdate.balance -= amount; 

            } else if (fundamentalType === 'receita') {
                if(currentAccountToUpdate) currentAccountToUpdate.balance -= amount; 
            } else if (fundamentalType === 'despesa') {
                 if(currentAccountToUpdate) { 
                    if (fundSource === 'overdraft') {
                        currentAccountToUpdate.balance += amount; 
                    } else if (fundSource && fundSource.startsWith('credit_card_')) {
                        const cardId = fundSource.replace('credit_card_', '');
                        const cardOwningAccount = accounts.find(a => a.id === currentAccountToUpdate.id && a.creditCards && a.creditCards.some(c => c.cardId === cardId));
                        if (cardOwningAccount) {
                            const card = cardOwningAccount.creditCards.find(c => c.cardId === cardId);
                            if (card) {
                                card.currentBillAmount -= amount; 
                                card.cardAvailableLimit += amount; 
                            }
                        }
                    } else { 
                        currentAccountToUpdate.balance += amount;
                    }
                }
            }
        };


        const renderTransactions = (searchTerm = "", filters = {}) => {
            transactionList.innerHTML = '';
            const beginningOfCurrentMonth = new Date(currentYear, currentMonth, 1);
            beginningOfCurrentMonth.setHours(0, 0, 0, 0);
            const lowerSearchTerm = searchTerm.toLowerCase().trim();

            const filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date + "T00:00:00");
                const isInCurrentMonthAndYear = transactionDate.getFullYear() === currentYear && transactionDate.getMonth() === currentMonth;
                const isPendingFromPreviousMonth = transactionDate < beginningOfCurrentMonth && !t.isPaid && t.fundamentalType === 'despesa';

                if (filters.type && filters.type !== "all" && t.type !== filters.type) return false;
                if (filters.category && filters.category !== "all" && t.category !== filters.category) return false;
                
                if (filters.accountId) { 
                    if (filters.accountId === "all") {
                        // Nenhuma ação, mostra todas
                    } else if (filters.accountId === "") { // Queremos transações NÃO vinculadas
                        if (t.accountId !== null && t.accountId !== undefined && t.accountId !== '') return false;
                    } else { // Queremos transações de uma conta específica
                        if (t.accountId !== filters.accountId) return false; 
                    }
                }


                if (filters.status && filters.status !== "all" && (filters.status === "paid" ? !t.isPaid : t.isPaid) ) return false;
                
                if (filters.fundSource && filters.fundSource !== "all") {
                    if(!t.accountId && filters.fundSource !== 'all') return false; 
                    if (filters.fundSource === "credit_card_any" && !t.fundSource?.startsWith("credit_card_")) return false;
                    else if (filters.fundSource !== "credit_card_any" && t.fundSource !== filters.fundSource) return false;
                }


                const matchesSearch = lowerSearchTerm === "" ||
                    t.description.toLowerCase().includes(lowerSearchTerm) ||
                    t.category.toLowerCase().includes(lowerSearchTerm) ||
                    formatCurrency(t.value).toLowerCase().includes(lowerSearchTerm) ||
                    (t.accountId && accounts.find(a => a.id === t.accountId)?.name.toLowerCase().includes(lowerSearchTerm)) ||
                    (t.fundSource && t.fundSource.startsWith('credit_card_') && 
                        accounts.flatMap(a => a.creditCards || []).find(c => `credit_card_${c.cardId}` === t.fundSource)?.customCardName?.toLowerCase().includes(lowerSearchTerm)) || 
                    (t.fundSource && t.fundSource.startsWith('credit_card_') && 
                        accounts.flatMap(a => a.creditCards || []).find(c => `credit_card_${c.cardId}` === t.fundSource)?.cardBrand?.toLowerCase().includes(lowerSearchTerm));
                
                return (isInCurrentMonthAndYear || isPendingFromPreviousMonth) && matchesSearch;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            noTransactionsMessage.classList.toggle('hidden', filteredTransactions.length > 0);
            if (selectAllTransactionsCheckbox) selectAllTransactionsCheckbox.checked = false;

            filteredTransactions.forEach(transaction => {
                const tr = document.createElement('tr');
                let rowClass = 'bg-white hover:bg-gray-50';
                const transactionDate = new Date(transaction.date + "T00:00:00");
                if (transaction.isPaid) rowClass += ' paid-transaction';
                else if (transactionDate < beginningOfCurrentMonth) rowClass += ' pending-previous-month';
                tr.className = rowClass;

                const accountName = transaction.accountId ? (accounts.find(acc => acc.id === transaction.accountId)?.name || 'Conta Desc.') : 'Geral / N/A';
                
                let fundSourceText = 'N/A';
                 if (transaction.accountId) { 
                    fundSourceText = 'Saldo Conta'; 
                    if (transaction.fundSource === 'overdraft') {
                        fundSourceText = 'Cheque Especial';
                    } else if (transaction.fundSource && transaction.fundSource.startsWith('credit_card_')) {
                        const cardId = transaction.fundSource.replace('credit_card_', '');
                        const mainAccountForCard = accounts.find(acc => acc.creditCards && acc.creditCards.some(c => c.cardId === cardId));
                        if (mainAccountForCard) {
                            const card = mainAccountForCard.creditCards.find(c => c.cardId === cardId);
                            const cardDisplayName = card ? (card.cardBrand === 'Outra' ? card.customCardName : card.cardBrand) : 'Cartão Desc.';
                            fundSourceText = `Cartão: ${cardDisplayName || 'Cartão'}`;
                        } else {
                            fundSourceText = 'Cartão Desc. (Conta não encontrada)';
                        }
                    } else if (transaction.type === 'receita' || transaction.type === 'transferencia_entrada') {
                        fundSourceText = 'N/A (Entrada)';
                    }
                }


                let typeDisplay = transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1).replace(/_/g, ' ');
                let valueColorClass = transaction.fundamentalType === 'receita' ? 'text-green-600' : 'text-red-600';
                if (transaction.isPaid && transaction.fundamentalType === 'despesa') valueColorClass = 'text-red-400';
                else if (!transaction.isPaid && transaction.fundamentalType === 'despesa') valueColorClass = 'text-red-700 font-bold';
                const statusText = transaction.isPaid ? 'Realizado' : 'Pendente';
                const statusClass = transaction.isPaid ? 'text-green-600' : 'text-red-700 font-bold';


                tr.innerHTML = `
                    <td class="px-2 py-4 text-center"><input type="checkbox" class="transaction-checkbox form-checkbox h-4 w-4" data-id="${transaction.id}" data-group-id="${transaction.originalGroupId || ''}"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${new Date(transaction.date + "T00:00:00").toLocaleDateString('pt-BR')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${valueColorClass}">${formatCurrency(transaction.value)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${typeDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${transaction.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${accountName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${fundSourceText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${transaction.installments}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${!transaction.isPaid && transaction.fundamentalType === 'despesa' ? `<button data-id="${transaction.id}" class="pay-transaction-btn text-blue-600 hover:text-blue-900 mr-2 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>` : ''}
                        <button data-id="${transaction.id}" class="edit-transaction-btn text-yellow-600 hover:text-yellow-900 mr-2 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button data-id="${transaction.id}" data-type="transaction" class="delete-btn text-red-500 hover:text-red-700 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>`;
                transactionList.appendChild(tr);
            });
            addTransactionActionListeners();
            updateSelectedTransactionsActions();
        };
        
        const addTransactionActionListeners = () => {
            document.querySelectorAll('.pay-transaction-btn').forEach(b => { b.onclick = (e) => markTransactionAsPaid(e.currentTarget.dataset.id, true); });
            document.querySelectorAll('.edit-transaction-btn').forEach(b => { b.onclick = (e) => openEditTransactionModal(e.currentTarget.dataset.id); });
            document.querySelectorAll('.delete-btn[data-type="transaction"]').forEach(b => { b.onclick = (e) => requestDeleteConfirmation(e.currentTarget.dataset.id, 'transaction'); });
        };
        
        const openEditTransactionModal = (transactionId) => {
             const tx = transactions.find(t => t.id === transactionId);
            if (!tx) { showFeedback('Transação não encontrada.', 'error'); return; }

            addTransactionModalTitle.textContent = 'Editar Transação';
            transactionFormModal.reset();
            modalTransactionIdInput.value = tx.id;
            modalDateInput.value = tx.date;
            modalDescriptionInput.value = tx.description.replace(/\s\(\d+\/\d+\)$/, ''); 
            modalValueInput.value = tx.value.toFixed(2);
            
            const activeTabType = tx.type.includes('transferencia') ? 'transferencia' : tx.type;
            modalTransactionTypeHiddenInput.value = activeTabType;

            document.querySelectorAll('.transaction-type-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === activeTabType);
            });

            // Simula o clique para configurar a UI corretamente
            const activeTabElement = document.querySelector(`.transaction-type-tab[data-type="${activeTabType}"]`);
            if (activeTabElement) activeTabElement.click();


            populateCategorySelect(modalCategorySelect);
            modalCategorySelect.value = tx.category;
            modalNewCategoryInput.classList.add('hidden');

            // Preenche o select de conta principal
            const accountSelectType = tx.type === 'receita' ? true : false;
            const allowNoLinkForAccount = tx.type === 'despesa' || tx.type === 'receita';
            populateAccountSelects(modalAccountSelect, false, false, allowNoLinkForAccount); 
            modalAccountSelect.value = tx.accountId || ""; 
            
            const accountChangeEvent = new Event('change'); 
            modalAccountSelect.dispatchEvent(accountChangeEvent);

            setTimeout(() => { 
                 if (tx.accountId && tx.fundSource) {
                    modalFundSourceSelect.value = tx.fundSource;
                 } else if (!tx.accountId) {
                    modalFundSourceDiv.classList.add('hidden');
                 }
            }, 0);


            if (tx.type === 'transferencia_saida' || tx.type === 'transferencia_entrada') {
                populateAccountSelects(modalDestinationAccountSelect, false, false, false); 
                modalDestinationAccountSelect.value = tx.destinationAccountId || "";
                modalDestinationAccountDiv.classList.remove('hidden');
            } else {
                modalDestinationAccountDiv.classList.add('hidden');
            }


            const [paidCount, totalCount] = tx.installments.split('/').map(Number);
            modalInstallmentsInput.value = totalCount;
            modalInstallmentsPaidInput.value = paidCount -1; 
            modalPaidStatusCheckbox.checked = tx.isPaid;

            addTransactionModal.classList.remove('hidden');
        };


        // --- Summary Calculations ---
         const updateSummary = () => {
             let totalPoderDeCompra = 0;
            let saldoLiquido = 0;
            accounts.forEach(acc => {
                saldoLiquido += acc.balance; 
                if (acc.type === 'corrente') {
                    totalPoderDeCompra += acc.balance + acc.limitOverdraft;
                } else {
                    totalPoderDeCompra += acc.balance;
                }
                if (acc.creditCards) {
                    acc.creditCards.forEach(card => {
                        totalPoderDeCompra += card.cardAvailableLimit;
                    });
                }
            });
            if(totalPoderCompraEl) totalPoderCompraEl.textContent = formatCurrency(totalPoderDeCompra);
            if(saldoLiquidoContasEl) {
                saldoLiquidoContasEl.textContent = formatCurrency(saldoLiquido);
                saldoLiquidoContasEl.className = `text-2xl font-bold ${saldoLiquido >= 0 ? 'text-green-700' : 'text-red-700'}`;
            }


            let despesasDoMesTotal = 0;
            const beginningOfCurrentMonth = new Date(currentYear, currentMonth, 1);
            beginningOfCurrentMonth.setHours(0,0,0,0);
            transactions.forEach(t => {
                const transactionDate = new Date(t.date + "T00:00:00");
                const isInCurrentMonthAndYear = transactionDate.getFullYear() === currentYear && transactionDate.getMonth() === currentMonth;
                const isPendingFromPreviousMonth = transactionDate < beginningOfCurrentMonth && !t.isPaid;
                if (t.fundamentalType === 'despesa' && (isInCurrentMonthAndYear || isPendingFromPreviousMonth)) {
                    despesasDoMesTotal += t.value;
                }
            });
            if(totalDespesasEl) totalDespesasEl.textContent = formatCurrency(despesasDoMesTotal);

            let faturasCartoesMes = 0;
            accounts.forEach(acc => {
                if (acc.creditCards) {
                    acc.creditCards.forEach(card => {
                        transactions.forEach(t => {
                            const tDate = new Date(t.date + "T00:00:00");
                            if (t.fundSource === `credit_card_${card.cardId}` && t.fundamentalType === 'despesa' && !t.isPaid &&
                                tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) {
                                faturasCartoesMes += t.value;
                            }
                        });
                    });
                }
            });
            if(totalFaturasCartoesMesEl) totalFaturasCartoesMesEl.textContent = formatCurrency(faturasCartoesMes);
        };
        
        const updateMonthlyDisplay = () => { if(currentMonthDisplay) currentMonthDisplay.textContent = new Date(currentYear,currentMonth).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});};
        
        const applyMainFilters = () => {
            const filters = {
                type: filterMainTypeSelect.value,
                category: filterMainCategorySelect.value,
                accountId: filterMainAccountSelect.value,
                fundSource: filterMainFundSourceSelect.value,
                status: filterMainStatusSelect.value,
            };
            renderTransactions(searchTransactionsInput.value, filters);
        };

        if(prevMonthBtn) prevMonthBtn.addEventListener('click',()=>{currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--;} updateMonthlyDisplay(); applyMainFilters(); updateSummary(); suggestFinancialGoals();});
        if(nextMonthBtn) nextMonthBtn.addEventListener('click',()=>{currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++;} updateMonthlyDisplay(); applyMainFilters(); updateSummary(); suggestFinancialGoals();});
        if(searchTransactionsInput) searchTransactionsInput.addEventListener('input', applyMainFilters);
        document.querySelectorAll('.filter-main-select').forEach(sel => sel.addEventListener('change', applyMainFilters));

        // --- Edit Account Modal ---
        function openEditAccountModal(accountId) {
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            editAccountIdInput.value = account.id;
            editAccountNameInput.value = account.name;
            editAccountTypeDisplay.value = account.type.charAt(0).toUpperCase() + account.type.slice(1);
            editAccountBalanceInput.value = account.balance.toFixed(2);

            editOverdraftSection.classList.toggle('hidden', account.type !== 'corrente');
            editCreditCardSection.classList.toggle('hidden', account.type !== 'corrente');
            editLinkedCardsContainer.innerHTML = ''; 

            if (account.type === 'corrente') {
                editOverdraftLimitInput.value = (account.limitOverdraft || 0).toFixed(2);
                if (account.creditCards) {
                    account.creditCards.forEach(card => addCardInputFields(editLinkedCardsContainer, card, true));
                }
            } else {
                editOverdraftLimitInput.value = '';
            }
            editAccountModal.classList.remove('hidden');
        }

        if(closeEditAccountModalBtn) closeEditAccountModalBtn.addEventListener('click', () => editAccountModal.classList.add('hidden'));
        if(cancelEditAccountBtn) cancelEditAccountBtn.addEventListener('click', () => editAccountModal.classList.add('hidden'));

        if(saveEditAccountBtn) saveEditAccountBtn.addEventListener('click', () => {
            const accountId = editAccountIdInput.value;
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            account.name = editAccountNameInput.value.trim();
            account.balance = parseFloat(editAccountBalanceInput.value) || 0;

            if (account.type === 'corrente') {
                account.limitOverdraft = parseFloat(editOverdraftLimitInput.value) || 0;
                
                const updatedCards = [];
                editLinkedCardsContainer.querySelectorAll('div[data-card-id]').forEach(cardDiv => {
                    if (cardDiv.classList.contains('marked-for-deletion')) { 
                        return;
                    }

                    const cardId = cardDiv.dataset.cardId;
                    const cardBrand = cardDiv.querySelector('.card-brand-select').value;
                    const customCardName = cardDiv.querySelector('.card-name-input').value.trim();
                    const cardLimit = parseFloat(cardDiv.querySelector('.card-limit-input').value) || 0;
                    const cardDueDay = parseInt(cardDiv.querySelector('.card-due-day-input').value) || 0;

                    if (cardBrand && cardLimit > 0 && cardDueDay >= 1 && cardDueDay <= 31) {
                         if (cardBrand === 'Outra' && !customCardName) {
                            showFeedback('Por favor, insira um nome para o cartão "Outra" ao editar.', 'error');
                            return; 
                        }
                        const existingCard = account.creditCards.find(c => c.cardId === cardId);
                        if (existingCard) { 
                            const oldCardLimit = existingCard.cardLimit;
                            existingCard.cardBrand = cardBrand;
                            existingCard.customCardName = cardBrand === 'Outra' ? customCardName : '';
                            existingCard.cardLimit = cardLimit;
                            existingCard.cardDueDay = cardDueDay;
                            existingCard.cardClosingDay = calculateClosingDay(cardDueDay);
                            const spentAmount = oldCardLimit - existingCard.cardAvailableLimit;
                            existingCard.cardAvailableLimit = cardLimit - spentAmount;
                            updatedCards.push(existingCard);
                        } else { 
                             updatedCards.push({
                                cardId: generateUniqueId(), 
                                cardBrand, 
                                customCardName: cardBrand === 'Outra' ? customCardName : '', 
                                cardLimit, 
                                cardDueDay,
                                cardAvailableLimit: cardLimit, 
                                currentBillAmount: 0,
                                cardClosingDay: calculateClosingDay(cardDueDay)
                            });
                        }
                    }
                });
                account.creditCards = updatedCards;
            }
            saveData();
            renderAll();
            editAccountModal.classList.add('hidden');
            showFeedback('Conta atualizada!', 'success');
        });

        // --- Detailed Statement Modal ---
        function openDetailedStatementModal(accountId) {
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            detailedStatementTitle.textContent = `Extrato Detalhado - ${account.name}`;
            statementSourceSelect.innerHTML = ''; 

            const balanceOpt = document.createElement('option');
            balanceOpt.value = 'account_balance';
            balanceOpt.textContent = 'Saldo da Conta Principal';
            statementSourceSelect.appendChild(balanceOpt);

            if (account.type === 'corrente' && account.limitOverdraft > 0) {
                const overdraftOpt = document.createElement('option');
                overdraftOpt.value = 'overdraft';
                overdraftOpt.textContent = 'Cheque Especial';
                statementSourceSelect.appendChild(overdraftOpt);
            }

            if (account.creditCards) {
                account.creditCards.forEach(card => {
                    const cardDisplayName = card.cardBrand === 'Outra' ? card.customCardName : card.cardBrand;
                    const cardOpt = document.createElement('option');
                    cardOpt.value = `credit_card_${card.cardId}`;
                    cardOpt.textContent = `Fatura Cartão: ${cardDisplayName || 'Cartão'}`;
                    statementSourceSelect.appendChild(cardOpt);
                });
            }
            
            statementSourceSelect.onchange = () => renderStatementForSource(accountId, statementSourceSelect.value);
            renderStatementForSource(accountId, statementSourceSelect.value); 

            detailedStatementModal.classList.remove('hidden');
        }
        
        function renderStatementForSource(accountId, selectedFundSource) {
            detailedStatementList.innerHTML = '';
            noDetailedStatementMessage.classList.add('hidden');
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            let statementTransactions = [];

            if (selectedFundSource === 'account_balance') {
                statementTransactions = transactions.filter(t => t.accountId === accountId && (t.fundSource === 'account_balance' || (!t.fundSource && !t.isCreditCardTransaction && t.type !== 'transferencia_saida' && t.type !== 'transferencia_entrada') || (t.type === 'transferencia_entrada' && t.destinationAccountId === accountId) || (t.type === 'transferencia_saida' && t.accountId === accountId && t.fundSource === 'account_balance') ))
                                                .sort((a,b) => new Date(a.date) - new Date(b.date));
            } else if (selectedFundSource === 'overdraft') {
                statementTransactions = transactions.filter(t => t.accountId === accountId && t.fundSource === 'overdraft')
                                                .sort((a,b) => new Date(a.date) - new Date(b.date));
            } else if (selectedFundSource.startsWith('credit_card_')) {
                statementTransactions = transactions.filter(t => t.accountId === accountId && t.fundSource === selectedFundSource)
                                                .sort((a,b) => new Date(a.date) - new Date(b.date));
            }


            if (statementTransactions.length === 0) {
                noDetailedStatementMessage.classList.remove('hidden');
                return;
            }

            statementTransactions.forEach(tx => {
                const tr = document.createElement('tr');
                let valueDisplay = formatCurrency(tx.value);
                let valueClass = "text-gray-800";

                if (selectedFundSource === 'account_balance' || selectedFundSource === 'overdraft') {
                    if (tx.fundamentalType === 'receita') {
                        valueDisplay = `+ ${valueDisplay}`;
                        valueClass = "text-green-600";
                    } else {
                        valueDisplay = `- ${valueDisplay}`;
                        valueClass = "text-red-600";
                    }
                } else { 
                     valueClass = tx.fundamentalType === 'despesa' ? "text-red-600" : "text-green-600";
                }


                tr.innerHTML = `
                    <td class="px-4 py-2 text-sm">${new Date(tx.date + "T00:00:00").toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-2 text-sm">${tx.description}</td>
                    <td class="px-4 py-2 text-sm text-right ${valueClass}">${valueDisplay}</td>
                    <td class="px-4 py-2 text-sm text-right"></td> 
                    <td class="px-4 py-2 text-right text-xs">
                        <button data-id="${tx.id}" class="edit-statement-tx-btn text-yellow-600 hover:text-yellow-800 mr-1 p-0.5">Editar</button>
                        <button data-id="${tx.id}" data-type="transaction" class="delete-statement-tx-btn text-red-400 hover:text-red-600 p-0.5">Excluir</button>
                    </td>
                `;
                tr.querySelector('.edit-statement-tx-btn').addEventListener('click', (e) => {
                    openEditTransactionModal(e.currentTarget.dataset.id);
                });
                tr.querySelector('.delete-statement-tx-btn').addEventListener('click', (e) => {
                     requestDeleteConfirmation(e.currentTarget.dataset.id, 'transaction', false, [], accountId, selectedFundSource);
                });
                detailedStatementList.appendChild(tr);
            });
        }

        if(closeDetailedStatementModalBtn) closeDetailedStatementModalBtn.addEventListener('click', () => detailedStatementModal.classList.add('hidden'));
        if(closeDetailedStatementModalFooterBtn) closeDetailedStatementModalFooterBtn.addEventListener('click', () => detailedStatementModal.classList.add('hidden'));


        // --- Delete Logic ---
        function requestDeleteConfirmation(id, type, isBulk = false, ids = [], accountIdForReversal = null, fundSourceForReversal = null) {
             itemToDelete = { id, type, showFeedback: !isBulk, isBulk, ids, accountIdForReversal, fundSourceForReversal };
            let itemName = "";
            if (type === 'allData') { itemName = "TODOS OS DADOS"; confirmationModalTitle.textContent = "Confirmar Limpeza Total"; }
            else if (isBulk) { itemName = `${ids.length} transações`; confirmationModalTitle.textContent = "Confirmar Exclusão em Lote"; }
            else if (type === 'account') { const acc = accounts.find(a => a.id === id); itemName = acc ? `a conta "${acc.name}"` : "este item"; confirmationModalTitle.textContent = "Confirmar Exclusão de Conta"; }
            else if (type === 'transaction') { const tx = transactions.find(t => t.id === id); itemName = tx ? `a transação "${tx.description}"` : "este item"; if (tx && tx.originalGroupId) itemName += " e suas parcelas"; confirmationModalTitle.textContent = "Confirmar Exclusão de Transação"; }
            confirmationModalMessage.textContent = `Tem certeza que deseja excluir ${itemName}? Esta ação não pode ser desfeita.`;
            confirmationModal.classList.remove('hidden');
        }
        if(closeConfirmationModalBtn) closeConfirmationModalBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        if(cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        if(confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', () => {
            let itemActuallyDeleted = false;
            if (itemToDelete.type === 'allData') {
                accounts = []; transactions = []; categories = ["Alimentação", "Transporte", "Moradia", "Lazer", "Saúde", "Educação", "Salário", "Investimentos", "Contas Fixas", "Compras", "Transferências", "Outros", "Revisar Importação"];
                itemActuallyDeleted = true;
            } else if (itemToDelete.isBulk) {
                let deletedCount = 0;
                const groupIdsProcessed = new Set();
                itemToDelete.ids.forEach(idToDel => {
                    const tx = transactions.find(t => t.id === idToDel);
                    if (tx) {
                        if (tx.originalGroupId && !groupIdsProcessed.has(tx.originalGroupId)) {
                            transactions = transactions.filter(t => {
                                if (t.originalGroupId === tx.originalGroupId) {
                                    updateAccountBalance(t.accountId, t.fundSource, t.value, t.fundamentalType, true, t.isPaid, t.destinationAccountId, t.type);
                                    deletedCount++;
                                    return false; 
                                }
                                return true;
                            });
                            groupIdsProcessed.add(tx.originalGroupId);
                        } else if (!tx.originalGroupId) { 
                            const txIdx = transactions.findIndex(t => t.id === idToDel);
                            if (txIdx > -1) {
                                const delTx = transactions[txIdx];
                                updateAccountBalance(delTx.accountId, delTx.fundSource, delTx.value, delTx.fundamentalType, true, delTx.isPaid, delTx.destinationAccountId, delTx.type);
                                transactions.splice(txIdx, 1);
                                deletedCount++;
                            }
                        }
                    }
                });
                if (deletedCount > 0) itemActuallyDeleted = true;
                if (itemToDelete.showFeedback && itemActuallyDeleted) showFeedback(`${deletedCount} transação(ões)/grupo(s) excluído(s).`, 'success');


            } else if (itemToDelete.type === 'account') {
                if (transactions.some(t => t.accountId === itemToDelete.id || t.destinationAccountId === itemToDelete.id)) {
                    showFeedback('Exclua ou desvincule as transações desta conta primeiro.', 'error');
                } else {
                    accounts = accounts.filter(acc => acc.id !== itemToDelete.id);
                    itemActuallyDeleted = true;
                }
            } else if (itemToDelete.type === 'transaction') {
                const tx = transactions.find(t => t.id === itemToDelete.id);
                if (tx) {
                    if (tx.originalGroupId) { 
                        let count = 0;
                        transactions = transactions.filter(t => {
                            if (t.originalGroupId === tx.originalGroupId) {
                                updateAccountBalance(t.accountId, t.fundSource, t.value, t.fundamentalType, true, t.isPaid, t.destinationAccountId, t.type);
                                count++;
                                return false;
                            }
                            return true;
                        });
                         if (count > 0) itemActuallyDeleted = true;
                    } else { 
                        const txIdx = transactions.findIndex(t_ => t_.id === itemToDelete.id);
                        if (txIdx > -1) {
                            const delTx = transactions[txIdx];
                            updateAccountBalance(delTx.accountId, delTx.fundSource, delTx.value, delTx.fundamentalType, true, delTx.isPaid, delTx.destinationAccountId, delTx.type);
                            transactions.splice(txIdx, 1);
                            itemActuallyDeleted = true;
                        }
                    }
                }
            }

            if (itemActuallyDeleted) {
                saveData();
                renderAll();
                 if (itemToDelete.showFeedback) showFeedback('Item(s) excluído(s) com sucesso.', 'success');
                if (itemToDelete.accountIdForReversal && itemToDelete.fundSourceForReversal && detailedStatementModal && !detailedStatementModal.classList.contains('hidden')) {
                    renderStatementForSource(itemToDelete.accountIdForReversal, itemToDelete.fundSourceForReversal);
                }
            }
            confirmationModal.classList.add('hidden');
            updateSelectedTransactionsActions();
        });
        
        const markTransactionAsPaid = (id, showIndividualFeedback = true) => {
             const tx = transactions.find(t => t.id === id);
            if (tx && !tx.isPaid) {
                if (!tx.isCreditCardTransaction && tx.fundamentalType === 'despesa') {
                    const account = accounts.find(acc => acc.id === tx.accountId);
                    if (account) { 
                        let tempBalance = account.balance;
                        if (tx.fundSource === 'overdraft') tempBalance += account.limitOverdraft;

                        if (tx.fundSource !== 'overdraft' && account.balance < tx.value && (account.balance + account.limitOverdraft < tx.value)) {
                             if (showIndividualFeedback) showFeedback(`Saldo insuficiente em ${account.name} (incluindo cheque especial, se aplicável) para pagar esta despesa.`, 'error');
                             return false; 
                        }
                    }
                    if(tx.accountId) { 
                        updateAccountBalance(tx.accountId, tx.fundSource, tx.value, tx.fundamentalType, false, true, tx.destinationAccountId, tx.type); 
                    }
                }
                tx.isPaid = true;
                saveData();
                if (showIndividualFeedback) showFeedback('Transação marcada como realizada!', 'success');
                renderAll();
                return true;
            } else if (tx && tx.isPaid) {
                if (showIndividualFeedback) showFeedback('Transação já está realizada.', 'info');
            }
            return false;
        };

        const populateCategorySelect = (selectElement, forBulkOrFilter = false, targetNewCategoryInput = modalNewCategoryInput) => {
            if(!selectElement) return;
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';
            
            const placeholderOptionValue = forBulkOrFilter === "filter" ? "all" : "";
            const placeholderOptionText = forBulkOrFilter === "filter" ? "Todas as Categorias" : (forBulkOrFilter ? "Manter original" : "Selecione categoria");

            if (forBulkOrFilter || selectElement === modalCategorySelect) {
                 const opt = document.createElement('option');
                 opt.value = placeholderOptionValue;
                 opt.textContent = placeholderOptionText;
                 if (selectElement === modalCategorySelect && !forBulkOrFilter) {
                    opt.disabled = true;
                    opt.selected = !currentVal;
                 }
                 selectElement.appendChild(opt);
            }


            categories.sort((a,b)=>a.localeCompare(b)).forEach(cat => {
                const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat;
                selectElement.appendChild(opt);
            });
            
            const newOptValue = selectElement === modalCategorySelect ? 'nova-categoria' : (selectElement === linkSelectedCategorySelect ? 'nova-categoria-lote' : 'nova-categoria-review'); 
            const newOpt = document.createElement('option');
            newOpt.value = newOptValue;
            newOpt.textContent = 'Adicionar Nova...';
            selectElement.appendChild(newOpt);

            if (currentVal && (categories.includes(currentVal) || currentVal === newOptValue || (forBulkOrFilter && currentVal === placeholderOptionValue) )) {
                selectElement.value = currentVal;
            } else if (selectElement === modalCategorySelect && !forBulkOrFilter && selectElement.options.length > 1 && !currentVal) {
                 selectElement.value = "";
            } else if (forBulkOrFilter && selectElement.options.length > 0) {
                selectElement.value = placeholderOptionValue;
            }

            if (selectElement === modalCategorySelect) {
                selectElement.addEventListener('change', () => { 
                    targetNewCategoryInput.classList.toggle('hidden', selectElement.value !== 'nova-categoria'); 
                    if(selectElement.value === 'nova-categoria') targetNewCategoryInput.focus(); 
                });
            }
        };
        
        const populateLinkSelectedAccountSelect = () => { 
            if(!linkSelectedAccountSelect) return;
             linkSelectedAccountSelect.innerHTML='<option value="">Vincular Conta...</option>';
             accounts.forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc.id;
                let typeText = acc.type === 'corrente' ? "C/C" : (acc.type === 'poupanca' ? "Poupança" : acc.type.charAt(0).toUpperCase() + acc.type.slice(1));
                opt.textContent = `${acc.name} (${typeText})`;
                linkSelectedAccountSelect.appendChild(opt);
             });
        };
        const populateLinkSelectedCategorySelect = () => { 
            if (!linkSelectedCategorySelect) return;
            const currentValue = linkSelectedCategorySelect.value;
            linkSelectedCategorySelect.innerHTML = '<option value="">Vincular Categoria...</option>';
            categories.sort((a, b) => a.localeCompare(b)).forEach(cat => {
                if (cat === "Revisar Importação") return;
                const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat;
                linkSelectedCategorySelect.appendChild(opt);
            });
            const newOpt = document.createElement('option'); newOpt.value = 'nova-categoria-lote'; newOpt.textContent = 'Adicionar Nova...';
            linkSelectedCategorySelect.appendChild(newOpt);
            if (currentValue && (categories.includes(currentValue) || currentValue === 'nova-categoria-lote')) {
                linkSelectedCategorySelect.value = currentValue;
            }
        };
        const populateReportSelectors = () => { 
            const currentYr = new Date().getFullYear(); const currentMth = new Date().getMonth();
            const populateYrSel = (sel, defYr) => { if(!sel) return; sel.innerHTML = ''; for(let y=currentYr+1; y>=currentYr-10; y--){ const o=document.createElement('option'); o.value=y; o.textContent=y; if(y===defYr)o.selected=true; sel.appendChild(o);}};
            const populateMthSel = (sel, defMth) => { if(!sel) return; sel.innerHTML = ''; const mN=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"]; mN.forEach((n,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=n; if(i===defMth)o.selected=true; sel.appendChild(o);});};
            populateYrSel(reportYearSelect1, currentYr); populateMthSel(reportMonthSelect1, currentMth);
            populateYrSel(reportYearSelect2, currentYr-1); populateMthSel(reportMonthSelect2, currentMth);
        };
        const checkCreditCardDueDates = () => { 
            const today=new Date(); today.setHours(0,0,0,0);
            accounts.forEach(account => {
                if (account.creditCards) {
                    account.creditCards.forEach(card => {
                        const dueDay = card.cardDueDay;
                        let billDueDate = new Date(today.getFullYear(), today.getMonth(), dueDay);
                        billDueDate.setHours(0,0,0,0);
                        if (today.getDate() > dueDay) billDueDate.setMonth(today.getMonth() + 1);

                        let billClosingDate = new Date(billDueDate);
                        billClosingDate.setDate(billDueDate.getDate() - (card.cardClosingDayOffset || 9)); 
                         if (billClosingDate > billDueDate) billClosingDate.setMonth(billClosingDate.getMonth() -1);

                        const cardDisplayName = card.customCardName || card.cardBrand;

                        if (today.getTime() === billClosingDate.getTime()) {
                            const closingBill = transactions.reduce((s, t) => {
                                const tDate = new Date(t.date + "T00:00:00");
                                if (t.fundSource === `credit_card_${card.cardId}` && t.fundamentalType === 'despesa' && tDate >= new Date(billClosingDate).setDate(billClosingDate.getDate() - 30) && tDate < billClosingDate) { 
                                    return s + t.value;
                                }
                                return s;
                            }, 0);
                            if (closingBill > 0) showFeedback(`FATURA FECHADA: ${cardDisplayName} (Conta: ${account.name}) fechou! Valor: ${formatCurrency(closingBill)}. Vencimento: ${billDueDate.toLocaleDateString('pt-BR')}`, 'info');
                        }

                        const diffT = billDueDate.getTime() - today.getTime();
                        const diffD = Math.ceil(diffT / (1000 * 60 * 60 * 24));
                        const billToNotify = transactions.reduce((s, t) => {
                             const tDate = new Date(t.date + "T00:00:00");
                             if (t.fundSource === `credit_card_${card.cardId}` && t.fundamentalType === 'despesa' && !t.isPaid && tDate >= billClosingDate && tDate < billDueDate ) { 
                                return s + t.value;
                             }
                             return s;
                        },0);

                        if (diffD <= 7 && diffD >= 0 && billToNotify > 0) {
                            showFeedback(`VENCIMENTO PRÓXIMO: Fatura ${cardDisplayName} (Conta: ${account.name}) vence ${diffD === 0 ? 'HOJE' : 'em ' + diffD + ' dia(s)'}! Valor atual: ${formatCurrency(billToNotify)}`, 'info');
                        }
                    });
                }
            });
        };
        const suggestFinancialGoals = () => { 
             if (!suggestedGoalsList || !noSuggestedGoalsMessage) return;
            suggestedGoalsList.innerHTML = ''; noSuggestedGoalsMessage.classList.add('hidden');
            const lowBalanceAccounts = accounts.filter(acc => acc.balance < 500 && acc.type !== 'investimento');
            if (lowBalanceAccounts.length > 0) {
                const li = document.createElement('li');
                li.innerHTML = `<strong>Economizar:</strong> Considere aumentar o saldo em contas como ${lowBalanceAccounts.map(a => a.name).join(', ')}.`;
                suggestedGoalsList.appendChild(li);
            }
            if (suggestedGoalsList.children.length === 0) noSuggestedGoalsMessage.classList.remove('hidden');
        };

        // --- Funções de PARSING de arquivos ---
        const parseFileAndOpenReviewModal = async (file) => {
            const fileName = file.name.toLowerCase();
            let parsedTransactionsFromFunction = []; 
            let errorOccurred = false;
            const reader = new FileReader();

            showFeedback(`Processando ${fileName}...`, "info", 5000);
            
            reader.onload = async (e) => {
                const fileContent = e.target.result;
                try {
                    if (fileName.endsWith('.ofx')) {
                        parsedTransactionsFromFunction = processOFX(fileContent, fileName);
                    } else if (fileName.endsWith('.pdf')) {
                        parsedTransactionsFromFunction = await processPDF(fileContent, fileName);
                    } else if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
                        parsedTransactionsFromFunction = await processExcel(fileContent, fileName);
                    } else {
                        showFeedback(`Formato de arquivo "${fileName.split('.').pop()}" não suportado. Use OFX, PDF ou Excel.`, 'error');
                        errorOccurred = true;
                    }

                    if (errorOccurred) {
                        if(loadFileForReviewBtn) loadFileForReviewBtn.disabled = false;
                        if(importFileInputModal) importFileInputModal.value = '';
                        return;
                    }

                    if (parsedTransactionsFromFunction.length > 0) {
                        importedTransactionsToReview = parsedTransactionsFromFunction.map(tx => ({...tx, id: tx.tempId || generateUniqueId() })); 
                        renderReviewModalTable();
                        if(fileImportSelectionModal) fileImportSelectionModal.classList.add('hidden');
                        if(reviewImportedModal) reviewImportedModal.classList.remove('hidden');
                    } else if (!errorOccurred) { 
                        showFeedback(`Nenhuma transação encontrada ou erro ao processar "${fileName}".`, "info");
                    }
                } catch (err) {
                     console.error("Erro no parsing do ficheiro:", err);
                     showFeedback(`Erro detalhado ao processar ${fileName}: ${err.message}`, "error");
                     errorOccurred = true; 
                } finally {
                     if(loadFileForReviewBtn) loadFileForReviewBtn.disabled = false;
                     if(importFileInputModal) importFileInputModal.value = '';
                }
            };

            reader.onerror = () => {
                showFeedback(`Erro ao ler o ficheiro ${fileName}.`, "error");
                if(loadFileForReviewBtn) loadFileForReviewBtn.disabled = false;
                if(importFileInputModal) importFileInputModal.value = '';
            };

            if (fileName.endsWith('.ofx')) {
                reader.readAsText(file); 
            } else if (fileName.endsWith('.pdf') || fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
                reader.readAsArrayBuffer(file); 
            } else {
                 showFeedback(`Formato de arquivo "${fileName.split('.').pop()}" não suportado. Use OFX, PDF ou Excel.`, 'error');
                 if(loadFileForReviewBtn) loadFileForReviewBtn.disabled = false;
                 if(importFileInputModal) importFileInputModal.value = '';
            }
        };
        

        // --- Nova Lógica para Importação com Modais ---
        if (openFileImportModalHeader) {
            openFileImportModalHeader.addEventListener('click', () => {
                if (fileImportSelectionModal) fileImportSelectionModal.classList.remove('hidden');
                if (fileImportArrow) fileImportArrow.classList.toggle('rotated'); 
            });
        }

        if (closeFileImportSelectionModalBtn) {
            closeFileImportSelectionModalBtn.addEventListener('click', () => {
                if (fileImportSelectionModal) fileImportSelectionModal.classList.add('hidden');
                if (fileImportArrow) fileImportArrow.classList.remove('rotated'); 
            });
        }
        if (cancelFileImportSelectionBtn) {
            cancelFileImportSelectionBtn.addEventListener('click', () => {
                if (fileImportSelectionModal) fileImportSelectionModal.classList.add('hidden');
                 if(importFileInputModal) importFileInputModal.value = '';
                if (fileImportArrow) fileImportArrow.classList.remove('rotated');
            });
        }

        if (loadFileForReviewBtn) {
            loadFileForReviewBtn.addEventListener('click', async () => {
                if (!importFileInputModal.files || importFileInputModal.files.length === 0) {
                    showFeedback('Nenhum arquivo selecionado.', 'error');
                    return;
                }
                const file = importFileInputModal.files[0];
                loadFileForReviewBtn.disabled = true;
                await parseFileAndOpenReviewModal(file); 
            });
        }

        // Funções para Modal de Revisão
        const renderReviewModalTable = () => {
            if (!reviewImportedTableBody || !importedTransactionsToReview) return;
            reviewImportedTableBody.innerHTML = '';
            noTransactionsToReviewMessage.classList.toggle('hidden', importedTransactionsToReview.length > 0);
            if (selectAllReviewCheckbox) selectAllReviewCheckbox.checked = importedTransactionsToReview.every(tx => tx.isSelected !== false);


            importedTransactionsToReview.forEach((tx, index) => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white hover:bg-gray-50 text-sm';

                const accountOptions = accounts.map(a => `<option value="${a.id}" ${tx.accountId === a.id ? 'selected' : ''}>${a.name}</option>`).join('');
                const categoryOptions = categories.filter(c => c !== "Revisar Importação").map(c => `<option value="${c}" ${tx.category === c ? 'selected' : ''}>${c}</option>`).join('');
                
                tr.innerHTML = `
                    <td class="px-2 py-2 text-center"><input type="checkbox" class="review-transaction-checkbox form-checkbox h-4 w-4 text-blue-600" data-index="${index}" ${tx.isSelected !== false ? 'checked' : ''}></td>
                    <td class="px-2 py-2"><input type="date" class="w-full" value="${tx.date || ''}" data-field="date" data-index="${index}"></td>
                    <td class="px-2 py-2"><textarea class="w-full" data-field="description" data-index="${index}" rows="2">${tx.description || ''}</textarea></td>
                    <td class="px-2 py-2"><input type="number" step="0.01" class="w-24" value="${(tx.value || 0).toFixed(2)}" data-field="value" data-index="${index}"></td>
                    <td class="px-2 py-2">
                        <select class="w-full type-select-review" data-field="type" data-index="${index}">
                            <option value="despesa" ${tx.type === 'despesa' ? 'selected' : ''}>Despesa</option>
                            <option value="receita" ${tx.type === 'receita' ? 'selected' : ''}>Receita</option>
                        </select>
                    </td>
                    <td class="px-2 py-2">
                        <select class="w-full category-select-review" data-field="category" data-index="${index}">
                            <option value="Revisar Importação" ${tx.category === 'Revisar Importação' ? 'selected' : ''}>Revisar Importação</option>
                            ${categoryOptions}
                            <option value="nova-categoria-review-row">Adicionar Nova...</option>
                        </select>
                        <input type="text" class="new-category-input-review-row hidden w-full mt-1" placeholder="Nova Cat." data-index="${index}">
                    </td>
                    <td class="px-2 py-2">
                        <div class="flex items-center space-x-1">
                            <input type="number" min="0" class="w-12 text-center" value="${tx.installmentsPaid || 0}" data-field="installmentsPaid" data-index="${index}" title="Parcelas Pagas">
                            <span>/</span>
                            <input type="number" min="1" class="w-12 text-center" value="${tx.installmentsTotal || 1}" data-field="installmentsTotal" data-index="${index}" title="Total Parcelas">
                        </div>
                    </td>
                    <td class="px-2 py-2">
                        <select class="w-full account-select-review" data-field="accountId" data-index="${index}">
                            <option value="">Nenhuma</option>
                            ${accountOptions}
                        </select>
                    </td>
                    <td class="px-2 py-2">
                        <select class="w-full fund-source-select-review" data-field="fundSource" data-index="${index}" ${tx.type !== 'despesa' ? 'disabled' : ''}>
                            <!-- Options preenchidas por JS -->
                        </select>
                    </td>
                    <td class="px-2 py-2">
                        <select class="w-full" data-field="isPaid" data-index="${index}">
                            <option value="false" ${!tx.isPaid ? 'selected' : ''}>Pendente</option>
                            <option value="true" ${tx.isPaid ? 'selected' : ''}>Paga</option>
                        </select>
                    </td>
                `;
                reviewImportedTableBody.appendChild(tr);

                const accSelect = tr.querySelector('.account-select-review');
                const fundSelect = tr.querySelector('.fund-source-select-review');
                if (tx.accountId && tx.type === 'despesa') {
                    populateFundSourceSelect(tx.accountId, fundSelect);
                    fundSelect.value = tx.fundSource || 'account_balance';
                } else {
                     fundSelect.innerHTML = '<option value="account_balance">Saldo Conta</option>'; 
                }

                tr.querySelectorAll('input, select, textarea').forEach(input => {
                    const eventType = input.tagName.toLowerCase() === 'select' || input.type === 'checkbox' || input.type === 'date' ? 'change' : 'blur';
                    input.addEventListener(eventType, (e) => {
                        const field = e.target.dataset.field;
                        const idx = parseInt(e.target.dataset.index);
                        let value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                        if (e.target.type === 'number') value = parseFloat(value) || 0;
                        if (field === 'isPaid') value = (value === 'true');
                        
                        importedTransactionsToReview[idx][field] = value;

                        if (field === 'type' || field === 'accountId') { 
                            const currentTx = importedTransactionsToReview[idx];
                            const currentRow = e.target.closest('tr');
                            const currentFundSelect = currentRow.querySelector('.fund-source-select-review');
                            if (currentTx.type === 'despesa' && currentTx.accountId) {
                                populateFundSourceSelect(currentTx.accountId, currentFundSelect);
                                currentFundSelect.disabled = false;
                                if (!Array.from(currentFundSelect.options).some(opt => opt.value === currentTx.fundSource)) {
                                     currentTx.fundSource = 'account_balance';
                                }
                                currentFundSelect.value = currentTx.fundSource;
                            } else {
                                currentFundSelect.innerHTML = '<option value="account_balance">Saldo Conta</option>';
                                currentFundSelect.disabled = true;
                                currentTx.fundSource = 'account_balance';
                            }
                        }
                         if (field === 'category' && value === 'nova-categoria-review-row') {
                            const newCatInput = currentRow.querySelector('.new-category-input-review-row');
                            newCatInput.classList.remove('hidden');
                            newCatInput.focus();
                        } else if (field === 'category' && value !== 'nova-categoria-review-row') {
                             const newCatInput = currentRow.querySelector('.new-category-input-review-row');
                             newCatInput.classList.add('hidden');
                             newCatInput.value = '';
                        }
                    });
                });
                 tr.querySelector('.new-category-input-review-row').addEventListener('blur', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    const newCategoryName = e.target.value.trim();
                    if (newCategoryName) {
                        importedTransactionsToReview[idx].category = newCategoryName;
                        const catSelect = e.target.closest('td').querySelector('.category-select-review');
                        if(catSelect.value === 'nova-categoria-review-row') catSelect.value = newCategoryName; 
                    }
                 });


            });
        };
        
        if(selectAllReviewCheckbox) {
            selectAllReviewCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.review-transaction-checkbox').forEach((checkbox, idx) => {
                    checkbox.checked = isChecked;
                    if(importedTransactionsToReview[idx]) importedTransactionsToReview[idx].isSelected = isChecked;
                });
            });
        }


        if (closeReviewImportedModalBtn) closeReviewImportedModalBtn.addEventListener('click', () => { if(reviewImportedModal) reviewImportedModal.classList.add('hidden'); importedTransactionsToReview = []; });
        if (cancelReviewImportBtn) cancelReviewImportBtn.addEventListener('click', () => { if(reviewImportedModal) reviewImportedModal.classList.add('hidden'); importedTransactionsToReview = []; });

        if (confirmReviewedImportBtn) {
            confirmReviewedImportBtn.addEventListener('click', () => {
                const transactionsToAdd = importedTransactionsToReview.filter(tx => tx.isSelected !== false);
                let importedCount = 0;

                transactionsToAdd.forEach(importedTx => {
                    let currentAccountId = importedTx.accountId; 
                    if (!importedTx.description || isNaN(parseFloat(importedTx.value)) || parseFloat(importedTx.value) <=0 || !currentAccountId && importedTx.type.includes('transferencia') || !importedTx.category) {
                        showFeedback(`Transação "${importedTx.description || 'Desconhecida'}" está incompleta e não será importada. Verifique descrição, valor, categoria e conta (obrigatória para transferências).`, 'error');
                        return; 
                    }
                    
                    let finalCategory = importedTx.category;
                    if (finalCategory === 'nova-categoria-review-row') {
                        const rowElement = Array.from(reviewImportedTableBody.children).find(row => row.querySelector(`[data-index="${importedTransactionsToReview.indexOf(importedTx)}"]`));
                        const newCatInputForRow = rowElement ? rowElement.querySelector('.new-category-input-review-row') : null;

                        if(newCatInputForRow && newCatInputForRow.value.trim()) {
                            finalCategory = newCatInputForRow.value.trim();
                            if (!categories.includes(finalCategory)) {
                                categories.push(finalCategory);
                                populateCategorySelect(modalCategorySelect); 
                                populateLinkSelectedCategorySelect();
                            }
                        } else {
                             showFeedback(`Categoria nova para "${importedTx.description}" não foi definida. Usando "Outros".`, 'info');
                            finalCategory = "Outros";
                        }
                    }


                    const totalInstallments = parseInt(importedTx.installmentsTotal) || 1;
                    const installmentsPaid = parseInt(importedTx.installmentsPaid) || 0;
                    const baseDate = new Date(importedTx.date + "T00:00:00"); 
                    const originalGroupIdForInstallments = totalInstallments > 1 ? generateUniqueId() : null;

                    for (let i = 0; i < totalInstallments; i++) {
                        const installmentDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + i, baseDate.getDate());
                        
                         if (installmentDate.getDate() !== baseDate.getDate()) {
                            installmentDate.setDate(0); 
                        }

                        const newTransaction = {
                            id: generateUniqueId(),
                            date: installmentDate.toISOString().split('T')[0],
                            description: totalInstallments > 1 ? `${importedTx.description} (${i + 1}/${totalInstallments})` : importedTx.description,
                            value: parseFloat(importedTx.value),
                            type: importedTx.type,
                            fundamentalType: (importedTx.type === 'receita' || importedTx.type === 'transferencia_entrada') ? 'receita' : 'despesa',
                            category: finalCategory,
                            accountId: currentAccountId, 
                            fundSource: currentAccountId ? (importedTx.fundSource || 'account_balance') : null,
                            isCreditCardTransaction: currentAccountId ? (importedTx.fundSource || '').startsWith('credit_card_') : false,
                            installments: `${i + 1}/${totalInstallments}`,
                            isPaid: i < installmentsPaid || (totalInstallments === 1 && importedTx.isPaid), 
                            originalGroupId: originalGroupIdForInstallments,
                            destinationAccountId: importedTx.type.includes('transferencia') ? importedTx.destinationAccountId : null 
                        };
                        transactions.push(newTransaction);
                        if (newTransaction.accountId) {
                           updateAccountBalance(newTransaction.accountId, newTransaction.fundSource, newTransaction.value, newTransaction.fundamentalType, false, newTransaction.isPaid, newTransaction.destinationAccountId, newTransaction.type);
                        }
                    }
                    importedCount++;
                });

                if (importedCount > 0) {
                    saveData();
                    renderAll();
                    showFeedback(`${importedCount} transação(ões) importada(s) com sucesso!`, 'success');
                } else if (transactionsToAdd.length > 0) {
                     showFeedback('Nenhuma transação válida para importar após revisão.', 'info');
                } else {
                     showFeedback('Nenhuma transação selecionada ou processada para importação.', 'info');
                }
                
                if(reviewImportedModal) reviewImportedModal.classList.add('hidden');
                importedTransactionsToReview = [];
            });
        }

        // --- Event Listeners (Collapsible sections, etc.) ---
        if(reportsHeader) reportsHeader.addEventListener('click', () => { reportsSectionContent.classList.toggle('hidden'); reportsArrow.classList.toggle('rotated'); });
        if(suggestedGoalsHeader) suggestedGoalsHeader.addEventListener('click', () => { suggestedGoalsContent.classList.toggle('hidden'); suggestedGoalsArrow.classList.toggle('rotated'); if(!suggestedGoalsContent.classList.contains('hidden')) suggestFinancialGoals(); });
        if(clearAllDataLink) clearAllDataLink.addEventListener('click', () => requestDeleteConfirmation(null, 'allData'));
        if(transactionList) transactionList.addEventListener('change', (e) => { if (e.target.classList.contains('transaction-checkbox')) updateSelectedTransactionsActions(); });
        if(selectAllTransactionsCheckbox) selectAllTransactionsCheckbox.addEventListener('change', (e) => { document.querySelectorAll('#transaction-list .transaction-checkbox').forEach(cb => { cb.checked = e.target.checked; }); updateSelectedTransactionsActions(); });

        function updateSelectedTransactionsActions() {
            const selectedCheckboxes = document.querySelectorAll('#transaction-list .transaction-checkbox:checked'); 
            const selectedCount = selectedCheckboxes.length;
            const hasSelected = selectedCount > 0;

            if(bulkActionsContainer) bulkActionsContainer.classList.toggle('hidden', !hasSelected);
            if(selectedTransactionsCountEl) selectedTransactionsCountEl.textContent = selectedCount;

            const allVisibleCheckboxes = document.querySelectorAll('#transaction-list .transaction-checkbox');
            if(selectAllTransactionsCheckbox) selectAllTransactionsCheckbox.checked = allVisibleCheckboxes.length > 0 && selectedCheckboxes.length === allVisibleCheckboxes.length;
        }
        if(paySelectedTransactionsBtn) paySelectedTransactionsBtn.addEventListener('click', () => { const ids = Array.from(document.querySelectorAll('#transaction-list .transaction-checkbox:checked')).map(cb=>cb.dataset.id); let c=0; ids.forEach(id => {if(markTransactionAsPaid(id,false))c++;}); if(c>0)showFeedback(`${c} transações pagas.`,'success'); renderAll();});
        if(deleteSelectedTransactionsBtn) deleteSelectedTransactionsBtn.addEventListener('click', () => { const ids=Array.from(document.querySelectorAll('#transaction-list .transaction-checkbox:checked')).map(cb=>cb.dataset.id); if(ids.length>0) requestDeleteConfirmation(null,'transaction',true,ids);});
        
        if (saveAllDataLink) { 
            saveAllDataLink.addEventListener('click', (e) => {
                 e.preventDefault(); 
                try {
                    const dataToSave = {
                        accounts: accounts,
                        transactions: transactions,
                        categories: categories,
                        savedAt: new Date().toISOString()
                    };
                    const jsonData = JSON.stringify(dataToSave, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    a.download = `controle_financeiro_backup_${timestamp}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showFeedback('Todos os dados foram salvos com sucesso!', 'success');
                } catch (error) {
                    console.error("Erro ao salvar dados:", error);
                    showFeedback('Erro ao salvar os dados. Verifique o console.', 'error');
                }
            });
        }
        
        if(toggleFiltersBtn && mainFiltersCollapsibleContent) {
            toggleFiltersBtn.addEventListener('click', () => {
                mainFiltersCollapsibleContent.classList.toggle('expanded');
            });
        }
        
        if (loadSavedDataBtn) {
            loadSavedDataBtn.addEventListener('click', () => {
                if (loadJsonInput) loadJsonInput.click();
            });
        }

        if (loadJsonInput) {
            loadJsonInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const loadedData = JSON.parse(e.target.result);
                            if (loadedData && Array.isArray(loadedData.accounts) && Array.isArray(loadedData.transactions) && Array.isArray(loadedData.categories)) {
                                accounts = loadedData.accounts;
                                transactions = loadedData.transactions;
                                categories = loadedData.categories;
                                if (!categories.includes("Revisar Importação")) categories.push("Revisar Importação");
                                if (!categories.includes("Transferências")) categories.push("Transferências");
                                
                                saveData(); 
                                renderAll(); 
                                showFeedback('Dados carregados com sucesso!', 'success');
                            } else {
                                showFeedback('Formato de arquivo JSON inválido.', 'error');
                            }
                        } catch (error) {
                            console.error("Erro ao carregar dados do JSON:", error);
                            showFeedback('Erro ao carregar o arquivo JSON. Verifique o console.', 'error');
                        } finally {
                            loadJsonInput.value = ''; 
                        }
                    };
                    reader.readAsText(file);
                }
            });
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            if (accountTypeSelect && accountTypeSelect.value === 'corrente') { 
                if(overdraftSection) overdraftSection.classList.remove('hidden');
                if(creditCardSection) creditCardSection.classList.remove('hidden');
                if (linkedCardsContainer && linkedCardsContainer.children.length === 0) addCardInputFields(linkedCardsContainer);
            }
            loadData(); 
        });

    </script>
</body>
</html>

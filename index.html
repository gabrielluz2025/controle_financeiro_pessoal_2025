<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal Unificado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js' defer></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // Define o caminho do worker para PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        #feedback-message {
            display: none; padding: 12px; margin-top: 16px; border-radius: 8px; font-weight: 500;
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; min-width: 300px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .feedback-success { background-color: #d1fae5; color: #065f46; }
        .feedback-error { background-color: #fee2e2; color: #991b1b; }
        .feedback-info { background-color: #e0f2fe; color: #075985; }
        .hidden { display: none !important; }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #e2e8f0; margin-bottom: 1rem; }
        .collapsible-header:hover { background-color: #f8fafc; }
        .collapsible-header h2 { margin-bottom: 0; }
        .collapsible-header-inner { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .collapsible-header-inner:hover { background-color: #f9fafb; }
        .arrow-icon { transition: transform 0.3s ease; }
        .arrow-icon.rotated { transform: rotate(90deg); }
        .paid-transaction td { text-decoration: line-through; color: #9ca3af; }
        .pending-previous-month td { font-style: italic; }
        .pending-previous-month:not(.paid-transaction) td { font-weight: 600; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; overflow-y: auto; }
        .modal-content { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 90%; max-width: 700px; margin-top: 2rem; margin-bottom: 2rem; max-height: 90vh; overflow-y: auto;}
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h3 { font-size: 1.5rem; font-weight: 600; color: #333; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .modal-body label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #4a5568; }
        .modal-body p { margin-bottom: 0.75rem; line-height: 1.6; }
        .modal-body strong { font-weight: 600; color: #1e40af; }
        .modal-body ul { list-style-position: inside; padding-left: 0.5rem; }
        .modal-body ul li { margin-bottom: 0.5rem; }
        .modal-body input[type="text"], .modal-body input[type="number"], .modal-body input[type="date"], .modal-body select { width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; margin-bottom: 1rem; background-color: #fff; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        #imported-transactions-table-body input, #imported-transactions-table-body select, #imported-transactions-table-body textarea { font-size: 0.875rem; padding: 0.25rem 0.5rem; }
        #imported-transactions-table-body textarea { min-height: 40px; }
        #reports-section-content .report-table th, #reports-section-content .report-table td { padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; text-align: left; }
        #reports-section-content .report-table th { background-color: #f8fafc; font-weight: 600; }
        #reports-section-content .report-table td:nth-child(n+2) { text-align: right; }
        .account-item-header, .card-item-header { cursor: pointer; display: flex; align-items: center; }
        .account-item-header .arrow-icon, .card-item-header .arrow-icon { margin-left: 0.5rem; }
        .account-details-content, .card-details-content-unified { padding-left: 1.5rem; margin-top: 0.5rem; }
        .bill-details-content ul { padding-left: 1rem; margin-top: 0.5rem; }
        .bill-details-content li { margin-bottom: 0.25rem; }
        #detailed-statement-modal .modal-content, #edit-account-modal .modal-content { max-height: 80vh; }
        #confirmation-modal .modal-content { max-width: 400px; }
        #suggested-goals-list li { background-color: #eef2ff; padding: 0.75rem 1rem; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.9rem; color: #3730a3; }
        #suggested-goals-list li strong { color: #312e81; }
        #clear-all-data-link, #save-all-data-link { font-size: 0.8rem; color: #6b7280; text-decoration: underline; cursor: pointer; }
        #clear-all-data-link:hover, #save-all-data-link:hover { color: #ef4444; }
        #save-all-data-link:hover { color: #16a34a; } /* Cor verde para o link de salvar */
        .add-transaction-type-btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease-in-out; }
        .sub-section-form { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; background-color: #f9fafb;}
        .sub-section-form h4 { font-size: 1rem; font-weight: 600; color: #4b5563; margin-bottom: 0.75rem; }
        .input-xs { font-size: 0.875rem; padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; } /* Tailwind-like small input */
        .btn-xs { padding: 0.25rem 0.75rem; font-size: 0.875rem; border-radius: 0.375rem; font-weight: 500; color: white; } /* Tailwind-like small button */
        .th-xs { padding: 0.5rem 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; color: #4b5563;} /* Tailwind-like small table header */

    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-10">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <div class="flex justify-between items-start mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 flex-grow">Controle Financeiro Pessoal Unificado</h1>
            <button id="clear-all-data-link" class="ml-4 whitespace-nowrap">Limpar Dados</button>
        </div>

        <!-- Painel de Resumo -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-blue-800">Poder de Compra Total</h2>
                <p id="total-poder-compra" class="text-2xl font-bold text-blue-700">R$ 0,00</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-red-800">Despesas do Mês</h2>
                <p id="total-despesas" class="text-2xl font-bold text-red-700">R$ 0,00</p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-green-800">Saldo Contas (Líquido)</h2>
                <p id="saldo-liquido-contas" class="text-2xl font-bold text-green-700">R$ 0,00</p>
            </div>
            <div class="bg-orange-100 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-orange-800">Faturas Cartões (Mês)</h2>
                <p id="total-faturas-cartoes-mes" class="text-2xl font-bold text-orange-700">R$ 0,00</p>
            </div>
        </div>

        <!-- Gerenciar Contas (Unificado) -->
        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gerenciar Contas</h2>
            <div class="p-4 bg-gray-50 rounded-lg shadow-sm mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Nova Conta</h3>
                <form id="add-account-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="account-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Conta</label>
                            <input type="text" id="account-name" placeholder="Ex: Banco X, Carteira" required class="w-full input-sm">
                        </div>
                        <div>
                            <label for="account-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Conta</label>
                            <select id="account-type" class="w-full input-sm">
                                <option value="corrente">Conta Corrente</option>
                                <option value="poupanca">Conta Poupança</option>
                                <option value="cash">Dinheiro (Caixa)</option>
                                <option value="investimento">Investimento</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label for="initial-balance" class="block text-sm font-medium text-gray-700 mb-1">Saldo Inicial (R$)</label>
                            <input type="number" id="initial-balance" step="0.01" placeholder="0.00" required class="w-full input-sm">
                        </div>
                    </div>

                    <!-- Seção Cheque Especial (para Conta Corrente) -->
                    <div id="overdraft-section" class="hidden sub-section-form">
                        <h4>Cheque Especial</h4>
                        <div>
                            <label for="overdraft-limit" class="block text-sm font-medium text-gray-700 mb-1">Limite do Cheque Especial (R$)</label>
                            <input type="number" id="overdraft-limit" step="0.01" placeholder="0.00" class="w-full input-sm">
                        </div>
                    </div>

                    <!-- Seção Cartões de Crédito (para Conta Corrente) -->
                    <div id="credit-card-section" class="hidden sub-section-form">
                        <h4>Cartões de Crédito Vinculados a esta Conta</h4>
                        <div id="linked-cards-container" class="space-y-3">
                            <!-- Campos para cartões serão adicionados aqui por JS -->
                        </div>
                        <button type="button" id="add-another-card-btn" class="mt-3 px-4 py-1.5 bg-purple-500 text-white text-xs font-semibold rounded-md hover:bg-purple-600">Adicionar Cartão a esta Conta</button>
                    </div>
                     <div class="flex justify-end pt-3">
                        <button type="submit" class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600">Adicionar Conta</button>
                    </div>
                </form>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Minhas Contas</h3>
                <ul id="accounts-list" class="bg-white rounded-md shadow-sm divide-y divide-gray-200">
                    <!-- Lista de contas unificadas será preenchida aqui -->
                </ul>
            </div>
        </div>

        <!-- Seções de Metas, Adicionar Transação, Importar, Relatórios, Opções de Dados (mantidas como antes, mas a lógica interna pode mudar) -->
        <div class="mb-8 border-b pb-6 border-gray-200">
            <div id="suggested-goals-header" class="collapsible-header">
                <h2 class="text-2xl font-semibold text-gray-700">Sugestões de Metas Financeiras</h2>
                <svg id="suggested-goals-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
            <div id="suggested-goals-content" class="hidden p-4 bg-gray-50 rounded-lg shadow-sm">
                <ul id="suggested-goals-list" class="space-y-2"></ul>
                <p id="no-suggested-goals-message" class="text-center text-gray-500 mt-2 hidden">Nenhuma sugestão de meta no momento.</p>
            </div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Adicionar Nova Transação</h2>
            <div class="flex flex-wrap gap-3">
                <button id="open-add-receita-modal-btn" data-type="receita" class="add-transaction-type-btn bg-green-500 hover:bg-green-600 text-white">Nova Receita</button>
                <button id="open-add-despesa-modal-btn" data-type="despesa" class="add-transaction-type-btn bg-red-500 hover:bg-red-600 text-white">Nova Despesa</button>
                <button id="open-add-transferencia-modal-btn" data-type="transferencia" class="add-transaction-type-btn bg-sky-500 hover:bg-sky-600 text-white">Nova Transferência</button>
            </div>
        </div>

        <!-- Importar Extratos (Outros Formatos) -->
        <div class="mb-8 border-b pb-6 border-gray-200">
            <div id="import-header" class="collapsible-header">
                <h2 class="text-2xl font-semibold text-gray-700">Importar Extratos (OFX, CSV, Excel, Word, Imagem)</h2>
                <svg id="import-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
            <div id="import-section-content" class="hidden">
                <p class="text-sm text-gray-600 mb-4">Seu arquivo deve ser OFX, CSV, Excel, Word (.docx) ou Imagem (.png, .jpg). Para extratos em PDF, utilize a secção "Importar Extrato PDF" abaixo. <span class="font-bold text-red-600">Atenção: Integração direta com bancos (Open Finance) não é possível.</span> <span class="font-bold text-orange-600">Importação de Word e Imagem: revise dados cuidadosamente.</span></p>
                <div class="p-4 bg-gray-50 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Carregar Arquivo de Extrato</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                        <div><label for="file-input" class="block text-sm font-medium text-gray-700 mb-1">Selecione o Arquivo</label><input type="file" id="file-input" accept=".ofx,.csv,.xls,.xlsx,.doc,.docx,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer"></div>
                        <div class="flex justify-end col-span-full sm:col-span-1"><button id="import-file-btn" class="w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700">Carregar para Revisão</button></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Importar Extrato PDF -->
        <div class="mb-8 border-b pb-6 border-gray-200">
            <div id="import-pdf-header" class="collapsible-header">
                <h2 class="text-2xl font-semibold text-gray-700">Importar Extrato PDF</h2>
                <svg id="import-pdf-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
            <div id="import-pdf-section-content" class="hidden">
                <p class="text-sm text-gray-600 mb-4">Selecione um arquivo de extrato no formato PDF. <span class="font-bold text-orange-600">A qualidade da extração pode variar. Revise os dados cuidadosamente.</span></p>
                <div class="p-4 bg-gray-50 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Carregar Arquivo PDF</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                        <div><label for="file-input-pdf" class="block text-sm font-medium text-gray-700 mb-1">Selecione o Arquivo PDF</label><input type="file" id="file-input-pdf" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer"></div>
                        <div class="flex justify-end col-span-full sm:col-span-1"><button id="import-pdf-file-btn" class="w-full sm:w-auto px-6 py-2 bg-purple-600 text-white font-semibold rounded-md shadow-md hover:bg-purple-700">Carregar PDF para Revisão</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="feedback-message"></div>
        <div id="import-review-section" class="mb-8 border-b pb-6 border-gray-200 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Revisar Transações Importadas</h2>
            <p class="text-sm text-gray-600 mb-4">Selecione as transações. Vincule-as a uma conta e ajuste os dados. <span class="font-bold text-orange-600">Para Word/Imagem, revise tudo.</span></p>
            
            <!-- Filtros para Revisão de Importação -->
            <div id="import-filters-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mb-4 p-3 bg-gray-50 rounded-md">
                <div>
                    <label for="filter-import-type" class="text-xs font-medium text-gray-700">Tipo:</label>
                    <select id="filter-import-type" class="filter-import-select mt-1 block w-full input-xs">
                        <option value="all">Todos os Tipos</option>
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                        <option value="transferencia_entrada">Transferência (Entrada)</option>
                        <option value="transferencia_saida">Transferência (Saída)</option>
                    </select>
                </div>
                <div>
                    <label for="filter-import-category" class="text-xs font-medium text-gray-700">Categoria:</label>
                    <select id="filter-import-category" class="filter-import-select mt-1 block w-full input-xs">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="filter-import-account" class="text-xs font-medium text-gray-700">Conta Vinculada:</label>
                    <select id="filter-import-account" class="filter-import-select mt-1 block w-full input-xs">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="filter-import-status" class="text-xs font-medium text-gray-700">Status Pagamento:</label>
                    <select id="filter-import-status" class="filter-import-select mt-1 block w-full input-xs">
                        <option value="all">Todos os Status</option>
                        <option value="true">Pago</option>
                        <option value="false">Não Pago</option>
                    </select>
                </div>
            </div>

            <div id="bulk-edit-imported-controls" class="hidden mt-4 mb-4 p-4 bg-gray-100 rounded-md shadow">
                <h4 class="text-md font-semibold text-gray-700 mb-3">Editar Selecionadas:</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div><label for="bulk-edit-type" class="block text-xs font-medium text-gray-700">Tipo:</label><select id="bulk-edit-type" class="mt-1 block w-full text-xs border-gray-300 rounded-md shadow-sm py-1.5 px-2"><option value="">Manter original</option><option value="receita">Receita</option><option value="despesa">Despesa</option><option value="transferencia_entrada">Transferência (Entrada)</option><option value="transferencia_saida">Transferência (Saída)</option></select></div>
                    <div><label for="bulk-edit-category" class="block text-xs font-medium text-gray-700">Categoria:</label><select id="bulk-edit-category" class="mt-1 block w-full text-xs border-gray-300 rounded-md shadow-sm py-1.5 px-2"></select></div>
                    <div><label for="bulk-edit-account" class="block text-xs font-medium text-gray-700">Vincular a Conta:</label><select id="bulk-edit-account" class="mt-1 block w-full text-xs border-gray-300 rounded-md shadow-sm py-1.5 px-2"></select></div>
                    <div><label for="bulk-edit-status" class="block text-xs font-medium text-gray-700">Status Pagamento:</label><select id="bulk-edit-status" class="mt-1 block w-full text-xs border-gray-300 rounded-md shadow-sm py-1.5 px-2"><option value="">Manter original</option><option value="true">Pago</option><option value="false">Não Pago</option></select></div>
                    <div class="lg:col-span-4 flex justify-end mt-2"><button id="apply-bulk-edit-imported-btn" class="px-4 py-2 bg-orange-500 text-white font-semibold rounded-md shadow-md hover:bg-orange-600 text-xs">Aplicar</button></div>
                </div>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md mb-4"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-yellow-50"><tr><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider"><input type="checkbox" id="select-all-imported-transactions"></th><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data</th><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Descrição</th><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Valor</th><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tipo</th><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Categoria</th><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Parcelas</th><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Vincular a Conta</th><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Fonte Pagamento (se despesa)</th><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th></tr></thead><tbody id="imported-transactions-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
            <div class="flex justify-end gap-4"><button id="cancel-review-btn" class="px-6 py-2 bg-gray-400 text-white font-semibold rounded-md shadow-md hover:bg-gray-500">Cancelar</button><button id="confirm-import-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700">Confirmar Selecionadas</button></div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <div id="reports-header" class="collapsible-header"><h2 class="text-2xl font-semibold text-gray-700">Relatórios de Gastos</h2><svg id="reports-arrow" class="arrow-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
            <div id="reports-section-content" class="hidden"><div class="p-4 bg-gray-50 rounded-lg shadow-sm mb-6"><h3 class="text-xl font-semibold text-gray-700 mb-3">Gerar Relatório</h3><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-x-4 gap-y-2 items-end mb-4"><div><label for="report-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label><select id="report-type" class="mt-1 block w-full input-sm"><option value="monthly">Mensal</option><option value="annual">Anual</option><option value="comparison_monthly">Comparativo Mensal</option><option value="comparison_annual">Comparativo Anual</option></select></div><div id="report-period1-month-div"><label for="report-month" class="block text-sm font-medium text-gray-700 mb-1">Mês (Período 1)</label><select id="report-month" class="mt-1 block w-full input-sm"></select></div><div id="report-period1-year-div"><label for="report-year" class="block text-sm font-medium text-gray-700 mb-1">Ano (Período 1)</label><select id="report-year" class="mt-1 block w-full input-sm"></select></div><div id="report-period2-month-div" class="hidden"><label for="report-month-comp" class="block text-sm font-medium text-gray-700 mb-1">Mês (Período 2)</label><select id="report-month-comp" class="mt-1 block w-full input-sm"></select></div><div id="report-period2-year-div" class="hidden"><label for="report-year-comp" class="block text-sm font-medium text-gray-700 mb-1">Ano (Período 2)</label><select id="report-year-comp" class="mt-1 block w-full input-sm"></select></div><div class="lg:col-span-1 flex justify-end self-end"><button id="generate-report-btn" class="w-full sm:w-auto px-6 py-2 bg-teal-500 text-white font-semibold rounded-md shadow-md hover:bg-teal-600">Gerar</button></div></div></div><div id="report-output-area" class="mt-6 overflow-x-auto"></div></div>
        </div>

        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Opções de Dados</h2>
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <button id="download-xlsx-btn" class="w-full sm:w-auto px-6 py-2 bg-gray-600 text-white font-semibold rounded-md shadow-md hover:bg-gray-700">Baixar Transações (Excel)</button>
                <a href="#" id="save-all-data-link" class="text-sm text-green-600 hover:text-green-800 underline">Salvar Todos os Dados (JSON)</a>
            </div>
        </div>

        <!-- Minhas Transações -->
        <div>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-semibold text-gray-700">Minhas Transações</h2>
                <div class="flex flex-wrap items-center gap-2">
                    <input type="text" id="search-transactions-input" placeholder="Buscar transações..." class="input-sm w-full sm:w-auto">
                    <button id="pay-selected-transactions-btn" class="hidden btn-xs bg-green-500">Pagar Selecionadas</button>
                    <button id="unpay-selected-transactions-btn" class="hidden btn-xs bg-yellow-500">Desmarcar Pagamento</button>
                    <select id="link-selected-account-select" class="hidden input-xs"></select>
                    <button id="link-selected-transactions-btn" class="hidden btn-xs bg-blue-500">Vincular Conta</button>
                    <select id="link-selected-category-select" class="hidden input-xs"></select>
                    <button id="link-selected-category-btn" class="hidden btn-xs bg-indigo-500">Vincular Categoria</button>
                    <button id="delete-selected-transactions-btn" class="hidden btn-xs bg-red-500">Excluir Selecionadas</button>
                </div>
            </div>

            <!-- Filtros para Minhas Transações -->
            <div id="main-filters-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 mb-4 p-3 bg-gray-100 rounded-md">
                <div>
                    <label for="filter-main-type" class="text-xs font-medium text-gray-700">Tipo:</label>
                    <select id="filter-main-type" class="filter-main-select mt-1 block w-full input-xs">
                        <option value="all">Todos os Tipos</option>
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                        <option value="transferencia_entrada">Transferência (Entrada)</option>
                        <option value="transferencia_saida">Transferência (Saída)</option>
                    </select>
                </div>
                <div>
                    <label for="filter-main-category" class="text-xs font-medium text-gray-700">Categoria:</label>
                    <select id="filter-main-category" class="filter-main-select mt-1 block w-full input-xs">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="filter-main-account" class="text-xs font-medium text-gray-700">Conta Principal:</label>
                    <select id="filter-main-account" class="filter-main-select mt-1 block w-full input-xs">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="filter-main-fund-source" class="text-xs font-medium text-gray-700">Fonte Pagamento:</label>
                    <select id="filter-main-fund-source" class="filter-main-select mt-1 block w-full input-xs">
                        <option value="all">Todas as Fontes</option>
                        <option value="account_balance">Saldo da Conta</option>
                        <option value="overdraft">Cheque Especial</option>
                        <option value="credit_card_any">Cartão de Crédito (Qualquer)</option>
                    </select>
                </div>
                <div>
                    <label for="filter-main-status" class="text-xs font-medium text-gray-700">Status:</label>
                    <select id="filter-main-status" class="filter-main-select mt-1 block w-full input-xs">
                        <option value="all">Todos os Status</option>
                        <option value="paid">Realizado</option>
                        <option value="pending">Pendente</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center space-x-4 mb-4">
                <button id="prev-month-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Anterior</button>
                <span id="current-month-display" class="text-lg font-semibold text-gray-800"></span>
                <button id="next-month-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Próximo</button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-3 text-center th-xs"><input type="checkbox" id="select-all-transactions"></th>
                            <th class="px-6 py-3 text-left th-xs">Data</th>
                            <th class="px-6 py-3 text-left th-xs">Status</th>
                            <th class="px-6 py-3 text-left th-xs">Descrição</th>
                            <th class="px-6 py-3 text-left th-xs">Valor</th>
                            <th class="px-6 py-3 text-left th-xs">Tipo</th>
                            <th class="px-6 py-3 text-left th-xs">Categoria</th>
                            <th class="px-6 py-3 text-left th-xs">Conta</th>
                            <th class="px-6 py-3 text-left th-xs">Fonte Pagamento</th>
                            <th class="px-6 py-3 text-left th-xs">Parcela</th>
                            <th class="px-6 py-3 text-left th-xs">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <p id="no-transactions-message" class="text-center text-gray-500 mt-4 hidden">Nenhuma transação registrada ainda.</p>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Transação -->
    <div id="add-transaction-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="add-transaction-modal-title">Adicionar Nova Transação</h3>
                <button class="modal-close-btn" id="close-add-transaction-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transaction-form-modal" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="hidden" id="modal-transaction-id"> <!-- Para edição -->
                    <div>
                        <label for="modal-date">Data</label>
                        <input type="date" id="modal-date" required>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="modal-description">Descrição</label>
                        <input type="text" id="modal-description" placeholder="Ex: Salário, Aluguel" required>
                    </div>
                    <div>
                        <label for="modal-value">Valor da Parcela (R$)</label>
                        <input type="number" id="modal-value" step="0.01" placeholder="0.00" required>
                    </div>
                    <div>
                        <label for="modal-type">Tipo</label>
                        <select id="modal-type" required>
                            <option value="receita">Receita</option>
                            <option value="despesa">Despesa</option>
                            <option value="transferencia_saida">Transferência (Saída)</option>
                            <option value="transferencia_entrada">Transferência (Entrada)</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="modal-category-select">Categoria</label>
                        <div class="flex items-center space-x-2">
                            <select id="modal-category-select" required></select>
                        </div>
                        <input type="text" id="modal-new-category-input" placeholder="Nova Categoria" class="mt-2 hidden">
                    </div>
                    <div>
                        <label for="modal-account-select">Conta Principal</label>
                        <select id="modal-account-select"></select> <!-- Será populado com contas principais -->
                    </div>
                    <!-- Novo campo para Fonte de Pagamento (para despesas) -->
                    <div id="modal-fund-source-div" class="hidden">
                        <label for="modal-fund-source-select">Fonte do Pagamento/Recebimento</label>
                        <select id="modal-fund-source-select"></select>
                    </div>
                    <!-- Campo para conta de destino (para transferências) -->
                    <div id="modal-destination-account-div" class="hidden">
                        <label for="modal-destination-account-select">Conta de Destino</label>
                        <select id="modal-destination-account-select"></select>
                    </div>
                    <div>
                        <label for="modal-installments">Parcelas (total)</label>
                        <input type="number" id="modal-installments" min="1" value="1">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="modal-installments-paid">Parcelas já pagas</label>
                        <input type="number" id="modal-installments-paid" min="0" value="0">
                    </div>
                     <div class="sm:col-span-2">
                        <label for="modal-paid-status" class="inline-flex items-center">
                            <input type="checkbox" id="modal-paid-status" class="form-checkbox h-5 w-5 text-blue-600">
                            <span class="ml-2 text-sm text-gray-700">Marcar como Paga/Recebida</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="save-add-transaction-modal-btn" type="submit" form="transaction-form-modal" class="btn bg-blue-600">Salvar Transação</button>
                <button id="cancel-add-transaction-modal-btn" class="btn bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Conta (Unificado) -->
    <div id="edit-account-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Conta</h3>
                <button class="modal-close-btn" id="close-edit-account-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-account-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-account-name">Nome da Conta</label>
                        <input type="text" id="edit-account-name" required>
                    </div>
                    <div>
                        <label for="edit-account-type-display">Tipo de Conta</label>
                        <input type="text" id="edit-account-type-display" readonly class="bg-gray-100">
                    </div>
                </div>
                <div>
                    <label for="edit-account-balance">Saldo Atual (R$)</label>
                    <input type="number" id="edit-account-balance" step="0.01" required>
                </div>
                <!-- Seção Cheque Especial para Edição -->
                <div id="edit-overdraft-section" class="hidden sub-section-form mt-4">
                    <h4>Cheque Especial</h4>
                    <div>
                        <label for="edit-overdraft-limit">Limite do Cheque Especial (R$)</label>
                        <input type="number" id="edit-overdraft-limit" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <!-- Seção Cartões de Crédito para Edição -->
                <div id="edit-credit-card-section" class="hidden sub-section-form mt-4">
                    <h4>Cartões de Crédito Vinculados</h4>
                    <div id="edit-linked-cards-container" class="space-y-3">
                        <!-- Campos para cartões existentes e novos serão adicionados aqui -->
                    </div>
                    <button type="button" id="edit-add-another-card-btn" class="mt-3 px-4 py-1.5 bg-purple-500 text-white text-xs font-semibold rounded-md hover:bg-purple-600">Adicionar Novo Cartão a esta Conta</button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-edit-account-btn" class="btn bg-blue-500">Salvar Alterações</button>
                <button id="cancel-edit-account-btn" class="btn bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Extrato Detalhado (Substitui Account Entries) -->
    <div id="detailed-statement-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailed-statement-title">Extrato Detalhado</h3>
                <button class="modal-close-btn" id="close-detailed-statement-modal">&times;</button>
            </div>
            <div class="modal-body overflow-y-auto">
                <div class="mb-4">
                    <label for="statement-source-select" class="block text-sm font-medium text-gray-700 mb-1">Visualizar Extrato de:</label>
                    <select id="statement-source-select" class="w-full input-sm">
                        <!-- Opções serão populadas por JS: Saldo Conta, Cheque Especial, Cartão X -->
                    </select>
                </div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left th-xs">Data</th>
                            <th class="px-4 py-2 text-left th-xs">Descrição</th>
                            <th class="px-4 py-2 text-left th-xs">Valor</th>
                            <th class="px-4 py-2 text-left th-xs">Saldo Após (Opcional)</th>
                            <th class="px-4 py-2 text-left th-xs">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-statement-list" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                <p id="no-detailed-statement-message" class="text-center text-gray-500 mt-4 hidden">Nenhuma transação para este extrato.</p>
            </div>
            <div class="modal-footer">
                <button id="close-detailed-statement-modal-footer" class="btn bg-gray-400">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação (Mantido) -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content"><div class="modal-header"><h3 id="confirmation-modal-title">Confirmar</h3><button class="modal-close-btn" id="close-confirmation-modal">&times;</button></div><div class="modal-body"><p id="confirmation-modal-message">Tem certeza?</p></div><div class="modal-footer"><button id="confirm-delete-btn" class="btn bg-red-600">Confirmar</button><button id="cancel-delete-btn" class="btn bg-gray-400">Cancelar</button></div></div>
    </div>

    <script>
        // --- Global Variables & Initial Setup ---
        let accounts = []; // Unified accounts array
        let transactions = [];
        let categories = ["Alimentação", "Transporte", "Moradia", "Lazer", "Saúde", "Educação", "Salário", "Investimentos", "Contas Fixas", "Compras", "Transferências", "Outros", "Revisar Importação"];
        let importedTransactionsToReview = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let itemToDelete = { id: null, type: null, showFeedback: true, isBulk: false, ids: [], accountIdForReversal: null, fundSourceForReversal: null };
        let cardFieldCounter = 0; // For dynamically adding card fields

        // --- DOM Elements ---
        const totalPoderCompraEl = document.getElementById('total-poder-compra');
        const totalDespesasEl = document.getElementById('total-despesas');
        const saldoLiquidoContasEl = document.getElementById('saldo-liquido-contas');
        const totalFaturasCartoesMesEl = document.getElementById('total-faturas-cartoes-mes');
        const addAccountForm = document.getElementById('add-account-form');
        const accountNameInput = document.getElementById('account-name');
        const accountTypeSelect = document.getElementById('account-type');
        const initialBalanceInput = document.getElementById('initial-balance');
        const overdraftSection = document.getElementById('overdraft-section');
        const overdraftLimitInput = document.getElementById('overdraft-limit');
        const creditCardSection = document.getElementById('credit-card-section');
        const linkedCardsContainer = document.getElementById('linked-cards-container');
        const addAnotherCardBtn = document.getElementById('add-another-card-btn');
        const accountsList = document.getElementById('accounts-list');
        const transactionList = document.getElementById('transaction-list');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthDisplay = document.getElementById('current-month-display');
        const searchTransactionsInput = document.getElementById('search-transactions-input');
        const addTransactionModal = document.getElementById('add-transaction-modal');
        const closeAddTransactionModalBtn = document.getElementById('close-add-transaction-modal');
        const cancelAddTransactionModalBtn = document.getElementById('cancel-add-transaction-modal-btn');
        const saveAddTransactionModalBtn = document.getElementById('save-add-transaction-modal-btn');
        const transactionFormModal = document.getElementById('transaction-form-modal');
        const addTransactionModalTitle = document.getElementById('add-transaction-modal-title');
        const modalTransactionIdInput = document.getElementById('modal-transaction-id');
        const modalDateInput = document.getElementById('modal-date');
        const modalDescriptionInput = document.getElementById('modal-description');
        const modalValueInput = document.getElementById('modal-value');
        const modalTypeSelect = document.getElementById('modal-type');
        const modalCategorySelect = document.getElementById('modal-category-select');
        const modalNewCategoryInput = document.getElementById('modal-new-category-input');
        const modalAccountSelect = document.getElementById('modal-account-select');
        const modalFundSourceDiv = document.getElementById('modal-fund-source-div');
        const modalFundSourceSelect = document.getElementById('modal-fund-source-select');
        const modalDestinationAccountDiv = document.getElementById('modal-destination-account-div');
        const modalDestinationAccountSelect = document.getElementById('modal-destination-account-select');
        const modalInstallmentsInput = document.getElementById('modal-installments');
        const modalInstallmentsPaidInput = document.getElementById('modal-installments-paid');
        const modalPaidStatusCheckbox = document.getElementById('modal-paid-status');
        const editAccountModal = document.getElementById('edit-account-modal');
        const closeEditAccountModalBtn = document.getElementById('close-edit-account-modal');
        const cancelEditAccountBtn = document.getElementById('cancel-edit-account-btn');
        const saveEditAccountBtn = document.getElementById('save-edit-account-btn');
        const editAccountIdInput = document.getElementById('edit-account-id');
        const editAccountNameInput = document.getElementById('edit-account-name');
        const editAccountTypeDisplay = document.getElementById('edit-account-type-display');
        const editAccountBalanceInput = document.getElementById('edit-account-balance');
        const editOverdraftSection = document.getElementById('edit-overdraft-section');
        const editOverdraftLimitInput = document.getElementById('edit-overdraft-limit');
        const editCreditCardSection = document.getElementById('edit-credit-card-section');
        const editLinkedCardsContainer = document.getElementById('edit-linked-cards-container');
        const editAddAnotherCardBtn = document.getElementById('edit-add-another-card-btn');
        const detailedStatementModal = document.getElementById('detailed-statement-modal');
        const closeDetailedStatementModalBtn = document.getElementById('close-detailed-statement-modal');
        const closeDetailedStatementModalFooterBtn = document.getElementById('close-detailed-statement-modal-footer');
        const detailedStatementTitle = document.getElementById('detailed-statement-title');
        const statementSourceSelect = document.getElementById('statement-source-select');
        const detailedStatementList = document.getElementById('detailed-statement-list');
        const noDetailedStatementMessage = document.getElementById('no-detailed-statement-message');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const closeConfirmationModalBtn = document.getElementById('close-confirmation-modal');
        
        // Elementos de Importação Geral
        const importHeader = document.getElementById('import-header');
        const importSectionContent = document.getElementById('import-section-content');
        const importArrow = document.getElementById('import-arrow');
        const fileInput = document.getElementById('file-input');
        const importFileBtn = document.getElementById('import-file-btn');

        // Elementos de Importação PDF (reintroduzidos)
        const importPdfHeader = document.getElementById('import-pdf-header');
        const importPdfSectionContent = document.getElementById('import-pdf-section-content');
        const importPdfArrow = document.getElementById('import-pdf-arrow');
        const fileInputPdf = document.getElementById('file-input-pdf');
        const importPdfFileBtn = document.getElementById('import-pdf-file-btn');
        
        const importReviewSection = document.getElementById('import-review-section');
        const importedTransactionsTableBody = document.getElementById('imported-transactions-table-body');
        const confirmImportBtn = document.getElementById('confirm-import-btn');
        const cancelReviewBtn = document.getElementById('cancel-review-btn');
        const selectAllImportedCheckbox = document.getElementById('select-all-imported-transactions');
        const bulkEditImportedControls = document.getElementById('bulk-edit-imported-controls');
        const bulkEditTypeSelect = document.getElementById('bulk-edit-type');
        const bulkEditCategorySelect = document.getElementById('bulk-edit-category');
        const bulkEditAccountSelect = document.getElementById('bulk-edit-account');
        const bulkEditStatusSelect = document.getElementById('bulk-edit-status');
        const applyBulkEditImportedBtn = document.getElementById('apply-bulk-edit-imported-btn');
        const reportsHeader = document.getElementById('reports-header');
        const reportsSectionContent = document.getElementById('reports-section-content');
        const reportsArrow = document.getElementById('reports-arrow');
        const reportTypeSelect = document.getElementById('report-type');
        const reportMonthSelectorDiv1 = document.getElementById('report-period1-month-div');
        const reportYearSelectorDiv1 = document.getElementById('report-period1-year-div');
        const reportMonthSelectorDiv2 = document.getElementById('report-period2-month-div');
        const reportYearSelectorDiv2 = document.getElementById('report-period2-year-div');
        const reportMonthSelect1 = document.getElementById('report-month');
        const reportYearSelect1 = document.getElementById('report-year');
        const reportMonthSelect2 = document.getElementById('report-month-comp');
        const reportYearSelect2 = document.getElementById('report-year-comp');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportOutputArea = document.getElementById('report-output-area');
        const suggestedGoalsHeader = document.getElementById('suggested-goals-header');
        const suggestedGoalsContent = document.getElementById('suggested-goals-content');
        const suggestedGoalsArrow = document.getElementById('suggested-goals-arrow');
        const suggestedGoalsList = document.getElementById('suggested-goals-list');
        const noSuggestedGoalsMessage = document.getElementById('no-suggested-goals-message');
        const downloadXlsxBtn = document.getElementById('download-xlsx-btn');
        const clearAllDataLink = document.getElementById('clear-all-data-link');
        const selectAllTransactionsCheckbox = document.getElementById('select-all-transactions');
        const paySelectedTransactionsBtn = document.getElementById('pay-selected-transactions-btn');
        const unpaySelectedTransactionsBtn = document.getElementById('unpay-selected-transactions-btn');
        const linkSelectedAccountSelect = document.getElementById('link-selected-account-select');
        const linkSelectedTransactionsBtn = document.getElementById('link-selected-transactions-btn');
        const linkSelectedCategorySelect = document.getElementById('link-selected-category-select');
        const linkSelectedCategoryBtn = document.getElementById('link-selected-category-btn');
        const deleteSelectedTransactionsBtn = document.getElementById('delete-selected-transactions-btn');
        // Filter DOM Elements
        const filterMainTypeSelect = document.getElementById('filter-main-type');
        const filterMainCategorySelect = document.getElementById('filter-main-category');
        const filterMainAccountSelect = document.getElementById('filter-main-account');
        const filterMainFundSourceSelect = document.getElementById('filter-main-fund-source');
        const filterMainStatusSelect = document.getElementById('filter-main-status');
        const filterImportTypeSelect = document.getElementById('filter-import-type');
        const filterImportCategorySelect = document.getElementById('filter-import-category');
        const filterImportAccountSelect = document.getElementById('filter-import-account');
        const filterImportStatusSelect = document.getElementById('filter-import-status');
        const saveAllDataLink = document.getElementById('save-all-data-link'); // Alterado de botão para link


        // --- Utility Functions ---
        const showFeedback = (message, type) => {
            feedbackMessageEl.textContent = message;
            feedbackMessageEl.className = '';
            feedbackMessageEl.classList.add(`feedback-${type}`, 'block');
            feedbackMessageEl.style.display = 'block';
            setTimeout(() => {
                if (feedbackMessageEl.textContent === message) {
                    feedbackMessageEl.style.display = 'none';
                }
            }, 7000);
        };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);

        const formatDateFromVariousFormats = (dateString, yearToAssume = new Date().getFullYear()) => {
            if (!dateString || typeof dateString !== 'string') return null;
            let day, month, year;
            dateString = dateString.trim();
            // Tenta DD/MM/YYYY ou DD.MM.YYYY
            let match = dateString.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{4})$/);
            if (match) { [ , day, month, year] = match.map(Number); }
            else { 
                // Tenta DD/MM/YY ou DD.MM.YY
                match = dateString.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{2})$/);
                if (match) { [ , day, month, year] = match.map(Number); year += (year < 70 ? 2000 : 1900); }
                else { 
                    // Tenta YYYY-MM-DD ou YYYY/MM/DD
                    match = dateString.match(/^(\d{4})[-\/\.](\d{1,2})[-\/\.](\d{1,2})$/);
                    if (match) { [ , year, month, day] = match.map(Number); }
                    else { 
                        // Tenta DD/MM ou DD.MM (assume ano atual)
                        match = dateString.match(/^(\d{1,2})[\/\.](\d{1,2})$/);
                        if (match) { [ , day, month] = match.map(Number); year = yearToAssume; }
                        // Tenta DDMMAAAA (sem separador)
                        else { match = dateString.match(/^(\d{2})(\d{2})(\d{4})$/);
                            if (match) { day = parseInt(match[1]); month = parseInt(match[2]); year = parseInt(match[3]); }
                            // Tenta DDMMAA (sem separador)
                            else { match = dateString.match(/^(\d{2})(\d{2})(\d{2})$/);
                                if (match) { day = parseInt(match[1]); month = parseInt(match[2]); year = parseInt(match[3]); year += (year < 70 ? 2000 : 1900); }
                                else return null; // Formato não reconhecido
                            }
                        }
                    }
                }
            }
            if (month < 1 || month > 12 || day < 1 || day > 31) return null;
            const dateObj = new Date(year, month - 1, day);
            if (dateObj.getFullYear() === year && dateObj.getMonth() === month - 1 && dateObj.getDate() === day) {
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }
            return null;
        };

        const parseCurrencyValue = (valueString) => {
            if (!valueString || typeof valueString !== 'string') return { value: 0, isCredit: null, extractedString: "", lineRemainder: valueString };
            
            let lineRemainder = valueString;
            // Padrões tentam capturar valores com R$, pontos como separador de milhar, vírgula como decimal, e indicadores C/D ou CR/DB
            // A ordem é importante: dos mais específicos para os mais genéricos.
            const currencyPatterns = [
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d{1,3}(?:\.\d{3})*(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i, // Ex: R$ 1.234,56 C
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d+(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,          // Ex: R$ 1234,56
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d{1,3}(?:,\d{3})*(?:\.\d{2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i, // Ex: R$ 1.234.56 (ponto como decimal)
                /(?:^|\s)(R\$\s*)?([\-\+]?\s*\d+(?:\.\d{2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,            // Ex: R$ 1234.56
                /(?:^|\s)([\-\+]?\s*\d{1,3}(?:\.\d{3})*(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,   // Ex: 1.234,56 D
                /(?:^|\s)([\-\+]?\s*\d+(?:,\d{1,2}))(?:\s*(C|CR|CRED|CREDITO|D|DB|DEB|DEBITO))?(?=\s|$)/i,                    // Ex: 1234,56
            ];
            
            let numericPart = ""; 
            let indicator = "";
            let originalMatchedString = "";

            for (const pattern of currencyPatterns) {
                const match = lineRemainder.match(pattern);
                if (match) {
                    originalMatchedString = match[0].trim();
                    numericPart = match[2] ? match[2].trim() : (match[1] && !match[1].toUpperCase().includes("R$") ? match[1].trim() : ""); // Pega o número
                    indicator = match[3] ? match[3].trim().toUpperCase() : ""; // Pega C/D/CR/DB
                    
                    // Remove o valor encontrado da linha para facilitar a extração da descrição
                    const startIndex = lineRemainder.indexOf(originalMatchedString);
                    if (startIndex !== -1) {
                        lineRemainder = lineRemainder.substring(0, startIndex) + lineRemainder.substring(startIndex + originalMatchedString.length);
                        lineRemainder = lineRemainder.trim();
                    }
                    break; 
                }
            }

            if (!numericPart) return { value: 0, isCredit: null, extractedString: "", lineRemainder: valueString };

            let cleanedNumericPart = numericPart.replace("R$", "").replace("+", "").trim();
            const hasMinus = cleanedNumericPart.startsWith('-');
            if (hasMinus) cleanedNumericPart = cleanedNumericPart.substring(1);
            
            let numberValue;
            // Lógica para tratar ponto como separador de milhar e vírgula como decimal
            if (cleanedNumericPart.includes(',')) { // Assume vírgula como decimal
                if (cleanedNumericPart.match(/\.\d{3},\d{1,2}$/)) { // Formato 1.234,56
                    numberValue = parseFloat(cleanedNumericPart.replace(/\./g, '').replace(',', '.'));
                } else { // Formato 1234,56 ou ,56
                    numberValue = parseFloat(cleanedNumericPart.replace(',', '.'));
                }
            } else if (cleanedNumericPart.includes('.')) { // Se não tem vírgula, mas tem ponto, pode ser 1234.56
                 if (cleanedNumericPart.match(/\.\d{2}$/) && !cleanedNumericPart.match(/\.\d{3}/) ) { // Apenas um ponto e dois decimais
                    numberValue = parseFloat(cleanedNumericPart);
                 } else { // Pode ser 1.234 (sem decimais) ou formato americano 1,234.56 (que não é o foco aqui)
                    numberValue = parseFloat(cleanedNumericPart.replace(/\./g, '')); // Remove pontos como milhar
                 }
            }
             else { // Sem ponto nem vírgula
                numberValue = parseFloat(cleanedNumericPart);
            }

            if (isNaN(numberValue)) return { value: 0, isCredit: null, extractedString: "", lineRemainder: valueString };

            let finalIsCredit = null;
            if (indicator.startsWith("C")) finalIsCredit = true;
            else if (indicator.startsWith("D")) finalIsCredit = false;
            else if (hasMinus) finalIsCredit = false;
            // Se não houver indicador C/D nem sinal de menos, pode ser necessário inferir de outra forma (ex: palavras-chave na descrição)

            return { value: Math.abs(numberValue), isCredit: finalIsCredit, extractedString: originalMatchedString, lineRemainder: lineRemainder };
        };
        const extractInstallmentInfo = (text) => {
            if (!text || typeof text !== 'string') return { paid: 1, total: 1, matchedText: "", lineRemainder: text };
            let paid = 1; let total = 1; let matchedText = ""; let lineRemainder = text;
            const patterns = [ /(\d{1,2})\s*\/\s*(\d{1,2})/, /parc(?:ela)?\.?\s*(\d{1,2})\s*(?:de|\/)\s*(\d{1,2})/i, /inst\s*(\d{1,2})\s*\/\s*(\d{1,2})/i ];
            for (const pattern of patterns) {
                const match = lineRemainder.match(pattern);
                if (match) {
                    paid = parseInt(match[1], 10); total = parseInt(match[2], 10); matchedText = match[0];
                    const startIndex = lineRemainder.indexOf(matchedText);
                    if (startIndex !== -1) { lineRemainder = lineRemainder.substring(0, startIndex) + lineRemainder.substring(startIndex + matchedText.length); lineRemainder = lineRemainder.trim(); }
                    break;
                }
            }
            if (total < paid || total <= 0 || paid <= 0) { return { paid: 1, total: 1, matchedText: "", lineRemainder: text }; }
            return { paid, total, matchedText, lineRemainder };
        };


        // --- Data Persistence ---
        const saveData = () => {
            localStorage.setItem('financialUnifiedAccounts', JSON.stringify(accounts));
            localStorage.setItem('financialUnifiedTransactions', JSON.stringify(transactions));
            localStorage.setItem('financialUnifiedCategories', JSON.stringify(categories));
        };
        const loadData = () => {
            const storedAccounts = localStorage.getItem('financialUnifiedAccounts');
            if (storedAccounts) accounts = JSON.parse(storedAccounts);
            const storedTransactions = localStorage.getItem('financialUnifiedTransactions');
            if (storedTransactions) transactions = JSON.parse(storedTransactions);
            const storedCategories = localStorage.getItem('financialUnifiedCategories');
            if (storedCategories) { categories = JSON.parse(storedCategories); if (!categories.includes("Revisar Importação")) categories.push("Revisar Importação"); if (!categories.includes("Transferências")) categories.push("Transferências");}
            else { if (!categories.includes("Revisar Importação")) categories.push("Revisar Importação"); if (!categories.includes("Transferências")) categories.push("Transferências");}

            renderAll();
        };

        const renderAll = () => {
            renderAccounts();
            populateAccountSelects(modalAccountSelect);
            populateAccountSelects(modalDestinationAccountSelect, true);
            populateCategorySelect(modalCategorySelect);
            populateCategorySelect(bulkEditCategorySelect, true);
            populateAccountSelects(bulkEditAccountSelect, true, true);
            populateLinkSelectedAccountSelect();
            populateLinkSelectedCategorySelect();
            populateReportSelectors();
            populateMainFilters(); 
            populateImportFilters(); 
            renderTransactions(); 
            updateSummary();
            updateMonthlyDisplay();
            checkCreditCardDueDates();
            suggestFinancialGoals();
        };


        // --- Account Management (Unified) ---
        const addCardInputFields = (container, cardData = null, isEditMode = false) => {
            cardFieldCounter++;
            const cardDiv = document.createElement('div');
            cardDiv.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 p-3 border border-purple-200 rounded-md relative';
            const cardId = cardData ? cardData.cardId : `newCard_${cardFieldCounter}`;
            cardDiv.dataset.cardId = cardId;

            const cardBrands = ["Visa", "Mastercard", "Elo", "American Express", "Hipercard", "Outra"];
            let brandOptions = cardBrands.map(brand => `<option value="${brand}" ${cardData && cardData.cardBrand === brand ? 'selected' : ''}>${brand}</option>`).join('');

            cardDiv.innerHTML = `
                <input type="hidden" class="card-id-field" value="${cardId}">
                <div>
                    <label for="card-brand-${cardId}" class="block text-xs font-medium text-gray-600 mb-0.5">Bandeira</label>
                    <select id="card-brand-${cardId}" class="w-full input-xs card-brand-select">
                        ${brandOptions}
                    </select>
                </div>
                <div>
                    <label for="card-name-${cardId}" class="block text-xs font-medium text-gray-600 mb-0.5">Nome Personalizado/Outra</label>
                    <input type="text" id="card-name-${cardId}" value="${cardData ? cardData.customCardName || '' : ''}" placeholder="Ex: Meu Cartão Azul" class="w-full input-xs card-name-input" ${cardData && cardData.cardBrand !== 'Outra' ? 'disabled' : ''}>
                </div>
                <div>
                    <label for="card-limit-${cardId}" class="block text-xs font-medium text-gray-600 mb-0.5">Limite (R$)</label>
                    <input type="number" id="card-limit-${cardId}" value="${cardData ? cardData.cardLimit : ''}" step="0.01" placeholder="2000.00" required class="w-full input-xs card-limit-input">
                </div>
                <div>
                    <label for="card-due-day-${cardId}" class="block text-xs font-medium text-gray-600 mb-0.5">Dia Venc. Fatura</label>
                    <input type="number" id="card-due-day-${cardId}" value="${cardData ? cardData.cardDueDay : ''}" min="1" max="31" placeholder="10" required class="w-full input-xs card-due-day-input">
                </div>
                ${isEditMode && cardData ? `<button type="button" class="absolute top-1 right-1 text-red-500 hover:text-red-700 remove-card-btn-edit p-0.5" data-card-id-to-remove="${cardId}">&times;</button>` : ''}
                 ${!isEditMode ? `<button type="button" class="absolute top-1 right-1 text-red-500 hover:text-red-700 remove-card-btn-new p-0.5">&times;</button>` : ''}
            `;
            container.appendChild(cardDiv);

            const brandSelect = cardDiv.querySelector('.card-brand-select');
            const nameInput = cardDiv.querySelector('.card-name-input');
            brandSelect.addEventListener('change', () => {
                nameInput.disabled = brandSelect.value !== 'Outra';
                if (brandSelect.value !== 'Outra') {
                    nameInput.value = ''; // Limpa se não for 'Outra'
                }
            });


            if (!isEditMode) {
                 cardDiv.querySelector('.remove-card-btn-new').addEventListener('click', () => cardDiv.remove());
            } else if (cardData) {
                 const removeBtnEdit = cardDiv.querySelector('.remove-card-btn-edit');
                 if(removeBtnEdit) removeBtnEdit.addEventListener('click', (e) => {
                    const cardIdToRemove = e.currentTarget.dataset.cardIdToRemove;
                    const cardToRemoveEl = container.querySelector(`div[data-card-id="${cardIdToRemove}"]`);
                    if (cardToRemoveEl) {
                        cardToRemoveEl.classList.add('hidden', 'marked-for-deletion');
                        showFeedback(`Cartão ${cardData.cardBrand} ${cardData.customCardName || ''} será removido ao salvar.`, 'info');
                    }
                });
            }
        };

        if (accountTypeSelect) {
            accountTypeSelect.addEventListener('change', () => {
                const isChecking = accountTypeSelect.value === 'corrente';
                overdraftSection.classList.toggle('hidden', !isChecking);
                creditCardSection.classList.toggle('hidden', !isChecking);
                if (!isChecking) {
                    linkedCardsContainer.innerHTML = ''; 
                    overdraftLimitInput.value = '';
                } else if (linkedCardsContainer.children.length === 0) { 
                    addCardInputFields(linkedCardsContainer);
                }
            });
        }

        if (addAnotherCardBtn) {
            addAnotherCardBtn.addEventListener('click', () => addCardInputFields(linkedCardsContainer));
        }
         if (editAddAnotherCardBtn) {
            editAddAnotherCardBtn.addEventListener('click', () => addCardInputFields(editLinkedCardsContainer, null, true));
        }


        if (addAccountForm) {
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = accountNameInput.value.trim();
                const type = accountTypeSelect.value;
                const initialBal = parseFloat(initialBalanceInput.value) || 0;
                const overdraftLim = type === 'corrente' ? (parseFloat(overdraftLimitInput.value) || 0) : 0;

                if (!name) {
                    showFeedback('Nome da conta é obrigatório.', 'error');
                    return;
                }

                const newAccount = {
                    id: generateUniqueId(),
                    name,
                    type,
                    balance: initialBal,
                    limitOverdraft: overdraftLim,
                    creditCards: [] 
                };

                if (type === 'corrente') {
                    linkedCardsContainer.querySelectorAll('div[data-card-id]').forEach(cardDiv => {
                        const cardBrand = cardDiv.querySelector('.card-brand-select').value;
                        const customCardName = cardDiv.querySelector('.card-name-input').value.trim();
                        const cardLimit = parseFloat(cardDiv.querySelector('.card-limit-input').value) || 0;
                        const cardDueDay = parseInt(cardDiv.querySelector('.card-due-day-input').value) || 0;

                        if (cardBrand && cardLimit > 0 && cardDueDay >= 1 && cardDueDay <= 31) {
                            if (cardBrand === 'Outra' && !customCardName) {
                                showFeedback('Por favor, insira um nome para o cartão "Outra".', 'error');
                                return; // Pula este cartão
                            }
                            newAccount.creditCards.push({
                                cardId: generateUniqueId(),
                                cardBrand,
                                customCardName: cardBrand === 'Outra' ? customCardName : '',
                                cardLimit,
                                cardAvailableLimit: cardLimit, 
                                cardDueDay,
                                cardClosingDay: calculateClosingDay(cardDueDay), 
                                currentBillAmount: 0
                            });
                        }
                    });
                }

                accounts.push(newAccount);
                saveData();
                renderAll(); 
                addAccountForm.reset();
                linkedCardsContainer.innerHTML = ''; 
                overdraftSection.classList.add('hidden');
                creditCardSection.classList.add('hidden');
                accountTypeSelect.value = 'corrente'; 
                showFeedback('Conta adicionada com sucesso!', 'success');
            });
        }
        const calculateClosingDay = (dueDay) => {
            if (!dueDay || dueDay < 1 || dueDay > 31) return null; 
            let closingDay = dueDay - 9;
            if (closingDay <= 0) {
                const tempDate = new Date(); 
                tempDate.setDate(dueDay); 
                tempDate.setMonth(tempDate.getMonth() -1); 
                const daysInPreviousMonth = new Date(tempDate.getFullYear(), tempDate.getMonth() + 1, 0).getDate();
                closingDay = daysInPreviousMonth + closingDay; 
            }
            return closingDay;
        };


        const renderAccounts = () => {
            accountsList.innerHTML = '';
            if (accounts.length === 0) {
                accountsList.innerHTML = '<li class="p-4 text-gray-500 text-center">Nenhuma conta adicionada.</li>';
                return;
            }
            accounts.forEach(account => {
                const li = document.createElement('li');
                li.className = 'p-3 border-b border-gray-200';

                let typeText = account.type.charAt(0).toUpperCase() + account.type.slice(1);
                if (account.type === 'corrente') typeText = "Conta Corrente";
                else if (account.type === 'poupanca') typeText = "Conta Poupança";
                else if (account.type === 'cash') typeText = "Dinheiro (Caixa)";

                let detailsHtml = `<p>Saldo: <span class="font-bold ${account.balance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(account.balance)}</span></p>`;
                if (account.type === 'corrente') {
                    detailsHtml += `<p>Cheque Especial: <span class="font-bold">${formatCurrency(account.limitOverdraft)}</span></p>`;
                    const totalAvailableChecking = account.balance + account.limitOverdraft;
                    detailsHtml += `<p>Disponível (C/C + Ch. Esp.): <span class="font-bold ${totalAvailableChecking >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(totalAvailableChecking)}</span></p>`;
                }

                if (account.creditCards && account.creditCards.length > 0) {
                    detailsHtml += `<h5 class="text-sm font-semibold mt-2 mb-1 text-purple-700">Cartões Vinculados:</h5><ul class="list-disc list-inside pl-2 text-xs">`;
                    account.creditCards.forEach(card => {
                        const cardDisplayName = card.cardBrand === 'Outra' ? card.customCardName : card.cardBrand;
                        const billForThisCardThisMonth = transactions.reduce((sum, t) => {
                            const tDate = new Date(t.date + "T00:00:00");
                             if (t.fundSource === `credit_card_${card.cardId}` && t.fundamentalType === 'despesa' && !t.isPaid && tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) {
                                return sum + t.value;
                            }
                            return sum;
                        },0);

                        detailsHtml += `<li>${cardDisplayName || 'Cartão'}: Limite ${formatCurrency(card.cardLimit)}, Disp. ${formatCurrency(card.cardAvailableLimit)}, Fatura Atual ${formatCurrency(billForThisCardThisMonth)}, Venc. dia ${card.cardDueDay} (Fech. dia ${card.cardClosingDay || 'N/A'})</li>`;
                    });
                    detailsHtml += `</ul>`;
                }
                
                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <div class="account-item-header flex justify-between items-center w-full">
                                <div>
                                    <span class="font-semibold text-gray-800">${account.name}</span>
                                    <span class="text-sm text-gray-500 ml-2">(${typeText})</span>
                                </div>
                                <svg class="arrow-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                            <div class="account-details-content hidden mt-2 pl-4 text-sm text-gray-600">
                                ${detailsHtml}
                                <button data-account-id="${account.id}" class="view-detailed-statement-btn text-xs text-blue-600 hover:text-blue-800 mt-1">Ver Extrato Detalhado</button>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button data-id="${account.id}" class="edit-account-btn text-yellow-500 hover:text-yellow-700 p-1 rounded-full hover:bg-yellow-100 mr-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg></button>
                            <button data-id="${account.id}" data-type="account" class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>
                        </div>
                    </div>`;
                
                const headerDiv = li.querySelector('.account-item-header');
                const detailsDiv = li.querySelector('.account-details-content');
                const arrowIcon = headerDiv.querySelector('.arrow-icon');
                headerDiv.addEventListener('click', () => {
                    detailsDiv.classList.toggle('hidden');
                    arrowIcon.classList.toggle('rotated');
                });
                li.querySelector('.view-detailed-statement-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDetailedStatementModal(account.id);
                });
                accountsList.appendChild(li);
            });
            addEditDeleteAccountListeners();
        };
        
        const addEditDeleteAccountListeners = () => {
            document.querySelectorAll('.edit-account-btn').forEach(b => {
                b.onclick = (e) => openEditAccountModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.delete-btn[data-type="account"]').forEach(b => {
                b.onclick = (e) => requestDeleteConfirmation(e.currentTarget.dataset.id, 'account');
            });
        };


        // --- Transaction Management (Adapted for Unified Accounts) ---
        const populateAccountSelects = (selectElement, includeCashOnly = false, includeMaintainOriginal = false, includeNoLink = true) => {
            if (!selectElement) return;
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';

            if (includeMaintainOriginal) {
                const maintainOpt = document.createElement('option');
                maintainOpt.value = ""; 
                maintainOpt.textContent = "Manter original / Não Vincular";
                selectElement.appendChild(maintainOpt);
            } else if (includeNoLink && !includeCashOnly) {
                 const noLinkOpt = document.createElement('option');
                 noLinkOpt.value = "";
                 noLinkOpt.textContent = "Não Vincular / Geral";
                 selectElement.appendChild(noLinkOpt);
            } else if (includeNoLink && includeCashOnly) { // For destination account, "Select Account"
                 const selectOpt = document.createElement('option');
                 selectOpt.value = "";
                 selectOpt.textContent = "Selecione uma Conta";
                 selectOpt.disabled = true;
                 selectOpt.selected = true;
                 selectElement.appendChild(selectOpt);
            }


            accounts.forEach(acc => {
                if (includeCashOnly && acc.type === 'corrente' && acc.creditCards && acc.creditCards.length > 0) return; 

                const opt = document.createElement('option');
                opt.value = acc.id;
                let typeText = acc.type.charAt(0).toUpperCase() + acc.type.slice(1);
                if (acc.type === 'corrente') typeText = "C/C";
                else if (acc.type === 'poupanca') typeText = "Poupança";
                opt.textContent = `${acc.name} (${typeText})`;
                selectElement.appendChild(opt);
            });
            if (currentVal && Array.from(selectElement.options).some(opt => opt.value === currentVal)) {
                 selectElement.value = currentVal;
            } else if (selectElement.options.length > 0 && (includeMaintainOriginal || (!includeCashOnly && includeNoLink) )) {
                selectElement.value = ""; 
            }
        };
        
        const populateFundSourceSelect = (accountId) => {
            modalFundSourceSelect.innerHTML = '';
            modalFundSourceDiv.classList.add('hidden');

            const account = accounts.find(acc => acc.id === accountId);
            if (!account || modalTypeSelect.value === 'receita' || modalTypeSelect.value === 'transferencia_entrada') { 
                if (modalTypeSelect.value === 'receita' || modalTypeSelect.value === 'transferencia_entrada') {
                     modalFundSourceSelect.innerHTML = `<option value="account_balance" selected>Saldo da Conta</option>`; 
                }
                return;
            }

            let hasOptions = false;
            const balanceOpt = document.createElement('option');
            balanceOpt.value = 'account_balance';
            balanceOpt.textContent = 'Saldo da Conta';
            modalFundSourceSelect.appendChild(balanceOpt);
            hasOptions = true;

            if (account.type === 'corrente') {
                if (account.limitOverdraft > 0) {
                    const overdraftOpt = document.createElement('option');
                    overdraftOpt.value = 'overdraft';
                    overdraftOpt.textContent = 'Cheque Especial';
                    modalFundSourceSelect.appendChild(overdraftOpt);
                    hasOptions = true;
                }
                if (account.creditCards && account.creditCards.length > 0) {
                    account.creditCards.forEach(card => {
                        const cardDisplayName = card.cardBrand === 'Outra' ? card.customCardName : card.cardBrand;
                        const cardOpt = document.createElement('option');
                        cardOpt.value = `credit_card_${card.cardId}`;
                        cardOpt.textContent = `Cartão: ${cardDisplayName || 'Cartão'}`;
                        modalFundSourceSelect.appendChild(cardOpt);
                        hasOptions = true;
                    });
                }
            }
            if (hasOptions) {
                modalFundSourceDiv.classList.remove('hidden');
            }
        };

        if (modalAccountSelect) {
            modalAccountSelect.addEventListener('change', (e) => {
                populateFundSourceSelect(e.target.value);
            });
        }
        if (modalTypeSelect) {
            modalTypeSelect.addEventListener('change', (e) => {
                const type = e.target.value;
                modalDestinationAccountDiv.classList.toggle('hidden', type !== 'transferencia_saida' && type !== 'transferencia_entrada');
                modalFundSourceDiv.classList.toggle('hidden', type === 'receita' || type === 'transferencia_entrada');

                if (type === 'receita' || type === 'transferencia_entrada') {
                    modalAccountSelect.required = true; 
                    populateAccountSelects(modalAccountSelect, true, false, true); 
                    modalFundSourceSelect.innerHTML = `<option value="account_balance" selected>Saldo da Conta</option>`; 
                } else if (type === 'despesa' || type === 'transferencia_saida') {
                     modalAccountSelect.required = true; 
                     populateAccountSelects(modalAccountSelect, false, false, true); 
                     populateFundSourceSelect(modalAccountSelect.value); 
                } else {
                     modalAccountSelect.required = false;
                     populateAccountSelects(modalAccountSelect, false, false, true);
                }
                 if (type === 'transferencia_saida' || type === 'transferencia_entrada') {
                    populateAccountSelects(modalDestinationAccountSelect, true, false, true); // Allow any account type as destination
                }
            });
        }


        document.querySelectorAll('.add-transaction-type-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const type = e.currentTarget.dataset.type;
                addTransactionModalTitle.textContent = `Adicionar Nova ${type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ')}`;
                transactionFormModal.reset();
                modalTransactionIdInput.value = ''; 
                modalTypeSelect.value = type;

                populateAccountSelects(modalAccountSelect, false, false, true); // Standard population for source
                populateAccountSelects(modalDestinationAccountSelect, true, false, true); // For transfers, can go to any account type
                populateCategorySelect(modalCategorySelect);
                modalNewCategoryInput.classList.add('hidden');
                modalDateInput.value = new Date().toISOString().split('T')[0];
                modalInstallmentsInput.value = 1;
                modalInstallmentsPaidInput.value = 0;
                modalPaidStatusCheckbox.checked = (type === 'receita' || type === 'transferencia_entrada'); 

                modalDestinationAccountDiv.classList.toggle('hidden', type !== 'transferencia_saida' && type !== 'transferencia_entrada');
                modalFundSourceDiv.classList.add('hidden'); 

                const event = new Event('change');
                modalTypeSelect.dispatchEvent(event);
                if (modalAccountSelect.value) { 
                    populateFundSourceSelect(modalAccountSelect.value);
                }

                addTransactionModal.classList.remove('hidden');
            });
        });
        
        if(closeAddTransactionModalBtn) closeAddTransactionModalBtn.addEventListener('click', () => addTransactionModal.classList.add('hidden'));
        if(cancelAddTransactionModalBtn) cancelAddTransactionModalBtn.addEventListener('click', () => addTransactionModal.classList.add('hidden'));

        if (transactionFormModal) {
            transactionFormModal.addEventListener('submit', (e) => {
                e.preventDefault();
                const transactionIdToEdit = modalTransactionIdInput.value;
                const baseDateString = modalDateInput.value;
                const description = modalDescriptionInput.value.trim();
                const valuePerInstallment = parseFloat(modalValueInput.value);
                const type = modalTypeSelect.value;
                const accountId = modalAccountSelect.value; 
                const fundSource = modalFundSourceDiv.classList.contains('hidden') || !modalFundSourceSelect.value ? 'account_balance' : modalFundSourceSelect.value; 
                const destinationAccountId = (type === 'transferencia_saida' || type === 'transferencia_entrada') ? modalDestinationAccountSelect.value : null;

                let category;
                if (modalCategorySelect.value === 'nova-categoria') {
                    category = modalNewCategoryInput.value.trim();
                    if (category && !categories.includes(category)) { categories.push(category); /*saveCategories();*/ populateCategorySelect(modalCategorySelect); populateCategorySelect(bulkEditCategorySelect); populateLinkSelectedCategorySelect(); modalCategorySelect.value = category; }
                    else if (categories.includes(category)) { modalCategorySelect.value = category; modalNewCategoryInput.classList.add('hidden'); }
                    else if (!category) { showFeedback('Insira nome para nova categoria.', 'error'); return; }
                } else { category = modalCategorySelect.value; }

                const totalInstallments = parseInt(modalInstallmentsInput.value) || 1;
                const installmentsPaidCount = parseInt(modalInstallmentsPaidInput.value) || 0;
                const isPaid = modalPaidStatusCheckbox.checked;

                if (!baseDateString || !description || isNaN(valuePerInstallment) || valuePerInstallment <= 0 || !type || !category) { showFeedback('Preencha campos obrigatórios.', 'error'); return; }
                if (installmentsPaidCount > totalInstallments || installmentsPaidCount < 0) { showFeedback('Parcelas pagas inválido.', 'error'); return; }
                if (!accountId && (type === 'despesa' || type === 'receita' || type === 'transferencia_saida' || type === 'transferencia_entrada')) { showFeedback('Selecione uma conta principal.', 'error'); return; }
                if ((type === 'transferencia_saida' || type === 'transferencia_entrada') && !destinationAccountId) { showFeedback('Selecione uma conta de destino para transferência.', 'error'); return; }
                if ((type === 'transferencia_saida' || type === 'transferencia_entrada') && accountId === destinationAccountId) { showFeedback('Conta de origem e destino não podem ser a mesma para transferência.', 'error'); return; }


                const fundamentalType = (type === 'receita' || type === 'transferencia_entrada') ? 'receita' : 'despesa';
                const isCreditCardTx = fundSource.startsWith('credit_card_');
                
                if (transactionIdToEdit) { 
                    const txIndex = transactions.findIndex(t => t.id === transactionIdToEdit);
                    if (txIndex === -1) { showFeedback('Erro: Transação para edição não encontrada.', 'error'); return; }
                    
                    const oldTx = JSON.parse(JSON.stringify(transactions[txIndex])); // Deep copy for reversal
                    updateAccountBalance(oldTx.accountId, oldTx.fundSource, oldTx.value, oldTx.fundamentalType, true, oldTx.isPaid, oldTx.destinationAccountId, oldTx.type);


                    transactions[txIndex] = {
                        ...transactions[txIndex], 
                        date: baseDateString, description, value: valuePerInstallment, type, fundamentalType, category, accountId,
                        fundSource, isCreditCardTransaction: isCreditCardTx,
                        installments: `${installmentsPaidCount + 1}/${totalInstallments}`, 
                        isPaid,
                        destinationAccountId
                    };
                    updateAccountBalance(accountId, fundSource, valuePerInstallment, fundamentalType, false, isPaid, destinationAccountId, type);
                    showFeedback('Transação atualizada!', 'success');

                } else { 
                    const originalGroupId = generateUniqueId();
                    for (let k = 1; k <= totalInstallments; k++) {
                        const transactionDateObject = new Date(baseDateString + "T00:00:00");
                        const monthOffset = k - (installmentsPaidCount + 1);
                        transactionDateObject.setMonth(transactionDateObject.getMonth() + monthOffset);
                        const originalDay = new Date(baseDateString + "T00:00:00").getDate();
                        if (transactionDateObject.getDate() !== originalDay) transactionDateObject.setDate(0);

                        const newTx = {
                            id: generateUniqueId(),
                            date: transactionDateObject.toISOString().split('T')[0],
                            description: `${description} (${k}/${totalInstallments})`,
                            value: valuePerInstallment, type, fundamentalType, category, accountId,
                            fundSource, isCreditCardTransaction: isCreditCardTx,
                            installments: `${k}/${totalInstallments}`,
                            isPaid: (k <= installmentsPaidCount) || isPaid, 
                            originalGroupId,
                            destinationAccountId
                        };
                        transactions.push(newTx);
                        updateAccountBalance(newTx.accountId, newTx.fundSource, newTx.value, newTx.fundamentalType, false, newTx.isPaid, newTx.destinationAccountId, newTx.type);
                    }
                    showFeedback('Transação(ões) adicionada(s)!', 'success');
                }

                saveData();
                renderAll();
                addTransactionModal.classList.add('hidden');
            });
        }
        
        const updateAccountBalance = (accountId, fundSource, value, fundamentalType, isReversal = false, isTransactionPaid = true, destinationAccountId = null, transactionType = null) => {
            if (!accountId || !isTransactionPaid) return; 

            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            const amount = isReversal ? value : -value; // if reversing, add back expense, subtract income. if applying, subtract expense, add income.

            if (transactionType === 'transferencia_saida') {
                if (fundSource === 'overdraft') account.balance += amount; 
                else if (fundSource && fundSource.startsWith('credit_card_')) { /* No direct balance impact for CC transfer out */ }
                else account.balance += amount; 

                const destAccount = accounts.find(acc => acc.id === destinationAccountId);
                if (destAccount) destAccount.balance -= amount; // amount is negative for source debit, so subtract to credit destination

            } else if (transactionType === 'transferencia_entrada') {
                 account.balance -= amount; // amount is positive for source credit, so subtract to debit source
                const srcAccount = accounts.find(acc => acc.id === destinationAccountId); // destinationAccountId is the source here
                if(srcAccount) srcAccount.balance += amount; 


            } else if (fundamentalType === 'receita') {
                account.balance -= amount; // amount is positive for income, so subtract to apply
            } else if (fundamentalType === 'despesa') {
                if (fundSource === 'overdraft') {
                    account.balance += amount; 
                } else if (fundSource && fundSource.startsWith('credit_card_')) {
                    const cardId = fundSource.replace('credit_card_', '');
                    const cardOwningAccount = accounts.find(a => a.creditCards && a.creditCards.some(c => c.cardId === cardId));
                    if (cardOwningAccount) {
                        const card = cardOwningAccount.creditCards.find(c => c.cardId === cardId);
                        if (card) {
                            card.currentBillAmount -= amount; 
                            card.cardAvailableLimit += amount; 
                        }
                    }
                } else { 
                    account.balance += amount;
                }
            }
        };


        const renderTransactions = (searchTerm = "", filters = {}) => {
            transactionList.innerHTML = '';
            const beginningOfCurrentMonth = new Date(currentYear, currentMonth, 1);
            beginningOfCurrentMonth.setHours(0, 0, 0, 0);
            const lowerSearchTerm = searchTerm.toLowerCase().trim();

            const filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date + "T00:00:00");
                const isInCurrentMonthAndYear = transactionDate.getFullYear() === currentYear && transactionDate.getMonth() === currentMonth;
                const isPendingFromPreviousMonth = transactionDate < beginningOfCurrentMonth && !t.isPaid && t.fundamentalType === 'despesa';

                // Apply Filters
                if (filters.type && filters.type !== "all" && t.type !== filters.type) return false;
                if (filters.category && filters.category !== "all" && t.category !== filters.category) return false;
                if (filters.accountId && filters.accountId !== "all" && t.accountId !== filters.accountId) return false;
                if (filters.status && filters.status !== "all" && (filters.status === "paid" ? !t.isPaid : t.isPaid) ) return false;
                if (filters.fundSource && filters.fundSource !== "all") {
                    if (filters.fundSource === "credit_card_any" && !t.fundSource?.startsWith("credit_card_")) return false;
                    else if (filters.fundSource !== "credit_card_any" && t.fundSource !== filters.fundSource) return false;
                }


                const matchesSearch = lowerSearchTerm === "" ||
                    t.description.toLowerCase().includes(lowerSearchTerm) ||
                    t.category.toLowerCase().includes(lowerSearchTerm) ||
                    formatCurrency(t.value).toLowerCase().includes(lowerSearchTerm) ||
                    (t.accountId && accounts.find(a => a.id === t.accountId)?.name.toLowerCase().includes(lowerSearchTerm)) ||
                    (t.fundSource && t.fundSource.startsWith('credit_card_') && accounts.flatMap(a => a.creditCards || []).find(c => `credit_card_${c.cardId}` === t.fundSource)?.cardName.toLowerCase().includes(lowerSearchTerm));
                
                return (isInCurrentMonthAndYear || isPendingFromPreviousMonth) && matchesSearch;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            noTransactionsMessage.classList.toggle('hidden', filteredTransactions.length > 0);
            if (selectAllTransactionsCheckbox) selectAllTransactionsCheckbox.checked = false;

            filteredTransactions.forEach(transaction => {
                const tr = document.createElement('tr');
                let rowClass = 'bg-white hover:bg-gray-50';
                const transactionDate = new Date(transaction.date + "T00:00:00");
                if (transaction.isPaid) rowClass += ' paid-transaction';
                else if (transactionDate < beginningOfCurrentMonth) rowClass += ' pending-previous-month';
                tr.className = rowClass;

                const accountName = transaction.accountId ? (accounts.find(acc => acc.id === transaction.accountId)?.name || 'Conta Desc.') : 'N/A';
                
                let fundSourceText = 'Saldo Conta';
                if (transaction.fundSource === 'overdraft') {
                    fundSourceText = 'Cheque Especial';
                } else if (transaction.fundSource && transaction.fundSource.startsWith('credit_card_')) {
                    const cardId = transaction.fundSource.replace('credit_card_', '');
                    const mainAccountForCard = accounts.find(acc => acc.creditCards && acc.creditCards.some(c => c.cardId === cardId));
                    if (mainAccountForCard) {
                        const card = mainAccountForCard.creditCards.find(c => c.cardId === cardId);
                        const cardDisplayName = card ? (card.cardBrand === 'Outra' ? card.customCardName : card.cardBrand) : 'Cartão Desc.';
                        fundSourceText = `Cartão: ${cardDisplayName || 'Cartão'}`;
                    } else {
                        fundSourceText = 'Cartão Desc. (Conta não encontrada)';
                    }
                } else if (transaction.type === 'receita' || transaction.type === 'transferencia_entrada') {
                    fundSourceText = 'N/A (Entrada)';
                }


                let typeDisplay = transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1).replace(/_/g, ' ');
                let valueColorClass = transaction.fundamentalType === 'receita' ? 'text-green-600' : 'text-red-600';
                if (transaction.isPaid && transaction.fundamentalType === 'despesa') valueColorClass = 'text-red-400';
                else if (!transaction.isPaid && transaction.fundamentalType === 'despesa') valueColorClass = 'text-red-700 font-bold';
                const statusText = transaction.isPaid ? 'Realizado' : 'Pendente';
                const statusClass = transaction.isPaid ? 'text-green-600' : 'text-red-700 font-bold';


                tr.innerHTML = `
                    <td class="px-2 py-4 text-center"><input type="checkbox" class="transaction-checkbox form-checkbox h-4 w-4" data-id="${transaction.id}" data-group-id="${transaction.originalGroupId || ''}"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${new Date(transaction.date + "T00:00:00").toLocaleDateString('pt-BR')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${valueColorClass}">${formatCurrency(transaction.value)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${typeDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${transaction.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${accountName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${fundSourceText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${transaction.installments}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${!transaction.isPaid && transaction.fundamentalType === 'despesa' ? `<button data-id="${transaction.id}" class="pay-transaction-btn text-blue-600 hover:text-blue-900 mr-2 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>` : ''}
                        <button data-id="${transaction.id}" class="edit-transaction-btn text-yellow-600 hover:text-yellow-900 mr-2 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button data-id="${transaction.id}" data-type="transaction" class="delete-btn text-red-500 hover:text-red-700 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>`;
                transactionList.appendChild(tr);
            });
            addTransactionActionListeners();
            updateSelectedTransactionsActions();
        };
        
        const addTransactionActionListeners = () => {
            document.querySelectorAll('.pay-transaction-btn').forEach(b => { b.onclick = (e) => markTransactionAsPaid(e.currentTarget.dataset.id, true); });
            document.querySelectorAll('.edit-transaction-btn').forEach(b => { b.onclick = (e) => openEditTransactionModal(e.currentTarget.dataset.id); });
            document.querySelectorAll('.delete-btn[data-type="transaction"]').forEach(b => { b.onclick = (e) => requestDeleteConfirmation(e.currentTarget.dataset.id, 'transaction'); });
        };
        
        const openEditTransactionModal = (transactionId) => {
            const tx = transactions.find(t => t.id === transactionId);
            if (!tx) { showFeedback('Transação não encontrada.', 'error'); return; }

            addTransactionModalTitle.textContent = 'Editar Transação';
            transactionFormModal.reset();
            modalTransactionIdInput.value = tx.id;
            modalDateInput.value = tx.date;
            modalDescriptionInput.value = tx.description.replace(/\s\(\d+\/\d+\)$/, ''); 
            modalValueInput.value = tx.value.toFixed(2);
            modalTypeSelect.value = tx.type;

            populateCategorySelect(modalCategorySelect);
            modalCategorySelect.value = tx.category;
            modalNewCategoryInput.classList.add('hidden');

            populateAccountSelects(modalAccountSelect, false, false, true);
            modalAccountSelect.value = tx.accountId;
            
            const typeChangeEvent = new Event('change');
            modalTypeSelect.dispatchEvent(typeChangeEvent);
            
            const accountChangeEvent = new Event('change');
            modalAccountSelect.dispatchEvent(accountChangeEvent); 

            setTimeout(() => { 
                 if (tx.fundSource) modalFundSourceSelect.value = tx.fundSource;
            }, 0);


            if (tx.type === 'transferencia_saida' || tx.type === 'transferencia_entrada') {
                populateAccountSelects(modalDestinationAccountSelect, true, false, true);
                modalDestinationAccountSelect.value = tx.destinationAccountId || "";
                modalDestinationAccountDiv.classList.remove('hidden');
            } else {
                modalDestinationAccountDiv.classList.add('hidden');
            }


            const [paidCount, totalCount] = tx.installments.split('/').map(Number);
            modalInstallmentsInput.value = totalCount;
            modalInstallmentsPaidInput.value = paidCount -1; 
            modalPaidStatusCheckbox.checked = tx.isPaid;

            addTransactionModal.classList.remove('hidden');
        };


        // --- Summary Calculations (Adapted) ---
        const updateSummary = () => {
            let totalPoderDeCompra = 0;
            let saldoLiquido = 0;
            accounts.forEach(acc => {
                saldoLiquido += acc.balance; 
                if (acc.type === 'corrente') {
                    totalPoderDeCompra += acc.balance + acc.limitOverdraft;
                } else {
                    totalPoderDeCompra += acc.balance;
                }
                if (acc.creditCards) {
                    acc.creditCards.forEach(card => {
                        totalPoderDeCompra += card.cardAvailableLimit;
                    });
                }
            });
            if(totalPoderCompraEl) totalPoderCompraEl.textContent = formatCurrency(totalPoderDeCompra);
            if(saldoLiquidoContasEl) {
                saldoLiquidoContasEl.textContent = formatCurrency(saldoLiquido);
                saldoLiquidoContasEl.className = `text-2xl font-bold ${saldoLiquido >= 0 ? 'text-green-700' : 'text-red-700'}`;
            }


            let despesasDoMesTotal = 0;
            const beginningOfCurrentMonth = new Date(currentYear, currentMonth, 1);
            beginningOfCurrentMonth.setHours(0,0,0,0);
            transactions.forEach(t => {
                const transactionDate = new Date(t.date + "T00:00:00");
                const isInCurrentMonthAndYear = transactionDate.getFullYear() === currentYear && transactionDate.getMonth() === currentMonth;
                const isPendingFromPreviousMonth = transactionDate < beginningOfCurrentMonth && !t.isPaid;
                if (t.fundamentalType === 'despesa' && (isInCurrentMonthAndYear || isPendingFromPreviousMonth)) {
                    despesasDoMesTotal += t.value;
                }
            });
            if(totalDespesasEl) totalDespesasEl.textContent = formatCurrency(despesasDoMesTotal);

            let faturasCartoesMes = 0;
            accounts.forEach(acc => {
                if (acc.creditCards) {
                    acc.creditCards.forEach(card => {
                        transactions.forEach(t => {
                            const tDate = new Date(t.date + "T00:00:00");
                            if (t.fundSource === `credit_card_${card.cardId}` && t.fundamentalType === 'despesa' && !t.isPaid &&
                                tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) {
                                faturasCartoesMes += t.value;
                            }
                        });
                    });
                }
            });
            if(totalFaturasCartoesMesEl) totalFaturasCartoesMesEl.textContent = formatCurrency(faturasCartoesMes);
        };
        
        const updateMonthlyDisplay = () => { if(currentMonthDisplay) currentMonthDisplay.textContent = new Date(currentYear,currentMonth).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});};
        
        const applyMainFilters = () => {
            const filters = {
                type: filterMainTypeSelect.value,
                category: filterMainCategorySelect.value,
                accountId: filterMainAccountSelect.value,
                fundSource: filterMainFundSourceSelect.value,
                status: filterMainStatusSelect.value,
            };
            renderTransactions(searchTransactionsInput.value, filters);
        };

        if(prevMonthBtn) prevMonthBtn.addEventListener('click',()=>{currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--;} updateMonthlyDisplay(); applyMainFilters(); updateSummary(); suggestFinancialGoals();});
        if(nextMonthBtn) nextMonthBtn.addEventListener('click',()=>{currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++;} updateMonthlyDisplay(); applyMainFilters(); updateSummary(); suggestFinancialGoals();});
        if(searchTransactionsInput) searchTransactionsInput.addEventListener('input', applyMainFilters);
        document.querySelectorAll('.filter-main-select').forEach(sel => sel.addEventListener('change', applyMainFilters));


        // --- Edit Account Modal (Unified) ---
        function openEditAccountModal(accountId) {
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            editAccountIdInput.value = account.id;
            editAccountNameInput.value = account.name;
            editAccountTypeDisplay.value = account.type.charAt(0).toUpperCase() + account.type.slice(1);
            editAccountBalanceInput.value = account.balance.toFixed(2);

            editOverdraftSection.classList.toggle('hidden', account.type !== 'corrente');
            editCreditCardSection.classList.toggle('hidden', account.type !== 'corrente');
            editLinkedCardsContainer.innerHTML = ''; 

            if (account.type === 'corrente') {
                editOverdraftLimitInput.value = (account.limitOverdraft || 0).toFixed(2);
                if (account.creditCards) {
                    account.creditCards.forEach(card => addCardInputFields(editLinkedCardsContainer, card, true));
                }
            } else {
                editOverdraftLimitInput.value = '';
            }
            editAccountModal.classList.remove('hidden');
        }

        if(closeEditAccountModalBtn) closeEditAccountModalBtn.addEventListener('click', () => editAccountModal.classList.add('hidden'));
        if(cancelEditAccountBtn) cancelEditAccountBtn.addEventListener('click', () => editAccountModal.classList.add('hidden'));

        if(saveEditAccountBtn) saveEditAccountBtn.addEventListener('click', () => {
            const accountId = editAccountIdInput.value;
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            account.name = editAccountNameInput.value.trim();
            account.balance = parseFloat(editAccountBalanceInput.value) || 0;

            if (account.type === 'corrente') {
                account.limitOverdraft = parseFloat(editOverdraftLimitInput.value) || 0;
                
                const updatedCards = [];
                editLinkedCardsContainer.querySelectorAll('div[data-card-id]').forEach(cardDiv => {
                    if (cardDiv.classList.contains('marked-for-deletion')) { 
                        return;
                    }

                    const cardId = cardDiv.dataset.cardId;
                    const cardBrand = cardDiv.querySelector('.card-brand-select').value;
                    const customCardName = cardDiv.querySelector('.card-name-input').value.trim();
                    const cardLimit = parseFloat(cardDiv.querySelector('.card-limit-input').value) || 0;
                    const cardDueDay = parseInt(cardDiv.querySelector('.card-due-day-input').value) || 0;

                    if (cardBrand && cardLimit > 0 && cardDueDay >= 1 && cardDueDay <= 31) {
                         if (cardBrand === 'Outra' && !customCardName) {
                            showFeedback('Por favor, insira um nome para o cartão "Outra" ao editar.', 'error');
                            return; // Pula este cartão
                        }
                        const existingCard = account.creditCards.find(c => c.cardId === cardId);
                        if (existingCard) { 
                            const oldCardLimit = existingCard.cardLimit;
                            existingCard.cardBrand = cardBrand;
                            existingCard.customCardName = cardBrand === 'Outra' ? customCardName : '';
                            existingCard.cardLimit = cardLimit;
                            existingCard.cardDueDay = cardDueDay;
                            existingCard.cardClosingDay = calculateClosingDay(cardDueDay);
                            const spentAmount = oldCardLimit - existingCard.cardAvailableLimit;
                            existingCard.cardAvailableLimit = cardLimit - spentAmount;
                            updatedCards.push(existingCard);
                        } else { 
                             updatedCards.push({
                                cardId: generateUniqueId(), 
                                cardBrand, 
                                customCardName: cardBrand === 'Outra' ? customCardName : '', 
                                cardLimit, 
                                cardDueDay,
                                cardAvailableLimit: cardLimit, 
                                currentBillAmount: 0,
                                cardClosingDay: calculateClosingDay(cardDueDay)
                            });
                        }
                    }
                });
                account.creditCards = updatedCards;
            }
            saveData();
            renderAll();
            editAccountModal.classList.add('hidden');
            showFeedback('Conta atualizada!', 'success');
        });

        // --- Detailed Statement Modal ---
        function openDetailedStatementModal(accountId) {
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            detailedStatementTitle.textContent = `Extrato Detalhado - ${account.name}`;
            statementSourceSelect.innerHTML = ''; 

            const balanceOpt = document.createElement('option');
            balanceOpt.value = 'account_balance';
            balanceOpt.textContent = 'Saldo da Conta Principal';
            statementSourceSelect.appendChild(balanceOpt);

            if (account.type === 'corrente' && account.limitOverdraft > 0) {
                const overdraftOpt = document.createElement('option');
                overdraftOpt.value = 'overdraft';
                overdraftOpt.textContent = 'Cheque Especial';
                statementSourceSelect.appendChild(overdraftOpt);
            }

            if (account.creditCards) {
                account.creditCards.forEach(card => {
                    const cardDisplayName = card.cardBrand === 'Outra' ? card.customCardName : card.cardBrand;
                    const cardOpt = document.createElement('option');
                    cardOpt.value = `credit_card_${card.cardId}`;
                    cardOpt.textContent = `Fatura Cartão: ${cardDisplayName || 'Cartão'}`;
                    statementSourceSelect.appendChild(cardOpt);
                });
            }
            
            statementSourceSelect.onchange = () => renderStatementForSource(accountId, statementSourceSelect.value);
            renderStatementForSource(accountId, statementSourceSelect.value); 

            detailedStatementModal.classList.remove('hidden');
        }
        
        function renderStatementForSource(accountId, selectedFundSource) {
            detailedStatementList.innerHTML = '';
            noDetailedStatementMessage.classList.add('hidden');
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            let statementTransactions = [];

            if (selectedFundSource === 'account_balance') {
                statementTransactions = transactions.filter(t => t.accountId === accountId && (t.fundSource === 'account_balance' || (!t.fundSource && !t.isCreditCardTransaction && t.type !== 'transferencia_saida' && t.type !== 'transferencia_entrada') || (t.type === 'transferencia_entrada' && t.destinationAccountId === accountId) || (t.type === 'transferencia_saida' && t.accountId === accountId && t.fundSource === 'account_balance') ))
                                            .sort((a,b) => new Date(a.date) - new Date(b.date));
            } else if (selectedFundSource === 'overdraft') {
                statementTransactions = transactions.filter(t => t.accountId === accountId && t.fundSource === 'overdraft')
                                            .sort((a,b) => new Date(a.date) - new Date(b.date));
            } else if (selectedFundSource.startsWith('credit_card_')) {
                statementTransactions = transactions.filter(t => t.accountId === accountId && t.fundSource === selectedFundSource)
                                            .sort((a,b) => new Date(a.date) - new Date(b.date));
            }


            if (statementTransactions.length === 0) {
                noDetailedStatementMessage.classList.remove('hidden');
                return;
            }

            statementTransactions.forEach(tx => {
                const tr = document.createElement('tr');
                let valueDisplay = formatCurrency(tx.value);
                let valueClass = "text-gray-800";

                if (selectedFundSource === 'account_balance' || selectedFundSource === 'overdraft') {
                    if (tx.fundamentalType === 'receita') {
                        valueDisplay = `+ ${valueDisplay}`;
                        valueClass = "text-green-600";
                    } else {
                        valueDisplay = `- ${valueDisplay}`;
                        valueClass = "text-red-600";
                    }
                } else { 
                     valueClass = tx.fundamentalType === 'despesa' ? "text-red-600" : "text-green-600";
                }


                tr.innerHTML = `
                    <td class="px-4 py-2 text-sm">${new Date(tx.date + "T00:00:00").toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-2 text-sm">${tx.description}</td>
                    <td class="px-4 py-2 text-sm text-right ${valueClass}">${valueDisplay}</td>
                    <td class="px-4 py-2 text-sm text-right"></td> <!-- Placeholder for running balance -->
                    <td class="px-4 py-2 text-right text-xs">
                        <button data-id="${tx.id}" class="edit-statement-tx-btn text-yellow-600 hover:text-yellow-800 mr-1 p-0.5">Editar</button>
                        <button data-id="${tx.id}" data-type="transaction" class="delete-statement-tx-btn text-red-400 hover:text-red-600 p-0.5">Excluir</button>
                    </td>
                `;
                tr.querySelector('.edit-statement-tx-btn').addEventListener('click', (e) => {
                    openEditTransactionModal(e.currentTarget.dataset.id);
                });
                tr.querySelector('.delete-statement-tx-btn').addEventListener('click', (e) => {
                     requestDeleteConfirmation(e.currentTarget.dataset.id, 'transaction', false, [], accountId, selectedFundSource);
                });
                detailedStatementList.appendChild(tr);
            });
        }

        if(closeDetailedStatementModalBtn) closeDetailedStatementModalBtn.addEventListener('click', () => detailedStatementModal.classList.add('hidden'));
        if(closeDetailedStatementModalFooterBtn) closeDetailedStatementModalFooterBtn.addEventListener('click', () => detailedStatementModal.classList.add('hidden'));


        // --- Delete Logic (Adapted) ---
        function requestDeleteConfirmation(id, type, isBulk = false, ids = [], accountIdForReversal = null, fundSourceForReversal = null) {
            itemToDelete = { id, type, showFeedback: !isBulk, isBulk, ids, accountIdForReversal, fundSourceForReversal };
            let itemName = "";
            if (type === 'allData') { itemName = "TODOS OS DADOS"; confirmationModalTitle.textContent = "Confirmar Limpeza Total"; }
            else if (isBulk) { itemName = `${ids.length} transações`; confirmationModalTitle.textContent = "Confirmar Exclusão em Lote"; }
            else if (type === 'account') { const acc = accounts.find(a => a.id === id); itemName = acc ? `a conta "${acc.name}"` : "este item"; confirmationModalTitle.textContent = "Confirmar Exclusão de Conta"; }
            else if (type === 'transaction') { const tx = transactions.find(t => t.id === id); itemName = tx ? `a transação "${tx.description}"` : "este item"; if (tx && tx.originalGroupId) itemName += " e suas parcelas"; confirmationModalTitle.textContent = "Confirmar Exclusão de Transação"; }
            confirmationModalMessage.textContent = `Tem certeza que deseja excluir ${itemName}? Esta ação não pode ser desfeita.`;
            confirmationModal.classList.remove('hidden');
        }
        if(closeConfirmationModalBtn) closeConfirmationModalBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        if(cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        if(confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', () => {
            let itemActuallyDeleted = false;
            if (itemToDelete.type === 'allData') {
                accounts = []; transactions = []; categories = ["Alimentação", "Transporte", "Moradia", "Lazer", "Saúde", "Educação", "Salário", "Investimentos", "Contas Fixas", "Compras", "Transferências", "Outros", "Revisar Importação"];
                itemActuallyDeleted = true;
            } else if (itemToDelete.isBulk) {
                let deletedCount = 0;
                const groupIdsProcessed = new Set();
                itemToDelete.ids.forEach(idToDel => {
                    const tx = transactions.find(t => t.id === idToDel);
                    if (tx) {
                        if (tx.originalGroupId && !groupIdsProcessed.has(tx.originalGroupId)) {
                            transactions = transactions.filter(t => {
                                if (t.originalGroupId === tx.originalGroupId) {
                                    updateAccountBalance(t.accountId, t.fundSource, t.value, t.fundamentalType, true, t.isPaid, t.destinationAccountId, t.type);
                                    deletedCount++;
                                    return false; 
                                }
                                return true;
                            });
                            groupIdsProcessed.add(tx.originalGroupId);
                        } else if (!tx.originalGroupId) { 
                            const txIdx = transactions.findIndex(t => t.id === idToDel);
                            if (txIdx > -1) {
                                const delTx = transactions[txIdx];
                                updateAccountBalance(delTx.accountId, delTx.fundSource, delTx.value, delTx.fundamentalType, true, delTx.isPaid, delTx.destinationAccountId, delTx.type);
                                transactions.splice(txIdx, 1);
                                deletedCount++;
                            }
                        }
                    }
                });
                if (deletedCount > 0) itemActuallyDeleted = true;
                if (itemToDelete.showFeedback && itemActuallyDeleted) showFeedback(`${deletedCount} transação(ões)/grupo(s) excluído(s).`, 'success');


            } else if (itemToDelete.type === 'account') {
                if (transactions.some(t => t.accountId === itemToDelete.id || t.destinationAccountId === itemToDelete.id)) {
                    showFeedback('Exclua ou desvincule as transações desta conta primeiro.', 'error');
                } else {
                    accounts = accounts.filter(acc => acc.id !== itemToDelete.id);
                    itemActuallyDeleted = true;
                }
            } else if (itemToDelete.type === 'transaction') {
                const tx = transactions.find(t => t.id === itemToDelete.id);
                if (tx) {
                    if (tx.originalGroupId) { 
                        let count = 0;
                        transactions = transactions.filter(t => {
                            if (t.originalGroupId === tx.originalGroupId) {
                                updateAccountBalance(t.accountId, t.fundSource, t.value, t.fundamentalType, true, t.isPaid, t.destinationAccountId, t.type);
                                count++;
                                return false;
                            }
                            return true;
                        });
                         if (count > 0) itemActuallyDeleted = true;
                    } else { 
                        const txIdx = transactions.findIndex(t_ => t_.id === itemToDelete.id);
                        if (txIdx > -1) {
                            const delTx = transactions[txIdx];
                            updateAccountBalance(delTx.accountId, delTx.fundSource, delTx.value, delTx.fundamentalType, true, delTx.isPaid, delTx.destinationAccountId, delTx.type);
                            transactions.splice(txIdx, 1);
                            itemActuallyDeleted = true;
                        }
                    }
                }
            }

            if (itemActuallyDeleted) {
                saveData();
                renderAll();
                 if (itemToDelete.showFeedback) showFeedback('Item(s) excluído(s) com sucesso.', 'success');
                if (itemToDelete.accountIdForReversal && itemToDelete.fundSourceForReversal && detailedStatementModal && !detailedStatementModal.classList.contains('hidden')) {
                    renderStatementForSource(itemToDelete.accountIdForReversal, itemToDelete.fundSourceForReversal);
                }
            }
            confirmationModal.classList.add('hidden');
            updateSelectedTransactionsActions();
        });
        
        const markTransactionAsPaid = (id, showIndividualFeedback = true) => {
            const tx = transactions.find(t => t.id === id);
            if (tx && !tx.isPaid) {
                if (!tx.isCreditCardTransaction && tx.fundamentalType === 'despesa') {
                    const account = accounts.find(acc => acc.id === tx.accountId);
                    if (account) {
                        let tempBalance = account.balance;
                        if (tx.fundSource === 'overdraft') tempBalance += account.limitOverdraft;

                        if (tx.fundSource !== 'overdraft' && account.balance < tx.value && (account.balance + account.limitOverdraft < tx.value)) {
                             if (showIndividualFeedback) showFeedback(`Saldo insuficiente em ${account.name} (incluindo cheque especial, se aplicável) para pagar esta despesa.`, 'error');
                             return false; 
                        }
                    }
                    updateAccountBalance(tx.accountId, tx.fundSource, tx.value, tx.fundamentalType, false, true, tx.destinationAccountId, tx.type); 
                }
                tx.isPaid = true;
                saveData();
                if (showIndividualFeedback) showFeedback('Transação marcada como realizada!', 'success');
                renderAll();
                return true;
            } else if (tx && tx.isPaid) {
                if (showIndividualFeedback) showFeedback('Transação já está realizada.', 'info');
            }
            return false;
        };

        const populateCategorySelect = (selectElement, forBulkOrFilter = false) => {
            if(!selectElement) return;
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';
            if (forBulkOrFilter) {
                const opt = document.createElement('option');
                opt.value = forBulkOrFilter === "filter" ? "all" : ""; 
                opt.textContent = forBulkOrFilter === "filter" ? "Todas as Categorias" : "Manter original";
                selectElement.appendChild(opt);
            } else { // For transaction modal
                const opt = document.createElement('option');
                opt.value = ""; opt.textContent = "Selecione categoria"; opt.disabled = true; opt.selected = !currentVal;
                selectElement.appendChild(opt);
            }
            categories.sort((a,b) => a.localeCompare(b)).forEach(cat => {
                const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat;
                selectElement.appendChild(opt);
            });
            const newOpt = document.createElement('option');
            newOpt.value = forBulkOrFilter ? 'nova-categoria-bulk' : 'nova-categoria';
            newOpt.textContent = 'Adicionar Nova...';
            selectElement.appendChild(newOpt);

            if (currentVal && (categories.includes(currentVal) || currentVal === newOpt.value || (forBulkOrFilter && currentVal === opt.value))) {
                selectElement.value = currentVal;
            } else if (!forBulkOrFilter && selectElement.options.length > 1 && !currentVal) {
                 selectElement.value = "";
            } else if (forBulkOrFilter && selectElement.options.length > 0) {
                selectElement.value = forBulkOrFilter === "filter" ? "all" : "";
            }
        };
        
        if(modalCategorySelect) modalCategorySelect.addEventListener('change', () => { modalNewCategoryInput.classList.toggle('hidden', modalCategorySelect.value !== 'nova-categoria'); if(modalCategorySelect.value === 'nova-categoria') modalNewCategoryInput.focus(); });
        if(bulkEditCategorySelect) bulkEditCategorySelect.addEventListener('change', (e) => {
            // Assuming a similar new category input for bulk edit, though not explicitly defined in HTML snippet
            // const newCatInputForBulk = document.getElementById('bulk-edit-new-category-input'); 
            // if (newCatInputForBulk) newCatInputForBulk.classList.toggle('hidden', e.target.value !== 'nova-categoria-bulk');
        });


        const populateLinkSelectedAccountSelect = () => { 
             if(!linkSelectedAccountSelect) return;
             linkSelectedAccountSelect.innerHTML='<option value="">Vincular Conta...</option>';
             accounts.forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc.id;
                let typeText = acc.type === 'corrente' ? "C/C" : (acc.type === 'poupanca' ? "Poupança" : acc.type.charAt(0).toUpperCase() + acc.type.slice(1));
                opt.textContent = `${acc.name} (${typeText})`;
                linkSelectedAccountSelect.appendChild(opt);
             });
        };
        const populateLinkSelectedCategorySelect = () => { 
            if (!linkSelectedCategorySelect) return;
            const currentValue = linkSelectedCategorySelect.value;
            linkSelectedCategorySelect.innerHTML = '<option value="">Vincular Categoria...</option>';
            categories.sort((a, b) => a.localeCompare(b)).forEach(cat => {
                if (cat === "Revisar Importação") return;
                const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat;
                linkSelectedCategorySelect.appendChild(opt);
            });
            const newOpt = document.createElement('option'); newOpt.value = 'nova-categoria-lote'; newOpt.textContent = 'Adicionar Nova...';
            linkSelectedCategorySelect.appendChild(newOpt);
            if (currentValue && (categories.includes(currentValue) || currentValue === 'nova-categoria-lote')) {
                linkSelectedCategorySelect.value = currentValue;
            }
        };
        const populateReportSelectors = () => { 
            const currentYr = new Date().getFullYear(); const currentMth = new Date().getMonth();
            const populateYrSel = (sel, defYr) => { if(!sel) return; sel.innerHTML = ''; for(let y=currentYr+1; y>=currentYr-10; y--){ const o=document.createElement('option'); o.value=y; o.textContent=y; if(y===defYr)o.selected=true; sel.appendChild(o);}};
            const populateMthSel = (sel, defMth) => { if(!sel) return; sel.innerHTML = ''; const mN=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"]; mN.forEach((n,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=n; if(i===defMth)o.selected=true; sel.appendChild(o);});};
            populateYrSel(reportYearSelect1, currentYr); populateMthSel(reportMonthSelect1, currentMth);
            populateYrSel(reportYearSelect2, currentYr-1); populateMthSel(reportMonthSelect2, currentMth);
        };
        const checkCreditCardDueDates = () => { 
            const today=new Date(); today.setHours(0,0,0,0);
            accounts.forEach(account => {
                if (account.creditCards) {
                    account.creditCards.forEach(card => {
                        const dueDay = card.cardDueDay;
                        let billDueDate = new Date(today.getFullYear(), today.getMonth(), dueDay);
                        billDueDate.setHours(0,0,0,0);
                        if (today.getDate() > dueDay) billDueDate.setMonth(today.getMonth() + 1);

                        let billClosingDate = new Date(billDueDate);
                        billClosingDate.setDate(billDueDate.getDate() - (card.cardClosingDayOffset || 9)); 
                         if (billClosingDate > billDueDate) billClosingDate.setMonth(billClosingDate.getMonth() -1);


                        if (today.getTime() === billClosingDate.getTime()) {
                            const closingBill = transactions.reduce((s, t) => {
                                const tDate = new Date(t.date + "T00:00:00");
                                if (t.fundSource === `credit_card_${card.cardId}` && t.fundamentalType === 'despesa' && tDate >= new Date(billClosingDate).setDate(billClosingDate.getDate() - 30) && tDate < billClosingDate) { 
                                    return s + t.value;
                                }
                                return s;
                            }, 0);
                            if (closingBill > 0) showFeedback(`FATURA FECHADA: ${card.cardName} (Conta: ${account.name}) fechou! Valor: ${formatCurrency(closingBill)}. Vencimento: ${billDueDate.toLocaleDateString('pt-BR')}`, 'info');
                        }

                        const diffT = billDueDate.getTime() - today.getTime();
                        const diffD = Math.ceil(diffT / (1000 * 60 * 60 * 24));
                        const billToNotify = transactions.reduce((s, t) => {
                             const tDate = new Date(t.date + "T00:00:00");
                             if (t.fundSource === `credit_card_${card.cardId}` && t.fundamentalType === 'despesa' && !t.isPaid && tDate >= billClosingDate && tDate < billDueDate ) { 
                                return s + t.value;
                             }
                             return s;
                        },0);

                        if (diffD <= 7 && diffD >= 0 && billToNotify > 0) {
                            showFeedback(`VENCIMENTO PRÓXIMO: Fatura ${card.cardName} (Conta: ${account.name}) vence ${diffD === 0 ? 'HOJE' : 'em ' + diffD + ' dia(s)'}! Valor atual: ${formatCurrency(billToNotify)}`, 'info');
                        }
                    });
                }
            });
        };
        const suggestFinancialGoals = () => { 
            if (!suggestedGoalsList || !noSuggestedGoalsMessage) return;
            suggestedGoalsList.innerHTML = ''; noSuggestedGoalsMessage.classList.add('hidden');
            const lowBalanceAccounts = accounts.filter(acc => acc.balance < 500 && acc.type !== 'investimento');
            if (lowBalanceAccounts.length > 0) {
                const li = document.createElement('li');
                li.innerHTML = `<strong>Economizar:</strong> Considere aumentar o saldo em contas como ${lowBalanceAccounts.map(a => a.name).join(', ')}.`;
                suggestedGoalsList.appendChild(li);
            }
            if (suggestedGoalsList.children.length === 0) noSuggestedGoalsMessage.classList.remove('hidden');

        };

        const finalizeImportProcessing = (parsedTxs, sourceFileName = "Arquivo Importado") => { 
            // Limpa ambos os inputs de ficheiro, caso existam
            if(fileInput) fileInput.value = ''; 
            if(fileInputPdf) fileInputPdf.value = '';
            
            // Reativa ambos os botões de importação
            if(importFileBtn) importFileBtn.disabled = false;
            if(importPdfFileBtn) importPdfFileBtn.disabled = false;

            if (parsedTxs && parsedTxs.length > 0) {
                importedTransactionsToReview = parsedTxs.map(tx => ({
                    ...tx,
                    id: generateUniqueId(), // ID temporário para a revisão
                    sourceFile: sourceFileName 
                }));
                renderImportedTransactionsForReview();
                importReviewSection.classList.remove('hidden');
                showFeedback(`${parsedTxs.length} transações carregadas de "${sourceFileName}" para revisão.`, "info");
            } else {
                importReviewSection.classList.add('hidden');
                showFeedback(`Nenhuma transação encontrada ou erro ao processar "${sourceFileName}".`, "info");
            }
        };
        const handleImportError = (err,fileType, fileName = "arquivo") => { 
            console.error(`Erro ao processar ${fileType} (${fileName}):`, err); 
            showFeedback(`Erro ao processar ${fileType} "${fileName}". Verifique console.`, 'error'); 
            importReviewSection.classList.add('hidden'); 
            if(fileInput) fileInput.value=''; 
            if(fileInputPdf) fileInputPdf.value='';
            if(importFileBtn) importFileBtn.disabled=false; 
            if(importPdfFileBtn) importPdfFileBtn.disabled=false;
        };
        
        // --- Funções de Parsing (Placeholders Melhorados) ---
        const parseOFX = async (file) => {
            showFeedback(`Processando OFX: ${file.name}... (Lógica de parsing não implementada)`, "info", 10000);
            console.log("Tentando processar OFX (lógica de parsing real necessária aqui).");
            const parsedTransactions = []; 
            finalizeImportProcessing(parsedTransactions, file.name);
        };

        const parseExcelCsv = async (file, extension) => {
            showFeedback(`Processando ${extension.toUpperCase()}: ${file.name}... (Lógica de parsing não implementada)`, "info", 10000);
            console.log(`Tentando processar ${extension.toUpperCase()} (lógica de parsing real necessária aqui).`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                let workbook;
                if (extension === '.csv') {
                    console.warn("Parsing de CSV precisa de tratamento específico para delimitadores e encoding.");
                    finalizeImportProcessing([], file.name); 
                    return;
                } else {
                    workbook = XLSX.read(data, {type: 'array'});
                }

                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false, dateNF:'yyyy-mm-dd'}); 

                console.log("Dados brutos do Excel/CSV:", jsonData);
                const parsedTransactions = []; 
                finalizeImportProcessing(parsedTransactions, file.name);
            };
            reader.onerror = function(err) {
                handleImportError(err, extension.toUpperCase(), file.name);
            };

            if (extension === '.csv') {
                reader.readAsArrayBuffer(file); 
            } else {
                reader.readAsArrayBuffer(file);
            }
        };

        const processAndStructureTextLines = (text, fileName) => {
            console.log(`Processando texto extraído de ${fileName}. Conteúdo abaixo (primeiros 1000 caracteres):`);
            console.log(text.substring(0, 1000) + (text.length > 1000 ? "..." : ""));
            
            const transactions = [];
            const lines = text.split('\n');
            
            // Padrões de data mais abrangentes
            const datePatterns = [
                /\b(\d{1,2}[\/\.-]\d{1,2}[\/\.-]\d{2,4})\b/g, // DD/MM/YYYY, DD.MM.YYYY, DD/MM/YY, DD.MM.YY
                /\b(\d{4}[-\/\.]\d{1,2}[-\/\.]\d{1,2})\b/g,    // YYYY-MM-DD, YYYY/MM/DD
                /\b(\d{1,2}\s+(?:Jan|Fev|Mar|Abr|Mai|Jun|Jul|Ago|Set|Out|Nov|Dez)\.?\s+\d{2,4})\b/gi // 01 Jan 2023
            ];
            
            lines.forEach(line => {
                line = line.trim();
                if (line.length < 5) return; 

                let extractedDate = null;
                for (const pattern of datePatterns) {
                    // Resetar lastIndex para cada padrão, pois são globais
                    pattern.lastIndex = 0; 
                    const dateMatch = pattern.exec(line);
                    if (dateMatch) {
                        extractedDate = formatDateFromVariousFormats(dateMatch[0]);
                        if (extractedDate) break; // Usa a primeira data válida encontrada
                    }
                }

                const valueInfo = parseCurrencyValue(line); 
                
                if (extractedDate && valueInfo.value > 0) {
                    let description = line;
                    // Remover a data e o valor da linha para obter a descrição
                    datePatterns.forEach(pattern => { // Tenta remover todos os formatos de data
                        pattern.lastIndex = 0; // Resetar
                        description = description.replace(pattern, "").trim();
                    });
                    if (valueInfo.extractedString) {
                        description = description.replace(valueInfo.extractedString, "").trim();
                    }
                    description = description.replace(/\s\s+/g, ' ').trim(); // Remove espaços extras

                    let type = 'despesa'; 
                    if (valueInfo.isCredit === true) {
                        type = 'receita';
                    } else if (valueInfo.isCredit === false) {
                        type = 'despesa';
                    } else { 
                        if (/(crédito|cred|recebimento|depósito|rendimento|entrada|valor creditado)/i.test(description) || /(crédito|cred|recebimento|depósito|rendimento|entrada|valor creditado)/i.test(line)) type = 'receita';
                        else if (/(débito|deb|pagamento|compra|saque|saída|valor debitado)/i.test(description) || /(débito|deb|pagamento|compra|saque|saída|valor debitado)/i.test(line)) type = 'despesa';
                    }
                    
                    if (description.length < 3 || /^\d+$/.test(description) || description.toLowerCase() === "saldo anterior" || description.toLowerCase().startsWith("saldo ")) {
                         description = `Transação importada (${fileName})`;
                    }
                    // Remove palavras comuns de extrato que não são parte da descrição útil
                    description = description.replace(/\b(SALDO ANTERIOR|SALDO DO DIA|SALDO FINAL|HISTORICO|LANÇAMENTOS|EXTRATO)\b/gi, "").trim();
                    description = description.replace(/\s\s+/g, ' ').trim();


                    transactions.push({
                        id: generateUniqueId(), 
                        date: extractedDate,
                        description: description || `Importado de ${fileName}`,
                        value: valueInfo.value,
                        type: type,
                        fundamentalType: type === 'receita' || type === 'transferencia_entrada' ? 'receita' : 'despesa',
                        category: 'Revisar Importação', 
                        installments: '1/1',
                        isPaid: false, 
                        accountId: null, 
                        fundSource: 'account_balance', 
                        isCreditCardTransaction: false,
                        sourceFile: fileName,
                        fundamentalTypeOriginalSignal: valueInfo.isCredit === null ? (type === 'receita' ? 1 : -1) : (valueInfo.isCredit ? 1 : -1)
                    });
                }
            });

            if (transactions.length === 0) {
                console.warn(`Nenhuma transação estruturada pôde ser extraída de ${fileName} com a lógica atual.`);
                showFeedback(`Nenhuma transação estruturada encontrada em ${fileName}. Verifique o conteúdo e a lógica de parsing.`, "info");
            }
            return transactions;
        };

        const parseWord = async (file) => { 
            showFeedback(`Processando Word: ${file.name}...`, "info", 15000);
            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                const text = result.value;
                const structuredTxs = processAndStructureTextLines(text, file.name);
                finalizeImportProcessing(structuredTxs, file.name);
            } catch (err) {
                handleImportError(err, "Word", file.name);
            }
        };

        const parseImage = async (file) => {
            showFeedback(`Processando Imagem com OCR: ${file.name}... (Pode demorar)`, "info", 30000);
            try {
                const { data: { text } } = await Tesseract.recognize(file, 'por', { logger: m => console.log(m.status, Math.round(m.progress * 100) + '%') });
                const structuredTxs = processAndStructureTextLines(text, file.name);
                finalizeImportProcessing(structuredTxs, file.name);
            } catch (err) {
                handleImportError(err, "Imagem", file.name);
            }
        };

        const parsePDF = async (file) => {
            if (typeof pdfjsLib === 'undefined') {
                handleImportError(new Error("Biblioteca PDF.js não carregada."), "PDF", file.name);
                return;
            }
            showFeedback(`Processando PDF: ${file.name}...`, "info", 20000);
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(" ") + "\n"; 
                }
                const structuredTxs = processAndStructureTextLines(fullText, file.name);
                finalizeImportProcessing(structuredTxs, file.name);
            } catch (err) {
                handleImportError(err, "PDF", file.name);
            }
        };
        
        // --- Filter Population Functions ---
        const populateMainFilters = () => {
            populateCategorySelect(filterMainCategorySelect, "filter");
            populateAccountSelects(filterMainAccountSelect, false, true, true); 
        };

        const populateImportFilters = () => {
            populateCategorySelect(filterImportCategorySelect, "filter");
            populateAccountSelects(filterImportAccountSelect, false, true, true); 
        };
        
        // --- Função para controlar visibilidade dos controlos de edição em lote ---
        const updateBulkEditControlsVisibility = () => {
            if (!bulkEditImportedControls || !selectAllImportedCheckbox) return;
            const selectedCheckboxes = document.querySelectorAll('#imported-transactions-table-body .imported-transaction-checkbox:checked');
            const hasSelected = selectedCheckboxes.length > 0;
            bulkEditImportedControls.classList.toggle('hidden', !hasSelected);

            const allVisibleCheckboxes = document.querySelectorAll('#imported-transactions-table-body .imported-transaction-checkbox');
            selectAllImportedCheckbox.checked = allVisibleCheckboxes.length > 0 && selectedCheckboxes.length === allVisibleCheckboxes.length;
        };


        // --- Render Imported Transactions with Filters ---
        const renderImportedTransactionsForReview = (filters = {}) => {
            if (!importedTransactionsTableBody) return;
            importedTransactionsTableBody.innerHTML = '';
            if (!importedTransactionsToReview || importedTransactionsToReview.length === 0) {
                importReviewSection.classList.add('hidden');
                if (selectAllImportedCheckbox) selectAllImportedCheckbox.checked = false;
                updateBulkEditControlsVisibility();
                return;
            }

            const filteredForReview = importedTransactionsToReview.filter(tx => {
                if (filters.type && filters.type !== "all" && tx.type !== filters.type) return false;
                if (filters.category && filters.category !== "all" && tx.category !== filters.category) return false;
                if (filters.accountId && filters.accountId !== "all") {
                    if (filters.accountId === "none" && tx.accountId) return false;
                    if (filters.accountId !== "none" && tx.accountId !== filters.accountId) return false;
                }
                if (filters.status && filters.status !== "all" && (filters.status === "true" ? !tx.isPaid : tx.isPaid)) return false;
                return true;
            });


            filteredForReview.forEach((tx) => { 
                const tr = document.createElement('tr'); tr.className = 'bg-white hover:bg-gray-50';
                const idxInMainArray = importedTransactionsToReview.findIndex(item => item.id === tx.id);


                let accOpts = accounts.map(a=>`<option value="${a.id}" ${tx.accountId===a.id?'selected':''}>${a.name} (${a.type==='corrente'?'C/C':(a.type==='poupanca'?'Poupança':'Dinheiro')})</option>`).join('');
                
                const valFmt = typeof tx.value==='number'?tx.value.toFixed(2):'0.00';
                const instTotal=tx.installmentsTotal||(tx.installments?parseInt(tx.installments.split('/')[1]):1)||1;
                const instPaid=tx.installmentsPaid||(tx.installments?parseInt(tx.installments.split('/')[0]):(tx.isPaid?1:0))||0;

                tr.innerHTML = `
                    <td class="px-2 py-2 text-center"><input type="checkbox" class="imported-transaction-checkbox form-checkbox h-4 w-4 text-blue-600" data-index="${idxInMainArray}" checked></td>
                    <td class="px-2 py-2"><input type="date" class="date-input w-full border rdd px-1 py-0.5 text-xs" value="${tx.date||new Date().toISOString().split('T')[0]}" data-index="${idxInMainArray}"></td>
                    <td class="px-2 py-2"><textarea class="description-input w-full border rdd px-1 py-0.5 text-xs" data-index="${idxInMainArray}" rows="2">${tx.description||''}</textarea></td>
                    <td class="px-2 py-2"><input type="number" step="0.01" class="value-input w-24 border rdd px-1 py-0.5 text-xs" value="${valFmt}" data-index="${idxInMainArray}"></td>
                    <td class="px-2 py-2"><select class="type-input w-full border rdd px-1 py-0.5 text-xs" data-index="${idxInMainArray}"><option value="receita" ${tx.type==='receita'?'selected':''}>Receita</option><option value="despesa" ${tx.type==='despesa'?'selected':''}>Despesa</option><option value="transferencia_entrada" ${tx.type==='transferencia_entrada'?'selected':''}>Transf. Entrada</option><option value="transferencia_saida" ${tx.type==='transferencia_saida'?'selected':''}>Transf. Saída</option></select></td>
                    <td class="px-2 py-2"><select class="category-input w-full border rdd px-1 py-0.5 text-xs" data-index="${idxInMainArray}">${categories.sort((a,b)=>a.localeCompare(b)).map(c=>`<option value="${c}" ${tx.category===c?'selected':''}>${c}</option>`).join('')}<option value="nova-categoria-review">Adicionar Nova...</option></select><input type="text" class="new-category-input-review hidden w-full border rdd px-1 py-0.5 text-xs mt-1" placeholder="Nova Cat." data-index="${idxInMainArray}" value="${!categories.includes(tx.category)&&tx.category&&tx.category!=='Outros'&&!tx.category?.startsWith('Importado')?tx.category:''}"></td>
                    <td class="px-2 py-2"><div class="flex space-x-1"><input type="number" min="1" value="${instTotal}" class="installments-total-review w-16 border rdd px-1 py-0.5 text-xs" data-index="${idxInMainArray}" title="Total Parcelas"><input type="number" min="0" value="${instPaid}" class="installments-paid-review w-16 border rdd px-1 py-0.5 text-xs" data-index="${idxInMainArray}" title="Parcelas Pagas"></div></td>
                    <td class="px-2 py-2"><select class="account-select-review w-full border rdd px-1 py-0.5 text-xs" data-index="${idxInMainArray}"><option value="">Não Vincular</option>${accOpts}</select></td>
                    <td class="px-2 py-2"><select class="fund-source-select-review hidden w-full border rdd px-1 py-0.5 text-xs" data-index="${idxInMainArray}"></select></td> <!-- Initially hidden, populated if account is selected -->
                    <td class="px-2 py-2"><select class="paid-status-input w-full border rdd px-1 py-0.5 text-xs" data-index="${idxInMainArray}"><option value="false" ${!tx.isPaid?'selected':''}>Não Pago</option><option value="true" ${tx.isPaid?'selected':''}>Pago</option></select></td>`;
                importedTransactionsTableBody.appendChild(tr);
                
                const currentIdx = idxInMainArray; 
                const accSelEl=tr.querySelector('.account-select-review');
                const fundSourceSelEl = tr.querySelector('.fund-source-select-review');

                if(tx.accountId) accSelEl.value=tx.accountId;
                
                if (tx.accountId && importedTransactionsToReview[currentIdx].type === 'despesa') {
                    populateFundSourceSelectForImportRow(fundSourceSelEl, tx.accountId);
                    fundSourceSelEl.value = importedTransactionsToReview[currentIdx].fundSource || 'account_balance';
                    fundSourceSelEl.classList.remove('hidden');
                }


                const catInEl=tr.querySelector('.category-input');const newCatInEl=tr.querySelector('.new-category-input-review');if(!categories.includes(tx.category)&&tx.category&&tx.category!=='Outros'&&!tx.category?.startsWith('Importado')){catInEl.value='nova-categoria-review';newCatInEl.classList.remove('hidden');}
                
                tr.querySelector('.date-input').addEventListener('change',(e)=>importedTransactionsToReview[currentIdx].date=e.target.value);
                tr.querySelector('.description-input').addEventListener('input',(e)=>importedTransactionsToReview[currentIdx].description=e.target.value);
                tr.querySelector('.value-input').addEventListener('change',(e)=>{const v=parseFloat(e.target.value)||0; const s=importedTransactionsToReview[currentIdx].fundamentalTypeOriginalSignal||(v>=0?1:-1); importedTransactionsToReview[currentIdx].value=Math.abs(v); if(v!==0)importedTransactionsToReview[currentIdx].fundamentalType=v*s>=0?'receita':'despesa'; else importedTransactionsToReview[currentIdx].fundamentalType=s>0?'receita':'despesa'; if(['receita','despesa'].includes(importedTransactionsToReview[currentIdx].type)||!importedTransactionsToReview[currentIdx].type){importedTransactionsToReview[currentIdx].type=importedTransactionsToReview[currentIdx].fundamentalType;tr.querySelector('.type-input').value=importedTransactionsToReview[currentIdx].type;}});
                tr.querySelector('.type-input').addEventListener('change',(e)=>{const nT=e.target.value; importedTransactionsToReview[currentIdx].type=nT; if(nT==='receita'||nT==='transferencia_entrada'){importedTransactionsToReview[currentIdx].fundamentalType='receita';importedTransactionsToReview[currentIdx].fundamentalTypeOriginalSignal=1;}else{importedTransactionsToReview[currentIdx].fundamentalType='despesa';importedTransactionsToReview[currentIdx].fundamentalTypeOriginalSignal=-1;} if(nT === 'despesa' && accSelEl.value) { populateFundSourceSelectForImportRow(fundSourceSelEl, accSelEl.value); fundSourceSelEl.classList.remove('hidden'); importedTransactionsToReview[currentIdx].fundSource = fundSourceSelEl.value || 'account_balance';} else {fundSourceSelEl.classList.add('hidden'); fundSourceSelEl.innerHTML = ''; importedTransactionsToReview[currentIdx].fundSource = 'account_balance';}});
                catInEl.addEventListener('change',(e)=>{if(e.target.value==='nova-categoria-review'){newCatInEl.classList.remove('hidden');newCatInEl.focus();importedTransactionsToReview[currentIdx].category='';}else{newCatInEl.classList.add('hidden');newCatInEl.value='';importedTransactionsToReview[currentIdx].category=e.target.value;}});
                newCatInEl.addEventListener('blur',(e)=>{if(e.target.value.trim()&&catInEl.value==='nova-categoria-review')importedTransactionsToReview[currentIdx].category=e.target.value.trim();});
                accSelEl.addEventListener('change',(e)=>{importedTransactionsToReview[currentIdx].accountId=e.target.value; importedTransactionsToReview[currentIdx].isCreditCardTransaction=false; if(importedTransactionsToReview[currentIdx].type === 'despesa' && e.target.value) { populateFundSourceSelectForImportRow(fundSourceSelEl, e.target.value); fundSourceSelEl.classList.remove('hidden'); importedTransactionsToReview[currentIdx].fundSource = fundSourceSelEl.value || 'account_balance';} else {fundSourceSelEl.classList.add('hidden'); fundSourceSelEl.innerHTML = ''; importedTransactionsToReview[currentIdx].fundSource = 'account_balance';}});
                fundSourceSelEl.addEventListener('change', (e) => { importedTransactionsToReview[currentIdx].fundSource = e.target.value; importedTransactionsToReview[currentIdx].isCreditCardTransaction = e.target.value.startsWith('credit_card_');});
                tr.querySelector('.paid-status-input').addEventListener('change',(e)=>importedTransactionsToReview[currentIdx].isPaid=e.target.value==='true');
                const instTotEl=tr.querySelector('.installments-total-review');const instPaidEl=tr.querySelector('.installments-paid-review');
                instTotEl.addEventListener('change',(e)=>{let t=parseInt(e.target.value)||1;if(t<1)t=1;e.target.value=t;importedTransactionsToReview[currentIdx].installmentsTotal=t;if(parseInt(instPaidEl.value)>t){instPaidEl.value=t;importedTransactionsToReview[currentIdx].installmentsPaid=t;}});
                instPaidEl.addEventListener('change',(e)=>{const t=parseInt(instTotEl.value)||1;let p=parseInt(e.target.value)||0;if(p<0)p=0;if(p>t)p=t;e.target.value=p;importedTransactionsToReview[currentIdx].installmentsPaid=p;});
                tr.querySelector('.imported-transaction-checkbox').addEventListener('change', updateBulkEditControlsVisibility);
            });
            updateBulkEditControlsVisibility(); // Chamada inicial após renderizar
        };
        
        function populateFundSourceSelectForImportRow(selectEl, accountId) {
            selectEl.innerHTML = '';
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

            const balanceOpt = document.createElement('option');
            balanceOpt.value = 'account_balance';
            balanceOpt.textContent = 'Saldo Conta';
            selectEl.appendChild(balanceOpt);

            if (account.type === 'corrente') {
                if (account.limitOverdraft > 0) {
                    const overdraftOpt = document.createElement('option');
                    overdraftOpt.value = 'overdraft';
                    overdraftOpt.textContent = 'Cheque Esp.';
                    selectEl.appendChild(overdraftOpt);
                }
                if (account.creditCards && account.creditCards.length > 0) {
                    account.creditCards.forEach(card => {
                        const cardDisplayName = card.cardBrand === 'Outra' ? card.customCardName : card.cardBrand;
                        const cardOpt = document.createElement('option');
                        cardOpt.value = `credit_card_${card.cardId}`;
                        cardOpt.textContent = `Cartão: ${(cardDisplayName || 'Cartão').substring(0,10)}..`;
                        selectEl.appendChild(cardOpt);
                    });
                }
            }
        }


        document.querySelectorAll('.filter-import-select').forEach(sel => sel.addEventListener('change', () => {
            const filters = {
                type: filterImportTypeSelect.value,
                category: filterImportCategorySelect.value,
                accountId: filterImportAccountSelect.value,
                status: filterImportStatusSelect.value,
            };
            renderImportedTransactionsForReview(filters);
        }));


        // --- Event Listeners (Collapsible sections, etc.) ---
        if(importHeader) importHeader.addEventListener('click', () => { importSectionContent.classList.toggle('hidden'); importArrow.classList.toggle('rotated'); });
        if(importPdfHeader) importPdfHeader.addEventListener('click', () => { importPdfSectionContent.classList.toggle('hidden'); importPdfArrow.classList.toggle('rotated'); });

        if(reportsHeader) reportsHeader.addEventListener('click', () => { reportsSectionContent.classList.toggle('hidden'); reportsArrow.classList.toggle('rotated'); });
        if(suggestedGoalsHeader) suggestedGoalsHeader.addEventListener('click', () => { suggestedGoalsContent.classList.toggle('hidden'); suggestedGoalsArrow.classList.toggle('rotated'); if(!suggestedGoalsContent.classList.contains('hidden')) suggestFinancialGoals(); });
        if(clearAllDataLink) clearAllDataLink.addEventListener('click', () => requestDeleteConfirmation(null, 'allData'));
        if(transactionList) transactionList.addEventListener('change', (e) => { if (e.target.classList.contains('transaction-checkbox')) updateSelectedTransactionsActions(); });
        if(selectAllTransactionsCheckbox) selectAllTransactionsCheckbox.addEventListener('change', (e) => { document.querySelectorAll('#transaction-list .transaction-checkbox').forEach(cb => { cb.checked = e.target.checked; }); updateSelectedTransactionsActions(); });
        // Listener para selectAllImportedCheckbox
        if(selectAllImportedCheckbox) {
            selectAllImportedCheckbox.addEventListener('change', (e) => {
                document.querySelectorAll('#imported-transactions-table-body .imported-transaction-checkbox').forEach(cb => {
                    cb.checked = e.target.checked;
                });
                updateBulkEditControlsVisibility();
            });
        }


        function updateSelectedTransactionsActions() {
            const selectedCheckboxes = document.querySelectorAll('#transaction-list .transaction-checkbox:checked'); 
            const hasSelected = selectedCheckboxes.length > 0;
            if(paySelectedTransactionsBtn) paySelectedTransactionsBtn.classList.toggle('hidden', !hasSelected);
            if(unpaySelectedTransactionsBtn) unpaySelectedTransactionsBtn.classList.toggle('hidden', !hasSelected);
            if(linkSelectedAccountSelect) linkSelectedAccountSelect.classList.toggle('hidden', !hasSelected);
            if(linkSelectedTransactionsBtn) linkSelectedTransactionsBtn.classList.toggle('hidden', !hasSelected);
            if(linkSelectedCategorySelect) linkSelectedCategorySelect.classList.toggle('hidden', !hasSelected);
            if(linkSelectedCategoryBtn) linkSelectedCategoryBtn.classList.toggle('hidden', !hasSelected);
            if(deleteSelectedTransactionsBtn) deleteSelectedTransactionsBtn.classList.toggle('hidden', !hasSelected);
            const allVisibleCheckboxes = document.querySelectorAll('#transaction-list .transaction-checkbox');
            if(selectAllTransactionsCheckbox) selectAllTransactionsCheckbox.checked = allVisibleCheckboxes.length > 0 && selectedCheckboxes.length === allVisibleCheckboxes.length;
        }
        if(paySelectedTransactionsBtn) paySelectedTransactionsBtn.addEventListener('click', () => { const ids = Array.from(document.querySelectorAll('#transaction-list .transaction-checkbox:checked')).map(cb=>cb.dataset.id); let c=0; ids.forEach(id => {if(markTransactionAsPaid(id,false))c++;}); if(c>0)showFeedback(`${c} transações pagas.`,'success'); renderAll();});
        if(deleteSelectedTransactionsBtn) deleteSelectedTransactionsBtn.addEventListener('click', () => { const ids=Array.from(document.querySelectorAll('#transaction-list .transaction-checkbox:checked')).map(cb=>cb.dataset.id); if(ids.length>0) requestDeleteConfirmation(null,'transaction',true,ids);});
        
        // --- Event Listener para Salvar Todos os Dados ---
        if (saveAllDataLink) { // Alterado de saveAllDataBtn para saveAllDataLink
            saveAllDataLink.addEventListener('click', (e) => {
                e.preventDefault(); // Prevenir comportamento padrão de link
                try {
                    const dataToSave = {
                        accounts: accounts,
                        transactions: transactions,
                        categories: categories,
                        savedAt: new Date().toISOString()
                    };
                    const jsonData = JSON.stringify(dataToSave, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    a.download = `controle_financeiro_backup_${timestamp}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showFeedback('Todos os dados foram salvos com sucesso!', 'success');
                } catch (error) {
                    console.error("Erro ao salvar dados:", error);
                    showFeedback('Erro ao salvar os dados. Verifique o console.', 'error');
                }
            });
        }
        
        // --- Event Listener para Importação de Arquivo (Geral) ---
        if (importFileBtn) {
            importFileBtn.addEventListener('click', async () => {
                if (!fileInput.files || fileInput.files.length === 0) {
                    showFeedback('Nenhum arquivo selecionado.', 'error'); return;
                }
                const file = fileInput.files[0];
                const fileName = file.name.toLowerCase();
                importFileBtn.disabled = true; 

                // Não processa PDF aqui, pois tem sua própria seção
                if (fileName.endsWith('.ofx')) {
                    await parseOFX(file);
                } else if (fileName.endsWith('.csv')) {
                    await parseExcelCsv(file, '.csv');
                } else if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
                    await parseExcelCsv(file, fileName.endsWith('.xls') ? '.xls' : '.xlsx');
                } else if (fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
                    await parseWord(file);
                } else if (fileName.endsWith('.png') || fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.gif') || fileName.endsWith('.bmp') || fileName.endsWith('.tiff') || fileName.endsWith('.webp')) {
                    await parseImage(file);
                } else {
                    showFeedback('Formato de arquivo não suportado nesta seção. Para PDF, use a seção específica.', 'error');
                    importFileBtn.disabled = false; 
                    fileInput.value = ''; 
                }
            });
        }
        
        // --- Event Listener para Importação de Arquivo PDF ---
        if (importPdfFileBtn) {
            importPdfFileBtn.addEventListener('click', async () => {
                if (!fileInputPdf.files || fileInputPdf.files.length === 0) {
                    showFeedback('Nenhum arquivo PDF selecionado.', 'error'); return;
                }
                const file = fileInputPdf.files[0];
                importPdfFileBtn.disabled = true;
                await parsePDF(file);
            });
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            if (accountTypeSelect.value === 'corrente') {
                overdraftSection.classList.remove('hidden');
                creditCardSection.classList.remove('hidden');
                if (linkedCardsContainer.children.length === 0) addCardInputFields(linkedCardsContainer);
            }
            loadData(); 
        });

    </script>
</body>
</html>
